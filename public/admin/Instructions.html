<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manufacturing Instructions</title>
  <link rel="stylesheet" href="https://unpkg.com/@coreui/icons/css/all.min.css">
  <style> 
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; margin: 0; padding: 0; }
    .container { max-width: 700px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.08); padding: 32px; }
    h1 { color: #4DBA93; text-align: center; margin-bottom: 32px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 24px; }
    th, td { padding: 12px 8px; border-bottom: 1px solid #e0e0e0; text-align: left; }
    th { background: #4DBA93; color: #fff; }
    .step-title { font-weight: bold; color: #4d6dba; }
    .ingredient-list { margin: 0; padding-left: 18px; }
    .step-row { background: #f6f8fa; }
    .icon { color: #4DBA93; margin-right: 8px; }
  </style>
  <link rel="icon" type="image/x-icon" href="/Assets/favicon.ico">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <script src="/Assets/CheckAccess.js"></script>
</head>
<body>
  <div class="container">
  <!-- Manufacturing Instructions header removed -->
    <div id="instructions"></div>
    
    <!-- Unit Conversion Calculator Button -->
    <button id="openCalculatorBtn" style="position:fixed; bottom:20px; right:20px; background:#4DBA93; color:white; border:none; border-radius:50%; width:60px; height:60px; font-size:24px; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.2); z-index:1000;" title="Unit Conversion Calculator">
      <i class="cil-calculator"></i>
    </button>
    
    <!-- Unit Conversion Calculator Modal -->
    <div id="calculatorModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
      <div style="background:white; padding:2rem; border-radius:12px; max-width:500px; width:90%; max-height:80vh; overflow-y:auto; box-shadow:0 8px 32px rgba(0,0,0,0.3);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
          <h3 style="margin:0; color:#4DBA93;">Unit Conversion Calculator</h3>
          <button id="closeCalculatorBtn" style="background:none; border:none; font-size:24px; color:#666; cursor:pointer;">&times;</button>
        </div>
        
        <div style="margin-bottom:1.5rem;">
          <label style="display:block; font-weight:600; margin-bottom:0.5rem;">Conversion Type:</label>
          <select id="conversionType" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:6px;">
            <option value="weight">Weight (lb ↔ kg ↔ oz ↔ g)</option>
            <option value="volume">Volume (fl oz ↔ ml ↔ cups ↔ L)</option>
            <option value="length">Length (in ↔ cm ↔ ft ↔ m)</option>
            <option value="temperature">Temperature (°F ↔ °C)</option>
          </select>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr auto 1fr; gap:1rem; align-items:end; margin-bottom:1.5rem;">
          <div>
            <label style="display:block; font-weight:600; margin-bottom:0.5rem;">From:</label>
            <input type="number" id="fromValue" placeholder="Enter value" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:6px; margin-bottom:0.5rem;">
            <select id="fromUnit" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:6px;">
              <!-- Options will be populated based on conversion type -->
            </select>
          </div>
          
          <div style="text-align:center; padding-top:1rem;">
            <i class="cil-arrow-right" style="font-size:20px; color:#4DBA93;"></i>
          </div>
          
          <div>
            <label style="display:block; font-weight:600; margin-bottom:0.5rem;">To:</label>
            <input type="number" id="toValue" readonly style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:6px; margin-bottom:0.5rem; background:#f8f9fa;">
            <select id="toUnit" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:6px;">
              <!-- Options will be populated based on conversion type -->
            </select>
          </div>
        </div>
        
        <button id="convertBtn" style="width:100%; background:#4DBA93; color:white; border:none; padding:0.75rem; border-radius:6px; font-size:16px; font-weight:600; cursor:pointer;">
          Convert
        </button>
        
        <div id="conversionResult" style="margin-top:1rem; padding:1rem; background:#f0fdf4; border-radius:6px; display:none;">
          <strong id="resultText"></strong>
        </div>
      </div>
    </div>
  </div>
  <script>
    checkPermissions(['service_role', 'employee']);
      
    const urlParams = new URLSearchParams(window.location.search);
    const orderNumber = urlParams.get('ordernumber');
    const instructionsDiv = document.getElementById('instructions');
    if (!orderNumber) {
      instructionsDiv.innerHTML = '<p style="color:red;">No order number provided.</p>';
    } else {
      (async function() {
       
        const { data: orderData, error: orderError } = await supabase
          .from('ManufacturingTasks')
          .select('ProductSKU, Quantity, Progress,Customer,UserID')
          .eq('OrderNumber', orderNumber)
          .single();
        if (orderError || !orderData) {
          instructionsDiv.innerHTML = '<p style="color:red;">Order not found.</p>';
          return;
        }
        // Fetch Product with ManufacturingSteps
        const { data: productData, error: prodError } = await supabase
          .from('Products')
          .select('Name, ManufacturingSteps, Quantity')
          .eq('ProductSKU', orderData.ProductSKU)
          .single();
        if (prodError || !productData) {
          instructionsDiv.innerHTML = '<p style="color:red;">Product not found.</p>';
          return;
        }
        const steps = productData.ManufacturingSteps?.Steps || productData.ManufacturingSteps || [];
        if (!Array.isArray(steps) || steps.length === 0) {
          instructionsDiv.innerHTML = '<p>No manufacturing steps found for this product.</p>';
          return;
        }
        // Find step index from Progress column
        let currentStep = 0;
        let foundStep = false;
        if (orderData.Progress) {
          const progressTitle = orderData.Progress.trim().toLowerCase();
          for (let i = 0; i < steps.length; i++) {
            const stepTitle = (steps[i]["Step Title"] || steps[i].StepTitle || `Step ${i+1}`).trim().toLowerCase();
            if (stepTitle === progressTitle) {
              currentStep = i;
              foundStep = true;
              break;
            }
          }
        }
        if (!foundStep && steps.length > 0) {
          // Update Progress column to first step title
          const firstStepTitle = steps[0]["Step Title"] || steps[0].StepTitle || `Step 1`;
          await supabase
            .from('ManufacturingTasks')
            .update({ Progress: firstStepTitle })
            .eq('OrderNumber', orderNumber);
        }
        // Lot number generation (same as other files):
        function generateLotNumber(orderNumber) {
          // Example: JL-{orderNumber}-{YYYYMMDD}
          const now = new Date();
          const yyyy = now.getFullYear();
          const mm = String(now.getMonth()+1).padStart(2,'0');
          const dd = String(now.getDate()).padStart(2,'0');
          return `JL-${orderNumber}-${yyyy}${mm}${dd}`;
        }
  async function renderStep(idx) {
          const step = steps[idx];
          const batchNumber = orderNumber;
          const lotNumber = await generatelotNumber(productData);
          const batchDate = new Date().toLocaleDateString();
          let html = `<div style='font-size:1.1em;color:#333;margin-bottom:18px;text-align:center;'>Batch Number: <strong>${batchNumber}</strong> &nbsp; | &nbsp; Lot Number: <strong>${lotNumber}</strong> &nbsp; | &nbsp; Batch Date: <strong>${batchDate}</strong></div>`;
          html += `<h2 style='color:#4d6dba;'>${productData.Name || orderData.ProductSKU} <span style='font-size:0.8em;color:#333;font-weight:normal;'>(Qty: ${orderData.Quantity})</span></h2>`;
          html += `<div class='step-card' style='background:#f6f8fa;border-radius:10px;padding:24px;margin-bottom:24px;'>`;
          html += `<div class='step-title' style='font-size:1.3em;color:#4d6dba;font-weight:bold;margin-bottom:10px;'>${step["Step Title"]}</div>`;
          html += `<div style='margin-bottom:10px;'><strong>Duration:</strong> ${step["Step Duration (Minutes)"] || ''} min</div>`;
          html += `<div style='margin-bottom:10px;'><strong>Ingredients:</strong></div>`;
          if (Array.isArray(step["Step Ingredients"])) {
            // Fetch ingredient names and locations from Supabase
            const ingredientSKUs = step["Step Ingredients"].map(ing => ing.IngredientSKU);
            let nameMap = {};
            let locationMap = {};
            if (ingredientSKUs.length > 0) {
              const { data: ingredients, error } = await supabase
                .from('Ingredients')
                .select('IngredientSKU,Name,Location')
                .in('IngredientSKU', ingredientSKUs);
              if (!error && ingredients) {
                ingredients.forEach(row => {
                  nameMap[row.IngredientSKU] = row.Name;
                  locationMap[row.IngredientSKU] = row.Location || '';
                });
              }
            }
            html += `<div style='overflow-x:auto;'><table style='width:100%; border-collapse:collapse; margin-top:0.3em; font-size:1em;'>`;
            html += `<colgroup>
                <col style='width:28%;'>
                <col style='width:15%;'>
                <col style='width:15%;'>
                <col style='width:17%;'>
                <col style='width:15%;'>
            </colgroup>`;
            html += `<thead><tr>
                <th style='padding:4px 8px; border:1px solid #b2d8a6;'>Ingredient</th>
                <th style='padding:4px 8px; border:1px solid #b2d8a6;'>SKU</th>
                <th style='padding:4px 8px; border:1px solid #b2d8a6;'>Amount(Lbs/Units)</th>
                <th style='padding:4px 8px; border:1px solid #b2d8a6;'>Location</th>
            </tr></thead><tbody>`;
            step["Step Ingredients"].forEach(ing => {
              const batchQty = orderData.Quantity || 1;
              const totalQty = (ing.IngredientQuantity !== undefined && ing.IngredientQuantity !== null)
                ? Math.round(ing.IngredientQuantity * batchQty * 1000) / 1000
                : '';
              html += `<tr>` +
                `<td style='padding:4px 8px; border:1px solid #b2d8a6;'>${nameMap[ing.IngredientSKU] || ''}</td>` +
                `<td style='padding:4px 8px; border:1px solid #b2d8a6;'>${ing.IngredientSKU}</td>` +
                `<td style='padding:4px 8px; border:1px solid #b2d8a6;'>${totalQty}</td>` +
                `<td style='padding:4px 8px; border:1px solid #b2d8a6;'>${locationMap[ing.IngredientSKU] || ''}</td>` +
              `</tr>`;
            });
            html += `</tbody></table></div>`;
          } else {
            html += '—';
          }
          // Replace [n] in instructions with corresponding ingredient info
          let instructionsText = step["Step Instructions"] || step.StepInstructions || '';
          if (Array.isArray(step["Step Ingredients"])) {
            instructionsText = instructionsText.replace(/\[(\d+)\]/g, (match, p1) => {
              const n = parseInt(p1, 10);
              const ing = step["Step Ingredients"][n];
              if (ing) {
                const batchQty = orderData.Quantity || 1;
                let qty = ing.IngredientQuantity !== undefined ? Math.round(ing.IngredientQuantity * batchQty * 1000) / 1000 : '';
                return `${ing.IngredientSKU} (${qty})`;
              }
              return match;
            });
          }
          html += `<div style='margin-bottom:10px;'><strong>Instructions:</strong><br>${instructionsText}</div>`;
          html += `</div>`;
          html += `<div style='text-align:center;margin-top:18px;'>`;
          html += `<span>Step ${idx+1} of ${steps.length}</span>`;
          html += `<button id='nextStep' style='margin-left:16px;'>${idx === steps.length-1 ? 'Finish' : 'Complete Step'}</button>`;
          html += `</div>`;
          instructionsDiv.innerHTML = html;
          document.getElementById('nextStep').onclick = async function() {
            await supabase
              .from("ManufacturingLog")
              .insert({ FinishedAt: new Date(), Step: step["Step Title"],OrderNumber: orderNumber, ProductSKU: orderData.ProductSKU, display_name: window.CurrentUserDisplayName });
            if (currentStep < steps.length-1) {
              currentStep++;
              // Update Progress column in ManufacturingTasks to the new step title
              const newProgress = steps[currentStep]["Step Title"] || steps[currentStep].StepTitle || `Step ${currentStep+1}`;
              await supabase
                .from('ManufacturingTasks')
                .update({ Progress: newProgress })
                .eq('OrderNumber', orderNumber);
              await renderStep(currentStep);
            } else {
              const today = new Date();
              const yyyy = today.getFullYear();
              const mm = String(today.getMonth()+1).padStart(2,'0');
              const dd = String(today.getDate()).padStart(2,'0');
              const completionDate = `${yyyy}-${mm}-${dd}`;
              // If last step, prompt for actual quantity made
              let ActualQuantity=null;
              while(ActualQuantity===null || isNaN(ActualQuantity) || ActualQuantity<0){
                ActualQuantity=parseInt(prompt("How many pieces were Actually made?"));
              }
              if(ActualQuantity<orderData.Quantity){
                if(confirm(`You entered ${ActualQuantity}, which is less than the ordered quantity of ${orderData.Quantity}. If you will be making the remaining product for this order again press "OK"`)){
                  //if they wish to make more later, set progress to "Requested" and update quantity to remaining amount, then update Products table and log and redirect
                await supabase
                .from('ManufacturingTasks')
                .insert({ ProductSKU: orderData.ProductSKU, Customer: orderData.Customer, UserID: orderData.UserID, Quantity: orderData.Quantity-ActualQuantity, Progress: 'requested' });
                await supabase
                .from('ManufacturingTasks')
                .update({ Progress: 'Completed', CompletionDate: completionDate })
                .eq('OrderNumber', orderNumber);
                await supabase
                .from('Products')
                .update({ LastBatch: completionDate, LastBatchNumber: orderNumber, Quantity: productData.Quantity + ActualQuantity})
                .eq('ProductSKU', orderData.ProductSKU);
              await supabase
                .from('inventoryupdatelogs')
                .insert({ created_at: new Date(), log: `Partially completed manufacturing order ${orderNumber} for product ${orderData.ProductSKU}, added ${ActualQuantity} to inventory.`,updated_by: window.CurrentUserDisplayName, SKU:orderData.ProductSKU,QuantityChanged: -ActualQuantity});
              window.location.href = 'Manufacturing.html';
                }
              }
              if(ActualQuantity!=orderData.Quantity){
                // Send alert to admin user of Quantity discrepancy
                const { data: userRow, error } = await supabase
                .from('Users')
                .select('Alerts')
                .eq('id', "bc4441d2-38e8-4e77-afb4-2609ec6f56f6")
                .maybeSingle();
              let alertsArr = [];
              if (!error && userRow && Array.isArray(userRow.Alerts)) {
                alertsArr = userRow.Alerts;
              }
              alertsArr.push(`${new Date().toLocaleString()}: Quantity discrepancy detected. Manufactured ${ActualQuantity} for order ${orderNumber}, which differs from the ordered quantity of ${orderData.Quantity}. Please investigate.`);
              await supabase
                .from('Users')
                .update({ Alerts: alertsArr })
                .eq('id', "bc4441d2-38e8-4e77-afb4-2609ec6f56f6");
              }
              // Last step: set progress to Completed and set CompletionDate, then update Products table and redirect
              
              await supabase
                .from('ManufacturingTasks')
                .update({ Progress: 'Completed', CompletionDate: completionDate })
                .eq('OrderNumber', orderNumber);
              // Update LastBatch and LastBatchNumber in Products table
              await supabase
                .from('Products')
                .update({ LastBatch: completionDate, LastBatchNumber: orderNumber, Quantity: productData.Quantity + ActualQuantity})
                .eq('ProductSKU', orderData.ProductSKU);
              await supabase
                .from('inventoryupdatelogs')
                .insert({ created_at: new Date(), log: `Completed manufacturing order ${orderNumber} for product ${orderData.ProductSKU}, added ${ActualQuantity} to inventory.`,updated_by: window.CurrentUserDisplayName, SKU:orderData.ProductSKU,QuantityChanged: ActualQuantity});
              console.log('Manufacturing completed for order', orderNumber);
              window.location.href = 'Manufacturing.html';
            }
          };
        }
        await renderStep(currentStep);
      })();
    }
        async function generatelotNumber(currentProduct) {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + 1; // 1-12
      const day = now.getDate();
      // Fetch shelf life from Products table
      let shelfLife = 36; // Default fallback
      try {
        const { data: productShelfData, error: shelfError } = await supabase
          .from('Products')
          .select('ShelfLife')
          .eq('ProductSKU', currentProduct.ProductSKU)
          .maybeSingle();
        if (!shelfError && productShelfData && productShelfData.ShelfLife) {
          shelfLife = productShelfData.ShelfLife;
        }
      } catch (error) {
        console.warn('Failed to fetch shelf life, using default of 3 years:', error);
      }
      // Month letter (a-l for Jan-Dec)
      const monthLetters = 'abcdefghijkl';
      const monthLetter = monthLetters[month - 1];
      // 3rd digit of year (from the right, e.g., 2024 -> 2)
      const thirdDigitYear = Math.floor((year % 100) / 10);
      // Last digit of year
      const lastDigitYear = year % 10;
      // Expiration month calculation
      let expirationMonth = month;
      let expirationYear = year + shelfLife/12; // Current year + shelf life
      if (day >= 15) {
        expirationMonth = month + 1;
        if (expirationMonth > 12) {
          expirationMonth = 1;
          expirationYear = year + shelfLife/12 + 1; // Account for month rollover
        }
      }
      // Format expiration month (01-12)
      const formattedExpMonth = expirationMonth.toString().padStart(2, '0');
      // Last 2 digits of expiration year
      const expYearLastTwo = (expirationYear % 100).toString().padStart(2, '0');
      // Combine: monthLetter + "-" + thirdDigitYear + day + lastDigitYear + expMonth + expYearLastTwo
      const lot = `${monthLetter}-${thirdDigitYear}${day.toString().padStart(2, '0')}${lastDigitYear}${formattedExpMonth}${expYearLastTwo}`;
      return lot;
    }

    // Unit Conversion Calculator
    const conversions = {
      weight: {
        units: { 'lb': 'Pounds', 'kg': 'Kilograms', 'oz': 'Ounces', 'g': 'Grams' },
        toGrams: { 'lb': 453.592, 'kg': 1000, 'oz': 28.3495, 'g': 1 }
      },
      volume: {
        units: { 'fl oz': 'Fluid Ounces', 'ml': 'Milliliters', 'cups': 'Cups', 'L': 'Liters' },
        toMl: { 'fl oz': 29.5735, 'ml': 1, 'cups': 236.588, 'L': 1000 }
      },
      length: {
        units: { 'in': 'Inches', 'cm': 'Centimeters', 'ft': 'Feet', 'm': 'Meters' },
        toCm: { 'in': 2.54, 'cm': 1, 'ft': 30.48, 'm': 100 }
      },
      temperature: {
        units: { 'F': 'Fahrenheit', 'C': 'Celsius' }
      }
    };

    function populateUnits() {
      const conversionType = document.getElementById('conversionType').value;
      const fromUnit = document.getElementById('fromUnit');
      const toUnit = document.getElementById('toUnit');
      
      fromUnit.innerHTML = '';
      toUnit.innerHTML = '';
      
      const units = conversions[conversionType].units;
      Object.keys(units).forEach(unit => {
        const option1 = document.createElement('option');
        option1.value = unit;
        option1.textContent = `${unit} (${units[unit]})`;
        fromUnit.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = unit;
        option2.textContent = `${unit} (${units[unit]})`;
        toUnit.appendChild(option2);
      });
      
      // Set different default selections
      if (toUnit.children.length > 1) {
        toUnit.selectedIndex = 1;
      }
    }

    function convertUnits() {
      const conversionType = document.getElementById('conversionType').value;
      const fromValue = parseFloat(document.getElementById('fromValue').value);
      const fromUnit = document.getElementById('fromUnit').value;
      const toUnit = document.getElementById('toUnit').value;
      
      if (isNaN(fromValue)) {
        alert('Please enter a valid number');
        return;
      }
      
      let result;
      
      if (conversionType === 'temperature') {
        if (fromUnit === 'F' && toUnit === 'C') {
          result = (fromValue - 32) * 5/9;
        } else if (fromUnit === 'C' && toUnit === 'F') {
          result = (fromValue * 9/5) + 32;
        } else {
          result = fromValue; // Same unit
        }
      } else {
        const conversionData = conversions[conversionType];
        const baseUnitKey = Object.keys(conversionData)[1]; // toGrams, toMl, toCm
        const baseUnit = conversionData[baseUnitKey];
        
        // Convert to base unit first, then to target unit
        const baseValue = fromValue * baseUnit[fromUnit];
        result = baseValue / baseUnit[toUnit];
      }
      
      document.getElementById('toValue').value = result.toFixed(4);
      
      const resultDiv = document.getElementById('conversionResult');
      const resultText = document.getElementById('resultText');
      resultText.textContent = `${fromValue} ${fromUnit} = ${result.toFixed(4)} ${toUnit}`;
      resultDiv.style.display = 'block';
    }

    // Calculator Modal Event Listeners
    document.getElementById('openCalculatorBtn').addEventListener('click', () => {
      document.getElementById('calculatorModal').style.display = 'flex';
      populateUnits();
    });

    document.getElementById('closeCalculatorBtn').addEventListener('click', () => {
      document.getElementById('calculatorModal').style.display = 'none';
    });

    document.getElementById('calculatorModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('calculatorModal')) {
        document.getElementById('calculatorModal').style.display = 'none';
      }
    });

    document.getElementById('conversionType').addEventListener('change', populateUnits);
    document.getElementById('fromUnit').addEventListener('change', convertUnits);
    document.getElementById('toUnit').addEventListener('change', convertUnits);
    document.getElementById('fromValue').addEventListener('input', convertUnits);
    document.getElementById('convertBtn').addEventListener('click', convertUnits);
  </script>
</body>
</html>
