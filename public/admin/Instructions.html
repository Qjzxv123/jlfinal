<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manufacturing Instructions</title>
  <link rel="stylesheet" href="https://unpkg.com/@coreui/icons/css/all.min.css">
  <style> 
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; margin: 0; padding: 0; }
    .container { max-width: 700px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.08); padding: 32px; }
    h1 { color: #4DBA93; text-align: center; margin-bottom: 32px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 24px; }
    th, td { padding: 12px 8px; border-bottom: 1px solid #e0e0e0; text-align: left; }
    th { background: #4DBA93; color: #fff; }
    .step-title { font-weight: bold; color: #4d6dba; }
    .ingredient-list { margin: 0; padding-left: 18px; }
    .step-row { background: #f6f8fa; }
    .icon { color: #4DBA93; margin-right: 8px; }
    .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fff; margin: 5% auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); max-height: 85vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-header h3 { margin: 0; color: #4DBA93; font-size: 1.3rem; }
    .close-btn { background: none; border: none; font-size: 28px; color: #666; cursor: pointer; line-height: 1; padding: 0; }
    #skuRowsContainer { max-height: 50vh; overflow-y: auto; margin-bottom: 12px; padding-right: 5px; }
    .sku-row { display: grid; grid-template-columns: 2fr 1fr auto; gap: 10px; margin-bottom: 12px; align-items: center; }
    .sku-row input, .sku-row select { padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; width: 100%; box-sizing: border-box; }
    .sku-row button { background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px; flex-shrink: 0; }
    .add-row-btn { background: #6c757d; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; margin-top: 10px; }
    .submit-btn { background: #4DBA93; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; margin-top: 20px; width: 100%; }
  </style>
  <link rel="icon" type="image/x-icon" href="/Assets/favicon.ico">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <script src="/Assets/CheckAccess.js"></script>
</head>
<body>
  <div class="container">
  <!-- Manufacturing Instructions header removed -->
    <div id="instructions"></div>
    
    <!-- Quantity Modal -->
    <div id="quantityModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Record Actual Quantity Made</h3>
          <button class="close-btn" onclick="closeQuantityModal()">&times;</button>
        </div>
        <p style="margin-bottom: 20px; color: #666; font-size: 14px; line-height: 1.5;">
          Enter the actual quantities produced for each SKU. When you submit, the system will:
          <br>• Update inventory for all entered SKUs
          <br>• Mark this manufacturing order as completed
          <br>• Log all inventory changes
          <br>• Create a new task if total quantity is less than ordered with the remaining quantity
        </p>
        <div id="skuRowsContainer">
          <!-- SKU rows will be added dynamically -->
        </div>
        <button class="add-row-btn" onclick="addSkuRow()">+ Add Another SKU</button>
        <button class="submit-btn" onclick="submitQuantities()">Submit</button>
      </div>
    </div>
    
    <!-- Unit Conversion Calculator Button -->
    <button id="openCalculatorBtn" style="position:fixed; bottom:20px; right:20px; background:#4DBA93; color:white; border:none; border-radius:50%; width:60px; height:60px; font-size:24px; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.2); z-index:1000;" title="Unit Conversion Calculator">
      <i class="cil-calculator"></i>
    </button>
    
    <!-- Unit Conversion Calculator Modal -->
    <div id="calculatorModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
      <div style="background:white; padding:2rem; border-radius:12px; max-width:500px; width:90%; max-height:80vh; overflow-y:auto; box-shadow:0 8px 32px rgba(0,0,0,0.3);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
          <h3 style="margin:0; color:#4DBA93;">Unit Conversion Calculator</h3>
          <button id="closeCalculatorBtn" style="background:none; border:none; font-size:24px; color:#666; cursor:pointer;">&times;</button>
        </div>
        
        <div style="margin-bottom:1.5rem;">
          <label style="display:block; font-weight:600; margin-bottom:0.5rem;">Conversion Type:</label>
          <select id="conversionType" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:6px;">
            <option value="weight">Weight (lb ↔ kg ↔ oz ↔ g)</option>
            <option value="volume">Volume (fl oz ↔ ml ↔ cups ↔ L)</option>
            <option value="length">Length (in ↔ cm ↔ ft ↔ m)</option>
            <option value="temperature">Temperature (°F ↔ °C)</option>
          </select>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr auto 1fr; gap:1rem; align-items:end; margin-bottom:1.5rem;">
          <div>
            <label style="display:block; font-weight:600; margin-bottom:0.5rem;">From:</label>
            <input type="number" id="fromValue" placeholder="Enter value" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:6px; margin-bottom:0.5rem;">
            <select id="fromUnit" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:6px;">
              <!-- Options will be populated based on conversion type -->
            </select>
          </div>
          
          <div style="text-align:center; padding-top:1rem;">
            <i class="cil-arrow-right" style="font-size:20px; color:#4DBA93;"></i>
          </div>
          
          <div>
            <label style="display:block; font-weight:600; margin-bottom:0.5rem;">To:</label>
            <input type="number" id="toValue" readonly style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:6px; margin-bottom:0.5rem; background:#f8f9fa;">
            <select id="toUnit" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:6px;">
              <!-- Options will be populated based on conversion type -->
            </select>
          </div>
        </div>
        
        <button id="convertBtn" style="width:100%; background:#4DBA93; color:white; border:none; padding:0.75rem; border-radius:6px; font-size:16px; font-weight:600; cursor:pointer;">
          Convert
        </button>
        
        <div id="conversionResult" style="margin-top:1rem; padding:1rem; background:#f0fdf4; border-radius:6px; display:none;">
          <strong id="resultText"></strong>
        </div>
      </div>
    </div>
  </div>
  <script>
    checkPermissions(['service_role', 'employee']);
      
    const urlParams = new URLSearchParams(window.location.search);
    const orderNumber = urlParams.get('ordernumber');
    const quantityOverride = urlParams.get('quantity'); // URL parameter to override quantity
    const instructionsDiv = document.getElementById('instructions');
    if (!orderNumber) {
      instructionsDiv.innerHTML = '<p style="color:red;">No order number provided.</p>';
    } else {
      (async function() {
       
        const { data: orderData, error: orderError } = await supabase
          .from('ManufacturingTasks')
          .select('ProductSKU, Quantity, Progress,Customer,UserID')
          .eq('OrderNumber', orderNumber)
          .single();
        if (orderError || !orderData) {
          instructionsDiv.innerHTML = '<p style="color:red;">Order not found.</p>';
          return;
        }
        
        // Override quantity if URL parameter is provided
        const effectiveQuantity = quantityOverride ? parseInt(quantityOverride) : orderData.Quantity;
        // Fetch Product with ManufacturingSteps
        const { data: productData, error: prodError } = await supabase
          .from('Products')
          .select('Name, ManufacturingSteps, Quantity')
          .eq('ProductSKU', orderData.ProductSKU)
          .single();
        if (prodError || !productData) {
          instructionsDiv.innerHTML = '<p style="color:red;">Product not found.</p>';
          return;
        }
        const steps = productData.ManufacturingSteps?.Steps || productData.ManufacturingSteps || [];
        if (!Array.isArray(steps) || steps.length === 0) {
          instructionsDiv.innerHTML = '<p>No manufacturing steps found for this product.</p>';
          return;
        }
        // Find step index from Progress column
        let currentStep = 0;
        let foundStep = false;
        if (orderData.Progress) {
          const progressTitle = orderData.Progress.trim().toLowerCase();
          for (let i = 0; i < steps.length; i++) {
            const stepTitle = (steps[i]["Step Title"] || steps[i].StepTitle || `Step ${i+1}`).trim().toLowerCase();
            if (stepTitle === progressTitle) {
              currentStep = i;
              foundStep = true;
              break;
            }
          }
        }
        if (!foundStep && steps.length > 0) {
          // Update Progress column to first step title
          const firstStepTitle = steps[0]["Step Title"] || steps[0].StepTitle || `Step 1`;
          await supabase
            .from('ManufacturingTasks')
            .update({ Progress: firstStepTitle })
            .eq('OrderNumber', orderNumber);
        }
        // Lot number generation (same as other files):
        function generateLotNumber(orderNumber) {
          // Example: JL-{orderNumber}-{YYYYMMDD}
          const now = new Date();
          const yyyy = now.getFullYear();
          const mm = String(now.getMonth()+1).padStart(2,'0');
          const dd = String(now.getDate()).padStart(2,'0');
          return `JL-${orderNumber}-${yyyy}${mm}${dd}`;
        }
  async function renderStep(idx) {
          const step = steps[idx];
          const batchNumber = orderNumber;
          const lotNumber = await generatelotNumber(productData);
          const batchDate = new Date().toLocaleDateString();
          let html = `<div style='font-size:1.1em;color:#333;margin-bottom:18px;text-align:center;'>
            <div>Batch Number: <strong>${batchNumber}</strong> &nbsp; | &nbsp; Lot Number: <strong>${lotNumber}</strong> &nbsp; | &nbsp; Batch Date: <strong>${batchDate}</strong></div>
            <button id='printBatchInfoBtn' style='margin-top:10px;background:#4DBA93;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;' title='Print Batch Information'>
              <i class='cil-print'></i> Print Batch Info
            </button>
          </div>`;
          html += `<h2 style='color:#4d6dba;'>${productData.Name || orderData.ProductSKU} <span style='font-size:0.8em;color:#333;font-weight:normal;'>(Qty: ${effectiveQuantity})</span></h2>`;
          html += `<div class='step-card' style='background:#f6f8fa;border-radius:10px;padding:24px;margin-bottom:24px;'>`;
          html += `<div class='step-title' style='font-size:1.3em;color:#4d6dba;font-weight:bold;margin-bottom:10px;'>${step["Step Title"]}</div>`;
          html += `<div style='margin-bottom:10px;'><strong>Duration:</strong> ${step["Step Duration (Minutes)"] || ''} min</div>`;
          html += `<div style='margin-bottom:10px;'><strong>Ingredients:</strong></div>`;
          if (Array.isArray(step["Step Ingredients"])) {
            // Fetch ingredient names and locations from Supabase
            const ingredientSKUs = step["Step Ingredients"].map(ing => ing.IngredientSKU);
            let nameMap = {};
            let locationMap = {};
            if (ingredientSKUs.length > 0) {
              const { data: ingredients, error } = await supabase
                .from('Ingredients')
                .select('IngredientSKU,Name,Location')
                .in('IngredientSKU', ingredientSKUs);
              if (!error && ingredients) {
                ingredients.forEach(row => {
                  nameMap[row.IngredientSKU] = row.Name;
                  locationMap[row.IngredientSKU] = row.Location || '';
                });
              }
            }
            html += `<div style='overflow-x:auto;'><table style='width:100%; border-collapse:collapse; margin-top:0.3em; font-size:1em;'>`;
            html += `<colgroup>
                <col style='width:28%;'>
                <col style='width:15%;'>
                <col style='width:15%;'>
                <col style='width:17%;'>
                <col style='width:15%;'>
            </colgroup>`;
            html += `<thead><tr>
                <th style='padding:4px 8px; border:1px solid #b2d8a6;'>Ingredient</th>
                <th style='padding:4px 8px; border:1px solid #b2d8a6;'>SKU</th>
                <th style='padding:4px 8px; border:1px solid #b2d8a6;'>Amount(Lbs/Units)</th>
                <th style='padding:4px 8px; border:1px solid #b2d8a6;'>Location</th>
            </tr></thead><tbody>`;
            step["Step Ingredients"].forEach(ing => {
              const batchQty = effectiveQuantity || 1;
              const totalQty = (ing.IngredientQuantity !== undefined && ing.IngredientQuantity !== null)
                ? Math.round(ing.IngredientQuantity * batchQty * 1000) / 1000
                : '';
              html += `<tr>` +
                `<td style='padding:4px 8px; border:1px solid #b2d8a6;'>${nameMap[ing.IngredientSKU] || ''}</td>` +
                `<td style='padding:4px 8px; border:1px solid #b2d8a6;'>${ing.IngredientSKU}</td>` +
                `<td style='padding:4px 8px; border:1px solid #b2d8a6;'>${totalQty}</td>` +
                `<td style='padding:4px 8px; border:1px solid #b2d8a6;'>${locationMap[ing.IngredientSKU] || ''}</td>` +
              `</tr>`;
            });
            html += `</tbody></table></div>`;
          } else {
            html += '—';
          }
          // Replace [n] in instructions with corresponding ingredient info
          let instructionsText = step["Step Instructions"] || step.StepInstructions || '';
          if (Array.isArray(step["Step Ingredients"])) {
            instructionsText = instructionsText.replace(/\[(\d+)\]/g, (match, p1) => {
              const n = parseInt(p1, 10);
              const ing = step["Step Ingredients"][n];
              if (ing) {
                const batchQty = effectiveQuantity || 1;
                let qty = ing.IngredientQuantity !== undefined ? Math.round(ing.IngredientQuantity * batchQty * 1000) / 1000 : '';
                return `${ing.IngredientSKU} (${qty})`;
              }
              return match;
            });
          }
          html += `<div style='margin-bottom:10px;'><strong>Instructions:</strong><br>${instructionsText}</div>`;
          html += `</div>`;
          html += `<div style='text-align:center;margin-top:18px;'>`;
          html += `<span>Step ${idx+1} of ${steps.length}</span><br>`;
          html += `<div style='margin-top:12px;'>`;
          if (idx > 0) {
            html += `<button id='prevStep' style='background:#6c757d; color:white; border:none; padding:10px 20px; border-radius:6px; font-size:14px; cursor:pointer; margin-right:8px;'>← Previous Step</button>`;
          }
          html += `<button id='nextStep' style='background:#4DBA93; color:white; border:none; padding:10px 20px; border-radius:6px; font-size:14px; cursor:pointer;'>${idx === steps.length-1 ? 'Finish' : 'Complete Step'}</button>`;
          html += `</div></div>`;
          instructionsDiv.innerHTML = html;
          
          // Print Batch Info button handler
          document.getElementById('printBatchInfoBtn').onclick = function() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
              <!DOCTYPE html>
              <html>
              <head>
                <title>Batch Information</title>
                <style>
                  body { font-family: Arial, sans-serif; padding: 40px; }
                  .batch-info { text-align: center; }
                  .batch-info h1 { margin-bottom: 30px; color: #2c3e50; }
                  .batch-info table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                  .batch-info td { padding: 15px; border: 1px solid #ddd; font-size: 18px; }
                  .batch-info td:first-child { font-weight: bold; background: #f8f9fa; width: 40%; }
                  @media print {
                    body { padding: 20px; }
                  }
                </style>
              </head>
              <body>
                <div class="batch-info">
                  <h1>Batch Information</h1>
                  <table>
                    <tr>
                      <td>Batch Number:</td>
                      <td>${batchNumber}</td>
                    </tr>
                    <tr>
                      <td>Batch Date:</td>
                      <td>${batchDate}</td>
                    </tr>
                    <tr>
                      <td>Product SKU:</td>
                      <td>${orderData.ProductSKU}</td>
                    </tr>
                    <tr>
                      <td>Product Name:</td>
                      <td>${productData.Name || 'N/A'}</td>
                    </tr>
                    <tr>
                      <td>Quantity:</td>
                      <td>${effectiveQuantity}</td>
                    </tr>
                  </table>
                </div>
              </body>
              </html>
            `);
            printWindow.document.close();
            setTimeout(() => {
              printWindow.focus();
              printWindow.print();
            }, 250);
          };
          
          // Previous Step button handler
          if (idx > 0) {
            document.getElementById('prevStep').onclick = async function() {
              currentStep--;
              // Update Progress column in ManufacturingTasks to the previous step title
              const prevProgress = steps[currentStep]["Step Title"] || steps[currentStep].StepTitle || `Step ${currentStep+1}`;
              await supabase
                .from('ManufacturingTasks')
                .update({ Progress: prevProgress })
                .eq('OrderNumber', orderNumber);
              await renderStep(currentStep);
            };
          }
          
          document.getElementById('nextStep').onclick = async function() {
            await supabase
              .from("ManufacturingLog")
              .insert({ FinishedAt: new Date(), Step: step["Step Title"],OrderNumber: orderNumber, ProductSKU: orderData.ProductSKU, display_name: window.CurrentUserDisplayName });
            if (currentStep < steps.length-1) {
              currentStep++;
              // Update Progress column in ManufacturingTasks to the new step title
              const newProgress = steps[currentStep]["Step Title"] || steps[currentStep].StepTitle || `Step ${currentStep+1}`;
              await supabase
                .from('ManufacturingTasks')
                .update({ Progress: newProgress })
                .eq('OrderNumber', orderNumber);
              await renderStep(currentStep);
            } else {
              const today = new Date();
              const yyyy = today.getFullYear();
              const mm = String(today.getMonth()+1).padStart(2,'0');
              const dd = String(today.getDate()).padStart(2,'0');
              const completionDate = `${yyyy}-${mm}-${dd}`;
              // If last step, open modal for actual quantity made
              await openQuantityModal(orderData, productData, effectiveQuantity, completionDate, orderNumber);
            }
          };
        }
        await renderStep(currentStep);
      })();
    }
        async function generatelotNumber(currentProduct) {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + 1; // 1-12
      const day = now.getDate();
      // Fetch shelf life from Products table
      let shelfLife = 36; // Default fallback
      try {
        const { data: productShelfData, error: shelfError } = await supabase
          .from('Products')
          .select('ShelfLife')
          .eq('ProductSKU', currentProduct.ProductSKU)
          .maybeSingle();
        if (!shelfError && productShelfData && productShelfData.ShelfLife) {
          shelfLife = productShelfData.ShelfLife;
        }
      } catch (error) {
        console.warn('Failed to fetch shelf life, using default of 3 years:', error);
      }
      // Month letter (a-l for Jan-Dec)
      const monthLetters = 'abcdefghijkl';
      const monthLetter = monthLetters[month - 1];
      // 3rd digit of year (from the right, e.g., 2024 -> 2)
      const thirdDigitYear = Math.floor((year % 100) / 10);
      // Last digit of year
      const lastDigitYear = year % 10;
      // Expiration month calculation
      let expirationMonth = month;
      let expirationYear = year + shelfLife/12; // Current year + shelf life
      if (day >= 15) {
        expirationMonth = month + 1;
        if (expirationMonth > 12) {
          expirationMonth = 1;
          expirationYear = year + shelfLife/12 + 1; // Account for month rollover
        }
      }
      // Format expiration month (01-12)
      const formattedExpMonth = expirationMonth.toString().padStart(2, '0');
      // Last 2 digits of expiration year
      const expYearLastTwo = (expirationYear % 100).toString().padStart(2, '0');
      // Combine: monthLetter + "-" + thirdDigitYear + day + lastDigitYear + expMonth + expYearLastTwo
      const lot = `${monthLetter}-${thirdDigitYear}${day.toString().padStart(2, '0')}${lastDigitYear}${formattedExpMonth}${expYearLastTwo}`;
      return lot;
    }

    // Quantity Modal Functions
    let modalOrderData, modalProductData, modalEffectiveQuantity, modalCompletionDate, modalOrderNumber;
    let allProducts = [];

    async function openQuantityModal(orderData, productData, effectiveQuantity, completionDate, orderNumber) {
      modalOrderData = orderData;
      modalProductData = productData;
      modalEffectiveQuantity = effectiveQuantity;
      modalCompletionDate = completionDate;
      modalOrderNumber = orderNumber;

      // Fetch all products for the dropdown
      const { data: products, error } = await supabase
        .from('Products')
        .select('ProductSKU, Name')
        .order('ProductSKU');
      
      if (!error && products) {
        allProducts = products;
      }

      // Add initial row with the ordered SKU
      document.getElementById('skuRowsContainer').innerHTML = '';
      addSkuRow(orderData.ProductSKU, effectiveQuantity);
      
      document.getElementById('quantityModal').style.display = 'block';
    }

    function closeQuantityModal() {
      document.getElementById('quantityModal').style.display = 'none';
    }

    function addSkuRow(defaultSku = '', defaultQuantity = '') {
      const container = document.getElementById('skuRowsContainer');
      const rowId = `skuRow_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      
      const rowDiv = document.createElement('div');
      rowDiv.className = 'sku-row';
      rowDiv.id = rowId;
      
      // Create SKU dropdown
      const skuSelect = document.createElement('select');
      skuSelect.className = 'sku-select';
      skuSelect.innerHTML = '<option value="">Select SKU</option>';
      allProducts.forEach(product => {
        const option = document.createElement('option');
        option.value = product.ProductSKU;
        option.textContent = `${product.ProductSKU} - ${product.Name}`;
        if (product.ProductSKU === defaultSku) {
          option.selected = true;
        }
        skuSelect.appendChild(option);
      });
      
      // Create quantity input
      const quantityInput = document.createElement('input');
      quantityInput.type = 'number';
      quantityInput.min = '0';
      quantityInput.placeholder = 'Quantity';
      quantityInput.className = 'quantity-input';
      quantityInput.value = defaultQuantity;
      
      // Create remove button
      const removeBtn = document.createElement('button');
      removeBtn.textContent = '×';
      removeBtn.title = 'Remove';
      removeBtn.onclick = () => {
        // Don't allow removing the last row
        if (container.children.length > 1) {
          rowDiv.remove();
        } else {
          alert('You must have at least one SKU entry.');
        }
      };
      
      rowDiv.appendChild(skuSelect);
      rowDiv.appendChild(quantityInput);
      rowDiv.appendChild(removeBtn);
      container.appendChild(rowDiv);
    }

    async function submitQuantities() {
      const rows = document.querySelectorAll('.sku-row');
      const skuQuantities = [];
      let totalQuantity = 0;
      
      // Validate and collect data
      for (const row of rows) {
        const sku = row.querySelector('.sku-select').value;
        const quantity = parseInt(row.querySelector('.quantity-input').value);
        
        if (!sku) {
          alert('Please select a SKU for all rows.');
          return;
        }
        
        if (isNaN(quantity) || quantity < 0) {
          alert('Please enter a valid quantity for all rows.');
          return;
        }
        
        skuQuantities.push({ sku, quantity });
        totalQuantity += quantity;
      }
      
      if (skuQuantities.length === 0) {
        alert('Please add at least one SKU entry.');
        return;
      }

      closeQuantityModal();

      // Check if total quantity is less than ordered quantity
      if (totalQuantity < modalEffectiveQuantity) {
        if (confirm(`Total quantity made (${totalQuantity}) is less than the ordered quantity (${modalEffectiveQuantity}). If you will be making the remaining product for this order again press "OK"`)) {
          // Create a new manufacturing task for the remaining quantity
          await supabase
            .from('ManufacturingTasks')
            .insert({ 
              ProductSKU: modalOrderData.ProductSKU, 
              Customer: modalOrderData.Customer, 
              UserID: modalOrderData.UserID, 
              Quantity: modalEffectiveQuantity - totalQuantity, 
              Progress: 'requested' 
            });
        }
      }

      // Check for quantity discrepancy
      if (totalQuantity !== modalEffectiveQuantity) {
        const { data: userRow, error } = await supabase
          .from('Users')
          .select('Alerts')
          .eq('id', "bc4441d2-38e8-4e77-afb4-2609ec6f56f6")
          .maybeSingle();
        
        let alertsArr = [];
        if (!error && userRow && Array.isArray(userRow.Alerts)) {
          alertsArr = userRow.Alerts;
        }
        alertsArr.push(`${new Date().toLocaleString()}: Quantity discrepancy detected. Manufactured ${totalQuantity} for order ${modalOrderNumber}, which differs from the ordered quantity of ${modalEffectiveQuantity}. SKUs made: ${skuQuantities.map(sq => `${sq.sku}(${sq.quantity})`).join(', ')}`);
        
        await supabase
          .from('Users')
          .update({ Alerts: alertsArr })
          .eq('id', "bc4441d2-38e8-4e77-afb4-2609ec6f56f6");
      }

      // Mark the original manufacturing task as completed
      await supabase
        .from('ManufacturingTasks')
        .update({ Progress: 'Completed', CompletionDate: modalCompletionDate })
        .eq('OrderNumber', modalOrderNumber);

      // Update inventory for each SKU
      for (const { sku, quantity } of skuQuantities) {
        // Fetch current product data
        const { data: currentProductData, error: productError } = await supabase
          .from('Products')
          .select('Quantity')
          .eq('ProductSKU', sku)
          .single();
        
        if (!productError && currentProductData) {
          // Update product inventory
          await supabase
            .from('Products')
            .update({ 
              LastBatch: modalCompletionDate, 
              LastBatchNumber: modalOrderNumber, 
              Quantity: currentProductData.Quantity + quantity
            })
            .eq('ProductSKU', sku);
          
          // Log inventory change
          await supabase
            .from('inventoryupdatelogs')
            .insert({ 
              created_at: new Date(), 
              log: `Completed manufacturing order ${modalOrderNumber} for product ${sku}, added ${quantity} to inventory.`,
              updated_by: window.CurrentUserDisplayName, 
              SKU: sku,
              QuantityChanged: quantity
            });
        }
      }

      console.log('Manufacturing completed for order', modalOrderNumber);
      window.location.href = 'Manufacturing.html';
    }

    // Unit Conversion Calculator
    const conversions = {
      weight: {
        units: { 'lb': 'Pounds', 'kg': 'Kilograms', 'oz': 'Ounces', 'g': 'Grams' },
        toGrams: { 'lb': 453.592, 'kg': 1000, 'oz': 28.3495, 'g': 1 }
      },
      volume: {
        units: { 'fl oz': 'Fluid Ounces', 'ml': 'Milliliters', 'cups': 'Cups', 'L': 'Liters' },
        toMl: { 'fl oz': 29.5735, 'ml': 1, 'cups': 236.588, 'L': 1000 }
      },
      length: {
        units: { 'in': 'Inches', 'cm': 'Centimeters', 'ft': 'Feet', 'm': 'Meters' },
        toCm: { 'in': 2.54, 'cm': 1, 'ft': 30.48, 'm': 100 }
      },
      temperature: {
        units: { 'F': 'Fahrenheit', 'C': 'Celsius' }
      }
    };

    function populateUnits() {
      const conversionType = document.getElementById('conversionType').value;
      const fromUnit = document.getElementById('fromUnit');
      const toUnit = document.getElementById('toUnit');
      
      fromUnit.innerHTML = '';
      toUnit.innerHTML = '';
      
      const units = conversions[conversionType].units;
      Object.keys(units).forEach(unit => {
        const option1 = document.createElement('option');
        option1.value = unit;
        option1.textContent = `${unit} (${units[unit]})`;
        fromUnit.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = unit;
        option2.textContent = `${unit} (${units[unit]})`;
        toUnit.appendChild(option2);
      });
      
      // Set different default selections
      if (toUnit.children.length > 1) {
        toUnit.selectedIndex = 1;
      }
    }

    function convertUnits() {
      const conversionType = document.getElementById('conversionType').value;
      const fromValue = parseFloat(document.getElementById('fromValue').value);
      const fromUnit = document.getElementById('fromUnit').value;
      const toUnit = document.getElementById('toUnit').value;
      
      if (isNaN(fromValue)) {
        alert('Please enter a valid number');
        return;
      }
      
      let result;
      
      if (conversionType === 'temperature') {
        if (fromUnit === 'F' && toUnit === 'C') {
          result = (fromValue - 32) * 5/9;
        } else if (fromUnit === 'C' && toUnit === 'F') {
          result = (fromValue * 9/5) + 32;
        } else {
          result = fromValue; // Same unit
        }
      } else {
        const conversionData = conversions[conversionType];
        const baseUnitKey = Object.keys(conversionData)[1]; // toGrams, toMl, toCm
        const baseUnit = conversionData[baseUnitKey];
        
        // Convert to base unit first, then to target unit
        const baseValue = fromValue * baseUnit[fromUnit];
        result = baseValue / baseUnit[toUnit];
      }
      
      document.getElementById('toValue').value = result.toFixed(4);
      
      const resultDiv = document.getElementById('conversionResult');
      const resultText = document.getElementById('resultText');
      resultText.textContent = `${fromValue} ${fromUnit} = ${result.toFixed(4)} ${toUnit}`;
      resultDiv.style.display = 'block';
    }

    // Calculator Modal Event Listeners
    document.getElementById('openCalculatorBtn').addEventListener('click', () => {
      document.getElementById('calculatorModal').style.display = 'flex';
      populateUnits();
    });

    document.getElementById('closeCalculatorBtn').addEventListener('click', () => {
      document.getElementById('calculatorModal').style.display = 'none';
    });

    document.getElementById('calculatorModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('calculatorModal')) {
        document.getElementById('calculatorModal').style.display = 'none';
      }
    });

    document.getElementById('conversionType').addEventListener('change', populateUnits);
    document.getElementById('fromUnit').addEventListener('change', convertUnits);
    document.getElementById('toUnit').addEventListener('change', convertUnits);
    document.getElementById('fromValue').addEventListener('input', convertUnits);
    document.getElementById('convertBtn').addEventListener('click', convertUnits);
  </script>
</body>
</html>
