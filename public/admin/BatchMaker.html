<!DOCTYPE html>
<html>
<head>
  <title>Batch Maker - Ingredient Subtraction</title>
  <link rel="stylesheet" href="https://unpkg.com/@coreui/icons/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #c1de9f 0%, #4dba93 100%);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      color: #333;
    }
    
    /* Sidebar Styles */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 60px;
      height: 100vh;
      background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
      color: white;
      z-index: 1000;
      transition: width 0.3s ease;
      overflow-x: hidden;
      overflow-y: hidden;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }
    
    .sidebar:hover {
      width: 250px;
    }
    
    .sidebar-header {
      padding-top: 0.75rem;
      border-bottom: 1px solid #34495e;
      text-align: center;
      white-space: nowrap;
    }
    
    .sidebar-header h2 {
      margin: 0;
      font-size: 1rem;
      color: #ecf0f1;
      opacity: 1;
      transition: opacity 0.3s ease;
    }
    
    .sidebar:not(:hover) .sidebar-header h2 {
      opacity: 0;
    }
    
    .sidebar:hover .sidebar-header h2 {
      font-size: 1.3rem;
    }
    
    .sidebar-nav {
      padding: 0.5rem 0;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      color: #ecf0f1;
      text-decoration: none;
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
      white-space: nowrap;
    }
    
    .nav-item:hover {
      background: rgba(255,255,255,0.1);
      border-left-color: #4DBA93;
      color: white;
    }
    
    .nav-item.active {
      background: rgba(77,186,147,0.2);
      border-left-color: #4DBA93;
      color: white;
    }
    
    .nav-item i {
      margin-right: 0.5rem;
      width: 20px;
      text-align: center;
      flex-shrink: 0;
    }
    
    .nav-item span {
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .sidebar:hover .nav-item span {
      opacity: 1;
    }
    
    .sidebar:hover .nav-item {
      padding: 0.75rem 1.5rem;
    }
    
    /* Main content adjustments */
    .main-content {
      margin-left: 60px;
      transition: margin-left 0.3s ease;
      width: calc(100% - 60px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
    }
    h1 {
      color: indigo;
      margin-top: 2rem;
      margin-bottom: 1rem;
      font-size: 2.5rem;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      text-align: center;
    }
    #main-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 2rem 2.5rem 2.5rem 2.5rem;
      margin-top: 3rem;
      width: 100%;
      max-width: 1200px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .form-group {
      margin: 1rem 0;
      width: 100%;
      max-width: 400px;
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #2c3e50;
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 0.75rem;
      border-radius: 6px;
      border: 2px solid #e1e5e9;
      background: #f1f5f9;
      font-size: 1rem;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }
    input[type="text"]:focus, input[type="number"]:focus {
      outline: none;
      border-color: #4DBA93;
      background: #fff;
    }
    button {
      background: #4DBA93;
      color: white;
      border: none;
      padding: 0.75rem 2rem;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      margin: 1rem 0;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    #output {
      margin-top: 1.5rem;
      background: white;
      border: 1px solid #e1e5e9;
      border-radius: 12px;
      padding: 1rem;
      width: 100%;
      min-height: 60px;
      max-width: 1100px;
      color: #333;
      font-size: 1rem;
      white-space: pre-line;
      box-sizing: border-box;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .success {
      color: #27ae60;
      font-weight: 600;
    }
    .error {
      color: #e74c3c;
      font-weight: 600;
    }
    .info {
      color: #4DBA93;
      font-weight: 600;
    }
    
    /* Modal styles for adding missing ingredients */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 2rem;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    
    .modal-header {
      margin-bottom: 1.5rem;
      color: #2c3e50;
      font-size: 1.2rem;
      font-weight: 600;
    }
    
    .modal-form-group {
      margin: 1rem 0;
    }
    
    .modal-form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #2c3e50;
    }
    
    .modal-form-group input {
      width: 100%;
      padding: 0.75rem;
      border-radius: 6px;
      border: 2px solid #e1e5e9;
      background: #f1f5f9;
      font-size: 1rem;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }
    
    .modal-form-group input:focus {
      outline: none;
      border-color: #4DBA93;
    }
    
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 2rem;
    }
    
    .modal-btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .modal-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }
    
    .modal-btn-cancel {
      background: #6b7280;
      color: white;
    }
    
    .modal-btn-save {
      background: #4DBA93;
      color: white;
    }
    
    .add-ingredient-btn {
      background: #f59e0b;
      color: white;
      border: none;
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      margin-left: 1rem;
    }
    
    .add-ingredient-btn:hover {
      background: #d97706;
    }
    
    /* Ingredient dropdown styles */
    .ingredient-dropdown-container {
      position: relative;
      width: 100%;
    }
    
    .ingredient-search {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      background: #f1f5f9;
      font-size: 1rem;
      box-sizing: border-box;
    }
    
    .ingredient-search:focus {
      outline: none;
      border-color: #4DBA93;
      background: #fff;
    }
    
    .ingredient-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #cbd5e1;
      border-top: none;
      border-radius: 0 0 6px 6px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1001;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .ingredient-dropdown div {
      padding: 0.5rem;
      cursor: pointer;
      border-bottom: 1px solid #e5e7eb;
      transition: background-color 0.2s;
    }
    
    .ingredient-dropdown div:hover {
      background-color: #f3f4f6;
    }
    
    .ingredient-dropdown div:last-child {
      border-bottom: none;
    }
    
    /* Ingredient table row hover effect */
    .ingredient-row:hover {
      background-color: rgba(255, 255, 255, 0.3) !important;
    }
    @media (max-width: 600px) {
      .sidebar {
        width: 0;
        overflow: hidden;
      }
      
      .sidebar:hover {
        width: 250px;
      }
      
      .main-content {
        margin-left: 0;
        width: 100%;
      }
      
      #main-container {
        padding: 1rem;
        max-width: 98vw;
        margin-top: 1rem;
      }
      .form-group {
        max-width: 100%;
      }
      #output {
        max-width: 100%;
      }
      .modal-content {
        margin: 1% auto !important;
        max-height: 95vh !important;
        width: 98% !important;
        padding: 1rem !important;
      }
      #processJsonEditor {
        height: 40vh !important;
        min-height: 250px !important;
        font-size: 11px !important;
      }
      .modal-form-group button {
        width: 100% !important;
        margin: 0.25rem 0 !important;
      }
      /* Responsive table styles */
      table {
        font-size: 0.8rem !important;
      }
      th, td {
        padding: 0.5rem 0.25rem !important;
      }
      th:nth-child(1), td:nth-child(1) {
        min-width: 80px;
      }
      th:nth-child(2), td:nth-child(2) {
        min-width: 60px;
      }
      th:nth-child(3), td:nth-child(3) {
        min-width: 40px;
      }
      th:nth-child(4), td:nth-child(4) {
        min-width: 50px;
      }
      th:nth-child(5), td:nth-child(5) {
        min-width: 50px;
      }
      th:nth-child(6), td:nth-child(6) {
        min-width: 50px;
      }
      th:nth-child(7), td:nth-child(7) {
        min-width: 50px;
      }
      .add-ingredient-btn {
        padding: 0.2rem 0.4rem !important;
        font-size: 0.7rem !important;
      }
    }
  </style>
  <link rel="icon" href="/public/favicon.ico">
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>J&L Tools</h2>
    </div>
    <nav class="sidebar-nav">
      <a href="BatchMaker.html" class="nav-item active"><i class="cil-factory"></i><span>Batch Maker</span></a>
      <a href="OrderViewer.html" class="nav-item"><i class="cil-3d"></i><span>Order Viewer</span></a>
      <a href="OrderTracker.html" class="nav-item"><i class="cil-list"></i><span>Order Tracker</span></a>
      <a href="InventoryUpdater.html" class="nav-item"><i class="cil-chart"></i><span>Inventory Updater</span></a>
      <a href="ProductIngredientViewer.html" class="nav-item"><i class="cil-columns"></i><span>Product Ingredients</span></a>
      <a href="AddProductAdmin.html" class="nav-item"><i class="cil-note-add"></i><span>Add/Update Product</span></a>
      <a href="AddIngredient.html" class="nav-item"><i class="cil-plus"></i><span>Add/Update Ingredient</span></a>
      <a href="IncomingIngredients.html" class="nav-item"><i class="cil-truck"></i><span>Incoming Ingredients</span></a>
      <a href="Qrcode.html" class="nav-item"><i class="cil-qr-code"></i><span>QR Code Generator</span></a>
      <a href="Quoting.html" class="nav-item"><i class="cil-money"></i><span>Product Quoting</span></a>
      <a href="Invoice.html" class="nav-item"><i class="cil-dollar"></i><span>Invoice Calculator</span></a>
      <a href="DatabaseViewer.html" class="nav-item"><i class="cil-spreadsheet"></i><span>Database Viewer</span></a>
      <a href="InventoryScanner.html" class="nav-item"><i class="cil-center-focus"></i><span>Scanner</span></a>
      <a href="Calendar.html" class="nav-item"><i class="cil-calendar"></i><span>Calendar</span></a>
      <a href="/public/InventoryViewer.html" class="nav-item"><i class="cil-exit-to-app"></i><span>Exit Admin Portal</span></a>    
    </nav>
  </div>
  
  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <h1>Batch Maker</h1>
    <div id="main-container">
    <div class="form-group">
      <label>Product SKU:</label>
      <div id="productDropdown" style="position: relative; width: 100%;"></div>
    </div>
    
    <div class="form-group">
      <label for="vesselSelect">Select Vessel:</label>
      <select id="vesselSelect" style="width: 100%; padding: 0.75rem; border-radius: 6px; border: 2px solid #e1e5e9; background: #f1f5f9; font-size: 1rem; box-sizing: border-box;">
        <option value="">-- Select Vessel --</option>
        <option value="P1-30L">P1-30L</option>
        <option value="P2-30L">P2-30L</option>
        <option value="P3-30L">P3-30L</option>
        <option value="P4-30L">P4-30L</option>
        <option value="P5-30L">P5-30L</option>
        <option value="P6-100L">P6-100L</option>
      </select>
    </div>

    <div class="form-group">
      <label for="batchSize">Batch Size:</label>
      <input type="number" id="batchSize" placeholder="Enter batch size" min="1" step="1" />
    </div>
    
    <button id="previewBtn" onclick="previewBatch()">Preview Ingredients</button>
    
    <div id="output"></div>

    <!-- Modal for scheduling a batch -->
    <div id="scheduleBatchModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">Schedule Batch</div>
        <div class="modal-form-group">
          <label>Product SKU:</label>
          <input type="text" id="scheduleProductSKU" readonly />
        </div>
        <div class="modal-form-group">
          <label>Batch Size:</label>
          <input type="number" id="scheduleBatchSize" readonly />
        </div>
        <div class="modal-form-group">
          <label for="scheduleDate">Planned Manufacture Date:</label>
          <input type="date" id="scheduleDate" />
        </div>
        <div class="modal-form-group">
          <label for="scheduleVessel">Vessel:</label>
          <select id="scheduleVessel" style="width: 100%; padding: 0.75rem; border-radius: 6px; border: 2px solid #e1e5e9; background: #f1f5f9; font-size: 1rem; box-sizing: border-box;">
            <option value="">-- Select Vessel --</option>
            <option value="P1-30L">P1-30L</option>
            <option value="P2-30L">P2-30L</option>
            <option value="P3-30L">P3-30L</option>
            <option value="P4-30L">P4-30L</option>
            <option value="P5-30L">P5-30L</option>
            <option value="P6-100L">P6-100L</option>
          </select>
        </div>
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-cancel" onclick="closeScheduleBatchModal()">Cancel</button>
          <button class="modal-btn modal-btn-save" onclick="confirmScheduleBatch()">Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for adding missing ingredients -->
  <div id="addIngredientModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">Add Missing Ingredient</div>
      <div class="modal-form-group">
        <label for="modalIngredientSKU">Ingredient SKU:</label>
        <input type="text" id="modalIngredientSKU" placeholder="Enter ingredient SKU" />
      </div>
      <div class="modal-form-group">
        <label for="modalIngredientName">Ingredient Name:</label>
        <input type="text" id="modalIngredientName" placeholder="Enter ingredient name" />
      </div>
      <div class="modal-form-group">
        <label for="modalIngredientSupplier">Supplier:</label>
        <input type="text" id="modalIngredientSupplier" placeholder="Enter supplier name" />
      </div>
      <div class="modal-form-group">
        <label for="modalIngredientQuantity">Current Quantity (lbs):</label>
        <input type="number" id="modalIngredientQuantity" placeholder="Enter current quantity" min="0" step="0.0001" />
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="closeAddIngredientModal()">Cancel</button>
        <button class="modal-btn modal-btn-save" onclick="saveNewIngredient()">Add Ingredient</button>
      </div>
    </div>
  </div>

  <!-- Modal for updating ingredient quantities -->
  <div id="updateQuantityModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">Update Ingredient Quantity</div>
      <div class="modal-form-group">
        <label for="updateIngredientSKU">Ingredient SKU:</label>
        <input type="text" id="updateIngredientSKU" readonly />
      </div>
      <div class="modal-form-group">
        <label for="updateIngredientName">Ingredient Name:</label>
        <input type="text" id="updateIngredientName" readonly />
      </div>
      <div class="modal-form-group">
        <label for="updateCurrentQuantity">Current Quantity (lbs):</label>
        <input type="number" id="updateCurrentQuantity" readonly />
      </div>
      <div class="modal-form-group">
        <label for="updateNewQuantity">New Quantity (lbs):</label>
        <input type="number" id="updateNewQuantity" placeholder="Enter new quantity" min="0" step="0.0001" />
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="closeUpdateQuantityModal()">Cancel</button>
        <button class="modal-btn modal-btn-save" onclick="saveUpdatedQuantity()">Update Quantity</button>
      </div>
    </div>
  </div>



  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    
    const supabaseUrl = 'https://ypvyrophqkfqwpefuigi.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlwdnlyb3BocWtmcXdwZWZ1aWdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMjQzMjAsImV4cCI6MjA2MzYwMDMyMH0.fDY3ZA-sVDoEK-_CgrgdjlUtVdH3YwULSAKjK9oFRbQ';
    const supabase = createClient(supabaseUrl, supabaseKey);
    async function checkAdmin() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = '/public/Login.html';
        return;
      }
      const { data: { user } } = await supabase.auth.getUser();
      // Adjust this check to match your Supabase user admin logic
      if (!user || !user.user_metadata || user.user_metadata.role !== 'service_role') {
        console.log(user.user_metadata);
        document.body.innerHTML = '<div style="margin:2rem;font-size:1.2rem;color:#e74c3c;text-align:center;">Access denied: Admins only</div>';
        throw new Error('Not admin');
      }
    }
    checkAdmin();
    const output = document.getElementById('output');
    const batchSizeInput = document.getElementById('batchSize');
    const previewBtn = document.getElementById('previewBtn');
    let currentIngredients = [];
    let currentProduct = null;
    let currentMissingIngredient = null;
    let allProducts = [];
    let productDropdownInstance = null;

    // Get references for vessel select
    const vesselSelect = document.getElementById('vesselSelect');

    // Fetch all ingredients for dropdowns
    async function fetchAllIngredients() {
      try {
        const { data: ingredients, error } = await supabase
          .from('Ingredients')
          .select('IngredientSKU, Name, Supplier')
          .order('Name');

        if (error) {
          console.error('Error fetching ingredients:', error);
          return [];
        }

        allIngredients = ingredients || [];
        return allIngredients;
      } catch (error) {
        console.error('Error fetching ingredients:', error);
        return [];
      }
    }

    // Fetch all products for dropdown
    async function fetchAllProducts() {
      try {
        const { data: products, error } = await supabase
          .from('Products')
          .select('ProductSKU, Name, Retailer')
          .order('ProductSKU');

        if (error) {
          console.error('Error fetching products:', error);
          allProducts = [];
          return;
        }

        allProducts = products || [];
      } catch (error) {
        console.error('Error fetching products:', error);
        allProducts = [];
      }
    }

    // Create product dropdown with search functionality
    function createProductDropdown() {
      const container = document.getElementById('productDropdown');
      if (!container) return;

      const dropdownHTML = `
        <div class="ingredient-dropdown-container" style="position: relative; width: 100%;">
          <input type="text" class="ingredient-search" placeholder="Type to search products..." 
                 style="width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 6px; background: #f1f5f9;" />
          <div class="ingredient-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #cbd5e1; border-top: none; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; z-index: 1001;">
          </div>
          <input type="hidden" class="selected-sku" value="" />
        </div>
      `;

      container.innerHTML = dropdownHTML;

      const searchInput = container.querySelector('.ingredient-search');
      const dropdown = container.querySelector('.ingredient-dropdown');
      const hiddenSKU = container.querySelector('.selected-sku');

      // Filter and display products based on search
      function updateDropdown(searchTerm = '') {
        const filtered = allProducts.filter(product => {
          const searchText = `${product.ProductSKU} ${product.Name || ''} ${product.Retailer || ''}`.toLowerCase();
          return searchText.includes(searchTerm.toLowerCase());
        });

        dropdown.innerHTML = '';
        
        filtered.slice(0, 20).forEach(product => {
          const option = document.createElement('div');
          option.style.cssText = 'padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #e5e7eb;';
          option.innerHTML = `
            <div style="font-weight: 500;">${product.ProductSKU}</div>
            <div style="font-size: 0.8rem; color: #6b7280;">
              ${product.Name || 'No Name'} | Retailer: ${product.Retailer || 'No Retailer'}
            </div>
          `;
          
          option.addEventListener('mouseenter', () => {
            option.style.backgroundColor = '#f3f4f6';
          });
          
          option.addEventListener('mouseleave', () => {
            option.style.backgroundColor = 'white';
          });
          
          option.addEventListener('click', () => {
            searchInput.value = product.ProductSKU;
            searchInput.style.backgroundColor = '#f0f9ff';
            searchInput.style.borderColor = '#3b82f6';
            hiddenSKU.value = product.ProductSKU;
            dropdown.style.display = 'none';
            
            
            // Trigger change event
            const changeEvent = new Event('change', { bubbles: true });
            hiddenSKU.dispatchEvent(changeEvent);
          });
          
          dropdown.appendChild(option);
        });

        if (filtered.length === 0) {
          dropdown.innerHTML = '<div style="padding: 0.5rem; color: #6b7280; font-style: italic;">No products found</div>';
        }
      }

      // Show dropdown when input is focused
      searchInput.addEventListener('focus', () => {
        updateDropdown(searchInput.value);
        dropdown.style.display = 'block';
      });

      // Update dropdown as user types
      searchInput.addEventListener('input', (e) => {
        searchInput.style.backgroundColor = '#f1f5f9';
        searchInput.style.borderColor = '#cbd5e1';
        updateDropdown(e.target.value);
        dropdown.style.display = 'block';
        hiddenSKU.value = ''; // Clear selection when typing
      });

      // Hide dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!container.contains(e.target)) {
          dropdown.style.display = 'none';
        }
      });

      return {
        getSKU: () => hiddenSKU.value,
        setSKU: (sku) => {
          hiddenSKU.value = sku;
          searchInput.value = sku;
        },
        clear: () => {
          searchInput.value = '';
          hiddenSKU.value = '';
        }
      };
    }

    // Create ingredient dropdown with search functionality
    function createIngredientDropdown(containerId, selectedSKU = '') {
      const container = document.getElementById(containerId);
      if (!container) return;

      // Create the dropdown HTML
      const dropdownHTML = `
        <div class="ingredient-dropdown-container" style="position: relative; width: 100%;">
          <input type="text" class="ingredient-search" placeholder="Type to search ingredients..." 
                 style="width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 6px; background: #f1f5f9;" />
          <div class="ingredient-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #cbd5e1; border-top: none; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; z-index: 1001;">
          </div>
          <input type="hidden" class="selected-sku" value="${selectedSKU}" />
        </div>
      `;

      container.innerHTML = dropdownHTML;

      const searchInput = container.querySelector('.ingredient-search');
      const dropdown = container.querySelector('.ingredient-dropdown');
      const hiddenSKU = container.querySelector('.selected-sku');

      // Set initial display value if SKU is provided
      if (selectedSKU) {
        const ingredient = allIngredients.find(ing => ing.IngredientSKU === selectedSKU);
        if (ingredient) {
          searchInput.value = `${ingredient.Name} (${ingredient.Supplier || 'No Supplier'})`;
        }
      }

      // Filter and display ingredients based on search
      function updateDropdown(searchTerm = '') {
        const filtered = allIngredients.filter(ingredient => {
          const searchText = `${ingredient.Name} ${ingredient.Supplier || ''}`.toLowerCase();
          return searchText.includes(searchTerm.toLowerCase());
        });

        dropdown.innerHTML = '';
        
        filtered.slice(0, 20).forEach(ingredient => { // Limit to 20 results
          const option = document.createElement('div');
          option.style.cssText = 'padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #e5e7eb;';
          option.innerHTML = `
            <div style="font-weight: 500;">${ingredient.Name}</div>
            <div style="font-size: 0.8rem; color: #6b7280;">SKU: ${ingredient.IngredientSKU} | Supplier: ${ingredient.Supplier || 'No Supplier'}</div>
          `;
          
          option.addEventListener('mouseenter', () => {
            option.style.backgroundColor = '#f3f4f6';
          });
          
          option.addEventListener('mouseleave', () => {
            option.style.backgroundColor = 'white';
          });
          
          option.addEventListener('click', () => {
            searchInput.value = `${ingredient.Name} (${ingredient.Supplier || 'No Supplier'})`;
            searchInput.style.backgroundColor = '#f0f9ff';
            searchInput.style.borderColor = '#3b82f6';
            hiddenSKU.value = ingredient.IngredientSKU;
            dropdown.style.display = 'none';
            
            // Special handling for modal ingredient selector
            if (containerId === 'ingredientSelectorForModal') {
              document.getElementById('modalNewIngredientSKU').value = ingredient.IngredientSKU;
              document.getElementById('modalNewIngredientName').value = ingredient.Name;
              document.getElementById('modalNewIngredientSupplier').value = ingredient.Supplier || '';
            }
            
            // Trigger change event for any listeners
            const changeEvent = new Event('change', { bubbles: true });
            hiddenSKU.dispatchEvent(changeEvent);
          });
          
          dropdown.appendChild(option);
        });

        if (filtered.length === 0) {
          dropdown.innerHTML = '<div style="padding: 0.5rem; color: #6b7280; font-style: italic;">No ingredients found</div>';
        }
      }

      // Show dropdown when input is focused
      searchInput.addEventListener('focus', () => {
        updateDropdown(searchInput.value);
        dropdown.style.display = 'block';
      });

      // Update dropdown as user types
      searchInput.addEventListener('input', (e) => {
        searchInput.style.backgroundColor = '#f1f5f9';
        searchInput.style.borderColor = '#cbd5e1';
        updateDropdown(e.target.value);
        dropdown.style.display = 'block';
        hiddenSKU.value = ''; // Clear selection when typing
      });

      // Hide dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!container.contains(e.target)) {
          dropdown.style.display = 'none';
        }
      });

      return {
        getSKU: () => hiddenSKU.value,
        setSKU: (sku) => {
          hiddenSKU.value = sku;
          const ingredient = allIngredients.find(ing => ing.IngredientSKU === sku);
          if (ingredient) {
            searchInput.value = `${ingredient.Name} (${ingredient.Supplier || 'No Supplier'})`;
          }
        },
        clear: () => {
          searchInput.value = '';
          hiddenSKU.value = '';
        }
      };
    }
    let allIngredients = []; // Cache for all ingredients data

    // Modal functions for adding missing ingredients
    async function openAddIngredientModal(ingredientSKU) {
      currentMissingIngredient = ingredientSKU;
      document.getElementById('modalIngredientSKU').value = ingredientSKU || '';
      document.getElementById('modalIngredientName').value = '';
      document.getElementById('modalIngredientSupplier').value = '';
      document.getElementById('modalIngredientQuantity').value = '';
      
      document.getElementById('addIngredientModal').style.display = 'block';
      
      // Focus on the ingredient SKU input field
      setTimeout(() => {
        document.getElementById('modalIngredientSKU').focus();
      }, 100);
    }

    function closeAddIngredientModal() {
      document.getElementById('addIngredientModal').style.display = 'none';
      currentMissingIngredient = null;
    }

    async function saveNewIngredient() {
      const sku = document.getElementById('modalIngredientSKU').value.trim();
      const name = document.getElementById('modalIngredientName').value.trim();
      const supplier = document.getElementById('modalIngredientSupplier').value.trim();
      const quantity = parseFloat(document.getElementById('modalIngredientQuantity').value);

      if (!sku) {
        alert('Please enter an ingredient SKU');
        return;
      }

      if (!name) {
        alert('Please enter an ingredient name');
        return;
      }

      if (!supplier) {
        alert('Please enter a supplier name');
        return;
      }

      if (isNaN(quantity) || quantity < 0) {
        alert('Please enter a valid quantity (0 or greater)');
        return;
      }

      try {
        // Insert the ingredient in the Ingredients table (fail if SKU exists)
        const { data, error } = await supabase
          .from('Ingredients')
          .insert([{
            'IngredientSKU': sku,
            'Name': name,
            'Supplier': supplier,
            'Quantity(Lbs/Units)': quantity
          }]);

        if (error) {
          if (error.code === '23505' || error.message.includes('duplicate')) {
            alert('An ingredient with this SKU already exists. Please use a unique SKU.');
          } else {
            alert(`Failed to add ingredient: ${error.message}`);
          }
          return;
        }

        alert('Ingredient added successfully!');
        closeAddIngredientModal();
        previewBatch();
      } catch (error) {
        alert(`Error adding ingredient: ${error.message}`);
      }
    }

    // Modal functions for updating ingredient quantities
    function openUpdateQuantityModal(ingredientSKU, ingredientName, currentQuantity) {
      document.getElementById('updateIngredientSKU').value = ingredientSKU;
      document.getElementById('updateIngredientName').value = ingredientName || 'Unknown';
      document.getElementById('updateCurrentQuantity').value = currentQuantity;
      document.getElementById('updateNewQuantity').value = '';
      document.getElementById('updateQuantityModal').style.display = 'block';
    }

    function closeUpdateQuantityModal() {
      document.getElementById('updateQuantityModal').style.display = 'none';
    }

    async function saveUpdatedQuantity() {
      const sku = document.getElementById('updateIngredientSKU').value;
      const newQuantity = parseFloat(document.getElementById('updateNewQuantity').value);

      if (isNaN(newQuantity) || newQuantity < 0) {
        alert('Please enter a valid quantity (0 or greater)');
        return;
      }

      try {
        // Update the ingredient quantity in the Ingredients table
        const { error } = await supabase
          .from('Ingredients')
          .update({ 'Quantity(Lbs/Units)': newQuantity })
          .eq('IngredientSKU', sku);

        if (error) {
          alert(`Failed to update ingredient quantity: ${error.message}`);
          return;
        }

        alert(`✅ Successfully updated quantity for ${sku}`);
        closeUpdateQuantityModal();
        
        // Refresh the preview to show the updated quantity
        previewBatch();

      } catch (error) {
        alert(`Error updating ingredient quantity: ${error.message}`);
      }
    }



    function parseProcessIngredients(processData, batchSize, productSizeLbs) {
      if (!processData) return [];
      const processedIngredients = [];
      try {
        // Extract ingredients from all phases
        Object.keys(processData).forEach(key => {
          if (key.startsWith('Phase ') && processData[key][`${key} Ingredients`]) {
            const phaseIngredients = processData[key][`${key} Ingredients`];
            phaseIngredients.forEach(ingredient => {
              // Check for valid IngredientSKU
              if (!ingredient.IngredientSKU || ingredient.IngredientSKU === '' || ingredient.IngredientSKU === '2' || !isNaN(ingredient.IngredientSKU)) {
                console.warn('Skipping ingredient with invalid or missing SKU:', ingredient);
                return;
              }
              
              let baseAmountLbs;
              
              // Only use percentage from process JSON, product size from Products table
              if (ingredient['Ingredient Quantity(%)'] !== undefined) {
                const percentage = ingredient['Ingredient Quantity(%)'];
                if (isNaN(percentage) || percentage <= 0) {
                  console.warn('Skipping ingredient with invalid percentage:', ingredient);
                  return;
                }
                baseAmountLbs = 1.1 * (percentage / 100) * productSizeLbs;
              } else {
                console.warn('Ingredient missing percentage information:', ingredient);
                return; // Skip this ingredient
              }
              
              const totalAmount = baseAmountLbs * batchSize;
              
              processedIngredients.push({
                sku: ingredient.IngredientSKU,
                baseAmount: baseAmountLbs,
                totalAmount: totalAmount,
                phase: key,
                percentage: ingredient['Ingredient Quantity(%)']
              });
            });
          }
        });

        // Extract container SKUs - subtract 1 per unit of batch
        if (window.currentProductMetadata && window.currentProductMetadata.containerSkus && Array.isArray(window.currentProductMetadata.containerSkus)) {
          window.currentProductMetadata.containerSkus.forEach(containerSku => {
            if (containerSku && containerSku !== '') {
              processedIngredients.push({
                sku: containerSku,
                baseAmount: 1, // 1 container per unit
                totalAmount: batchSize, // 1 container per unit * batch size
                phase: 'Containers',
                percentage: null, // Containers don't use percentages
                isContainer: true // Flag to identify containers
              });
            }
          });
        }
        
        return processedIngredients;
        
      } catch (error) {
        console.error('Error parsing process ingredients:', error);
        return [];
      }
    }

    // Batch size choice prompt removed

    async function previewBatch() {
      const productSKU = productDropdownInstance ? productDropdownInstance.getSKU() : '';
      const batchSize = parseInt(batchSizeInput.value);
      
      if (!productSKU) {
        output.innerHTML = '<div class="error">Please enter a product SKU</div>';
        return;
      }
      
      if (!batchSize || batchSize < 1) {
        output.innerHTML = '<div class="error">Please enter a valid batch size (minimum 1)</div>';
        return;
      }

      output.innerHTML = '<div class="info">Loading product information...</div>';
      previewBtn.disabled = true;

      try {
        // Fetch product information including Product Weight(oz)
        const { data: product, error: productError } = await supabase
          .from('Products')
          .select('Process, Name, "Product Weight(oz)"')
          .eq('ProductSKU', productSKU)
          .single();

        if (productError || !product) {
          output.innerHTML = `<div class="error">Product with SKU \"${productSKU}\" not found</div>`;
          previewBtn.disabled = false;
          return;
        }

        if (!product.Process) {
          output.innerHTML = `
            <div class="error">Product \"${productSKU}\" has no process specified</div>
            <a href="AddProductAdmin.html" style="display: inline-block; background: #4DBA93; color: white; padding: 0.5rem 1rem; text-decoration: none; border-radius: 4px; margin-top: 0.5rem;">Add Product Process</a>
          `;
          previewBtn.disabled = false;
          return;
        }


        // Convert Product Weight(oz) to lbs
        const productSizeOz = Number(product['Product Weight(oz)']) || 0;
        const productSizeLbs = productSizeOz / 16;
        currentProduct = {
          ...product,
          ProductSKU: productSKU
        };
        currentIngredients = parseProcessIngredients(product.Process, batchSize, productSizeLbs);

        if (currentIngredients.length === 0) {
          output.innerHTML = `
            <div class="error">No valid ingredients found in process. Please check the Process JSON format.</div>
            <a href="AddProductAdmin.html" style="display: inline-block; background: #4DBA93; color: white; padding: 0.5rem 1rem; text-decoration: none; border-radius: 4px; margin-top: 0.5rem;">Add Product Process</a>
          `;
          previewBtn.disabled = false;
          return;
        }        // Fetch current quantities for all ingredients from the ingredients table
        const ingredientSKUs = currentIngredients.map(ing => ing.sku);
        const { data: ingredientData, error: ingredientError } = await supabase
          .from('Ingredients')
          .select('IngredientSKU, Name, Supplier, "Quantity(Lbs/Units)", LowInvThreshold')
          .in('IngredientSKU', ingredientSKUs);

        if (ingredientError) {
          output.innerHTML = `<div class="error">Error fetching ingredient data: ${ingredientError.message}</div>`;
          previewBtn.disabled = false;
          return;
        }

        // Create a map of ingredient data
        const ingredientMap = new Map();
        ingredientData.forEach(ing => {
          ingredientMap.set(ing.IngredientSKU, ing);
        });

        // Generate preview with batch card table format
        let previewHTML = `
          <div style="background: linear-gradient(135deg, #c1de9f 0%, #4dba93 100%); color: white; padding: 1.5rem; border-radius: 12px; margin: 1rem 0; box-shadow: 0 4px 12px rgba(0,0,0,0.15); text-align: center;">
            <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700; letter-spacing: 1px;">📋 BATCH CARD</h2>
            <p style="margin: 0.5rem 0 0 0; font-size: 1.1rem; opacity: 0.9;">${batchSize} unit(s) of ${product.Name || productSKU}</p>
          </div>
        `;



        let canMakeBatch = true;
        let missingIngredients = [];
        let potentialLowInventoryWarnings = [];

        // Group ingredients by phase
        const ingredientsByPhase = new Map();
        currentIngredients.forEach(ingredient => {
          const phase = ingredient.phase || 'Phase 1';
          if (!ingredientsByPhase.has(phase)) {
            ingredientsByPhase.set(phase, []);
          }
          ingredientsByPhase.get(phase).push(ingredient);
        });

        // Sort phases - numbered phases first, then custom phases alphabetically
        const sortedPhases = Array.from(ingredientsByPhase.keys()).sort((a, b) => {
          const aIsNumbered = /^Phase \d+$/.test(a);
          const bIsNumbered = /^Phase \d+$/.test(b);
          
          if (aIsNumbered && bIsNumbered) {
            // Both are numbered phases, sort numerically
            const numA = parseInt(a.replace('Phase ', ''));
            const numB = parseInt(b.replace('Phase ', ''));
            return numA - numB;
          } else if (aIsNumbered && !bIsNumbered) {
            // Numbered phases come first
            return -1;
          } else if (!aIsNumbered && bIsNumbered) {
            // Numbered phases come first
            return 1;
          } else {
            // Both are custom phases, sort alphabetically
            return a.localeCompare(b);
          }
        });

        // Generate color for each phase
        const phaseColors = [
          '#bbdefb', // Darker blue
          '#e1bee7', // Darker purple
          '#c8e6c9', // Darker green
          '#ffe0b2', // Darker orange
          '#f8bbd9', // Darker pink
          '#dcedc8', // Darker lime
          '#b2dfdb', // Darker teal
          '#fff9c4'  // Darker yellow
        ];

        for (let phaseIndex = 0; phaseIndex < sortedPhases.length; phaseIndex++) {
          const phase = sortedPhases[phaseIndex];
          const ingredients = ingredientsByPhase.get(phase);
          const phaseColor = phaseColors[phaseIndex % phaseColors.length];
          
          previewHTML += `
            <div style="background: transparent; border: none; border-radius: 12px; margin: 0.1rem 0; padding: 0; box-shadow: none; overflow: hidden;">
              <table style="width: 100%; border-collapse: collapse; background: ${phaseColor}; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <thead>
                  <tr style="background: linear-gradient(135deg, #c1de9f 0%, #4dba93 100%); color: white;">
                    <th style="padding: 1rem 0.75rem; text-align: left; font-weight: 600; font-size: 0.9rem; letter-spacing: 0.5px;">Ingredient Name</th>
                    <th style="padding: 1rem 0.75rem; text-align: left; font-weight: 600; font-size: 0.9rem; letter-spacing: 0.5px;">SKU</th>
                    <th style="padding: 1rem 0.75rem; text-align: center; font-weight: 600; font-size: 0.9rem; letter-spacing: 0.5px;">%</th>
                    <th style="padding: 1rem 0.75rem; text-align: center; font-weight: 600; font-size: 0.9rem; letter-spacing: 0.5px;">Required</th>
                    <th style="padding: 1rem 0.75rem; text-align: center; font-weight: 600; font-size: 0.9rem; letter-spacing: 0.5px;">Available</th>
                    <th style="padding: 1rem 0.75rem; text-align: center; font-weight: 600; font-size: 0.9rem; letter-spacing: 0.5px;">Status</th>
                    <th style="padding: 1rem 0.75rem; text-align: center; font-weight: 600; font-size: 0.9rem; letter-spacing: 0.5px;">Action</th>
                  </tr>
                </thead>
                <tbody>
          `;

          for (let ingredient of ingredients) {
            const ingredientInfo = ingredientMap.get(ingredient.sku);
            const isContainer = ingredient.isContainer || false;
            
            if (!ingredientInfo) {
              previewHTML += `
                <tr style="border-bottom: 1px solid #e2e8f0; transition: background-color 0.2s ease;" class="ingredient-row">
                  <td style="padding: 1rem 0.75rem; color: #dc3545; font-weight: 500; border-right: 1px solid #f1f5f9;">NOT FOUND</td>
                  <td style="padding: 1rem 0.75rem; color: #dc3545; font-weight: 500; font-family: 'Courier New', monospace; font-size: 0.9rem; border-right: 1px solid #f1f5f9;">${ingredient.sku}</td>
                  <td style="padding: 1rem 0.75rem; text-align: center; font-weight: 500; border-right: 1px solid #f1f5f9;">${isContainer ? '1 per unit' : (ingredient.percentage || 'N/A') + '%'}</td>
                  <td style="padding: 1rem 0.75rem; text-align: center; font-weight: 500; border-right: 1px solid #f1f5f9;">${isContainer ? ingredient.totalAmount + ' units' : ingredient.totalAmount.toFixed(4) + ' lbs'}</td>
                  <td style="padding: 1rem 0.75rem; text-align: center; color: #dc3545; font-weight: 500; border-right: 1px solid #f1f5f9;">N/A</td>
                  <td style="padding: 1rem 0.75rem; text-align: center; border-right: 1px solid #f1f5f9;">
                    <span style="background: #dc3545; color: white; padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; box-shadow: 0 2px 4px rgba(220,53,69,0.3);">❌ MISSING</span>
                  </td>
                  <td style="padding: 1rem 0.75rem; text-align: center;">
                    <button class="add-ingredient-btn" onclick="openAddIngredientModal('${ingredient.sku}')" style="margin: 0; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">Add</button>
                  </td>
                </tr>
              `;
              canMakeBatch = false;
              missingIngredients.push(ingredient.sku);
            } else {
              const available = ingredientInfo['Quantity(Lbs/Units)'] || 0;
              const lowThreshold = ingredientInfo.LowInvThreshold || 0;
              const newQtyAfterBatch = available - ingredient.totalAmount;
              const sufficient = available >= ingredient.totalAmount;
              const statusBg = sufficient ? '#28a745' : '#dc3545';
              const statusText = sufficient ? '✅ OK' : '❌ LOW';
              
              // Check if this ingredient will be below threshold after batch
              if (sufficient && newQtyAfterBatch < lowThreshold && lowThreshold > 0) {
                potentialLowInventoryWarnings.push({
                  sku: ingredient.sku,
                  name: ingredientInfo.Name || ingredient.sku,
                  currentQty: available,
                  afterBatchQty: newQtyAfterBatch,
                  threshold: lowThreshold
                });
              }
              
              const nameStyle = isContainer ? 'font-weight: 500; font-style: italic; color: #6f42c1;' : 'font-weight: 500;';
              const quantityDisplay = isContainer ? ingredient.totalAmount + ' units' : ingredient.totalAmount.toFixed(4) + ' lbs';
              const availableDisplay = isContainer ? Math.floor(available) + ' units' : available.toFixed(4) + ' lbs';
              const percentageDisplay = isContainer ? '1 per unit' : (ingredient.percentage || 'N/A') + '%';
              
              previewHTML += `
                <tr style="border-bottom: 1px solid #e2e8f0; transition: background-color 0.2s ease;" class="ingredient-row">
                  <td style="padding: 1rem 0.75rem; ${nameStyle} border-right: 1px solid #f1f5f9;">${isContainer ? '📦 ' : ''}${ingredientInfo.Name || 'Unknown'}${isContainer ? ' (Container)' : ''}</td>
                  <td style="padding: 1rem 0.75rem; font-family: 'Courier New', monospace; font-size: 0.9rem; color: #4a5568; border-right: 1px solid #f1f5f9;">${ingredient.sku}</td>
                  <td style="padding: 1rem 0.75rem; text-align: center; font-weight: 600; color: #2d3748; border-right: 1px solid #f1f5f9;">${percentageDisplay}</td>
                  <td style="padding: 1rem 0.75rem; text-align: center; font-weight: 600; color: #2d3748; border-right: 1px solid #f1f5f9;">${quantityDisplay}</td>
                  <td style="padding: 1rem 0.75rem; text-align: center; ${sufficient ? 'color: #38a169;' : 'color: #e53e3e;'} font-weight: 600; border-right: 1px solid #f1f5f9;">${availableDisplay}</td>
                  <td style="padding: 1rem 0.75rem; text-align: center; border-right: 1px solid #f1f5f9;">
                    <span style="background: ${statusBg}; color: white; padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; box-shadow: 0 2px 4px rgba(${sufficient ? '40,167,69' : '220,53,69'},0.3);">${statusText}</span>
                  </td>
                  <td style="padding: 1rem 0.75rem; text-align: center;">
                    ${sufficient ? 
                      '<span style="color: #38a169; font-size: 0.9rem; font-weight: 600;">✓ Ready</span>' : 
                      `<button class="add-ingredient-btn" onclick="openUpdateQuantityModal('${ingredient.sku}', '${ingredientInfo.Name || 'Unknown'}', ${available})" style="margin: 0; padding: 0.4rem 0.8rem; font-size: 0.8rem; border-radius: 6px; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">Update</button>`
                    }
                  </td>
                </tr>
              `;
              
              if (!sufficient) {
                canMakeBatch = false;
              }
            }
          }

          previewHTML += `
                </tbody>
              </table>
            </div>
          `;
        }

        // Add potential low inventory warnings to preview
        if (potentialLowInventoryWarnings.length > 0) {
          previewHTML += `
            <div style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); color: white; padding: 1.5rem; border-radius: 12px; margin: 1.5rem 0; box-shadow: 0 4px 12px rgba(237,137,54,0.3);">
              <h3 style="margin: 0 0 1rem 0; font-size: 1.2rem; font-weight: 700;">⚠️ LOW INVENTORY WARNING (After Batch)</h3>
              <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                ${potentialLowInventoryWarnings.map(warning => 
                  `<div style="margin: 0.5rem 0; padding: 0.5rem; background: rgba(255,255,255,0.1); border-radius: 6px;">
                    <strong>${warning.name}</strong> (${warning.sku})<br>
                    <small>Will drop from ${warning.currentQty} to ${warning.afterBatchQty.toFixed(4)} (below threshold ${warning.threshold})</small>
                  </div>`
                ).join('')}
              </div>
              <p style="margin: 1rem 0 0 0; font-size: 0.9rem; opacity: 0.9; font-style: italic;">These ingredients may need restocking after this batch.</p>
            </div>
          `;
        }

        if (canMakeBatch) {
          previewHTML += `
            <div style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; padding: 1.5rem; border-radius: 12px; margin: 1.5rem 0; text-align: center; box-shadow: 0 4px 12px rgba(72,187,120,0.3);">
              <h3 style="margin: 0; font-size: 1.3rem; font-weight: 700;">✅ ALL INGREDIENTS AVAILABLE!</h3>
              <p style="margin: 0.5rem 0 0 0; font-size: 1rem; opacity: 0.9;">Ready to make batch</p>
            </div>
          `;
          
          // Add Make Batch and Schedule Batch buttons with OR separator
          previewHTML += `
            <div style="display: flex; align-items: center; justify-content: center; gap: 1.5rem; margin: 1rem 0;">
              <button onclick="makeBatch()" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; border: none; padding: 1rem 2rem; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(72,187,120,0.3); transition: all 0.3s ease;">Make Batch</button>
              <span style="font-weight: 600; color: #888;">-----or-----</span>
              <button onclick="openScheduleBatchModal()" style="background: linear-gradient(135deg, #4dbad5 0%, #1976d2 100%); color: white; border: none; padding: 1rem 2rem; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(77,186,213,0.3); transition: all 0.3s ease;">Schedule Batch</button>
            </div>
          `;

    // Schedule Batch Modal logic

    // Helper: get all vessel options
    const ALL_VESSELS = [
      'P1-30L',
      'P2-30L',
      'P3-30L',
      'P4-30L',
      'P5-30L',
      'P6-100L'
    ];

    // Helper: fetch vessels already scheduled for a date
    async function getUnavailableVesselsForDate(date) {
      if (!date) return [];
      try {
        const { data, error } = await supabase
          .from('ManufacturingTasks')
          .select('Vessel')
          .eq('PlannedManufactureDate', date);
        if (error) return [];
        return (data || []).map(row => row.Vessel).filter(Boolean);
      } catch (e) {
        return [];
      }
    }

    // Helper: update vessel select options based on date
    async function updateScheduleVesselOptions() {
      const date = document.getElementById('scheduleDate').value;
      const select = document.getElementById('scheduleVessel');
      if (!select) return;
      select.innerHTML = '<option value="">-- Select Vessel --</option>';
      if (!date) {
        ALL_VESSELS.forEach(v => {
          select.innerHTML += `<option value="${v}">${v}</option>`;
        });
        return;
      }
      const unavailable = await getUnavailableVesselsForDate(date);
      const available = ALL_VESSELS.filter(v => !unavailable.includes(v));
      available.forEach(v => {
        select.innerHTML += `<option value="${v}">${v}</option>`;
      });
    }

    window.openScheduleBatchModal = async function() {
      const sku = productDropdownInstance ? productDropdownInstance.getSKU() : '';
      const batchSize = parseInt(batchSizeInput.value);
      document.getElementById('scheduleProductSKU').value = sku;
      document.getElementById('scheduleBatchSize').value = batchSize;
      document.getElementById('scheduleDate').value = '';
      await updateScheduleVesselOptions();
      document.getElementById('scheduleBatchModal').style.display = 'block';
      // Add event listener for date change to update vessels
      const dateInput = document.getElementById('scheduleDate');
      if (dateInput && !dateInput._vesselListenerAdded) {
        dateInput.addEventListener('change', updateScheduleVesselOptions);
        dateInput._vesselListenerAdded = true;
      }
    };

    window.closeScheduleBatchModal = function() {
      document.getElementById('scheduleBatchModal').style.display = 'none';
    };

    window.confirmScheduleBatch = async function() {
      const sku = document.getElementById('scheduleProductSKU').value;
      const batchSize = parseInt(document.getElementById('scheduleBatchSize').value);
      const vessel = document.getElementById('scheduleVessel').value;
      const date = document.getElementById('scheduleDate').value;
      if (!sku || !batchSize || !vessel || !date) {
        alert('Please ensure all fields are filled out.');
        return;
      }
      try {
        const { error } = await supabase
          .from('ManufacturingTasks')
          .insert([
            {
              'ProductSKU': sku,
              'Quantity': batchSize,
              'PlannedManufactureDate': date,
              'Vessel': vessel
            }
          ]);
        if (error) {
          alert('Failed to schedule batch: ' + error.message);
        } else {
          alert('Batch scheduled successfully!');
          closeScheduleBatchModal();
          setTimeout(() => { location.reload(); }, 300);
        }
      } catch (err) {
        alert('Error scheduling batch: ' + err.message);
      }
    };
        } else {
          previewHTML += `
            <div style="background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%); color: white; padding: 1.5rem; border-radius: 12px; margin: 1.5rem 0; text-align: center; box-shadow: 0 4px 12px rgba(245,101,101,0.3);">
              <h3 style="margin: 0; font-size: 1.3rem; font-weight: 700;">❌ CANNOT MAKE BATCH</h3>
              <p style="margin: 0.5rem 0 0 0; font-size: 1rem; opacity: 0.9;">Insufficient or missing ingredients</p>
            </div>
          `;
        }

        output.innerHTML = previewHTML;

      } catch (error) {
        output.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      }

      previewBtn.disabled = false;
    }

    async function makeBatch() {
      if (!currentProduct || !currentIngredients.length) {
        output.innerHTML = '<div class="error">Please preview the batch first</div>';
        return;
      }

      const batchSize = parseInt(batchSizeInput.value);
      output.innerHTML = '<div class="info">Making batch...</div>';
      previewBtn.disabled = true;

      let successCount = 0;
      let errorCount = 0;
      let results = [];

      // Declare these at the top so they're always defined
      let batchNumber = null;
      let lotNumber = null;
      let batchTimestamp = null;

      try {
        let lowInventoryWarnings = [];

        for (let ingredient of currentIngredients) {          // Fetch current quantity and threshold from ingredients table
          const { data: ingredientData, error: fetchError } = await supabase
            .from('Ingredients')
            .select('"Quantity(Lbs/Units)", Name, Supplier, LowInvThreshold')
            .eq('IngredientSKU', ingredient.sku)
            .single();

          if (fetchError || !ingredientData) {
            results.push(`<div class="error">❌ ${ingredient.sku}: Failed to fetch current quantity</div>`);
            errorCount++;
            continue;
          }

          const currentQty = ingredientData['Quantity(Lbs/Units)'] || 0;
          const newQty = currentQty - ingredient.totalAmount;
          const lowThreshold = ingredientData.LowInvThreshold || 0;

          // Update the quantity in ingredients table
          const { error: updateError } = await supabase
            .from('Ingredients')
            .update({ 'Quantity(Lbs/Units)': newQty })
            .eq('IngredientSKU', ingredient.sku);

          if (updateError) {
            results.push(`<div class="error">❌ ${ingredient.sku}: Failed to update - ${updateError.message}</div>`);
            errorCount++;
          } else {
            results.push(`<div class="success">✅ ${ingredient.sku}: ${ingredient.totalAmount} lbs/units removed (${currentQty} → ${newQty})</div>`);
            successCount++;

            // Check if new quantity is below low inventory threshold
            if (newQty < lowThreshold && lowThreshold > 0) {
              lowInventoryWarnings.push({
                sku: ingredient.sku,
                name: ingredientData.Name || ingredient.sku,
                currentQty: newQty,
                threshold: lowThreshold
              });
            }

            // Log the ingredient usage
            const logEntry = `${new Date().toISOString().substring(0, 10)},${ingredient.sku},${ingredient.totalAmount},${ingredient.isContainer ? 'CONTAINER:' : 'BATCH:'}${currentProduct.ProductSKU}:${batchSize}\n`;
            try {
              let existing = localStorage.getItem('batchlog.csv') || '';
              if (!existing.includes('Date,SKU,Quantity,Notes')) {
                existing = 'Date,SKU,Quantity,Notes\n' + existing;
              }
              existing += logEntry;
              localStorage.setItem('batchlog.csv', existing);
            } catch (e) {
              console.warn('Failed to log batch ingredient usage:', e);
            }
          }
        }

        // Add the finished product to inventory
        const { data: productData, error: productFetchError } = await supabase
          .from('Products')
          .select('Quantity')
          .eq('ProductSKU', currentProduct.ProductSKU)
          .single();

        if (!productFetchError && productData) {

          const currentProductQty = productData.Quantity || 0;
          const newProductQty = currentProductQty + batchSize;

          // Generate random lot number (6-digit number)
          batchNumber = Math.floor(100000 + Math.random() * 900000);
          batchTimestamp = new Date().toISOString();

          // Generate custom lot number with shelf life lookup
          async function generatelotNumber() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1; // 1-12
            const day = now.getDate();
            // Fetch shelf life from Products table
            let shelfLifeYears = 3; // Default fallback
            try {
              const { data: productShelfData, error: shelfError } = await supabase
                .from('Products')
                .select('ShelfLife')
                .eq('ProductSKU', currentProduct.ProductSKU)
                .single();
              if (!shelfError && productShelfData && productShelfData.ShelfLife) {
                shelfLifeYears = productShelfData.ShelfLife;
              }
            } catch (error) {
              console.warn('Failed to fetch shelf life, using default of 1 year:', error);
            }
            // Month letter (a-l for Jan-Dec)
            const monthLetters = 'abcdefghijkl';
            const monthLetter = monthLetters[month - 1];
            // 3rd digit of year (from the right, e.g., 2024 -> 2)
            const thirdDigitYear = Math.floor((year % 100) / 10);
            // Last digit of year
            const lastDigitYear = year % 10;
            // Expiration month calculation
            let expirationMonth = month;
            let expirationYear = year + shelfLifeYears; // Current year + shelf life
            if (day >= 15) {
              expirationMonth = month + 1;
              if (expirationMonth > 12) {
                expirationMonth = 1;
                expirationYear = year + shelfLifeYears + 1; // Account for month rollover
              }
            }
            // Format expiration month (01-12)
            const formattedExpMonth = expirationMonth.toString().padStart(2, '0');
            // Last 2 digits of expiration year
            const expYearLastTwo = (expirationYear % 100).toString().padStart(2, '0');
            // Combine: monthLetter + "-" + thirdDigitYear + day + lastDigitYear + expMonth + expYearLastTwo
            const lot = `${monthLetter}-${thirdDigitYear}${day.toString().padStart(2, '0')}${lastDigitYear}${formattedExpMonth}${expYearLastTwo}`;
            return lot;
          }
          lotNumber = await generatelotNumber();

          const { error: productUpdateError } = await supabase
            .from('Products')
            .update({ 
              Quantity: newProductQty,
              LastBatchNumber: batchNumber,
              LastBatch: batchTimestamp
            })
            .eq('ProductSKU', currentProduct.ProductSKU);

          if (!productUpdateError) {
            results.push(`<div class="success">✅ Added ${batchSize} unit(s) of ${currentProduct.ProductSKU} to inventory (${currentProductQty} → ${newProductQty})</div>`);
            results.push(`<div class="success">📦 Batch Number: ${batchNumber} | Lot Number: ${lotNumber} | Batch Time: ${new Date(batchTimestamp).toLocaleString()}</div>`);

            // Log the product addition with lot number
            const productLogEntry = `${new Date().toISOString().substring(0, 10)},${currentProduct.ProductSKU},${batchSize},BATCH_PRODUCTION:BATCH${batchNumber}\n`;
            try {
              let existing = localStorage.getItem('inventorylog.csv') || '';
              existing += productLogEntry;
              localStorage.setItem('inventorylog.csv', existing);
            } catch (e) {
              console.warn('Failed to log product addition:', e);
            }
          } else {
            results.push(`<div class="error">❌ Failed to add finished product to inventory: ${productUpdateError.message}</div>`);
          }
        }

        // Generate low inventory warnings if any
        let lowInventoryHTML = '';
        if (lowInventoryWarnings.length > 0) {
          lowInventoryHTML = `
            <div class="error" style="background-color: #fef3c7; border-color: #f59e0b; color: #92400e; margin: 1rem 0;">
              ⚠️ <strong>Low Inventory Warning:</strong>
              <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                ${lowInventoryWarnings.map(warning => 
                  `<li>${warning.name} (${warning.sku}): Current quantity ${warning.currentQty} is below threshold ${warning.threshold}</li>`
                ).join('')}
              </ul>
              <em>Consider restocking these ingredients soon.</em>
            </div>
          `;
        }

        const summaryHTML = `
          <div class="info">Batch completed!</div>
          <div style="margin: 1rem 0;">
            <strong>Summary:</strong> ${successCount} ingredients processed successfully, ${errorCount} errors
          </div>
          ${lowInventoryHTML}
          ${results.join('')}
        `;

        output.innerHTML = summaryHTML;



        // Clear form and redirect if successful
        if (errorCount === 0) {
          // Capture SKU before clearing currentProduct
          const sku = currentProduct.ProductSKU;
          // Clear form
          if (productDropdownInstance) {
            productDropdownInstance.clear();
          }
          batchSizeInput.value = '';
          currentIngredients = [];
          currentProduct = null;

          // Open ManufacturingInstructions in a new tab after a short delay to show completion message, robust to file location
          setTimeout(() => {
            // Get the current directory of the HTML file robustly
            let basePath = window.location.pathname;
            basePath = basePath.substring(0, basePath.lastIndexOf('/') + 1);
            const instructionsPath = basePath + 'ManufacturingInstructions.html';
            const params = new URLSearchParams({
              sku,
              batch: batchNumber,
              lot: lotNumber,
              batchtime: batchTimestamp,
              batchSize: batchSize // Pass batch size through URL
            });
            window.open((instructionsPath + '?' + params.toString()).replace("/app.asar", ""), '_blank');
          }, 1200);
        }

      } catch (error) {
        output.innerHTML = `<div class="error">Batch creation failed: ${error.message}</div>`;
      }

      previewBtn.disabled = false;
    }

    // Add download batch log functionality
    const downloadLogBtn = document.createElement('button');
    downloadLogBtn.textContent = 'Download Batch Log';
    downloadLogBtn.style.background = '#6b7280';
    downloadLogBtn.onclick = function() {
      const log = localStorage.getItem('batchlog.csv');
      if (!log) {
        output.innerHTML = '<div class="error">No batch log found.</div>';
        return;
      }
      const blob = new Blob([log], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'batchlog.csv';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
    };
    
    document.getElementById('main-container').appendChild(downloadLogBtn);

    // Helper: get URL params
    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        ProductSKU: params.get('ProductSKU') || '',
        Quantity: params.get('Quantity') || '',
        Vessel: params.get('Vessel') || ''
      };
    }

    // Initialize data and create dropdowns
    async function initializeApp() {
      await fetchAllIngredients();
      await fetchAllProducts();
      productDropdownInstance = createProductDropdown();
      // Add event listeners for vessel and product changes
      vesselSelect.addEventListener('change', autoPopulateMaxBatch);
      // Listen for product change via dropdown
      const productDropdownInput = document.querySelector('#productDropdown .ingredient-search');
      if (productDropdownInput) {
        productDropdownInput.addEventListener('change', autoPopulateMaxBatch);
      }

      // Auto-fill from URL params if present
      const params = getUrlParams();
      if (params.ProductSKU && productDropdownInstance) {
        productDropdownInstance.setSKU(params.ProductSKU);
      }
      if (params.Quantity) {
        batchSizeInput.value = params.Quantity;
      }
      if (params.Vessel) {
        // Set vessel select in main form
        if (vesselSelect) vesselSelect.value = params.Vessel;
        // Set vessel in schedule modal if open
        const scheduleVesselSelect = document.getElementById('scheduleVessel');
        if (scheduleVesselSelect) scheduleVesselSelect.value = params.Vessel;
      }
      if (params.PlannedManufactureDate) {
        // If schedule modal exists, pre-fill date
        const scheduleDateInput = document.getElementById('scheduleDate');
        if (scheduleDateInput) {
          scheduleDateInput.value = params.PlannedManufactureDate;
        }
      }
    }
    // Helper to get product size (oz) for selected product
    function getSelectedProductSizeOz() {
      const sku = productDropdownInstance ? productDropdownInstance.getSKU() : '';
      if (!sku) return null;
      const product = allProducts.find(p => p.ProductSKU === sku);
      if (!product) return null;
      // Try to get Product Weight(oz) from allProducts (may be missing if not selected in fetchAllProducts)
      if (product['Product Weight(oz)']) return Number(product['Product Weight(oz)']);
      // If not present, fallback to fetching from DB (async, not used here)
      return null;
    }

    // Auto-populate Max Batch based on vessel and product size
    async function autoPopulateMaxBatch() {
      const vessel = vesselSelect.value;
      const sku = productDropdownInstance ? productDropdownInstance.getSKU() : '';
      if (!vessel || !sku) return;

      // Try to get product size from allProducts first
      let product = allProducts.find(p => p.ProductSKU === sku);
      let productSizeOz = null;
      if (product && product['Product Weight(oz)']) {
        productSizeOz = Number(product['Product Weight(oz)']);
      } else {
        // Fallback: fetch from DB if not present
        const { data, error } = await supabase
          .from('Products')
          .select('"Product Weight(oz)"')
          .eq('ProductSKU', sku)
          .single();
        if (data && data['Product Weight(oz)']) {
          productSizeOz = Number(data['Product Weight(oz)']);
        }
      }
      if (!productSizeOz || isNaN(productSizeOz) || productSizeOz <= 0) return;

      // Calculate max batch
      let maxBatch = 0;
      if (["P1-30L","P2-30L","P3-30L","P4-30L","P5-30L"].includes(vessel)) {
        maxBatch = (816 / productSizeOz) * 1.1;
      } else if (vessel === "P6-100L") {
        maxBatch = (2576 / productSizeOz) * 1.1;
      }
      maxBatch = Math.floor(maxBatch);
      if (maxBatch > 0) {
        batchSizeInput.value = maxBatch;
      }
    }

    initializeApp();

    // Make functions globally available
    window.previewBatch = previewBatch;
    window.makeBatch = makeBatch;
    window.openAddIngredientModal = openAddIngredientModal;
    window.closeAddIngredientModal = closeAddIngredientModal;
    window.saveNewIngredient = saveNewIngredient;
    window.openUpdateQuantityModal = openUpdateQuantityModal;
    window.closeUpdateQuantityModal = closeUpdateQuantityModal;
    window.saveUpdatedQuantity = saveUpdatedQuantity;

    // Add Enter key support
    batchSizeInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        previewBatch();
      }
    });

    // Add Enter key support for product dropdown
    document.addEventListener('keydown', function(e) {
      if (e.target.closest('#productDropdown .ingredient-search') && e.key === 'Enter') {
        batchSizeInput.focus();
      }
    });

    // Combined click-outside handler for modals
    window.addEventListener('click', function(event) {
      const addModal = document.getElementById('addIngredientModal');
      const updateModal = document.getElementById('updateQuantityModal');

      // Close modals if clicking outside
      if (event.target === addModal) {
        closeAddIngredientModal();
      } else if (event.target === updateModal) {
        closeUpdateQuantityModal();
      }
    });
  </script>
  </div>
</body>
</html>
