<!DOCTYPE html>
<html lang="en">
<head>
  <meta charfet="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Warehouse Shipments Viewer</title>
  <link rel="stylesheet" href="https://unpkg.com/@coreui/icons/css/all.min.css">
  <link rel="stylesheet" href="/Assets/sidebar.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #c1de9f 0%, #4dba93 100%);
      min-height: 100vh;
      color: #333;
      margin: 0;
      padding: 0;
      display: flex;
    }
    
    .main-content {
      margin-left: 60px;
      transition: margin-left 0.3s ease;
      width: calc(100% - 60px);
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      color: indigo;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }
    
    .controls {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn {
      background: #4DBA93;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .btn:disabled {
      background: #ccc;
      cursor: pointer;
      transform: none;
    }

    .search-box {
      flex: 1;
      min-width: 300px;
    }

    .search-box input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }

    .search-box input:focus {
      outline: none;
      border-color: #4DBA93;
    }

    .filter-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .filter-controls select {
      padding: 8px 12px;
      border: 2px solid #e1e5e9;
      border-radius: 6px;
      font-size: 14px;
    }

    .status {
      margin: 20px 0;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
    }

    .loading {
      color: #4DBA93;
      font-weight: 600;
    }

    .error {
      color: #e74c3c;
      font-weight: 600;
    }

    .success {
      color: #27ae60;
      font-weight: 600;
    }

    .shipments-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .shipments-summary {
      padding: 15px 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #e1e5e9;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .summary-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .shipments-table {
      width: 100%;
      border-collapse: collapse;
    }

    .shipments-table th,
    .shipments-table td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #e1e5e9;
    }

    .shipments-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #2c3e50;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .shipments-table tr:hover {
      background: #f8f9fa;
    }

    .sku-link {
      color: #4DBA93;
      text-decoration: none;
      font-weight: 500;
      font-family: 'Courier New', monospace;
    }

    .sku-link:hover {
      text-decoration: underline;
    }

    .quantity-badge {
      background: #c1de9f;
      color: #2c3e50;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.9rem;
      font-weight: 600;
      min-width: 40px;
      text-align: center;
    }

    .notes-cell {
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .notes-cell:hover {
      white-space: normal;
      word-wrap: break-word;
    }

    .user-name {
      font-weight: 500;
      color: #2c3e50;
    }

    .no-shipments {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .no-shipments h3 {
      margin-bottom: 10px;
      color: #2c3e50;
    }

    .action-buttons {
      background: white;
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: center;
    }

    .action-btn {
      background: #BA4D74;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .action-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }

    .action-btn.danger {
      background: #e74c3c;
    }

    .action-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .checkbox-cell {
      width: 40px;
      text-align: center;
    }

    .shipment-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .selected-row {
      background: #e8f5e8 !important;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 20px;
      border-radius: 12px;
      width: 80%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 2px solid #e1e5e9;
      padding-bottom: 15px;
    }

    .modal-header h2 {
      color: #2c3e50;
      margin: 0;
    }

    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
    }

    .close:hover {
      color: #000;
    }

    .box-selection {
      margin-bottom: 20px;
    }

    .box-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      margin-bottom: 10px;
      background: #f8f9fa;
    }

    .box-item.selected {
      border-color: #4DBA93;
      background: #e8f5e8;
    }

    .box-info {
      flex: 1;
    }

    .box-sku {
      font-weight: 600;
      color: #2c3e50;
      font-family: 'Courier New', monospace;
    }

    .box-dimensions {
      color: #666;
      font-size: 0.9rem;
    }

    .box-quantity {
      color: #4DBA93;
      font-weight: 600;
    }

    .quantity-input {
      width: 80px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      text-align: center;
    }

    .process-summary {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    /* SKU Search Styles */
    .sku-search-container {
      position: relative;
      flex: 2;
    }

    .sku-search-input {
      width: 100%;
      padding: 8px;
      border: 1.5px solid #e1e5e9;
      border-radius: 7px;
      font-size: 14px;
      transition: border-color 0.3s, box-shadow 0.3s;
      box-sizing: border-box;
    }

    .sku-search-input:focus {
      outline: none;
      border-color: #4DBA93;
      box-shadow: 0 0 0 3px rgba(77, 186, 147, 0.1);
    }

    .sku-suggestions {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 200px;
      overflow-y: auto;
      border: 2px solid #4DBA93;
      border-top: none;
      border-radius: 0 0 8px 8px;
      background: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 1000;
      animation: slideDown 0.2s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-5px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .sku-suggestion-item {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background-color 0.2s;
      font-size: 0.9em;
    }

    .sku-suggestion-item:last-child {
      border-bottom: none;
    }

    .sku-suggestion-item:hover {
      background-color: #f0f9f0;
    }

    .sku-suggestion-item strong {
      color: #4DBA93;
      font-weight: 600;
    }

    .sku-suggestion-item .sku-type {
      color: #666;
      font-size: 0.8em;
      background: #f8f9fa;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 8px;
    }

    .sku-suggestion-item .sku-name {
      color: #666;
      font-size: 0.85em;
      margin-top: 2px;
    }

    /* Retailer select styling */
    #retailerSelect:focus {
      outline: none;
      border-color: #4DBA93;
      box-shadow: 0 0 0 3px rgba(77, 186, 147, 0.1);
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <script src="/Assets/CheckAccess.js"></script>
  <script src="/Assets/IngredientUtils.js"></script>
  <link rel="icon" type="image/x-icon" href="/Assets/favicon.ico">
</head>
<body>
  <!-- Sidebar -->
  <div id="sidebar"></div>
  <script src="/Assets/sidebar.js"></script>
  
  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <div class="container">
      <div class="header">
        <h1>Warehouse Shipments Viewer</h1>
        <p>View and manage Warehouse shipment orders</p>
      </div>

      <div class="controls">        
        <button class="btn" onclick="openCreateOrderModal()" id="createOrderBtn" style="background: #4DBA93;">
          ➕ Create New Order
        </button>
        <button class="btn" onclick="openReceiveModal()" id="receiveBtn" style="background: #4DBA93;">
          ⚙️ Process Shipments
        </button>
        <button class="btn" id="markRecievedBtn" style="background: #10b981;" onclick="markSelectedAsRecieved()" disabled>Mark as Recieved</button>
        
        
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Search by SKU, user name, or notes..." 
                 oninput="filterShipments()">
        </div>
        
        <div class="filter-controls">
          <select id="userFilter" onchange="filterShipments()">
            <option value="">All Users</option>
          </select>
        </div>
      </div>

      <div class="status" id="statusDiv" style="display: none;"></div>

      <div class="action-buttons" id="actionButtons" style="display: none;">
        <span style="font-weight: 600; color: #2c3e50;">Selected Shipments:</span>
        <span id="selectedCount" style="font-weight: 600; color: #4DBA93;">0</span>
        <button title="Delete Selected Shipments" class="action-btn danger" onclick="deleteSelectedShipments()" id="deleteBtn">
          <i class="cil-trash"></i>
        </button>
      </div>

      <div class="shipments-container">
        <div class="shipments-summary" id="shipmentsSummary" style="display: none;">
          <div class="summary-item">
            <span>Total Shipments: <strong id="totalShipments">0</strong></span>
          </div>
        </div>

        <div id="shipmentsTableContainer">
          <div class="no-shipments">
            <h3>Ready to load shipments</h3>
          </div>
        </div>

          <!-- Collapsible Processed Shipments Table -->
          <div id="processedShipmentsSection" style="margin-top:32px;">
            <div style="display:flex;align-items:center;cursor:pointer;gap:10px;background:#f8f9fa;padding:12px 18px;border-radius:8px 8px 0 0;user-select:none;" onclick="toggleProcessedShipments()">
              <span id="processedCollapseArrow" style="font-size:1.3em;font-weight:bold;">&#9654;</span>
              <span style="font-size:1.1em;font-weight:600;color:#2c3e50;">Processed Shipments</span>
              <span id="processedCount" style="margin-left:8px;color:#4DBA93;font-weight:600;"></span>
            </div>
            <div id="processedShipmentsTableContainer" style="display:none;border:1px solid #e1e5e9;border-top:none;border-radius:0 0 8px 8px;overflow-x:auto;background:white;"></div>
          </div>
      </div>
    </div>
  </div>

  <!-- Receive Shipment Modal -->
  <div id="receiveModal" class="modal">
    <div class="modal-content" style="max-width: 600px; padding: 32px 28px; border-radius: 18px; box-shadow: 0 6px 24px rgba(0,0,0,0.18);">
      <div class="modal-header" style="border-bottom: none; margin-bottom: 0; padding-bottom: 0;">
        <h2 style="font-size: 1.5rem; color: #2c3e50; margin: 0;">Process Shipment</h2>
        <span class="close" onclick="closeReceiveModal()" style="top: 18px; right: 18px;">&times;</span>
      </div>
      <form id="receiveForm" onsubmit="submitReceiveShipment(event)" style="margin-top: 18px;">
        <div style="margin-bottom: 22px;">
          <label style="font-weight:600; margin-bottom: 6px; display: block; color: #34495e;">Actual Contents</label>
          <div id="actualContentsDropdowns"></div>
        </div>
        <div style="margin-bottom: 22px;">
          <label for="receivingHoursInput" style="font-weight:600; margin-bottom: 6px; display: block; color: #34495e;">Receiving Hours</label>
          <input id="receivingHoursInput" type="text" style="width:100%;font-size:1.08rem;padding:10px;border:1.5px solid #e1e5e9;border-radius:7px;box-sizing:border-box;transition:border-color 0.2s,box-shadow 0.2s;" placeholder="e.g. 2.5" required />
        </div>
        <div style="margin-bottom: 22px;">
          <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #34495e; cursor: pointer;">
            <input type="checkbox" id="shipmentCompleteCheckbox" style="width: 18px; height: 18px; cursor: pointer;">
            <span>Mark shipment as completely received</span>
          </label>
          <div style="margin-top: 6px; font-size: 0.9rem; color: #666;">
            If unchecked, shipment will be marked as "Partially Received" and can be processed again later.
          </div>
        </div>
        <div style="display: flex; gap: 12px; justify-content: center; margin-top: 18px;">
          <button class="btn" type="submit" id="submitReceiveBtn" style="background: #4DBA93; min-width: 140px;">Add to Inventory</button>
          <button class="btn" type="button" onclick="closeReceiveModal()" style="background:#b0b0b0; min-width: 100px;">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create Order Modal -->
  <div id="createOrderModal" class="modal">
    <div class="modal-content" style="max-width: 700px; padding: 32px 28px; border-radius: 18px; box-shadow: 0 6px 24px rgba(0,0,0,0.18);">
      <div class="modal-header" style="border-bottom: none; margin-bottom: 0; padding-bottom: 0;">
        <h2 style="font-size: 1.5rem; color: #2c3e50; margin: 0;">Create New Shipment Order</h2>
        <span class="close" onclick="closeCreateOrderModal()" style="top: 18px; right: 18px;">&times;</span>
      </div>
      <form id="createOrderForm" onsubmit="submitCreateOrder(event)" style="margin-top: 18px;">
        <div style="margin-bottom: 22px;">
          <label for="retailerSelect" style="font-weight:600; margin-bottom: 6px; display: block; color: #34495e;">Retailer/Customer</label>
          <select id="retailerSelect" style="width:100%;font-size:1.08rem;padding:10px;border:1.5px solid #e1e5e9;border-radius:7px;box-sizing:border-box;transition:border-color 0.2s,box-shadow 0.2s;background:#fff;" required>
            <option value="">Loading...</option>
          </select>
        </div>
        <div style="margin-bottom: 22px;">
          <label for="trackingLinkInput" style="font-weight:600; margin-bottom: 6px; display: block; color: #34495e;">Tracking Link (Optional)</label>
          <input id="trackingLinkInput" type="url" style="width:100%;font-size:1.08rem;padding:10px;border:1.5px solid #e1e5e9;border-radius:7px;box-sizing:border-box;transition:border-color 0.2s,box-shadow 0.2s;" placeholder="https://..." />
        </div>
        <div style="margin-bottom: 22px;">
          <label style="font-weight:600; margin-bottom: 6px; display: block; color: #34495e;">Items to Ship</label>
          <div id="itemsContainer">
            <div class="item-row" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
              <div class="sku-search-container">
                <input type="text" class="sku-search-input" placeholder="Search SKU or name..." required />
                <div class="sku-suggestions"></div>
              </div>
              <input type="number" class="item-quantity" placeholder="Qty" min="1" style="flex: 1; padding: 8px; border: 1.5px solid #e1e5e9; border-radius: 7px;" required />
              <button type="button" class="btn" onclick="removeItemRow(this)" style="background: #e74c3c; padding: 8px 12px; font-size: 14px;">✕</button>
            </div>
          </div>
          <button type="button" class="btn" onclick="addItemRow()" style="background: #4DBA93; padding: 8px 16px; font-size: 14px; margin-top: 10px;">+ Add Item</button>
        </div>
        <div style="display: flex; gap: 12px; justify-content: center; margin-top: 18px;">
          <button class="btn" type="submit" id="submitCreateOrderBtn" style="background: #4DBA93; min-width: 140px;">Create Order</button>
          <button class="btn" type="button" onclick="closeCreateOrderModal()" style="background:#b0b0b0; min-width: 100px;">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Access control and inactivity timeout
    checkPermissions(['service_role','employee']);
    

    let allShipments = [];
    let filteredShipments = [];
    let selectedShipments = new Set();
    let availableBoxes = [];
    let selectedBoxes = {};
    let allSKUs = []; // Store all SKUs from Products and Ingredients
    let allRetailers = []; // Store all retailers from Users table

    function showStatus(message, type = 'loading') {
      const statusDiv = document.getElementById('statusDiv');
      statusDiv.style.display = 'block';
      statusDiv.className = `status ${type}`;
      statusDiv.textContent = message;
    }

    function hideStatus() {
      document.getElementById('statusDiv').style.display = 'none';
    }

    // --- Create Order Logic ---
    async function loadAllRetailers() {
      try {
        const { data: users, error } = await supabase
          .from('Users')
          .select('id, display_name, email')
          .in('Role', ['client', 'service_role'])
          .order('display_name', { ascending: true });

        if (error) throw error;

        allRetailers = users || [];
        console.log(`Loaded ${allRetailers.length} retailers`);

        // Populate the select dropdown
        const select = document.getElementById('retailerSelect');
        if (select) {
          select.innerHTML = '<option value="">Select a retailer...</option>';
          allRetailers.forEach(user => {
            const opt = document.createElement('option');
            opt.value = user.display_name || user.email;
            opt.textContent = user.display_name ? `${user.display_name} (${user.email})` : user.email;
            select.appendChild(opt);
          });
        }
      } catch (error) {
        console.error('Error loading retailers:', error);
        showStatus(`Error loading retailers: ${error.message}`, 'error');
        
        // Set error state in dropdown
        const select = document.getElementById('retailerSelect');
        if (select) {
          select.innerHTML = '<option value="">Error loading retailers</option>';
        }
      }
    }

    async function loadAllSKUs() {
      try {
        // Load Products
        const { data: products, error: prodError } = await supabase
          .from('Products')
          .select('ProductSKU, Name');
        
        // Load Ingredients
        const { data: ingredients, error: ingError } = await supabase
          .from('Ingredients')
          .select('IngredientSKU, Name');

        // Load Boxes
        const { data: boxes, error: boxError } = await supabase
          .from('Boxes')
          .select('SKU, Dimensions');

        if (prodError) throw prodError;
        if (ingError) throw ingError;
        if (boxError) throw boxError;

        allSKUs = [];
        
        // Add products
        if (products) {
          products.forEach(prod => {
            allSKUs.push({
              sku: prod.ProductSKU,
              name: prod.Name || '',
              type: 'Product'
            });
          });
        }
        
        // Add ingredients
        if (ingredients) {
          ingredients.forEach(ing => {
            allSKUs.push({
              sku: ing.IngredientSKU,
              name: ing.Name || '',
              type: 'Ingredient'
            });
          });
        }

        // Add boxes
        if (boxes) {
          boxes.forEach(box => {
            allSKUs.push({
              sku: box.SKU,
              name: box.Dimensions || '',
              type: 'Box'
            });
          });
        }
        
        console.log(`Loaded ${allSKUs.length} SKUs (${products?.length || 0} products, ${ingredients?.length || 0} ingredients, ${boxes?.length || 0} boxes)`);
      } catch (error) {
        console.error('Error loading SKUs:', error);
        showStatus(`Error loading SKUs: ${error.message}`, 'error');
      }
    }

    function showSKUSuggestions(inputElement, searchTerm) {
      const suggestionsDiv = inputElement.parentElement.querySelector('.sku-suggestions');
      
      if (!searchTerm || searchTerm.length < 1) {
        suggestionsDiv.style.display = 'none';
        return;
      }
      
      const filtered = allSKUs.filter(item => 
        item.sku.toLowerCase().includes(searchTerm.toLowerCase()) ||
        (item.name && item.name.toLowerCase().includes(searchTerm.toLowerCase()))
      );
      
      if (filtered.length === 0) {
        suggestionsDiv.innerHTML = '<div class="sku-suggestion-item" style="color:#999;cursor:default;"><em>No SKUs found</em></div>';
        suggestionsDiv.style.display = 'block';
        return;
      }
      
      let html = '';
      filtered.slice(0, 10).forEach(item => { // Limit to 10 suggestions
        html += `<div class="sku-suggestion-item" 
          onclick="selectSKU('${item.sku}', '${(item.name || '').replace(/'/g, "&#39;")}', '${item.type}', this)"
        >
          <strong>${item.sku}</strong>
          <span class="sku-type">${item.type}</span>
          ${item.name ? `<div class="sku-name">${item.name}</div>` : ''}
        </div>`;
      });
      
      suggestionsDiv.innerHTML = html;
      suggestionsDiv.style.display = 'block';
    }

    function selectSKU(sku, name, type, element) {
      const suggestionsDiv = element.parentElement;
      const inputElement = suggestionsDiv.parentElement.querySelector('.sku-search-input');
      const itemRow = inputElement.closest('.item-row');
      const unitInput = itemRow.querySelector('.unit-input');
      
      inputElement.value = sku;
      inputElement.dataset.selectedSku = sku;
      suggestionsDiv.style.display = 'none';
      
      // Show unit dropdown only if ingredient is selected
      if (unitInput) {
        unitInput.style.display = type === 'Ingredient' ? 'block' : 'none';
      }
    }

    function setupSKUSearch(container) {
      const input = container.querySelector('.sku-search-input');
      const suggestions = container.querySelector('.sku-suggestions');
      
      input.addEventListener('input', function() {
        delete this.dataset.selectedSku; // Reset selection when typing
        showSKUSuggestions(this, this.value);
      });
      
      // Hide suggestions when clicking outside
      document.addEventListener('click', function(e) {
        if (!container.contains(e.target)) {
          suggestions.style.display = 'none';
        }
      });
    }

    function openCreateOrderModal() {
      // Load data if not already loaded
      if (allSKUs.length === 0) {
        loadAllSKUs();
      }
      if (allRetailers.length === 0) {
        loadAllRetailers();
      }
      
      // Clear form
      document.getElementById('retailerSelect').value = '';
      document.getElementById('trackingLinkInput').value = '';
      
      // Reset items container to one row
      const container = document.getElementById('itemsContainer');
      container.innerHTML = `
        <div class="item-row" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
          <div class="sku-search-container">
            <input type="text" class="sku-search-input" placeholder="Search SKU or name..." required />
            <div class="sku-suggestions"></div>
          </div>
          <input type="number" class="item-quantity" placeholder="Qty" min="1" style="flex: 1; padding: 8px; border: 1.5px solid #e1e5e9; border-radius: 7px;" required />
          <select class="unit-input" style="display:none;flex:0.8;padding:8px;border:1.5px solid #e1e5e9;border-radius:7px;">
            <option value="lb">lb</option>
            <option value="kg">kg</option>
            <option value="oz">oz</option>
            <option value="g">g</option>
            <option value="ml">ml</option>
            <option value="L">L</option>
            <option value="fl oz">fl oz</option>
            <option value="cups">cups</option>
            <option value="pcs">pcs</option>
          </select>
          <button type="button" class="btn" onclick="removeItemRow(this)" style="background: #e74c3c; padding: 8px 12px; font-size: 14px;">✕</button>
        </div>
      `;
      
      // Setup SKU search for the initial row
      setupSKUSearch(container.querySelector('.item-row'));
      
      document.getElementById('createOrderModal').style.display = 'block';
    }

    function closeCreateOrderModal() {
      document.getElementById('createOrderModal').style.display = 'none';
    }

    function addItemRow() {
      const container = document.getElementById('itemsContainer');
      const newRow = document.createElement('div');
      newRow.className = 'item-row';
      newRow.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
      newRow.innerHTML = `
        <div class="sku-search-container">
          <input type="text" class="sku-search-input" placeholder="Search SKU or name..." required />
          <div class="sku-suggestions"></div>
        </div>
        <input type="number" class="item-quantity" placeholder="Qty" min="1" style="flex: 1; padding: 8px; border: 1.5px solid #e1e5e9; border-radius: 7px;" required />
        <select class="unit-input" style="display:none;flex:0.8;padding:8px;border:1.5px solid #e1e5e9;border-radius:7px;">
          <option value="lb">lb</option>
          <option value="kg">kg</option>
          <option value="oz">oz</option>
          <option value="g">g</option>
          <option value="ml">ml</option>
          <option value="L">L</option>
          <option value="fl oz">fl oz</option>
          <option value="cups">cups</option>
          <option value="pcs">pcs</option>
        </select>
        <button type="button" class="btn" onclick="removeItemRow(this)" style="background: #e74c3c; padding: 8px 12px; font-size: 14px;">✕</button>
      `;
      container.appendChild(newRow);
      
      // Setup SKU search for the new row
      setupSKUSearch(newRow);
    }

    function removeItemRow(button) {
      const container = document.getElementById('itemsContainer');
      if (container.children.length > 1) {
        button.parentElement.remove();
      } else {
        alert('At least one item is required.');
      }
    }

    async function submitCreateOrder(event) {
      event.preventDefault();
      const btn = document.getElementById('submitCreateOrderBtn');
      btn.disabled = true;
      btn.textContent = '⏳ Creating...';

      try {
        const retailer = document.getElementById('retailerSelect').value.trim();
        const trackingLink = document.getElementById('trackingLinkInput').value.trim();
        
        if (!retailer) {
          throw new Error('Please select a retailer/customer.');
        }
        
        // Collect items
        const itemRows = document.querySelectorAll('.item-row');
        const items = [];
        
        for (const row of itemRows) {
          const skuInput = row.querySelector('.sku-search-input');
          const sku = skuInput.dataset.selectedSku || skuInput.value.trim();
          const quantity = parseInt(row.querySelector('.item-quantity').value);
          const unitInput = row.querySelector('.unit-input');
          
          if (sku && quantity > 0) {
            // Validate that the SKU exists in our loaded data
            const skuInfo = allSKUs.find(item => item.sku === sku);
            if (skuInfo) {
              const newItem = { sku, quantity };
              // Only add unit field for ingredients
              if (skuInfo.type === 'Ingredient' && unitInput && unitInput.style.display !== 'none') {
                newItem.unit = unitInput.value;
              }
              items.push(newItem);
            } else {
              throw new Error(`Invalid SKU: ${sku}. Please select a valid SKU from the suggestions.`);
            }
          }
        }

        if (items.length === 0) {
          throw new Error('Please add at least one item with valid SKU and quantity.');
        }

        // Create the shipment order
        const { data, error } = await supabase
          .from('ReceivingLog')
          .insert({
            Retailer: retailer,
            TrackingLink: trackingLink || null,
            AllegedContents: { items },
            Status: 'Pending'
          })
          .select()
          .single();

        if (error) throw error;

        // Add to local arrays
        const newShipment = {
          id: data.id,
          TrackingLink: data.TrackingLink,
          UserID: data.UserID,
          Retailer: data.Retailer,
          ReceivingHours: data.ReceivingHours,
          ActualContents: data.ActualContents,
          RecievedAt: data.RecievedAt,
          Status: data.Status || 'Pending',
          items: items
        };

        allShipments.unshift(newShipment);
        filteredShipments = [...allShipments];
        
        displayShipments();
        updateSummary();
        populateUserFilter();
        closeCreateOrderModal();
        
        showStatus('Shipment order created successfully!', 'success');
        setTimeout(hideStatus, 3000);

      } catch (error) {
        showStatus(`Error creating order: ${error.message}`, 'error');
      }

      btn.disabled = false;
      btn.textContent = 'Create Order';
    }


    // --- Receive Shipment Logic ---
function openReceiveModal() {
  if (selectedShipments.size !== 1) {
    alert('Please select exactly one shipment to receive.');
    return;
  }
  document.getElementById('receivingHoursInput').value = '';
  document.getElementById('shipmentCompleteCheckbox').checked = true; // Default to complete
  // Build dropdowns for AllegedContents
  const shipmentId = Array.from(selectedShipments)[0];
  const shipment = allShipments.find(s => s.id === shipmentId);
  const container = document.getElementById('actualContentsDropdowns');
  container.innerHTML = '';
  if (shipment && shipment.items && shipment.items.length > 0) {
    shipment.items.forEach(item => {
      const div = document.createElement('div');
      div.style.marginBottom = '18px';
      div.style.background = '#f8f9fa';
      div.style.border = '1.5px solid #e1e5e9';
      div.style.borderRadius = '10px';
      div.style.padding = '14px 16px 10px 16px';
      div.style.display = 'flex';
      div.style.alignItems = 'center';
      div.style.gap = '18px';
      div.innerHTML = `
        <div style="flex:1;min-width:0;">
          <div style="font-weight:600;font-size:1.04rem;color:#34495e;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
            SKU: <span style='font-family:monospace;'>${item.sku}</span>
            <span style='color:#888;font-size:0.97em;font-weight:400;margin-left:8px;'>(Ordered: ${item.quantity})</span>
          </div>
        </div>
        <input type="number" value="${item.quantity}" min="0" max="${item.quantity}" id="actual-qty-${item.sku}" class="styled-qty-input" required style="width:90px;padding:8px 10px;border:1.5px solid #4DBA93;border-radius:7px;font-size:1.08rem;background:#fff;color:#2c3e50;transition:border-color 0.2s,box-shadow 0.2s;" />
      `;
      container.appendChild(div);
    });
    // Add style for .styled-qty-input if not present
    if (!document.getElementById('styled-qty-input-css')) {
      const style = document.createElement('style');
      style.id = 'styled-qty-input-css';
      style.textContent = `
        .styled-qty-input:focus {
          outline: none;
          border-color: #2c3e50;
          box-shadow: 0 0 0 2px #c1de9f;
        }
        .styled-qty-input::-webkit-inner-spin-button,
        .styled-qty-input::-webkit-outer-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
      `;
      document.head.appendChild(style);
    }
  } else {
    container.innerHTML = '<em>No SKUs found in AllegedContents.</em>';
  }
  document.getElementById('receiveModal').style.display = 'block';
}

    function closeReceiveModal() {
      document.getElementById('receiveModal').style.display = 'none';
    }

async function submitReceiveShipment(event) {
  event.preventDefault();
  const btn = document.getElementById('submitReceiveBtn');
  btn.disabled = true;
  btn.textContent = '⏳ Receiving...';
  try {
    const shipmentId = Array.from(selectedShipments)[0];
    const shipment = allShipments.find(s => s.id === shipmentId);
    const receivingHours = parseFloat(document.getElementById('receivingHoursInput').value.trim()) || 0;
    const isComplete = document.getElementById('shipmentCompleteCheckbox').checked;
    
    // Build ActualContents from dropdowns
    let items = [];
    if (shipment && shipment.items && shipment.items.length > 0) {
      for (const item of shipment.items) {
        const qtyInput = document.getElementById(`actual-qty-${item.sku}`);
        let qty = parseInt(qtyInput.value, 10);
        if (isNaN(qty) || qty < 0) qty = 0;
        
        // Check if this SKU is an ingredient to preserve unit
        const skuInfo = allSKUs.find(s => s.sku === item.sku);
        const isIngredient = skuInfo && skuInfo.type === 'Ingredient';
        
        const newItem = { sku: item.sku, quantity: qty };
        if (isIngredient && item.unit) {
          newItem.unit = item.unit;
        }
        items.push(newItem);
      }
    }
    
    // Handle ActualContents - add to existing for partial shipments
    let actualContents;
    if (isComplete) {
      // For complete shipments, use the current input as final ActualContents
      actualContents = { items };
    } else {
      // For partial shipments, add new quantities to existing ActualContents
      const existingContents = shipment.ActualContents || { items: [] };
      const existingItems = existingContents.items || [];
      
      // Create a map for easy lookup and accumulation
      const itemsMap = new Map();
      
      // Add existing quantities
      existingItems.forEach(item => {
        if (item.sku) {
          itemsMap.set(item.sku, (itemsMap.get(item.sku) || 0) + (item.quantity || 0));
        }
      });
      
      // Add new quantities
      items.forEach(item => {
        if (item.sku && item.quantity > 0) {
          itemsMap.set(item.sku, (itemsMap.get(item.sku) || 0) + item.quantity);
        }
      });
      
      // Convert back to items array
      const combinedItems = Array.from(itemsMap.entries()).map(([sku, quantity]) => ({
        sku,
        quantity
      }));
      
      actualContents = { items: combinedItems };
    }
    
    // Determine status and ReceivingHours handling
    let newStatus = isComplete ? 'Processed' : 'Partially Received';
    let updateData = {
      ActualContents: actualContents,
      RecievedAt: new Date().toISOString(),
      Status: newStatus
    };
    
    // Handle ReceivingHours - add to existing hours for partial shipments
    if (isComplete) {
      // For complete shipments, set the total receiving hours
      updateData.ReceivingHours = receivingHours;
    } else {
      // For partial shipments, add to existing ReceivingHours
      const currentReceivingHours = parseFloat(shipment.ReceivingHours) || 0;
      updateData.ReceivingHours = currentReceivingHours + receivingHours;
    }
    
    // Update the shipment in ReceivingLog
    const { error } = await supabase
      .from('ReceivingLog')
      .update(updateData)
      .eq('id', shipmentId);
    if (error) throw error;

    // --- Add to Products inventory ---
    // Get displayName from user.user_metadata.display_name if available
    let displayName = null;
    if (window.user && window.user.user_metadata && window.user.user_metadata.display_name) {
      displayName = window.user.user_metadata.display_name;
    }
    
    // For inventory updates, use the current input quantities (items), not cumulative actualContents
    for (const item of items) {
      if (!item.sku || !item.quantity || item.quantity <= 0) continue;
      
      // Try to update Products table first
      const { data: prod, error: prodErr } = await supabase
        .from('Products')
        .select('Quantity')
        .eq('ProductSKU', item.sku)
        .maybeSingle();
      
      if (prodErr) throw prodErr;
      
      if (prod) {
        // Update Products table
        const newQty = (prod.Quantity || 0) + item.quantity;
        const { error: upErr } = await supabase
          .from('Products')
          .update({ Quantity: newQty })
          .eq('ProductSKU', item.sku);
        if (upErr) throw upErr;
        
        // Log the inventory update
        const logMsg = `Received ${item.quantity} SKU ${item.sku}`;
        await supabase
          .from('inventoryupdatelogs')
          .insert({
            log: logMsg,
            updated_by: displayName || shipment.Retailer || null,
            SKU: item.sku,
            QuantityChanged: item.quantity
          });
      } else {
        // Try to update Boxes table
        const { data: box, error: boxErr } = await supabase
          .from('Boxes')
          .select('Quantity')
          .eq('SKU', item.sku)
          .maybeSingle();
        
        if (boxErr) throw boxErr;
        
        if (box) {
          // Update Boxes table
          const newQty = (box.Quantity || 0) + item.quantity;
          const { error: upBoxErr } = await supabase
            .from('Boxes')
            .update({ Quantity: newQty })
            .eq('SKU', item.sku);
          if (upBoxErr) throw upBoxErr;
          
          // Log the inventory update
          const logMsg = `Received ${item.quantity} Box SKU ${item.sku}`;
          await supabase
            .from('inventoryupdatelogs')
            .insert({
              log: logMsg,
              updated_by: displayName || shipment.Retailer || null,
              SKU: item.sku,
              QuantityChanged: item.quantity
            });
        } else {
          // Try to update Ingredients table using IngredientUtils
          const result = await IngredientAdd(item.sku, item.quantity, item.unit || 'lb');
          
          if (!result.success) {
            throw new Error(result.message);
          }

          // Log the inventory update
          const logMsg = `Received ${item.quantity} ${item.unit || 'lb'} Ingredient SKU ${item.sku}`;
          await supabase
            .from('inventoryupdatelogs')
            .insert({
              log: logMsg,
              updated_by: displayName || shipment.Retailer || null,
              SKU: item.sku,
              QuantityChanged: item.quantity
            });
        }
      }
    }

    // Update local arrays
    allShipments = allShipments.map(s => s.id === shipmentId ? { 
      ...s, 
      ActualContents: actualContents, 
      ReceivingHours: updateData.ReceivingHours, 
      RecievedAt: new Date().toISOString(), 
      Status: newStatus 
    } : s);
    filteredShipments = filteredShipments.map(s => s.id === shipmentId ? { 
      ...s, 
      ActualContents: actualContents, 
      ReceivingHours: updateData.ReceivingHours, 
      RecievedAt: new Date().toISOString(), 
      Status: newStatus 
    } : s);
    selectedShipments.clear();
    displayShipments();
    updateSummary();
    populateUserFilter();
    closeReceiveModal();
    
    // Show appropriate success message
    const statusMessage = isComplete 
      ? 'Shipment marked as Processed and inventory updated!' 
      : 'Shipment marked as Partially Received and inventory updated!';
    showStatus(statusMessage, 'success');
    setTimeout(hideStatus, 3000);
  } catch (error) {
    showStatus(`Error receiving shipment: ${error.message}`, 'error');
  }
  btn.disabled = false;
  btn.textContent = 'Add to Inventory';
}

    async function loadShipments() {


      showStatus('Loading Warehouse shipments...', 'loading');
      
      try {
        const { data: logs, error } = await supabase
          .from('ReceivingLog')
          .select('id, TrackingLink, UserID, Retailer, AllegedContents, ReceivingHours, ActualContents, RecievedAt, Status')
          .order('id', { ascending: false });

        if (error) {
          throw error;
        }

        allShipments = (logs || []).map(log => {
          const items = (log.AllegedContents && log.AllegedContents.items && Array.isArray(log.AllegedContents.items)) ? log.AllegedContents.items : [];
          return {
            id: log.id,
            TrackingLink: log.TrackingLink,
            UserID: log.UserID,
            Retailer: log.Retailer,
            ReceivingHours: log.ReceivingHours,
            ActualContents: log.ActualContents,
            RecievedAt: log.RecievedAt,
            Status: log.Status || '',
            items: items
          };
        });
        showStatus(`Successfully loaded ${allShipments.length} shipments`, 'success');
        setTimeout(hideStatus, 3000);

      } catch (error) {
        console.error('Error loading shipments:', error);
        showStatus(`Error loading shipments: ${error.message}`, 'error');
      }

      filteredShipments = [...allShipments];
      displayShipments();
      updateSummary();
      populateUserFilter();
    }

    function populateUserFilter() {
      const userSelect = document.getElementById('userFilter');
      const currentValue = userSelect.value;
      
      // Get unique users from allShipments (Retailer)
      const users = Array.from(new Set(allShipments.map(shipment => shipment.Retailer).filter(Boolean)));
      users.sort((a, b) => a.localeCompare(b));
      
      // Save the first option (All Users)
      const firstOption = document.createElement('option');
      firstOption.value = '';
      firstOption.textContent = 'All Users';
      
      userSelect.innerHTML = '';
      userSelect.appendChild(firstOption);
      
      users.forEach(user => {
        const opt = document.createElement('option');
        opt.value = user;
        opt.textContent = user;
        userSelect.appendChild(opt);
      });
      
      // Restore previous selection if possible
      userSelect.value = currentValue;
    }

    function filterShipments() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const userFilter = document.getElementById('userFilter').value;

      filteredShipments = allShipments.filter(shipment => {
        // User filter
        if (userFilter && shipment.Retailer !== userFilter) {
          return false;
        }

        // Search filter
        if (searchTerm) {
          // Search in all SKUs, Retailer, and TrackingLink
          const skuString = shipment.items.map(i => i.sku).join(' ');
          const searchFields = [
            skuString,
            shipment.Retailer,
            shipment.TrackingLink
          ].join(' ').toLowerCase();

          if (!searchFields.includes(searchTerm)) {
            return false;
          }
        }

        return true;
      });

      displayShipments();
      updateSummary();
    }

    function displayShipments() {
      const container = document.getElementById('shipmentsTableContainer');
      const summaryDiv = document.getElementById('shipmentsSummary');
      const actionButtons = document.getElementById('actionButtons');
      
      if (filteredShipments.length === 0) {
        summaryDiv.style.display = 'none';
        actionButtons.style.display = 'none';
        container.innerHTML = `
          <div class="no-shipments">
            <h3>${allShipments.length === 0 ? 'No shipments found' : 'No shipments match your filters'}</h3>
            <p>${allShipments.length === 0 ? 'No Warehouse shipments have been created yet. Use the Warehouse Shipments form to create shipments.' : 'Try adjusting your search or filter criteria'}</p>
          </div>
        `;
        return;
      }

      summaryDiv.style.display = 'flex';
      actionButtons.style.display = 'flex';

      // Only show non-processed shipments in the main table
      const nonProcessedShipments = filteredShipments.filter(s => s.Status !== 'Processed');
      const tableHTML = `
        <table class="shipments-table">
          <thead>
            <tr>
              <th class="checkbox-cell">
                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
              </th>
              <th>ID</th>
              <th>Items</th>
              <th>User</th>
              <th>Tracking Link</th>
              <th>Status</th>
              <th>Received At</th>
            </tr>
          </thead>
          <tbody>
            ${nonProcessedShipments.map((shipment, idx) => {
              const isSelected = selectedShipments.has(shipment.id);
              const retailer = shipment.Retailer || 'Unknown User';
              const tracking = shipment.TrackingLink || '';
              const receivedAt = shipment.RecievedAt ? shipment.RecievedAt : 'Not yet received';
              const status = shipment.Status || '';
              const collapseId = `collapse-items-${shipment.id}`;
              return `
                <tr class="${isSelected ? 'selected-row' : ''} collapsible-row" id="shipment-${shipment.id}" data-collapse="${collapseId}" style="cursor:pointer;">
                  <td class="checkbox-cell" onclick="event.stopPropagation();">
                    <input type="checkbox" class="shipment-checkbox" 
                           ${isSelected ? 'checked' : ''} 
                           onchange="toggleShipmentSelection(${shipment.id})">
                  </td>
                  <td><strong>#${shipment.id}</strong></td>
                  <td><span class="collapse-arrow" style="font-weight:bold;font-size:1.2em;">&#9660;</span></td>
                  <td><span class="user-name">${retailer}</span></td>
                  <td>${tracking}</td>
                  <td>${status}</td>
                  <td>${receivedAt}</td>
                </tr>
                <tr id="${collapseId}" class="items-detail-row" style="display:none;background:#f9f9f9;">
                  <td colspan="7">
                    <table style="width:100%;border-collapse:collapse;">
                      <thead>
                        <tr><th>SKU</th><th>Quantity</th>${shipment.items.some(item => item.unit) ? '<th>Unit</th>' : ''}</tr>
                      </thead>
                      <tbody>
                        ${shipment.items.map(item => `<tr><td>${item.sku}</td><td>${item.quantity}</td>${item.unit ? `<td>${item.unit}</td>` : ''}</tr>`).join('')}
                      </tbody>
                    </table>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
    // Render Processed Shipments Table
    renderProcessedShipmentsTable();
    // Mark as Recieved handler for selected shipment
    window.markSelectedAsRecieved = async function() {
      if (selectedShipments.size === 0) return;
      if (!confirm(`Mark ${selectedShipments.size} shipment(s) as Recieved?`)) return;
      try {
        const now = new Date().toISOString();
        const ids = Array.from(selectedShipments);
        // Update all selected shipments in the database
        const { error } = await supabase
          .from('ReceivingLog')
          .update({ RecievedAt: now, Status: 'Recieved' })
          .in('id', ids);
        if (error) throw error;
        // Update local arrays
        allShipments = allShipments.map(s => ids.includes(s.id) ? { ...s, RecievedAt: now, Status: 'Recieved' } : s);
        filteredShipments = filteredShipments.map(s => ids.includes(s.id) ? { ...s, RecievedAt: now, Status: 'Recieved' } : s);
        selectedShipments.clear();
        displayShipments();
        updateSummary();
        showStatus(`${ids.length} shipment(s) marked as Recieved!`, 'success');
        setTimeout(hideStatus, 2000);
      } catch (err) {
        showStatus('Error marking as Recieved: ' + err.message, 'error');
      }
    }

      container.innerHTML = tableHTML;
      updateSelectedCount();
      updateSelectAllCheckbox();
      // Add click listeners for collapsible rows
      document.querySelectorAll('.collapsible-row').forEach(row => {
        row.addEventListener('click', function(e) {
          // Prevent toggling if clicking the checkbox cell
          if (e.target.closest('.checkbox-cell')) return;
          const collapseId = this.getAttribute('data-collapse');
          const detailRow = document.getElementById(collapseId);
          const arrow = this.querySelector('.collapse-arrow');
          if (detailRow) {
            const isOpen = detailRow.style.display === '';
            detailRow.style.display = isOpen ? 'none' : '';
            if (arrow) {
              arrow.innerHTML = isOpen ? '&#9660;' : '&#9650;';
            }
          }
        });
      });
    }

      // Collapsible Processed Shipments Table logic
      function renderProcessedShipmentsTable() {
        const processedShipments = allShipments.filter(s => s.Status === 'Processed');
        const processedCount = processedShipments.length;
        document.getElementById('processedCount').textContent = processedCount > 0 ? `(${processedCount})` : '';
        const container = document.getElementById('processedShipmentsTableContainer');
        if (processedCount === 0) {
          container.innerHTML = `<div class="no-shipments"><h3>No processed shipments</h3></div>`;
          return;
        }
        container.innerHTML = `
          <table class="shipments-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Items</th>
                <th>User</th>
                <th>Tracking Link</th>
                <th>Status</th>
                <th>Received At</th>
              </tr>
            </thead>
            <tbody>
              ${processedShipments.map(shipment => {
                const retailer = shipment.Retailer || 'Unknown User';
                const tracking = shipment.TrackingLink || '';
                const receivedAt = shipment.RecievedAt ? shipment.RecievedAt : 'Not yet received';
                const status = shipment.Status || '';
                const collapseId = `collapse-processed-items-${shipment.id}`;
                return `
                  <tr class="collapsible-row-processed" id="processed-shipment-${shipment.id}" data-collapse="${collapseId}" style="cursor:pointer;">
                    <td><strong>#${shipment.id}</strong></td>
                    <td><span class="collapse-arrow-processed" style="font-weight:bold;font-size:1.2em;">&#9660;</span></td>
                    <td><span class="user-name">${retailer}</span></td>
                    <td>${tracking}</td>
                    <td>${status}</td>
                    <td>${receivedAt}</td>
                  </tr>
                  <tr id="${collapseId}" class="items-detail-row-processed" style="display:none;background:#f9f9f9;">
                    <td colspan="6">
                      <table style="width:100%;border-collapse:collapse;">
                        <thead>
                          <tr><th>SKU</th><th>Quantity</th>${(shipment.ActualContents && shipment.ActualContents.items && shipment.ActualContents.items.some(item => item.unit)) ? '<th>Unit</th>' : ''}</tr>
                        </thead>
                        <tbody>
                          ${(shipment.ActualContents && shipment.ActualContents.items ? shipment.ActualContents.items : []).map(item => `<tr><td>${item.sku}</td><td>${item.quantity}</td>${item.unit ? `<td>${item.unit}</td>` : ''}</tr>`).join('')}
                        </tbody>
                      </table>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;
        // Add click listeners for collapsible rows in processed table
        document.querySelectorAll('.collapsible-row-processed').forEach(row => {
          row.addEventListener('click', function(e) {
            const collapseId = this.getAttribute('data-collapse');
            const detailRow = document.getElementById(collapseId);
            const arrow = this.querySelector('.collapse-arrow-processed');
            if (detailRow) {
              const isOpen = detailRow.style.display === '';
              detailRow.style.display = isOpen ? 'none' : '';
              if (arrow) {
                arrow.innerHTML = isOpen ? '&#9660;' : '&#9650;';
              }
            }
          });
        });
      }

      // Toggle processed shipments section
      window.toggleProcessedShipments = function() {
        const container = document.getElementById('processedShipmentsTableContainer');
        const arrow = document.getElementById('processedCollapseArrow');
        const isOpen = container.style.display === '';
        container.style.display = isOpen ? 'none' : '';
        arrow.innerHTML = isOpen ? '&#9654;' : '&#9660;';
      }

    function updateSummary() {
      const summaryDiv = document.getElementById('shipmentsSummary');
      
      if (filteredShipments.length === 0) {
        summaryDiv.style.display = 'none';
        return;
      }

      document.getElementById('totalShipments').textContent = filteredShipments.length;
    }

    function toggleShipmentSelection(shipmentId) {
      const shipmentRow = document.getElementById(`shipment-${shipmentId}`);
      const checkbox = shipmentRow.querySelector('.shipment-checkbox');
      
      if (selectedShipments.has(shipmentId)) {
        selectedShipments.delete(shipmentId);
        shipmentRow.classList.remove('selected-row');
      } else {
        selectedShipments.add(shipmentId);
        shipmentRow.classList.add('selected-row');
      }
      
      updateSelectedCount();
      updateSelectAllCheckbox();
    }

    function toggleSelectAll() {
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      
      if (selectAllCheckbox.checked) {
        filteredShipments.forEach(shipment => {
          selectedShipments.add(shipment.id);
        });
      } else {
        selectedShipments.clear();
      }
      
      displayShipments();
    }

    function updateSelectedCount() {
      const selectedCountSpan = document.getElementById('selectedCount');
      selectedCountSpan.textContent = selectedShipments.size;
      // Enable Mark as Recieved button if at least one shipment is selected
      const btn = document.getElementById('markRecievedBtn');
      if (!btn) return;
      btn.disabled = selectedShipments.size === 0;
    }

    function updateSelectAllCheckbox() {
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      const filteredShipmentIds = filteredShipments.map(shipment => shipment.id);
      const selectedFilteredShipments = filteredShipmentIds.filter(id => selectedShipments.has(id));
      
      if (selectedFilteredShipments.length === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      } else if (selectedFilteredShipments.length === filteredShipmentIds.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
      } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
      }
    }

    function getSelectedShipmentsData() {
      return allShipments.filter(shipment => selectedShipments.has(shipment.id));
    }

    async function deleteSelectedShipments() {
      if (selectedShipments.size === 0) {
        alert('Please select at least one shipment to delete.');
        return;
      }
      
      if (!confirm(`Are you sure you want to delete ${selectedShipments.size} selected shipment(s)? This action cannot be undone.`)) {
        return;
      }

      showStatus('Deleting selected shipments...', 'loading');
      
      let deletedCount = 0;
      let errorCount = 0;

      for (const shipmentId of selectedShipments) {
        try {
          const { error } = await supabase
            .from('ReceivingLog')
            .delete()
            .eq('id', shipmentId);

          if (!error) {
            deletedCount++;
            // Remove from local arrays
            allShipments = allShipments.filter(s => s.id !== shipmentId);
            filteredShipments = filteredShipments.filter(s => s.id !== shipmentId);
          } else {
            console.error('Error deleting shipment', shipmentId, error);
            errorCount++;
          }
        } catch (err) {
          console.error('Error deleting shipment', shipmentId, err);
          errorCount++;
        }
      }

      selectedShipments.clear();
      displayShipments();
      updateSummary();
      
      showStatus(`${deletedCount} shipment(s) deleted${errorCount > 0 ? `, ${errorCount} errors` : ''}`, errorCount === 0 ? 'success' : 'error');
      setTimeout(hideStatus, 3000);
    }

    // Make functions globally available
    window.loadShipments = loadShipments;
    window.filterShipments = filterShipments;
    window.toggleShipmentSelection = toggleShipmentSelection;
    window.toggleSelectAll = toggleSelectAll;
    window.deleteSelectedShipments = deleteSelectedShipments;
    window.openReceiveModal = openReceiveModal;
    window.closeReceiveModal = closeReceiveModal;
    window.submitReceiveShipment = submitReceiveShipment;
    window.openCreateOrderModal = openCreateOrderModal;
    window.closeCreateOrderModal = closeCreateOrderModal;
    window.addItemRow = addItemRow;
    window.removeItemRow = removeItemRow;
    window.submitCreateOrder = submitCreateOrder;
    window.selectSKU = selectSKU;
    window.loadAllSKUs = loadAllSKUs;
    window.loadAllRetailers = loadAllRetailers;

    // Initialize the page
    window.addEventListener('DOMContentLoaded', () => {
      loadShipments();
      loadAllSKUs(); // Load SKUs for the create order modal
      loadAllRetailers(); // Load retailers for the create order modal
    });

    // Close modal when clicking outside of it
    window.addEventListener('click', (event) => {
      const receiveModal = document.getElementById('receiveModal');
      const createModal = document.getElementById('createOrderModal');
      
      if (event.target === receiveModal) {
        closeReceiveModal();
      }
      
      if (event.target === createModal) {
        closeCreateOrderModal();
      }
    });
  </script>
</body>
</html>