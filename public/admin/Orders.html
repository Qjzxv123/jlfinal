<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Viewer</title>
    <link rel="stylesheet" href="https://unpkg.com/@coreui/icons/css/all.min.css">
    <link rel="stylesheet" href="/Assets/sidebar.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #c1de9f 0%, #4dba93 100%);
            min-height: 100vh;
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
        }
        .main-content {
            margin-left: 60px;
            width: calc(100% - 60px);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: indigo;
            text-align: center;
            margin-bottom: 30px;
        }
        .order-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 24px;
            padding: 24px;
        }
        .order-link {
            color: #4DBA93;
            text-decoration: underline;
        }
        .notes {
            color: #e74c3c;
            font-style: italic;
        }
        .customer-messages {
            color: #ba4d74;
        }
        .items-toggle,
        .customer-toggle {
            cursor: pointer;
            color: #4DBA93;
            font-weight: 600;
            margin-bottom: 6px;
            display: inline-block; /* shrink clickable area to just the text */
            width: auto;
            padding: 0; /* no extra hit area */
        }
        .items-list {
            display: none;
            margin-top: 8px;
        }
        .show {
            display: block !important;
        }
        .selected {
            border: 2px solid #4DBA93;
            background: #f0f9f0;
        }
        /* Indicate cards are clickable for selection */
        .order-card { cursor: pointer; }
        .btn {
            background: #4DBA93;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn:hover {
            background: #3a9b74;
        }
        /* New styles for order stats banner */
        #orderStatsBanner {
            width: 100%;
            margin: 0 0 18px 0;
            padding: 18px 24px 10px 24px;
            background: white;
            color: #222;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(77,186,147,0.08);
            font-size: 1.08rem;
            display: flex;
            flex-wrap: wrap;
            gap: 24px 36px;
            align-items: center;
            justify-content: flex-start;
            font-weight: 500;
            box-sizing: border-box;
        }

        /* Controls styles */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 12px 16px;
            align-items: center;
        }
        .controls > * { min-width: 0; }
        .controls .btn { white-space: nowrap; }
        .search-box { width: 100%; }
        .filter-controls {
            display: grid;
            grid-template-columns: repeat(2, minmax(150px, 1fr));
            gap: 10px;
            align-items: center;
            width: 100%;
        }
        /* Normalize element heights inside controls */
        .controls input,
        .controls select,
        .controls .btn {
            height: 44px;
            box-sizing: border-box;
        }
        .controls input { padding: 10px 12px; }
        .controls select { padding: 8px 12px; }
        .controls .btn { padding: 10px 16px; }
         .action-buttons {
             background: white;
             padding: 15px 20px;
             border-radius: 12px;
             box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
             margin-bottom: 20px;
             display: flex;
             gap: 10px;
             align-items: center;
             flex-wrap: wrap;
             justify-content: center;
         }
        /* Responsive behavior without media queries handled via flex-wrap and min-widths */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 12px 16px;
            align-items: center;
            flex-wrap: wrap;
        }
        .controls > * {
            min-width: 180px;
        }
        .search-box {
            flex: 1 1 600px;
            min-width: 260px;
            max-width: none;
        }
        .search-box input { width: 100%; }
        .filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            flex: 0 0 auto; /* don't grow; keep natural width */
            min-width: 220px;
        }
        .filter-controls select {
            flex: 1 1 180px;
            min-width: 160px;
        }
        .controls .btn { white-space: nowrap; }
        .action-buttons {
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }
        /* Make all action buttons the same height */
        .action-buttons .btn {
            height: 44px;
            padding: 0 20px; /* horizontal padding only to keep uniform height */
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .action-buttons .btn i { line-height: 1; }
        .action-btn {
            background: #BA4D74;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }
        .action-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .btn {
            background: #4DBA93;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
    /* Toggle arrow spacing (arrow on the right) */
    .toggle-arrow { display: inline-block; margin-left: 6px; }
        /* Platform badge styles */
        .platform-badge {
            display: inline-block;
            padding: 6px 12px; /* slightly larger */
            border-radius: 999px;
            color: #fff;
            font-weight: 600;
            font-size: 13px; /* slightly larger */
            line-height: 1;
            vertical-align: middle;
            letter-spacing: .2px;
            user-select: none;
        }
        .platform-etsy { background: #f56500; }
        .platform-faire { background: #2c5aa0; }
        .platform-shopify { background: #95bf47; }
        .platform-shopify-tiktok { background: #ff0050; }
        .platform-amazon { background: #ff9900; }
        /* Inventory Removed badge */
        .inv-removed-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 999px;
            background: #6b7280;
            color: #fff;
            font-weight: 600;
            font-size: 12px;
            line-height: 1;
            letter-spacing: .2px;
            user-select: none;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script src="/Assets/CheckAccess.js"></script>
    <link rel="icon" type="image/x-icon" href="/Assets/favicon.ico">
</head>
<body>
    <div id="sidebar"></div>
    <script src="/Assets/sidebar.js"></script>
    <div class="main-content">
        <div class="container">
            <h1>Order Viewer</h1>
            <!-- Controls Row (Manifest, Search, Filters) -->
<div class="controls">
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search orders (ID, customer, SKU, retailer, platform, notes, address)" oninput="filterOrders()" />
    </div>
    <div class="filter-controls">
        <select id="platformFilter" onchange="filterOrders()">
            <option value="">All Platforms</option>
            <option value="etsy">Etsy</option>
            <option value="faire">Faire</option>
            <option value="shopify">Shopify</option>
            <option value="shopify(tiktok)">Shopify(TikTok)</option>
            <option value="amazon">Amazon</option>
        </select>
        <select id="retailerFilter" onchange="filterOrders()">
            <option value="">All Retailers</option>
            <option value="Desesh">Desesh</option>
            <option value="J&amp;L Naturals">J&amp;L Naturals</option>
            <option value="River Organics">River Organics</option>
        </select>
    </div>
</div>
            <div class="action-buttons">
                <button class="btn" onclick="window.open('https://apps.goshippo.com/shipments/manifests', '_blank')" id="manifestBtn" style="background: #9b59b6; border-color: #8e44ad;">
                    📋 Print Daily Manifest
                </button>
                <button id="printPicklistPackingBtn" class="btn" style="border-radius:8px; font-size:16px; font-weight:600; background:#BA4D74; color:white;" onclick="printPicklistAndPackingSlips()">📋 Print Picklist and Packing Slips</button>
                <button id="printShippingLabelsBtn" class="btn" style="border-radius:8px; font-size:16px; font-weight:600; background:#2c3e50; color:white;" onclick="openShippingLabelsModal()" disabled>📦 Print Shipping Labels</button>
                <button id="removeInventoryBtn" class="btn" style="border-radius:8px; font-size:16px; font-weight:600; background:#e67e22; color:white;" onclick="removeProductsFromInventory()" disabled>📊 Remove Products From Inventory</button>
                <button id="removeSelectedOrdersBtn" class="btn" aria-label="Remove Selected Orders" style="padding:0; width:44px; height:44px; border-radius:8px; font-size:20px; background:#e74c3c; color:white; display:inline-flex; align-items:center; justify-content:center;" onclick="removeSelectedOrders()">
                    <i class="cil-trash" style="margin:0; line-height:1;"></i>
                </button>
            </div>
            <!-- Order Stats Banner -->
            <div id="orderStatsBanner" style="width:100%;max-width:1200px;margin:0 auto 18px auto;padding:18px 24px 10px 24px; color:#222;border-radius:10px;box-shadow:0 2px 10px rgba(77,186,147,0.08);font-size:1.08rem;display:flex;flex-wrap:wrap;gap:24px 36px;align-items:center;justify-content:flex-start;font-weight:500;"></div>
            <div id="ordersTableContainer">
                <p>Loading orders...</p>
            </div>
        </div>
    </div>
    <script>
        checkPermissions(['service_role', 'employee']);
        
        let selectedOrders = new Set();
        let orders = [];
        // Helpers to render platform badges consistently
        function platformClass(p) {
            const s = (p || '').toLowerCase().trim();
            if (!s) return '';
            if (s.includes('shopify') && s.includes('tiktok')) return 'platform-shopify-tiktok';
            if (s === 'etsy') return 'platform-etsy';
            if (s === 'faire') return 'platform-faire';
            if (s === 'shopify') return 'platform-shopify';
            if (s === 'amazon') return 'platform-amazon';
            return '';
        }
        function getPlatformBadgeHtml(p) {
            if (!p) return '';
            const cls = platformClass(p);
            return `<span class="platform-badge ${cls}">${p}</span>`;
        }
        function toggleOrderSelection(orderId) {
            const sid = String(orderId);
            if (selectedOrders.has(sid)) {
                selectedOrders.delete(sid);
            } else {
                selectedOrders.add(sid);
            }
            updateSelectedCount();
            updateOrderCardSelection();
        }
        function updateOrderCardSelection() {
            // Match the rendered list to the DOM (renderOrders uses filteredOrders)
            (filteredOrders || []).forEach((order, idx) => {
                const card = document.getElementById(`order-card-${idx}`);
                if (!card) return;
                if (selectedOrders.has(String(order.OrderID))) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
        }
        function updateSelectedCount() {
            // Remove legacy standalone selected count (moved into banner)
            const old = document.getElementById('selectedCountDiv');
            if (old && old.parentNode) old.parentNode.removeChild(old);
            // DRY: enable/disable action buttons based on selection
            updateActionButtons();
            // Refresh stats banner to reflect selected count
            renderOrderStatsBanner();
        }

        // Helpers for DRY button state logic
        function getSelectionInfo() {
            const hasSelection = selectedOrders.size > 0;
            let hasEligibleForInventory = false;
            if (hasSelection) {
                const selectedIdSet = new Set(Array.from(selectedOrders).map(String));
                for (const o of orders) {
                    if (selectedIdSet.has(String(o.OrderID)) && !o.InventoryRemoved) { hasEligibleForInventory = true; break; }
                }
            }
            return { hasSelection, hasEligibleForInventory };
        }
        function setBtnState(btn, enabled) {
            if (!btn) return;
            btn.disabled = !enabled;
            btn.style.opacity = enabled ? '1' : '0.6';
            btn.style.cursor = enabled ? 'pointer' : 'not-allowed';
        }
        function updateActionButtons() {
            const { hasSelection, hasEligibleForInventory } = getSelectionInfo();
            // Buttons
            const printBtn = document.getElementById('printPicklistPackingBtn');
            const removeInvBtn = document.getElementById('removeInventoryBtn');
            const removeOrdersBtn = document.getElementById('removeSelectedOrdersBtn');
            const printLabelsBtn = document.getElementById('printShippingLabelsBtn');
            // Manifest button excluded from gating per request
            setBtnState(printBtn, hasSelection);
            setBtnState(removeOrdersBtn, hasSelection);
            setBtnState(removeInvBtn, hasEligibleForInventory);
            setBtnState(printLabelsBtn, hasSelection);
        }
        // Toggle selection of all currently visible (filtered) orders
        function toggleSelectVisible() {
            // Always treat filteredOrders as the currently visible set (may be empty)
            const visible = filteredOrders;
            const cb = document.getElementById('selectVisibleCheckbox');
            if (!cb) return;
            if (!visible.length) return;
            if (cb.checked) {
                // Select all visible
                visible.forEach(o => selectedOrders.add(String(o.OrderID)));
            } else {
                // Deselect only visible, leave hidden selections untouched
                const visibleIdSet = new Set(visible.map(o => String(o.OrderID)));
                for (const id of Array.from(selectedOrders)) {
                    if (visibleIdSet.has(String(id))) selectedOrders.delete(id);
                }
            }
            updateSelectedCount();
            updateOrderCardSelection();
        }
        let filteredOrders = [];
        async function loadOrders() {
            const container = document.getElementById('ordersTableContainer');
            container.innerHTML = '<p>Loading orders...</p>';
            try {
                const { data: ordersRaw, error } = await supabase
                    .from('Orders')
                    .select('*')
                    .order('OrderID', { ascending: false });
                if (error) throw error;
                if (!ordersRaw || ordersRaw.length === 0) {
                    container.innerHTML = '<p>No orders found.</p>';
                    return;
                }
                orders = ordersRaw;
                filteredOrders = ordersRaw;
                renderOrders();
                updateSelectedCount();
            } catch (err) {
                container.innerHTML = `<p style="color:red;">Error loading orders: ${err.message}</p>`;
            }
        }

        function filterOrders() {
    // Reset selection whenever filters/search change
    if (selectedOrders && selectedOrders.size) {
        selectedOrders.clear();
    }
    const search = document.getElementById('searchInput').value.trim().toLowerCase();
    const platform = document.getElementById('platformFilter').value;
    const retailer = document.getElementById('retailerFilter').value;
    filteredOrders = orders.filter(o => {
        let match = true;
        if (search) {
            // Helper to safely include
            const incl = (v) => v !== undefined && v !== null && v.toString().toLowerCase().includes(search);
            // Parse customer and items safely
            let customerObj = {};
            try { customerObj = typeof o.Customer === 'object' ? (o.Customer||{}) : JSON.parse(o.Customer||'{}'); } catch {}
            let itemsArr = [];
            try { itemsArr = Array.isArray(o.Items) ? o.Items : JSON.parse(o.Items||'[]'); } catch {}
            const fields = [
                o.OrderID, o.OrderNumber,
                o.Retailer, o.Platform,
                o.Notes, o.CustomerMessages,
                o.CustomerName,
                customerObj.name, customerObj.address1, customerObj.address2,
                customerObj.city, customerObj.state, customerObj.zipCode, customerObj.country
            ];
            // Add item fields
            if (Array.isArray(itemsArr)) {
                itemsArr.forEach(it => { fields.push(it?.SKU, it?.Name); });
            }
            match = fields.some(incl);
        }
        if (platform) {
            // Compare lowercased, and handle Shopify(TikTok) edge case
            const plat = (o.Platform || '').toLowerCase();
            const filterPlat = platform.toLowerCase();
            if (plat !== filterPlat) match = false;
        }
        if (retailer && o.Retailer !== retailer) match = false;
        return match;
    });
    renderOrders();
    // Refresh selection-dependent UI (counts, button states, banner)
    updateSelectedCount();
    updateOrderCardSelection();
}

        function renderOrders() {
            const container = document.getElementById('ordersTableContainer');
            let cardsHtml = '';
            filteredOrders.forEach((order, idx) => {
                // Customer collapsible
                let customerToggleId = `customer-toggle-${idx}`;
                let customerBlockId = `customer-block-${idx}`;
                let customerHtml = '';
                try {
                    const customerObj = typeof order.Customer === 'object' ? order.Customer : JSON.parse(order.Customer);
                    customerHtml = `<div class='customer-toggle' id='${customerToggleId}' style='cursor:pointer; color:#4DBA93; font-weight:600; margin-bottom:6px; display:inline-block;' onclick=\"toggleSection('${customerBlockId}','${customerToggleId}-arrow')\">Customer<span id='${customerToggleId}-arrow' class='toggle-arrow'>▼</span></div><div id='${customerBlockId}' class='customer-block' style='display:none; margin-top:8px;'>
                        <div style=\"margin-bottom:4px;\"><strong>Name:</strong> ${customerObj.name || ''}</div>
                        <div style=\"margin-bottom:4px;\"><strong>Address 1:</strong> ${customerObj.address1 || ''}</div>
                        ${customerObj.address2 ? `<div style=\\"margin-bottom:4px;\\"><strong>Address 2:</strong> ${customerObj.address2}</div>` : ''}
                        <div style=\"margin-bottom:4px;\"><strong>City:</strong> ${customerObj.city || ''}</div>
                        <div style=\"margin-bottom:4px;\"><strong>State:</strong> ${customerObj.state || ''}</div>
                        <div style=\"margin-bottom:4px;\"><strong>Zip Code:</strong> ${customerObj.zipCode || ''}</div>
                        <div style=\"margin-bottom:4px;\"><strong>Country:</strong> ${customerObj.country || ''}</div>
                    </div>`;
                } catch (e) {
                    customerHtml = '<span style="color:#e74c3c;">Error parsing customer</span>';
                }
                let itemsHtml = '';
                let itemsToggleId = `items-toggle-${idx}`;
                let itemsListId = `items-list-${idx}`;
                try {
                    const itemsArr = Array.isArray(order.Items) ? order.Items : JSON.parse(order.Items);
                    if (Array.isArray(itemsArr)) {
                        itemsHtml = `<div class='items-toggle' id='${itemsToggleId}' style='cursor:pointer; color:#4DBA93; font-weight:600; margin-bottom:6px; display:inline-block;' onclick="toggleSection('${itemsListId}','${itemsToggleId}-arrow')">Items<span id='${itemsToggleId}-arrow' class='toggle-arrow'>▼</span></div><div id='${itemsListId}' class='items-list' style='display:none; margin-top:8px;'>` +
                            itemsArr.map(item => `
                                <div style=\"margin-bottom:6px; padding:6px; background:#f1f3f4; border-radius:4px;\">
                                    <strong>SKU:</strong> ${item.SKU ? `<a href=\"/admin/ProductInfo.html?sku=${encodeURIComponent(item.SKU)}\" target=\"_blank\">${item.SKU}</a>` : ''}<br>
                                    <strong>Name:</strong> ${item.Name || ''}<br>
                                    <strong>Quantity:</strong> ${item.Quantity || 0}
                                </div>
                            `).join('') + '</div>';
                    } else {
                        itemsHtml = '<span style="color:#e74c3e;">Invalid items format</span>';
                    }
                } catch (e) {
                    itemsHtml = '<span style="color:#e74c3c;">Error parsing items</span>';
                }
                cardsHtml += `<div class="order-card${selectedOrders.has(String(order.OrderID)) ? ' selected' : ''}" id="order-card-${idx}" data-order-id="${order.OrderID}" style=" border-radius:12px; box-shadow:0 4px 6px rgba(0,0,0,0.1); margin-bottom:24px; padding:24px; position:relative;">
                    ${(order.InventoryRemoved || getPlatformBadgeHtml(order.Platform)) ? `<span style=\"position:absolute; top:14px; right:18px; z-index:1; display:flex; gap:8px; align-items:center;\">${order.InventoryRemoved ? `<span class=\"inv-removed-badge\" title=\"Inventory already decremented\">Inventory Removed</span>` : ''}${getPlatformBadgeHtml(order.Platform) || ''}</span>` : ''}
                    <h2 style="margin-top:0; color:#4DBA93; font-size:1.3rem;">
                        ${order.Link ? `<a href="${order.Link}" target="_blank" class="order-link">Order #${order.OrderID}</a>` : `Order #${order.OrderID}`}
                    </h2>
                    <div style="margin-bottom:10px;"><strong>Retailer:</strong> ${order.Retailer || ''}</div>
                    <div style="margin-bottom:10px;">${customerHtml}</div>
                    <div style="margin-bottom:10px;">${itemsHtml}</div>
                    <div style="margin-bottom:10px;"><strong>Notes:</strong> <span class="notes">${order.Notes || ''}</span></div>
                    <div style="margin-bottom:10px;">
                        <strong>Customer Message:</strong>
                        <span class="customer-messages">${order.CustomerMessages || ''}</span>
                    </div>
                    <button class="btn" style="position:absolute; bottom:18px; right:18px; padding:6px 18px; font-size:15px; border-radius:6px; background:#4DBA93;" onclick="openEditOrderModal('${order.OrderID}')">Edit</button>
                </div>`;
            });
            container.innerHTML = cardsHtml;
            // Whole-card toggle selection with guards for interactive elements
            const interactiveSelector = 'a, button, .items-toggle, .customer-toggle, input, textarea, select, label';
            container.querySelectorAll('.order-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    if (e.target.closest(interactiveSelector)) return; // ignore clicks on interactive controls
                    const id = card.getAttribute('data-order-id');
                    toggleOrderSelection(id);
                });
            });
        }
        // Toggle a collapsible block and flip the arrow between ▼ and ▲
        function toggleSection(contentId, arrowId) {
            const block = document.getElementById(contentId);
            if (!block) return;
            block.classList.toggle('show');
            const arrow = document.getElementById(arrowId);
            if (arrow) {
                const open = block.classList.contains('show');
                arrow.textContent = open ? '▲' : '▼';
            }
        }
        function renderOrderStatsBanner() {
            const banner = document.getElementById('orderStatsBanner');
            if (!banner) return;
            // Use filteredOrders directly; if no results, visible is []
            const visible = filteredOrders;
            const totalVisible = visible.length;
            const platformCounts = {};
            const retailerCounts = {};
            let visibleSelectedCount = 0;
            const selectedIdStrSet = new Set(Array.from(selectedOrders).map(id => String(id)));
            visible.forEach(o => {
                if (o.Platform) platformCounts[o.Platform] = (platformCounts[o.Platform]||0)+1;
                if (o.Retailer) retailerCounts[o.Retailer] = (retailerCounts[o.Retailer]||0)+1;
                if (selectedIdStrSet.has(String(o.OrderID))) visibleSelectedCount++;
            });
            // Master checkbox + stats
            let html = `<label style=\"display:inline-flex;align-items:center;font-weight:600;gap:8px;cursor:pointer;\">`+
                `<input type=\"checkbox\" id=\"selectVisibleCheckbox\" onchange=\"toggleSelectVisible()\" style=\"transform:scale(1.25);cursor:pointer;\">`+
                `<span>Select (${selectedOrders.size})</span>`+
                `</label>`;
            // Replaced selected counts with Total Orders (visible)
            html += `<span style='margin-left:22px;font-size:1.08em;font-weight:600;'>Total Orders: ${totalVisible}</span>`;
            // Selected count now shown inline next to the Select checkbox label
            if (Object.keys(platformCounts).length) {
                html += `<span style='margin-left:18px;'>` + Object.entries(platformCounts)
                    .map(([p,c])=>`<span class="platform-badge ${platformClass(p)}" style="margin-right:7px;">${p}: <b>${c}</b></span>`)
                    .join('') + `</span>`;
            }
            if (Object.keys(retailerCounts).length) {
                html += `<span style='margin-left:18px;'>` + Object.entries(retailerCounts).map(([r,c])=>`<span style='background:#fff3;padding:3px 10px;border-radius:6px;margin-right:7px;'>${r}: <b>${c}</b></span>`).join('') + `</span>`;
            }
            banner.innerHTML = html;
            // Apply tri-state (indeterminate) logic AFTER inserting the checkbox into DOM
            const cb = document.getElementById('selectVisibleCheckbox');
            if (cb) {
                if (!totalVisible) {
                    cb.checked = false;
                    cb.indeterminate = false;
                    cb.disabled = true;
                    cb.style.cursor = 'not-allowed';
                } else if (visibleSelectedCount === 0) {
                    cb.checked = false;
                    cb.indeterminate = false;
                    cb.disabled = false;
                } else if (visibleSelectedCount === totalVisible) {
                    cb.checked = true;
                    cb.indeterminate = false;
                    cb.disabled = false;
                } else {
                    cb.checked = false; // not fully selected
                    cb.indeterminate = true; // some selected
                    cb.disabled = false;
                }
            }
            // If there are zero visible orders, consider showing a friendly note in orders container if it's empty.
            if (!totalVisible) {
                const container = document.getElementById('ordersTableContainer');
                if (container && !container.innerHTML.trim()) {
                    container.innerHTML = '<p style="margin:12px 4px;color:#444;font-weight:500;">No orders match the current filters.</p>';
                }
            }
        }
        const origRenderOrders = renderOrders;
        renderOrders = function() { origRenderOrders(); renderOrderStatsBanner(); };
        const origLoadOrders = loadOrders;
        loadOrders = async function() { await origLoadOrders(); renderOrderStatsBanner(); };
        loadOrders();

        // Modal for editing order
        let currentEditOrder = null;
        async function openEditOrderModal(orderId) {
            const order = orders.find(o => o.OrderID == orderId);
            if (!order) return;
            currentEditOrder = order;
            // Fetch retailer options from Users table
            const retailerSelect = document.getElementById('editRetailer');
            retailerSelect.innerHTML = '<option value="">Loading...</option>';
            let retailerOptions = '';
            try {
                const { data: users, error } = await supabase
                    .from('Users')
                    .select('display_name, Role')
                    .in('Role', ['service_role', 'client']);
                if (error) throw error;
                if (users && users.length > 0) {
                    retailerOptions = users.map(u => `<option value="${u.display_name}">${u.display_name}</option>`).join('');
                }
            } catch (e) {
                retailerOptions = '';
            }
            retailerSelect.innerHTML = `<option value="">-- Select Retailer --</option>` + retailerOptions;
            retailerSelect.value = order.Retailer || '';
            // Fill other modal fields
            document.getElementById('editOrderID').value = order.OrderID;
            document.getElementById('editPlatform').value = order.Platform || '';
            document.getElementById('editNotes').value = order.Notes || '';
            document.getElementById('editCustomerMessages').value = order.CustomerMessages || '';
            // Populate Items table
            let itemsArr = [];
            try {
                itemsArr = Array.isArray(order.Items) ? order.Items : JSON.parse(order.Items);
            } catch { itemsArr = []; }
            const itemsTable = document.getElementById('editItemsTableBody');
            itemsTable.innerHTML = '';
            itemsArr.forEach((item, idx) => {
                itemsTable.innerHTML += `
                    <tr>
                        <td>${item.SKU || ''}</td>
                        <td>${item.Name || ''}</td>
                        <td>${item.Quantity || 0}</td>
                        <td><button type="button" onclick="removeEditItemRow(${idx})" style="color:#e74c3c; background:none; border:none; font-size:18px; cursor:pointer;">&times;</button></td>
                    </tr>
                `;
            });
            if (itemsArr.length === 0) {
                itemsTable.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#aaa;">No items</td></tr>';
            }
            // Store items in window for editing
            window._editItemsArr = itemsArr;

            // Populate Customer fields
            let customerObj = {};
            try {
                customerObj = typeof order.Customer === 'object' ? order.Customer : JSON.parse(order.Customer);
            } catch { customerObj = {}; }
            document.getElementById('editCustomerName').value = customerObj.name || '';
            document.getElementById('editCustomerAddress1').value = customerObj.address1 || '';
            document.getElementById('editCustomerAddress2').value = customerObj.address2 || '';
            document.getElementById('editCustomerCity').value = customerObj.city || '';
            document.getElementById('editCustomerState').value = customerObj.state || '';
            document.getElementById('editCustomerZipCode').value = customerObj.zipCode || '';
            document.getElementById('editCustomerCountry').value = customerObj.country || '';
            document.getElementById('editOrderModal').style.display = 'block';
        }

        async function saveEditOrder() {
            if (!currentEditOrder) return;
            const orderId = currentEditOrder.OrderID;
            const retailer = document.getElementById('editRetailer').value;
            const platform = document.getElementById('editPlatform').value;
            const notes = document.getElementById('editNotes').value;
            const customerMessages = document.getElementById('editCustomerMessages').value;
            // Gather items from table as plain text
            const items = [];
            const rows = document.querySelectorAll('#editItemsTableBody tr');
            for (let i = 0; i < rows.length; i++) {
                const tds = rows[i].querySelectorAll('td');
                if (tds.length >= 3) {
                    items.push({
                        SKU: tds[0].textContent.trim(),
                        Name: tds[1].textContent.trim(),
                        Quantity: Number(tds[2].textContent.trim()) || 0
                    });
                }
            }
            // Gather customer fields
            const customer = {
                name: document.getElementById('editCustomerName').value,
                address1: document.getElementById('editCustomerAddress1').value,
                address2: document.getElementById('editCustomerAddress2').value,
                city: document.getElementById('editCustomerCity').value,
                state: document.getElementById('editCustomerState').value,
                zipCode: document.getElementById('editCustomerZipCode').value,
                country: document.getElementById('editCustomerCountry').value
            };
            document.getElementById('editOrderSaveStatus').textContent = 'Saving...';
            try {
                const { error } = await supabase
                    .from('Orders')
                    .update({
                        Retailer: retailer,
                        Platform: platform,
                        Notes: notes,
                        CustomerMessages: customerMessages,
                        Items: items,
                        Customer: customer
                    })
                    .eq('OrderID', orderId);
                if (error) throw error;
                document.getElementById('editOrderSaveStatus').textContent = 'Saved!';
                setTimeout(() => { document.getElementById('editOrderSaveStatus').textContent = ''; }, 1500);
                // Update local data and re-render
                currentEditOrder.Retailer = retailer;
                currentEditOrder.Platform = platform;
                currentEditOrder.Notes = notes;
                currentEditOrder.CustomerMessages = customerMessages;
                currentEditOrder.Items = items;
                currentEditOrder.Customer = customer;
                renderOrders();
                closeEditOrderModal();
            } catch (err) {
                document.getElementById('editOrderSaveStatus').textContent = 'Error saving!';
            }
        }

        function closeEditOrderModal() {
            document.getElementById('editOrderModal').style.display = 'none';
        }
        async function printPicklistAndPackingSlips() {
            if (selectedOrders.size === 0) {
                alert('Please select at least one order to print.');
                return;
            }
            // --- Master Picklist ---
            const selectedOrdersData = orders.filter(order => selectedOrders.has(String(order.OrderID)));
            // Fetch default customer messages per retailer
            const retailers = Array.from(new Set(selectedOrdersData.map(o => o.Retailer).filter(Boolean)));
            const defaultMsgByRetailer = {};
            if (retailers.length > 0) {
                try {
                    const { data: usersMsgData, error: usersMsgError } = await supabase
                        .from('Users')
                        .select('display_name, "DefaultCustomerMessage"')
                        .in('display_name', retailers);
                    if (!usersMsgError && usersMsgData) {
                        usersMsgData.forEach(u => {
                            defaultMsgByRetailer[u.display_name] = u.DefaultCustomerMessage || '';
                        });
                    }
                } catch (e) {
                    // ignore fetch errors; fallback to empty default
                }
            }
            // Aggregate SKUs split by plus sign and map to product names
            const skuMap = new Map();
            const nameMap = new Map();
            selectedOrdersData.forEach(order => {
                try {
                    const itemsArr = Array.isArray(order.Items) ? order.Items : JSON.parse(order.Items);
                    itemsArr.forEach(item => {
                        if (item.SKU) {
                            skuMap.set(item.SKU, (skuMap.get(item.SKU) || 0) + (item.Quantity || 0));
                            nameMap.set(item.SKU, item.Name || 'Unknown Product');
                        }
                    });
                } catch (e) {}
            });
            const picklistItems = Array.from(skuMap.entries()).map(([sku, quantity]) => ({
                sku: sku,
                name: nameMap.get(sku) || 'Unknown Product',
                quantity: quantity
            }));
            let picklistHtml = `
                <div style="font-family: Arial, sans-serif; padding: 20px; background: white;">
                    <div style="text-align: center; border-bottom: 3px solid #000; padding-bottom: 15px; margin-bottom: 25px;">
                        <h2 style="margin:0; font-size:2.5rem; color:indigo; text-shadow:2px 2px 4px rgba(0,0,0,0.3);">Master Picklist</h2>
                    </div>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 16px;">
                        <thead><tr style='background:#f8f9fa;'><th style='padding:12px 8px;'>SKU</th><th style='padding:12px 8px;'>Name</th><th style='padding:12px 8px;'>Quantity</th></tr></thead>
                        <tbody>
                            ${picklistItems.map(item => `<tr><td style='padding:12px 8px;'>${item.sku}</td><td style='padding:12px 8px;'>${item.name}</td><td style='padding:12px 8px;'>${item.quantity}</td></tr>`).join('')}
                        </tbody>
                    </table>
                </div>`;
            // --- Packing Slips ---
            let packingSlipsHtml = '';
            selectedOrdersData.forEach((order, index) => {
                let customerObj = {};
                try {
                    customerObj = typeof order.Customer === 'object' ? order.Customer : JSON.parse(order.Customer);
                } catch (e) {}
                let customerAddress = [
                    customerObj.address1,
                    customerObj.address2,
                    customerObj.city,
                    customerObj.state,
                    customerObj.zipCode,
                    customerObj.country
                ].filter(Boolean).join(', ');
                let itemsArr = [];
                try {
                    itemsArr = Array.isArray(order.Items) ? order.Items : JSON.parse(order.Items);
                } catch (e) {}
                // Retailer logo logic
                let logoUrl = '';
                let logoAlt = '';
                const shop = (order.Retailer || '').toLowerCase();
                if (shop.includes('desesh')) {
                    logoUrl = 'https://desesh.com/cdn/shop/files/Desesh_Logo_-_Zero_Waste_Plastic_Free_Sustainable_Kitchen_Bathroom_Laundry.png?v=1669413380&width=500';
                    logoAlt = 'Desesh Logo';
                } else if (shop.includes('river organics')) {
                    logoUrl = 'https://riverorganics.org/cdn/shop/files/RO_Secondary_Logos-14_98f44cae-12e5-46ee-9391-5e0e168f2427.png?v=1735735433&width=255';
                    logoAlt = 'River Organics Logo';
                } else if (shop.includes('j&l naturals')) {
                    logoUrl = 'https://www.jnlnaturals.com/cdn/shop/files/JL_PNG_TRAN_BLACK_FINAL_Cropped_outlined.png?v=1697910301&width=300';
                    logoAlt = 'JNL Naturals Logo';
                }
                const fallbackMsg = (order.CustomerMessages && String(order.CustomerMessages).trim()) || defaultMsgByRetailer[order.Retailer] || '';
                packingSlipsHtml += `
                    <div style="font-family: Arial, sans-serif; padding: 20px; background: white; ${index > 0 ? 'page-break-before: always;' : ''}">
                        <div style="margin-bottom: 25px; position: relative; min-height: 60px;">
                            ${logoUrl ? `<img src='${logoUrl}' alt='${logoAlt}' style='max-width:180px; position:absolute; top:0; right:0; margin-bottom:12px;' />` : ''}
                            <div style="font-size:1.2rem; font-weight:700; color:#2c3e50;"><strong>Order #${order.OrderID}</strong></div>
                            <div><strong>Fulfillment Date:</strong> ${new Date().getMonth()+1+'/'+new Date().getDate()+'/'+new Date().getFullYear()}</div>
                            <div><strong>Platform:</strong> ${order.Platform || ''}</div>
                            <div><strong>Customer:</strong> ${customerObj.name || ''}</div>
                            <div><strong>Address:</strong> ${customerAddress || ''}</div>
                        </div>
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 16px;">
                            <thead><tr style='background:#f8f9fa;'><th style='padding:12px 8px;'>SKU</th><th style='padding:12px 8px;'>Name</th><th style='padding:12px 8px;'>Quantity</th></tr></thead>
                            <tbody>
                                ${itemsArr.map(item => `<tr><td style='padding:12px 8px;'>${item.SKU}</td><td style='padding:12px 8px;'>${item.Name}</td><td style='padding:12px 8px;'>${item.Quantity}</td></tr>`).join('')}
                            </tbody>
                        </table>
                        <div style="padding: 10px;">
                            <p style="margin: 0; font-size: 14px; font-weight: 600; color: #ba4d74;">
                                ${fallbackMsg}
                            </p>
                        </div>
                    </div>`;
            });
            // --- Print both in one window ---
            const printWindow = window.open('', '_blank');
            printWindow.document.write(picklistHtml + '<div style="page-break-after: always;"></div>' + packingSlipsHtml);
            printWindow.document.close();
            printWindow.print();
        }

        // Remove selected orders from Supabase and update UI
        async function removeSelectedOrders() {
            if (selectedOrders.size === 0) {
                alert('Please select at least one order to remove.');
                return;
            }
            if (!confirm('Are you sure you want to remove the selected orders? This action cannot be undone.')) {
                return;
            }
            try {
                // Normalize to actual OrderID types from loaded orders
                const selectedIds = orders
                    .filter(o => selectedOrders.has(String(o.OrderID)))
                    .map(o => o.OrderID);
                if (selectedIds.length === 0) {
                    // Fallback if selection holds numeric ids
                    const byId = new Set(Array.from(selectedOrders));
                    orders.forEach(o => { if (byId.has(o.OrderID)) selectedIds.push(o.OrderID); });
                }
                const { error } = await supabase
                    .from('Orders')
                    .delete()
                    .in('OrderID', selectedIds);
                if (error) throw error;
                // Update local arrays
                const idSet = new Set(selectedIds.map(String));
                orders = orders.filter(o => !idSet.has(String(o.OrderID)));
                filteredOrders = filteredOrders.filter(o => !idSet.has(String(o.OrderID)));
                selectedOrders.clear();
                renderOrders();
                renderOrderStatsBanner();
                updateSelectedCount();
                alert(`Removed ${selectedIds.length} order(s).`);
            } catch (err) {
                alert('Error removing orders: ' + (err?.message || String(err)));
            }
        }
        // Close modals on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' || e.key === 'Esc') {
                const resultsModal = document.getElementById('invRemovalResultsModal');
                const editModal = document.getElementById('editOrderModal');
                const addModal = document.getElementById('addItemModal');
                const shipModal = document.getElementById('shippingLabelsModal');
                // Priority: close results modal first
                if (resultsModal && resultsModal.style.display !== 'none') {
                    closeInvRemovalResultsModal();
                    return;
                }
                if (shipModal && shipModal.style.display !== 'none') {
                    closeShippingLabelsModal();
                    return;
                }
                // If Add Item modal is open, close only it (do not close Edit modal behind it)
                if (addModal && addModal.style.display !== 'none') {
                    closeAddItemModal();
                    return;
                }
                // Otherwise, close Edit Order modal if open
                if (editModal && editModal.style.display !== 'none') {
                    closeEditOrderModal();
                }
            }
        });

        // Inventory removal results modal helpers
        function showInvRemovalResultsModal(results, successCount, errorCount, issues) {
            const modal = document.getElementById('invRemovalResultsModal');
            const body = document.getElementById('invRemovalResultsBody');
            if (!modal || !body) return;
            // Build summary and table
            const total = results.length;
            const summaryHtml = `<div style="margin-bottom:12px;font-weight:600;color:#2c3e50;">Processed ${total} SKU(s). Successes: ${successCount}, Errors: ${errorCount}</div>`;
            let tableHtml = '<div style="max-height:50vh;overflow:auto;border:1px solid #eee;border-radius:8px;">';
            tableHtml += '<table style="width:100%;border-collapse:collapse;font-size:0.98rem;">';
            tableHtml += '<thead><tr style="background:#f8f9fa;"><th style="padding:8px 10px;text-align:left;">SKU</th><th style="padding:8px 10px;text-align:left;">Removed</th><th style="padding:8px 10px;text-align:left;">From → To</th><th style="padding:8px 10px;text-align:left;">Orders</th><th style="padding:8px 10px;text-align:left;">Status</th><th style="padding:8px 10px;text-align:left;">Message</th></tr></thead><tbody>';
            results.forEach(r => {
                const fromTo = (r.fromQty === null || r.toQty === null) ? '—' : `${r.fromQty} → ${r.toQty}`;
                const statusColor = r.status === 'success' ? '#16a34a' : '#dc2626';
                const ordersStr = (r.orderIds && r.orderIds.length) ? r.orderIds.join(', ') : '';
                const skuLink = r.sku ? `<a href="/admin/ProductInfo.html?sku=${encodeURIComponent(r.sku)}" target="_blank">${r.sku}</a>` : '';
                tableHtml += `<tr style="border-top:1px solid #eee;"><td style="padding:8px 10px;">${skuLink}</td><td style="padding:8px 10px;">${r.removed ?? ''}</td><td style="padding:8px 10px;">${fromTo}</td><td style="padding:8px 10px;">${ordersStr}</td><td style="padding:8px 10px;color:${statusColor};font-weight:600;">${r.status}</td><td style="padding:8px 10px;">${r.message || ''}</td></tr>`;
            });
            tableHtml += '</tbody></table></div>';
            const issuesHtml = (issues && issues.length) ? `<div style="margin-top:10px;color:#6b7280;">Additional issues: ${issues.join('; ')}</div>` : '';
            body.innerHTML = summaryHtml + tableHtml + issuesHtml;
            modal.style.display = 'block';
        }
        function closeInvRemovalResultsModal() {
            const modal = document.getElementById('invRemovalResultsModal');
            if (modal) modal.style.display = 'none';
        }
        // Decrement inventory quantities based on selected orders
        async function removeProductsFromInventory() {
            if (selectedOrders.size === 0) {
                alert('Please select at least one order to remove products from inventory.');
                return;
            }
            if (!confirm('Decrease inventory for all items in the selected orders?')) {
                return;
            }
            // Build SKU -> array of { orderID, quantity }
            const skuMap = new Map();
            // Consider only selected orders that have not yet had inventory removed
            const selected = orders.filter(o => (selectedOrders.has(o.OrderID) || selectedOrders.has(String(o.OrderID))));
            const skippedAlreadyRemoved = [];
            const eligible = selected.filter(o => {
                if (o.InventoryRemoved) { skippedAlreadyRemoved.push(o.OrderID); return false; }
                return true;
            });
            if (eligible.length === 0) {
                alert('All selected orders already have inventory removed. Nothing to do.');
                return;
            }
            eligible.forEach(order => {
                let itemsArr = [];
                try { itemsArr = Array.isArray(order.Items) ? order.Items : JSON.parse(order.Items||'[]'); } catch {}
                (itemsArr||[]).forEach(it => {
                    const sku = it?.SKU;
                    const qty = Number(it?.Quantity) || 0;
                    if (!sku || qty <= 0) return;
                    if (!skuMap.has(sku)) skuMap.set(sku, []);
                    skuMap.get(sku).push({ orderID: order.OrderID, quantity: qty });
                });
            });
            if (skuMap.size === 0) {
                alert('No SKUs found in selected orders.');
                return;
            }
            // Batch fetch products by SKU with Quantity column
            const allSkus = Array.from(skuMap.keys());
            const { data: productsData, error: productsError } = await supabase
                .from('Products')
                .select('ProductSKU,Quantity,Name')
                .in('ProductSKU', allSkus);
            if (productsError) {
                alert('Error loading products: ' + (productsError.message || String(productsError)));
                return;
            }
            const productLookup = new Map();
            (productsData || []).forEach(prod => productLookup.set(prod.ProductSKU, prod));
            let successCount = 0;
            let errorCount = 0;
            const issues = [];
            const results = [];
            const logRows = [];
            const updatedBy = (typeof CurrentUserDisplayName !== 'undefined' && CurrentUserDisplayName) ? CurrentUserDisplayName : ((window.user && (window.user.user_metadata?.display_name || window.user.email)) || '');
            for (const [sku, removals] of skuMap.entries()) {
                const totalToRemove = removals.reduce((sum, r) => sum + (Number(r.quantity)||0), 0);
                if (!totalToRemove) continue;
                const prod = productLookup.get(sku);
                const orderIds = Array.from(new Set(removals.map(r => r.orderID)));
                if (!prod) {
                    errorCount++;
                    issues.push(`${sku}: not found`);
                    results.push({ sku, removed: totalToRemove, fromQty: null, toQty: null, orderIds, status: 'error', message: 'Product not found' });
                    continue;
                }
                const currentQty = Number(prod.Quantity) || 0;
                const newQuantity = currentQty - totalToRemove; 
                const { error: updateError } = await supabase
                    .from('Products')
                    .update({ Quantity: newQuantity })
                    .eq('ProductSKU', sku);
                if (updateError) {
                    errorCount++;
                    issues.push(`${sku}: ${updateError.message || String(updateError)}`);
                    results.push({ sku, removed: totalToRemove, fromQty: currentQty, toQty: currentQty, orderIds, status: 'error', message: updateError.message || String(updateError) });
                } else {
                    successCount++;
                    // Queue inventory update log (negative change, include order IDs)
                    const orderIdsStr = orderIds.join(', ');
                    logRows.push({
                        log: `Decremented inventory by ${totalToRemove} due to orders: ${orderIdsStr}`,
                        updated_by: updatedBy,
                        SKU: sku,
                        QuantityChanged: -totalToRemove
                    });
                    results.push({ sku, removed: totalToRemove, fromQty: currentQty, toQty: newQuantity, orderIds, status: 'success', message: 'Updated successfully' });
                }
            }
            // Insert inventory logs if any successful updates
            if (logRows.length > 0) {
                const { error: logError } = await supabase
                    .from('inventoryupdatelogs')
                    .insert(logRows);
                if (logError) {
                    issues.push(`Log insert failed: ${logError.message || String(logError)}`);
                }
            }
            if (skippedAlreadyRemoved.length) {
                issues.push(`Skipped orders already flagged InventoryRemoved: ${skippedAlreadyRemoved.join(', ')}`);
            }
            // Flag eligible selected orders as InventoryRemoved = true
            try {
                const selectedIds = eligible.map(o => o.OrderID);
                if (selectedIds.length > 0) {
                    const { error: orderFlagError } = await supabase
                        .from('Orders')
                        .update({ InventoryRemoved: true })
                        .in('OrderID', selectedIds);
                    if (orderFlagError) {
                        issues.push(`Failed to update InventoryRemoved on orders: ${orderFlagError.message || String(orderFlagError)}`);
                    } else {
                        // Update local cache
                        const idSet = new Set(selectedIds.map(String));
                        orders.forEach(o => { if (idSet.has(String(o.OrderID))) o.InventoryRemoved = true; });
                    }
                }
            } catch (e) {
                issues.push(`Error flagging orders as InventoryRemoved: ${e?.message || String(e)}`);
            }
            // Show results modal with detailed rows
            showInvRemovalResultsModal(results, successCount, errorCount, issues);
        }
        /* ===================== Shipping Labels: Per-Order Modal Wizard ===================== */
        const DEFAULT_BOX_SKU = 'PDM6x9-250';
    const DEFAULT_BOX_DIMENSIONS = { length: '6', width: '9', height: '1' };
    let shippingLabelPackages = {}; // { orderId: [ { boxSku, length, width, height, weight } ] }
    let productWeightCache = {}; // SKU -> weight (oz)
    let shippingModalOrderIds = [];
    let currentShippingModalIndex = 0;
    let shippingRatesByOrderId = {};
    let shippingRateErrors = {};
    let shippingShipmentIds = {};
    let shippingSummaryOrders = [];
    let selectedShippingRates = {};
    let boxesList = [];
        async function ensureProductWeightsForSkus(skus) {
            const needed = skus.filter(s => productWeightCache[s] === undefined);
            if (!needed.length) return;
            try {
                const { data, error } = await supabase
                    .from('Products')
                    .select('ProductSKU, "Product Weight(oz)"')
                    .in('ProductSKU', needed);
                if (!error && data) {
                    data.forEach(row => {
                        const w = Number(row['Product Weight(oz)']);
                        if (!isNaN(w)) productWeightCache[row.ProductSKU] = w;
                    });
                }
            } catch(e){ /* ignore */ }
        }
        async function loadBoxesList() {
            try {
                const { data, error } = await supabase
                    .from('Boxes')
                    .select('SKU, "Dimensions"')
                    .order('SKU', { ascending: true });
                if (error) {
                    console.error('Error loading boxes:', error);
                    boxesList = [];
                } else {
                    boxesList = (data || []).map(row => ({
                        sku: String(row.SKU || '').trim(),
                        dimensions: String((row['Dimensions'] !== undefined ? row['Dimensions'] : row.Dimensions) || '').trim()
                    }));
                }
            } catch (err) {
                console.error('Exception loading boxes:', err);
                boxesList = [];
            }
            return boxesList;
        }
        function parseBoxDimensions(dimStr) {
            const matches = String(dimStr || '').match(/\d+(?:\.\d+)?/g) || [];
            return {
                length: matches[0] ? matches[0] : '',
                width: matches[1] ? matches[1] : '',
                height: matches[2] ? matches[2] : ''
            };
        }
        function getDefaultBoxPreset() {
            if (boxesList && boxesList.length) {
                const defaultMatch = boxesList.find(b => String(b.sku || '').trim().toUpperCase() === DEFAULT_BOX_SKU.toUpperCase());
                if (defaultMatch) {
                    const dims = parseBoxDimensions(defaultMatch.dimensions);
                    return {
                        boxSku: String(defaultMatch.sku || '').trim(),
                        length: dims.length || DEFAULT_BOX_DIMENSIONS.length,
                        width: dims.width || DEFAULT_BOX_DIMENSIONS.width,
                        height: dims.height || DEFAULT_BOX_DIMENSIONS.height
                    };
                }
                // Fallback to first available box in list
                const fallback = boxesList[0];
                const dims = parseBoxDimensions(fallback.dimensions);
                return {
                    boxSku: String(fallback.sku || '').trim(),
                    length: dims.length || DEFAULT_BOX_DIMENSIONS.length,
                    width: dims.width || DEFAULT_BOX_DIMENSIONS.width,
                    height: dims.height || DEFAULT_BOX_DIMENSIONS.height
                };
            }
            return {
                boxSku: DEFAULT_BOX_SKU,
                length: DEFAULT_BOX_DIMENSIONS.length,
                width: DEFAULT_BOX_DIMENSIONS.width,
                height: DEFAULT_BOX_DIMENSIONS.height
            };
        }
        function createEmptyPackage() {
            const preset = getDefaultBoxPreset();
            return { boxSku: preset.boxSku, length: preset.length, width: preset.width, height: preset.height, weight: '' };
        }
        async function openShippingLabelsModal() {
            if (!selectedOrders.size) { alert('Select at least one order first.'); return; }
            cleanupShippingModals();
            shippingLabelPackages = {};
            shippingRatesByOrderId = {};
            shippingRateErrors = {};
            shippingShipmentIds = {};
            shippingSummaryOrders = [];
            selectedShippingRates = {};
            shippingModalOrderIds = [];
            currentShippingModalIndex = 0;
            const selectedIdStrings = new Set(Array.from(selectedOrders).map(id => String(id)));
            const selectedList = orders.filter(o => selectedIdStrings.has(String(o.OrderID)));
            if (!selectedList.length) {
                alert('Selected orders could not be loaded. Please refresh and try again.');
                return;
            }
            const boxes = await loadBoxesList();
            if (!boxes || boxes.length === 0) {
                alert('No boxes are defined. Please add entries to the Boxes table before creating shipping labels.');
                return;
            }
            shippingModalOrderIds = selectedList.map(o => o.OrderID);
            // Gather SKUs
            const allSkus = [];
            selectedList.forEach(o => {
                let items = [];
                try { items = Array.isArray(o.Items) ? o.Items : JSON.parse(o.Items||'[]'); } catch {}
                shippingLabelPackages[o.OrderID] = [ createEmptyPackage() ];
                (items||[]).forEach(it => { if (it && it.SKU) allSkus.push(it.SKU); });
            });
            if (allSkus.length) await ensureProductWeightsForSkus(Array.from(new Set(allSkus)));
            // Build a modal per order
            selectedList.forEach((o, idx) => buildSingleShippingModal(o, idx, selectedList.length));
            showShippingModalAt(0);
        }
        function cleanupShippingModals() {
            document.querySelectorAll('.shipping-labels-modal-wrapper').forEach(n => n.remove());
        }
        function buildSingleShippingModal(order, idx, total) {
            let customerObj = {};
            try { customerObj = typeof order.Customer === 'object' ? order.Customer : JSON.parse(order.Customer||'{}'); } catch {}
            const addr = [customerObj.address1, customerObj.address2, customerObj.city, customerObj.state, customerObj.zipCode, customerObj.country].filter(Boolean).join(', ');
            // Items & expected weight
            let itemsArr = [];
            try { itemsArr = Array.isArray(order.Items) ? order.Items : JSON.parse(order.Items||'[]'); } catch {}
            let expectedWeight = 0;
            const itemsRows = (itemsArr||[]).map(it => {
                const w = productWeightCache[it.SKU] !== undefined ? productWeightCache[it.SKU] : null;
                const qty = Number(it.Quantity)||0;
                if (w !== null) expectedWeight += w * qty;
                return `<tr>
                    <td style='padding:4px 6px;'>${it.SKU || ''}</td>
                    <td style='padding:4px 6px;'>${(it.Name||'').replace(/</g,'&lt;')}</td>
                    <td style='padding:4px 6px;'>${qty}</td>
                    <td style='padding:4px 6px;'>${w !== null ? w : '<span style="color:#999;">?</span>'}</td>
                </tr>`; }).join('');
            const itemsTableHtml = `<div style="margin:6px 0 12px 0; overflow-x:auto;">
                <table style="width:100%; border-collapse:collapse; font-size:12px; min-width:420px;">
                    <thead><tr style='background:#f0f4f7;'><th style='padding:5px 6px;text-align:left;'>SKU</th><th style='padding:5px 6px;text-align:left;'>Name</th><th style='padding:5px 6px;text-align:left;'>Qty</th><th style='padding:5px 6px;text-align:left;'>Wt (oz)</th></tr></thead>
                    <tbody>${itemsRows}</tbody>
                </table>
            </div>`;
            const expectedBadge = `<div style="font-size:12px; font-weight:600; color:#1e3a32; background:#e8f5f1; padding:4px 10px; border-radius:20px; display:inline-block;">Expected Weight: ${expectedWeight ? expectedWeight.toFixed(2) : '—'} oz</div>`;
            const packages = shippingLabelPackages[order.OrderID] || [];
            const pkgRows = packages.map((p,i)=>shippingPackageRowHtml(order.OrderID,i,p)).join('');
            const navHtml = `<div style='display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-top:16px;'>
                <div style='font-size:12px; color:#555;'>Order ${idx+1} of ${total}</div>
                <div style='display:flex; gap:10px;'>
                    <button class='btn' style='background:#e0e0e0; color:#2c3e50; padding:8px 18px; border-radius:7px;' onclick='closeShippingLabelsModal()'>Cancel</button>
                    ${idx>0 ? `<button class='btn' style='background:#888; padding:8px 18px; border-radius:7px;' onclick='showShippingModalAt(${idx-1})'>&larr; Previous</button>`: ''}
                    ${idx < total-1 ? `<button class='btn' id='shipNextBtn-${order.OrderID}' style='background:#2c3e50; padding:8px 18px; border-radius:7px;' onclick='goToNextShippingModal(${idx})' disabled>Save & Next &rarr;</button>` : `<button class='btn' id='shipFinishBtn-${order.OrderID}' style='background:#2c3e50; padding:8px 18px; border-radius:7px;' onclick='finishShippingModals("${order.OrderID}")' disabled>Finish</button>`}
                </div>
            </div>`;
            const html = `<div id='shippingLabelsModal-${order.OrderID}' class='shipping-labels-modal-wrapper' style='display:none; position:fixed; z-index:3700; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4);'>
                <div style='background:white; max-width:760px; width:92%; margin:50px auto; border-radius:14px; box-shadow:0 12px 40px rgba(0,0,0,0.22); padding:26px 30px 24px 30px; position:relative; max-height:85vh; overflow-y:auto;'>
                    <span onclick='closeShippingLabelsModal()' style='position:absolute; top:14px; right:18px; font-size:30px; color:#888; cursor:pointer;'>&times;</span>
                    <h2 style='margin:0 0 4px 0; font-size:1.45rem; color:#2c3e50;'>Shipping Labels - Order #${order.OrderID}</h2>
                    <div style='display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:8px;'>
                        ${order.Platform ? `<div class="platform-badge ${platformClass(order.Platform)}" style='font-size:11px;'>${order.Platform}</div>`:''}
                        ${order.Retailer ? `<div style='background:#f1f5f9; padding:4px 10px; border-radius:20px; font-size:11px; font-weight:600;'>${order.Retailer}</div>`:''}
                        <div style='flex:1 1 100%; font-size:12px; color:#555;'>${addr || ''}</div>
                        ${expectedBadge}
                    </div>
                    <h4 style='margin:10px 0 4px 0; font-size:0.9rem; letter-spacing:.5px; color:#334155;'>Items</h4>
                    ${itemsTableHtml}
                    <h4 style='margin:8px 0 6px 0; font-size:0.9rem; letter-spacing:.5px; color:#334155;'>Packages</h4>
                    <div style='overflow-x:auto;'>
                        <table style='width:100%; border-collapse:collapse; font-size:13px; min-width:520px;' id='packages-table-${order.OrderID}'>
                            <thead><tr style='background:#f8f9fa;'><th style='padding:6px 4px;text-align:left;'>#</th><th style='padding:6px 4px;text-align:left;'>Box</th><th style='padding:6px 4px;text-align:left;'>Dimensions (in)</th><th style='padding:6px 4px;text-align:left;'>Weight (oz)</th><th style='padding:6px 4px;text-align:left;'>Remove</th></tr></thead>
                            <tbody id='packages-tbody-${order.OrderID}'>${pkgRows}</tbody>
                        </table>
                    </div>
                    <div style='margin-top:10px;'>
                        <button type='button' class='btn' style='background:#4DBA93; padding:6px 14px; font-size:13px; border-radius:6px;' onclick="addPackageRow('${order.OrderID}')">+ Add Package</button>
                        <span id='shippingLabelsStatus-${order.OrderID}' style='margin-left:12px; font-size:12px; color:#4DBA93;'></span>
                    </div>
                    ${navHtml}
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
            validateSingleShippingOrder(order.OrderID);
        }
        function showShippingModalAt(idx) {
            currentShippingModalIndex = idx;
            shippingModalOrderIds.forEach(id => {
                const modal = document.getElementById('shippingLabelsModal-' + id);
                if (modal) modal.style.display = 'none';
            });
            const orderId = shippingModalOrderIds[idx];
            const target = document.getElementById('shippingLabelsModal-' + orderId);
            if (target) target.style.display = 'block';
        }
        function goToNextShippingModal(currentIdx) {
            if (currentIdx >= shippingModalOrderIds.length - 1) return;
            showShippingModalAt(currentIdx + 1);
        }
        async function finishShippingModals(finalOrderId) {
            if (finalOrderId) {
                const finishBtn = document.getElementById('shipFinishBtn-' + finalOrderId);
                if (finishBtn) {
                    finishBtn.disabled = true;
                    finishBtn.textContent = 'Collecting Rates...';
                    finishBtn.style.opacity = '0.7';
                }
            }
            const orderList = shippingModalOrderIds
                .map(id => orders.find(o => String(o.OrderID) === String(id)))
                .filter(Boolean);
            closeShippingLabelsModal();
            if (!orderList.length) return;
            shippingSummaryOrders = orderList;
            await collectRatesForOrders(orderList);
            openRatesSummaryModal(orderList);
        }
        function closeShippingLabelsModal() {
            cleanupShippingModals();
            hideRatesLoadingOverlay();
        }
        function showRatesLoadingOverlay(message) {
            let overlay = document.getElementById('ratesLoadingOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'ratesLoadingOverlay';
                overlay.style.position = 'fixed';
                overlay.style.left = '0';
                overlay.style.top = '0';
                overlay.style.width = '100vw';
                overlay.style.height = '100vh';
                overlay.style.background = 'rgba(0,0,0,0.45)';
                overlay.style.zIndex = '5000';
                overlay.style.display = 'flex';
                overlay.style.alignItems = 'center';
                overlay.style.justifyContent = 'center';
                overlay.innerHTML = `<div style="background:#fff; padding:24px 32px; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.25); font-size:16px; color:#2c3e50; font-weight:600; min-width:240px; text-align:center;">
                    <span id="ratesLoadingMessage">${escapeHtml(message || 'Loading...')}</span>
                </div>`;
                document.body.appendChild(overlay);
            } else {
                overlay.style.display = 'flex';
            }
            updateRatesLoadingMessage(message || 'Loading...');
        }
        function updateRatesLoadingMessage(message) {
            const label = document.getElementById('ratesLoadingMessage');
            if (label) label.textContent = message;
        }
        function hideRatesLoadingOverlay() {
            const overlay = document.getElementById('ratesLoadingOverlay');
            if (overlay) overlay.remove();
        }
        async function collectRatesForOrders(orderList) {
            if (!orderList.length) return;
            showRatesLoadingOverlay('Fetching rates (0/' + orderList.length + ')...');
            shippingRatesByOrderId = {};
            shippingRateErrors = {};
            shippingShipmentIds = {};
            selectedShippingRates = {};
            try {
                for (let i = 0; i < orderList.length; i++) {
                    const order = orderList[i];
                    updateRatesLoadingMessage(`Fetching rates (${i + 1}/${orderList.length})...`);
                    const pkgs = shippingLabelPackages[order.OrderID] || [];
                    const result = await fetchRatesForOrder(order, pkgs);
                    if (result.shipmentId) shippingShipmentIds[order.OrderID] = result.shipmentId;
                    if (result.error) {
                        shippingRateErrors[order.OrderID] = result.error;
                        continue;
                    }
                    shippingRatesByOrderId[order.OrderID] = result.rates || [];
                    const cheapest = pickCheapestRate(result.rates || []);
                    if (cheapest) selectedShippingRates[order.OrderID] = cheapest;
                }
                updateRatesLoadingMessage('Preparing summary...');
            } finally {
                hideRatesLoadingOverlay();
            }
        }
        async function fetchRatesForOrder(order, pkgs) {
            if (!pkgs || !pkgs.length) {
                return { rates: [], error: 'No packages defined.' };
            }
            try {
                const response = await fetch('/.netlify/functions/shippo-create-shipment-and-get-rates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order, parcels: pkgs })
                });
                const text = await response.text();
                let data;
                try { data = JSON.parse(text); } catch {
                    return { rates: [], error: 'Invalid JSON from rates endpoint.' };
                }
                if (!response.ok || data.error) {
                    let errMsg = data.error || data.detail || data.message || 'Failed to fetch rates.';
                    if (typeof errMsg !== 'string') {
                        try { errMsg = JSON.stringify(errMsg); } catch { errMsg = 'Failed to fetch rates.'; }
                    }
                    return { rates: [], error: errMsg };
                }
                return { rates: data.rates || [], shipmentId: data.shipment_id || null };
            } catch (err) {
                return { rates: [], error: err?.message || 'Error fetching rates.' };
            }
        }
        function pickCheapestRate(rates) {
            let cheapest = null;
            let minAmount = null;
            (rates || []).forEach(rate => {
                const amt = parseFloat(rate.amount_local ?? rate.amount);
                if (Number.isFinite(amt) && (minAmount === null || amt < minAmount)) {
                    minAmount = amt;
                    cheapest = rate;
                }
            });
            return cheapest;
        }
        function openRatesSummaryModal(orderList) {
            closeRatesSummaryModal();
            const rowsHtml = orderList.map(order => {
                let itemsArr = [];
                try { itemsArr = Array.isArray(order.Items) ? order.Items : JSON.parse(order.Items || '[]'); } catch {}
                if (!Array.isArray(itemsArr)) itemsArr = [];
                const itemsHtml = itemsArr.length
                    ? itemsArr.map(it => {
                        const qty = Number(it?.Quantity || it?.quantity || 0) || 0;
                        const sku = escapeHtml(it?.SKU || '');
                        const name = escapeHtml(it?.Name || it?.name || '');
                        return `${sku}${name ? ' – ' + name : ''} × ${qty}`;
                    }).join('<br>')
                    : '<span style="color:#999;">No items</span>';
                const pkgs = shippingLabelPackages[order.OrderID] || [];
                const boxesHtml = pkgs.length
                    ? pkgs.map((p, idx) => {
                        const len = escapeHtml(p.length || '?');
                        const wid = escapeHtml(p.width || '?');
                        const ht = escapeHtml(p.height || '?');
                        const weightText = `@ ${escapeHtml(p.weight ? `${p.weight} oz` : '? oz')}`;
                        const sku = p.boxSku ? `Box ${escapeHtml(p.boxSku)}` : '';
                        const dimsText = `${len}×${wid}×${ht} in`;
                        const parts = [sku, dimsText, weightText].filter(Boolean);
                        return `#${idx + 1}: ${parts.join(' ')}`;
                    }).join('<br>')
                    : '<span style="color:#999;">No boxes</span>';
                // Retrieve and sort rates by price ascending
                let rates = shippingRatesByOrderId[order.OrderID] || [];
                if (rates && rates.length > 1) {
                    rates = rates.slice().sort((a,b) => {
                        const av = parseFloat(a.amount_local ?? a.amount);
                        const bv = parseFloat(b.amount_local ?? b.amount);
                        if (!Number.isFinite(av) && !Number.isFinite(bv)) return 0;
                        if (!Number.isFinite(av)) return 1; // push invalid to end
                        if (!Number.isFinite(bv)) return -1;
                        return av - bv;
                    });
                    shippingRatesByOrderId[order.OrderID] = rates; // persist sorted order
                }
                const errorMsg = shippingRateErrors[order.OrderID];
                let rateCell = '';
                if (errorMsg) {
                    rateCell = `<div style='color:#b91c1c; font-size:12px;'>${escapeHtml(errorMsg)}</div>`;
                } else if (!rates.length) {
                    rateCell = "<span style='color:#999;'>No rates</span>";
                } else {
                    const selected = String((selectedShippingRates[order.OrderID] || {}).object_id || '');
                    const cheapestId = String((pickCheapestRate(rates) || {}).object_id || '');
                    const options = rates.map(rate => {
                        const amtNum = parseFloat(rate.amount_local ?? rate.amount);
                        const amountText = Number.isFinite(amtNum) ? ('$' + amtNum.toFixed(2)) : (rate.amount_local || rate.amount || '');
                        const provider = rate.provider || rate.carrier || '';
                        const service = rate.servicelevel_name || rate.servicelevel?.name || rate.service || '';
                        const rateId = String(rate.object_id || '');
                        const isCheapest = rateId === cheapestId;
                        const label = `${provider} - ${service} (${amountText})${isCheapest ? ' • Cheapest' : ''}`;
                        return `<option value="${escapeHtml(rateId)}" ${selected === rateId ? 'selected' : ''}>${escapeHtml(label)}</option>`;
                    }).join('');
                    rateCell = `<select id="rateSelect-${order.OrderID}" onchange="handleRateSelectionChange('${order.OrderID}', this.value)" style="padding:6px 8px; border-radius:6px; border:1px solid #d1d5db; min-width:220px;">${options}</select>`;
                }
                const orderNumber = order.OrderNumber || order.orderNumber || order.OrderID;
                return `<tr>
                    <td style='padding:8px 10px; font-weight:600;'>${escapeHtml(orderNumber)}</td>
                    <td style='padding:8px 10px; font-size:12px;'>${itemsHtml}</td>
                    <td style='padding:8px 10px; font-size:12px;'>${boxesHtml}</td>
                    <td style='padding:8px 10px;'>${rateCell}</td>
                </tr>`;
            }).join('');
            const modalHtml = `<div id='ratesSummaryModal' style='position:fixed; z-index:5100; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.45); display:flex; align-items:flex-start; justify-content:center; padding:60px 16px;'>
                <div style='background:#fff; width:95%; max-width:900px; border-radius:14px; box-shadow:0 16px 40px rgba(0,0,0,0.25); padding:28px 30px 26px 30px; position:relative; max-height:85vh; overflow:auto;'>
                    <span onclick='cancelRatesSummary()' style='position:absolute; top:12px; right:16px; font-size:30px; color:#888; cursor:pointer;'>&times;</span>
                    <h3 style='margin:0 0 12px 0; font-size:1.3rem; color:#2c3e50;'>Review Rates for Selected Orders</h3>
                    <p style='margin:0 0 14px 0; font-size:13px; color:#475569;'>Choose a shipping rate for each order. The cheapest option is pre-selected.</p>
                    <div style='overflow-x:auto;'>
                        <table style='width:100%; border-collapse:collapse; font-size:13px;'>
                            <thead><tr style='background:#f0f4f7;'><th style='padding:10px; text-align:left;'>Order</th><th style='padding:10px; text-align:left;'>Items</th><th style='padding:10px; text-align:left;'>Boxes</th><th style='padding:10px; text-align:left;'>Rate</th></tr></thead>
                            <tbody>${rowsHtml}</tbody>
                        </table>
                    </div>
                    <div style='margin-top:20px; display:flex; justify-content:flex-end; gap:12px;'>
                        <button class='btn' style='background:#e0e0e0; color:#2c3e50;' onclick='cancelRatesSummary()'>Cancel</button>
                        <button class='btn' style='background:#2c3e50; padding:10px 20px; border-radius:8px;' onclick='finalizeRateSelections()'>Confirm Rates</button>
                    </div>
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        function closeRatesSummaryModal() {
            const modal = document.getElementById('ratesSummaryModal');
            if (modal) modal.remove();
        }
        function cancelRatesSummary() {
            closeRatesSummaryModal();
            if (!shippingSummaryOrders || !shippingSummaryOrders.length) return;
            cleanupShippingModals();
            shippingRatesByOrderId = {};
            shippingRateErrors = {};
            shippingShipmentIds = {};
            selectedShippingRates = {};
            shippingModalOrderIds = shippingSummaryOrders.map(o => o.OrderID);
            currentShippingModalIndex = 0;
            shippingSummaryOrders.forEach((order, idx) => buildSingleShippingModal(order, idx, shippingSummaryOrders.length));
            showShippingModalAt(0);
        }
        function handleRateSelectionChange(orderId, rateId) {
            const rates = shippingRatesByOrderId[orderId] || [];
            const desired = String(rateId || '');
            const match = rates.find(r => String(r.object_id || '') === desired);
            if (match) {
                selectedShippingRates[orderId] = match;
            } else {
                delete selectedShippingRates[orderId];
            }
        }
        async function finalizeRateSelections() {
            const totalWithRates = (shippingSummaryOrders || []).filter(order => (shippingRatesByOrderId[order.OrderID] || []).length).length;
            const selectedCount = Object.keys(selectedShippingRates || {}).length;
            const hasErrors = Object.values(shippingRateErrors || {}).some(Boolean);
            if (hasErrors) {
                alert('Some orders did not return rates. Please adjust packages or try again.');
                return;
            }
            if (selectedCount < totalWithRates) {
                alert('Please choose a rate for every order before confirming.');
                return;
            }
            if (!shippingSummaryOrders.length) {
                alert('No orders selected for purchasing labels.');
                return;
            }

            const payloadOrders = shippingSummaryOrders.map(order => {
                const orderId = order.OrderID;
                const pkgs = (shippingLabelPackages[orderId] || []).map(pkg => ({
                    boxSku: pkg.boxSku || '',
                    length: pkg.length || '',
                    width: pkg.width || '',
                    height: pkg.height || '',
                    weight: pkg.weight || ''
                }));
                const selectedRate = selectedShippingRates[orderId];
                return {
                    orderId,
                    packages: pkgs,
                    rateId: selectedRate?.object_id || null,
                    rate: selectedRate ? {
                        object_id: selectedRate.object_id,
                        amount: selectedRate.amount,
                        amount_local: selectedRate.amount_local,
                        provider: selectedRate.provider,
                        carrier: selectedRate.carrier,
                        servicelevel_name: selectedRate.servicelevel_name,
                        service: selectedRate.service,
                        servicelevel: selectedRate.servicelevel ? { name: selectedRate.servicelevel?.name || selectedRate.servicelevel_name } : undefined
                    } : null,
                    shipmentId: shippingShipmentIds[orderId] || null,
                    orderData: order
                };
            });

            showRatesLoadingOverlay('Purchasing labels and updating orders...');
            let results = [];
            try {
                const response = await fetch('/.netlify/functions/shippo-batch-label', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orders: payloadOrders })
                });
                const text = await response.text();
                let data;
                try {
                    data = text ? JSON.parse(text) : {};
                } catch (err) {
                    throw new Error('Failed to parse server response while purchasing labels.');
                }
                if (!response.ok || data.error) {
                    const errMsg = data?.error || data?.message || text || 'Server returned an error while purchasing labels.';
                    throw new Error(errMsg);
                }
                if (Array.isArray(data.results)) {
                    results = data.results;
                }
            } catch (err) {
                console.error('Error purchasing labels:', err);
                alert('Error purchasing labels: ' + (err?.message || err));
                return;
            } finally {
                hideRatesLoadingOverlay();
            }

            closeRatesSummaryModal();

            const successIds = new Set(results.filter(res => res && res.success).map(res => String(res.orderId)));
            if (successIds.size) {
                orders = orders.filter(order => !successIds.has(String(order.OrderID)));
                filteredOrders = filteredOrders.filter(order => !successIds.has(String(order.OrderID)));
                successIds.forEach(id => selectedOrders.delete(id));
                filterOrders();
            } else {
                renderOrders();
                renderOrderStatsBanner();
            }
            updateSelectedCount();
            updateActionButtons();

            shippingLabelPackages = {};
            shippingRatesByOrderId = {};
            shippingRateErrors = {};
            shippingShipmentIds = {};
            selectedShippingRates = {};
            shippingSummaryOrders = [];
            shippingModalOrderIds = [];
            currentShippingModalIndex = 0;

            showBatchLabelResultsModal(results);
            const labelLinks = results.filter(res => res && res.success && res.labelUrl);
            labelLinks.forEach((res, idx) => {
                setTimeout(() => {
                    try {
                        window.open(res.labelUrl, '_blank', 'noopener');
                    } catch (err) {
                        console.warn('Failed to open label window:', err);
                    }
                }, idx * 400);
            });
        }
        function showBatchLabelResultsModal(results) {
            closeBatchLabelResultsModal();
            const safeResults = Array.isArray(results) ? results : [];
            if (!safeResults.length) {
                alert('No response received from label purchase request.');
                return;
            }
            const rows = safeResults.map(res => {
                const orderId = escapeHtml(res?.orderId || '');
                const statusHtml = res?.success
                    ? "<span style='color:#16a34a; font-weight:600;'>Success</span>"
                    : "<span style='color:#b91c1c; font-weight:600;'>Failed</span>";
                const tracking = escapeHtml(res?.trackingNumber || '—');
                const shippingCostValue = Number(res?.shippingCost);
                const shippingCost = Number.isFinite(shippingCostValue) ? `$${shippingCostValue.toFixed(2)}` : '—';
                const labelLink = res?.labelUrl
                    ? `<a href="${escapeHtml(res.labelUrl)}" target="_blank" rel="noopener" style="color:#2563eb;">Download Label</a>`
                    : '<span style="color:#999;">—</span>';
                const warningList = Array.isArray(res?.warnings) ? res.warnings.filter(Boolean) : [];
                const hasLabel = Boolean(res?.labelUrl);
                const notesParts = [];
                if (!res?.success && res?.error) {
                    if (hasLabel) notesParts.push("<div style='color:#16a34a;'>Label purchased successfully.</div>");
                    notesParts.push(`<div style='color:#b91c1c;'>${escapeHtml(res.error)}</div>`);
                } else if (warningList.length) {
                    if (hasLabel) notesParts.push("<div style='color:#16a34a;'>Label purchased successfully.</div>");
                    warningList.forEach(msg => notesParts.push(`<div style='color:#b45309;'>${escapeHtml(msg)}</div>`));
                } else {
                    notesParts.push('<span style="color:#16a34a;">All steps completed.</span>');
                }
                const notesHtml = notesParts.join('');
                return `<tr>
                    <td style='padding:10px 12px; font-weight:600;'>${orderId}</td>
                    <td style='padding:10px 12px;'>${statusHtml}</td>
                    <td style='padding:10px 12px;'>${tracking}</td>
                    <td style='padding:10px 12px;'>${escapeHtml(res?.carrier || '—')}</td>
                    <td style='padding:10px 12px;'>${shippingCost}</td>
                    <td style='padding:10px 12px;'>${labelLink}</td>
                    <td style='padding:10px 12px; font-size:12px;'>${notesHtml}</td>
                </tr>`;
            }).join('');
            const modalHtml = `<div id='batchLabelResultsModal' style='position:fixed; z-index:5200; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.45); display:flex; align-items:flex-start; justify-content:center; padding:60px 16px;'>
                <div style='background:#fff; width:95%; max-width:940px; border-radius:14px; box-shadow:0 16px 40px rgba(0,0,0,0.25); padding:28px 30px 26px 30px; position:relative; max-height:85vh; overflow:auto;'>
                    <span onclick='closeBatchLabelResultsModal()' style='position:absolute; top:12px; right:16px; font-size:30px; color:#888; cursor:pointer;'>&times;</span>
                    <h3 style='margin:0 0 12px 0; font-size:1.3rem; color:#2c3e50;'>Label Purchase Summary</h3>
                    <p style='margin:0 0 14px 0; font-size:13px; color:#475569;'>Download the labels and review any warnings that may need manual follow-up.</p>
                    <div style='overflow-x:auto;'>
                        <table style='width:100%; border-collapse:collapse; font-size:13px;'>
                            <thead><tr style='background:#f0f4f7;'><th style='padding:10px; text-align:left;'>Order</th><th style='padding:10px; text-align:left;'>Status</th><th style='padding:10px; text-align:left;'>Tracking</th><th style='padding:10px; text-align:left;'>Carrier</th><th style='padding:10px; text-align:left;'>Cost</th><th style='padding:10px; text-align:left;'>Label</th><th style='padding:10px; text-align:left;'>Notes</th></tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                    <div style='margin-top:20px; display:flex; justify-content:flex-end;'>
                        <button class='btn' style='background:#2c3e50; padding:10px 20px; border-radius:8px;' onclick='closeBatchLabelResultsModal()'>Close</button>
                    </div>
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        function closeBatchLabelResultsModal() {
            const modal = document.getElementById('batchLabelResultsModal');
            if (modal) modal.remove();
        }
        function escapeHtml(value) {
            if (value === null || value === undefined) return '';
            return value.toString().replace(/[&<>"']/g, ch => {
                switch (ch) {
                    case '&': return '&amp;';
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '"': return '&quot;';
                    case '\'': return '&#39;';
                    default: return ch;
                }
            });
        }
        // (removed older duplicate functions using onchange)
        function shippingPackageRowHtml(orderId, idx, p) {
            const selectedSku = String(p.boxSku || '').trim();
            const knownSkus = new Set(boxesList.map(box => String(box.sku || '').trim()));
            const optionsArr = [];
            if (boxesList.length) {
                optionsArr.push('<option value="">Select a box</option>');
                boxesList.forEach(box => {
                    const normalizedSku = String(box.sku || '').trim();
                    const cleanValue = escapeHtml(normalizedSku);
                    const labelRaw = box.dimensions ? `${normalizedSku} – ${box.dimensions}` : normalizedSku;
                    const cleanLabel = escapeHtml(labelRaw || '');
                    const isSelected = selectedSku === normalizedSku;
                    optionsArr.push(`<option value="${cleanValue}"${isSelected ? ' selected' : ''}>${cleanLabel}</option>`);
                });
            } else {
                optionsArr.push('<option value="">No boxes available</option>');
            }
            if (selectedSku && !knownSkus.has(selectedSku)) {
                const fallbackVal = escapeHtml(selectedSku);
                optionsArr.push(`<option value="${fallbackVal}" selected>(Unavailable) ${fallbackVal}</option>`);
            }
            const options = optionsArr.join('');
            const hasDimensions = p.length && p.width && p.height;
            const dimsLabel = hasDimensions
                ? `${escapeHtml(p.length)}×${escapeHtml(p.width)}×${escapeHtml(p.height)} in`
                : (selectedSku
                    ? '<span style="color:#b91c1c;">Missing box dimensions</span>'
                    : '<span style="color:#999;">Select a box</span>');
            const weightVal = escapeHtml(p.weight || '');
            return `<tr>
                <td style='padding:4px 6px; font-weight:600;'>${idx+1}</td>
                <td style='padding:4px 6px; min-width:170px;'>
                    <select style='width:100%; padding:6px 8px; border:1px solid #d1d5db; border-radius:6px;' onchange="handlePackageBoxChange('${orderId}', ${idx}, this.value)">
                        ${options}
                    </select>
                </td>
                <td style='padding:4px 6px;'>${dimsLabel}</td>
                <td style='padding:4px 6px;'><input type='number' min='0' step='0.01' value='${weightVal}' placeholder='0' style='width:100px; padding:4px 6px; border:1px solid #d1d5db; border-radius:5px;' oninput="updatePackageField('${orderId}', ${idx}, 'weight', this.value)"></td>
                <td style='padding:4px 6px;'><button type='button' style="background:none; border:none; color:#e74c3c; font-size:18px; cursor:pointer;" onclick="removePackageRow('${orderId}', ${idx})">&times;</button></td>
            </tr>`;
        }
        function handlePackageBoxChange(orderId, idx, boxSku) {
            if (!shippingLabelPackages[orderId] || !shippingLabelPackages[orderId][idx]) return;
            const pkg = shippingLabelPackages[orderId][idx];
            const normalizedSku = boxSku ? String(boxSku).trim() : '';
            pkg.boxSku = normalizedSku;
            const box = boxesList.find(b => String(b.sku || '').trim() === normalizedSku);
            if (box) {
                const dims = parseBoxDimensions(box.dimensions);
                pkg.length = dims.length;
                pkg.width = dims.width;
                pkg.height = dims.height;
            } else {
                pkg.length = '';
                pkg.width = '';
                pkg.height = '';
            }
            renderPackageTable(orderId);
            validateSingleShippingOrder(orderId);
        }
        function addPackageRow(orderId) {
            if (!shippingLabelPackages[orderId]) shippingLabelPackages[orderId] = [];
            const current = shippingLabelPackages[orderId];
            if (current.length) {
                const last = current[current.length - 1];
                shippingLabelPackages[orderId].push({
                    boxSku: String(last.boxSku || '').trim(),
                    length: last.length || '',
                    width: last.width || '',
                    height: last.height || '',
                    weight: ''
                });
            } else {
                shippingLabelPackages[orderId].push(createEmptyPackage());
            }
            renderPackageTable(orderId);
            validateSingleShippingOrder(orderId);
        }
        function removePackageRow(orderId, idx) {
            if (!shippingLabelPackages[orderId]) return;
            shippingLabelPackages[orderId].splice(idx,1);
            if (!shippingLabelPackages[orderId].length) shippingLabelPackages[orderId].push(createEmptyPackage());
            renderPackageTable(orderId);
            validateSingleShippingOrder(orderId);
        }
        function renderPackageTable(orderId) {
            const tbody = document.getElementById('packages-tbody-' + orderId);
            if (!tbody) return;
            const pkgs = shippingLabelPackages[orderId] || [];
            tbody.innerHTML = pkgs.map((p,i)=>shippingPackageRowHtml(orderId,i,p)).join('');
        }
        function updatePackageField(orderId, idx, field, value) {
            if (!shippingLabelPackages[orderId] || !shippingLabelPackages[orderId][idx]) return;
            shippingLabelPackages[orderId][idx][field] = value;
            validateSingleShippingOrder(orderId);
        }
        function validateSingleShippingOrder(orderId) {
            const pkgs = shippingLabelPackages[orderId] || [];
            const valid = pkgs.length > 0 && pkgs.every(p => p.boxSku && p.length && p.width && p.height && p.weight && Number(p.weight) > 0);
            const finishBtn = document.getElementById('shipFinishBtn-' + orderId);
            const nextBtn = document.getElementById('shipNextBtn-' + orderId);
            if (finishBtn) { finishBtn.disabled = !valid; finishBtn.style.opacity = valid ? '1' : '0.55'; }
            if (nextBtn) { nextBtn.disabled = !valid; nextBtn.style.opacity = valid ? '1' : '0.55'; }
        }
    </script>
</script>

<!-- Edit Order Modal -->
<div id="editOrderModal" style="display:none; position:fixed; z-index:2000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35);">
    <div style="background:white; max-width:420px; margin:60px auto; border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,0.18); padding:32px 28px 24px 28px; position:relative; max-height:80vh; overflow-y:auto;">
        <span onclick="closeEditOrderModal()" style="position:absolute; top:16px; right:18px; font-size:28px; color:#888; cursor:pointer;">&times;</span>
        <h2 style="margin-top:0; color:#4DBA93; font-size:1.3rem; margin-bottom:18px;">Edit Order</h2>
        <label style="font-weight:600; color:#2c3e50;">Order ID</label>
        <input id="editOrderID" type="text" readonly style="width:100%; margin-bottom:12px; padding:8px; border-radius:6px; border:1px solid #e1e5e9; background:#f8f9fa; color:#888;" />
        <label style="font-weight:600; color:#2c3e50;">Retailer</label>
        <select id="editRetailer" style="width:100%; margin-bottom:12px; padding:8px; border-radius:6px; border:1px solid #e1e5e9;"></select>
    <label style="font-weight:600; color:#2c3e50;">Platform</label>
    <input id="editPlatform" type="text" readonly style="width:100%; margin-bottom:12px; padding:8px; border-radius:6px; border:1px solid #e1e5e9; background:#f8f9fa; color:#888;" />
        <label style="font-weight:600; color:#2c3e50;">Items</label>
        <table style="width:100%;margin-bottom:0;border-collapse:collapse;">
            <thead>
                <tr style="background:#f9f9f9;">
                    <th style="padding:6px 4px;">SKU</th>
                    <th style="padding:6px 4px;">Name</th>
                    <th style="padding:6px 4px;">Quantity</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="editItemsTableBody"></tbody>
        </table>
        <div style="margin-bottom:14px;"><button type="button" onclick="openAddItemModal()" style="background:#4DBA93; color:white; border:none; border-radius:6px; padding:6px 16px; font-size:14px; cursor:pointer;">+ Add Item</button></div>

        <label style="font-weight:600; color:#2c3e50; display:block;">Customer</label>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 16px;margin-bottom:12px;">
            <div><input id="editCustomerName" type="text" placeholder="Name" style="width:100%;padding:7px;border-radius:6px;border:1px solid #e1e5e9;" /></div>
            <div><input id="editCustomerAddress1" type="text" placeholder="Address 1" style="width:100%;padding:7px;border-radius:6px;border:1px solid #e1e5e9;" /></div>
            <div><input id="editCustomerAddress2" type="text" placeholder="Address 2" style="width:100%;padding:7px;border-radius:6px;border:1px solid #e1e5e9;" /></div>
            <div><input id="editCustomerCity" type="text" placeholder="City" style="width:100%;padding:7px;border-radius:6px;border:1px solid #e1e5e9;" /></div>
            <div><input id="editCustomerState" type="text" placeholder="State" style="width:100%;padding:7px;border-radius:6px;border:1px solid #e1e5e9;" /></div>
            <div><input id="editCustomerZipCode" type="text" placeholder="Zip Code" style="width:100%;padding:7px;border-radius:6px;border:1px solid #e1e5e9;" /></div>
            <div><input id="editCustomerCountry" type="text" placeholder="Country" style="width:100%;padding:7px;border-radius:6px;border:1px solid #e1e5e9;" /></div>
        </div>
    <label style="font-weight:600; color:#2c3e50;">Notes</label>
    <textarea id="editNotes" style="width:100%; min-height:40px; margin-bottom:12px; padding:8px; border-radius:6px; border:1px solid #e1e5e9;"></textarea>
    <label style="font-weight:600; color:#2c3e50;">Customer Message</label>
    <textarea id="editCustomerMessages" style="width:100%; min-height:40px; margin-bottom:18px; padding:8px; border-radius:6px; border:1px solid #e1e5e9;"></textarea>
        <div style="display:flex; align-items:center; justify-content:flex-end; gap:10px;">
            <span id="editOrderSaveStatus" style="font-size:13px; color:#4DBA93;"></span>
            <button class="btn" style="padding:8px 22px; font-size:15px; border-radius:6px; background:#4DBA93;" onclick="saveEditOrder()">Save</button>
        </div>
    </div>
</div>

<!-- Add Item Modal -->
<div id="addItemModal" style="display:none; position:fixed; z-index:3000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35);">
  <div style="background:white; max-width:400px; margin:80px auto; border-radius:14px; box-shadow:0 8px 32px rgba(0,0,0,0.18); padding:32px 28px 22px 28px; position:relative; overflow:hidden;">
    <span onclick="closeAddItemModal()" style="position:absolute; top:14px; right:18px; font-size:28px; color:#888; cursor:pointer; transition:color 0.2s;">&times;</span>
    <h3 style="margin-top:0; color:#4DBA93; font-size:1.25rem; margin-bottom:18px; font-weight:600; letter-spacing:0.5px;">Add Item</h3>
    <label style="font-weight:600; color:#2c3e50; margin-bottom:4px; display:block;">Product</label>
    <input id="addItemProductSearch" type="text" placeholder="Search product..." style="width:100%;margin-bottom:8px;padding:10px 12px;border-radius:7px;border:1.5px solid #e1e5e9;font-size:15px;outline:none;transition:border 0.2s;" oninput="filterProductOptions()" autocomplete="off" />
    <div id="addItemProductOptions" style="max-height:140px;overflow-y:auto;margin-bottom:12px;border-radius:6px;background:#f8f9fa;"></div>
    <label style="font-weight:600; color:#2c3e50; margin-bottom:4px; display:block;">Quantity</label>
    <input id="addItemQuantity" type="number" min="1" value="1" style="width:100%;margin-bottom:18px;padding:10px 12px;border-radius:7px;border:1.5px solid #e1e5e9;font-size:15px;outline:none;transition:border 0.2s;" />
    <div style="display:flex;align-items:center;justify-content:flex-end;gap:10px;">
      <span id="addItemStatus" style="font-size:13px;color:#4DBA93;"></span>
      <button class="btn" style="padding:9px 26px;font-size:15px;border-radius:7px;background:#4DBA93;box-shadow:none;" onclick="confirmAddItem()">Add</button>
    </div>
  </div>
</div>

<!-- Inventory Removal Results Modal -->
<div id="invRemovalResultsModal" style="display:none; position:fixed; z-index:3500; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35);">
    <div style="background:white; max-width:860px; margin:60px auto; border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,0.18); padding:22px 22px 16px 22px; position:relative; max-height:80vh; overflow:auto;">
        <span onclick="closeInvRemovalResultsModal()" style="position:absolute; top:12px; right:14px; font-size:26px; color:#888; cursor:pointer;">&times;</span>
        <h3 style="margin:0 0 12px 0; color:#4DBA93; font-size:1.25rem;">Inventory Removal Results</h3>
        <div id="invRemovalResultsBody">Loading...</div>
        <div style="margin-top:14px; display:flex; justify-content:flex-end;">
            <button class="btn" style="padding:8px 18px; border-radius:6px;" onclick="closeInvRemovalResultsModal()">Close</button>
        </div>
    </div>
  
</div>
<script>
    let productsList = [];
    async function openAddItemModal() {
      document.getElementById('addItemProductSearch').value = '';
      document.getElementById('addItemQuantity').value = 1;
      document.getElementById('addItemStatus').textContent = '';
      document.getElementById('addItemProductOptions').innerHTML = '<div style="color:#aaa;padding:6px;">Loading...</div>';
      document.getElementById('addItemModal').style.display = 'block';
      // Fetch products if not already loaded
      if (productsList.length === 0) {
        try {
          const { data, error } = await supabase.from('Products').select('ProductSKU, Name');
          if (!error && data) productsList = data;
        } catch {}
      }
      filterProductOptions();
    }
    function closeAddItemModal() {
      document.getElementById('addItemModal').style.display = 'none';
    }
    function filterProductOptions() {
      const search = document.getElementById('addItemProductSearch').value.trim().toLowerCase();
      const optionsDiv = document.getElementById('addItemProductOptions');
      let filtered = productsList;
      if (search) {
        filtered = productsList.filter(p => (p.ProductSKU && p.ProductSKU.toLowerCase().includes(search)) || (p.Name && p.Name.toLowerCase().includes(search)));
      }
      if (filtered.length === 0) {
        optionsDiv.innerHTML = '<div style="color:#aaa;padding:6px;">No products found</div>';
        return;
      }
      optionsDiv.innerHTML = filtered.map(p => `<div class='add-item-option' style='padding:8px 10px;cursor:pointer;border-radius:5px;margin-bottom:3px;background:#fff;transition:background 0.15s;' onmouseover='this.style.background="#eaf6f3"' onmouseout='this.style.background="#fff"' onclick='selectAddItemProduct("${p.ProductSKU.replace(/"/g,'&quot;')}", "${(p.Name||'').replace(/"/g,'&quot;')}")'><strong>${p.ProductSKU}</strong> - ${p.Name || ''}</div>`).join('');
    }
    let selectedAddItemProduct = null;
    function selectAddItemProduct(sku, name) {
      selectedAddItemProduct = { SKU: sku, Name: name };
      document.getElementById('addItemProductSearch').value = sku + (name ? ' - ' + name : '');
      document.getElementById('addItemProductOptions').innerHTML = '';
    }
    function confirmAddItem() {
      const qty = Number(document.getElementById('addItemQuantity').value);
      if (!selectedAddItemProduct || !selectedAddItemProduct.SKU) {
        document.getElementById('addItemStatus').textContent = 'Select a product.';
        return;
      }
      if (!qty || qty < 1) {
        document.getElementById('addItemStatus').textContent = 'Enter a valid quantity.';
        return;
      }
      // Add the new item row to the items table as plain text (not editable)
      const itemsTable = document.getElementById('editItemsTableBody');
      const idx = itemsTable.querySelectorAll('tr').length;
      itemsTable.innerHTML += `
    <tr>
      <td>${selectedAddItemProduct.SKU}</td>
      <td>${selectedAddItemProduct.Name || ''}</td>
      <td>${qty}</td>
      <td><button type="button" onclick="removeEditItemRow(${idx})" style="color:#e74c3c; background:none; border:none; font-size:18px; cursor:pointer;">&times;</button></td>
    </tr>
  `;
  closeAddItemModal();
  selectedAddItemProduct = null;
    }
    function removeEditItemRow(idx) {
      const itemsTable = document.getElementById('editItemsTableBody');
      const rows = Array.from(itemsTable.querySelectorAll('tr'));
      if (rows[idx]) rows[idx].remove();
    }
    window.removeEditItemRow = removeEditItemRow;
</script>
</body>
</html>
