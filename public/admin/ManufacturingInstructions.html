<!DOCTYPE html>
<html lang="en">
<head>
    <title>Manufacturing Instructions</title>
    <style>
        .instructions { display: none; }
        .visible { display: block; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="icon" href="/public/favicon.ico">
</head>
<body>
    <div id="instructions" class="instructions">
        <div id="batchInfoContainer"></div>
        <div id="batchSummaryContainer"></div>
        
        <div id="productSteps"></div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Show batch/lot/batchtime and summary from URL only
            const params = new URLSearchParams(window.location.search);
            const batch = params.get('batch') || '';
            const lot = params.get('lot') || '';
            const batchtime = params.get('batchtime') || '';
            let batchInfoHTML = '';
            if (batch || lot || batchtime) {
                batchInfoHTML = `<div style="padding: 0.7rem 1.2rem; margin: 1rem 0 0.5rem 0; font-size: 1.08em; border: 1px solid #888; border-radius: 6px; text-align:center;">
                    <b>Batch Number:</b> ${batch ? batch : '<em>Not specified</em>'} &nbsp; | &nbsp;
                    <b>Lot Number:</b> ${lot ? lot : '<em>Not specified</em>'} &nbsp; | &nbsp;
                    <b>Batch Date:</b> ${batchtime ? (new Date(batchtime).toISOString().slice(0,10)) : '<em>Not specified</em>'}
                </div>`;
            }
            document.getElementById('batchInfoContainer').innerHTML = batchInfoHTML;

            // Show batch summary and low inventory warnings from URL parameters only
            const batchSummaryContainer = document.getElementById('batchSummaryContainer');
            let summaryHTML = '';
            const batchSummary = params.get('batchSummaryHTML');
            if (batchSummary) {
                summaryHTML += batchSummary;
            }
            const lowInventory = params.get('lowInventoryHTML');
            if (lowInventory) {
                summaryHTML += lowInventory;
            }
            if (summaryHTML) {
                batchSummaryContainer.innerHTML = summaryHTML;
            }
        });
        // Initialize Supabase
        const SUPABASE_URL = 'https://ypvyrophqkfqwpefuigi.supabase.co'; // Replace with your Supabase URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlwdnlyb3BocWtmcXdwZWZ1aWdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMjQzMjAsImV4cCI6MjA2MzYwMDMyMH0.fDY3ZA-sVDoEK-_CgrgdjlUtVdH3YwULSAKjK9oFRbQ'; // Replace with your Supabase anon key
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function checkAdmin() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = '/public/Login.html';
        return;
      }
      const { data: { user } } = await supabase.auth.getUser();
      // Adjust this check to match your Supabase user admin logic
      if (!user || !user.user_metadata || user.user_metadata.role !== 'service_role') {
        console.log(user.user_metadata);
        document.body.innerHTML = '<div style="margin:2rem;font-size:1.2rem;color:#e74c3c;text-align:center;">Access denied: Admins only</div>';
        throw new Error('Not admin');
      }
    }
    checkAdmin();
        // Helper to get SKU from URL query string
        function getSku() {
            const params = new URLSearchParams(window.location.search);
            return params.get('sku');
        }

        async function showInstructions() {
            const sku = getSku();
            // Query Supabase for product by SKU, including ManufacturingInstructions
            const { data, error } = await supabase
                .from('Products') 
                .select('Name,Process,"Product Type",ContainerSKUs,"Pour Temperature","Pour Consistency",Aroma,"Product Weight(oz)",ManufacturingInstructions')
                .eq('ProductSKU', sku)
                .single();

            if (error || !data) {
                console.error('Error fetching product data:', error);
                document.getElementById('productSteps').innerHTML = '<div style="color:#e74c3c;text-align:center;">Error loading product instructions.</div>';
                return;
            }



            // Always render batch card table first
            let batchCardTable = await generateBatchCardTable(data.Process);
            document.getElementById('productSteps').innerHTML = batchCardTable;

            // If ManufacturingInstructions is present and non-empty, display it below the batch card and skip auto instructions
            if (data.ManufacturingInstructions!=null && data.ManufacturingInstructions.trim() !== '') {
                document.getElementById('productSteps').innerHTML += `<div style="white-space:pre-line;font-family:inherit;line-height:1.7;padding:1.2rem;border:1px solid #888;border-radius:8px;margin:1rem 0;max-width:900px;margin-left:auto;margin-right:auto;">${data.ManufacturingInstructions}</div>`;
                document.getElementById('instructions').classList.add('visible');
                return;
            }

            // Otherwise, continue with auto-generated instructions
            console.log('Product data retrieved:', data); // Debug log

            // Color-coded batch card table (like in BatchMaker), grouped by phase
            function generateBatchCardTable(process) {
                if (!process || typeof process !== 'object') return '<em>No process data</em>';
                const phaseKeys = Object.keys(process).filter(k => k.startsWith('Phase ')).sort((a, b) => {
                    const numA = parseInt(a.replace('Phase ', ''));
                    const numB = parseInt(b.replace('Phase ', ''));
                    return numA - numB;
                });
                // Gather all unique IngredientSKUs
                const allSKUs = new Set();
                phaseKeys.forEach(phaseKey => {
                    const phase = process[phaseKey];
                    let ingredients = [];
                    const phaseNumMatch = phaseKey.match(/Phase (\d+)/);
                    if (phaseNumMatch) {
                        const phaseNum = phaseNumMatch[1];
                        const phaseIngredientsKey = `Phase ${phaseNum} Ingredients`;
                        if (Array.isArray(phase[phaseIngredientsKey])) {
                            ingredients = phase[phaseIngredientsKey];
                        }
                    }
                    if (ingredients.length === 0 && Array.isArray(phase['Ingredients'])) {
                        ingredients = phase['Ingredients'];
                    }
                    ingredients.forEach(ing => {
                        if (ing.IngredientSKU) allSKUs.add(ing.IngredientSKU);
                    });
                });

                // Try to get batch size from URL or data
                function getBatchSize() {
                    const params = new URLSearchParams(window.location.search);
                    let batchSize = parseFloat(params.get('batchSize'));
                    if (!isNaN(batchSize) && batchSize > 0) return batchSize;
                    if (typeof data.BatchSize === 'number' && data.BatchSize > 0) return data.BatchSize;
                    return 1; // fallback
                }

                // Try to get product total weight in grams (from data or process)
                function getProductTotalWeightGrams() {
                    // Only use Product Weight(oz) from Supabase and convert to grams
                    if (typeof data['Product Weight(oz)'] === 'number') return data['Product Weight(oz)'] * 28.3495231;
                    // fallback
                    return null;
                }

                // Calculate ingredient weight in grams for a given ingredient, using percent and batch size
                function calculateIngredientWeight(ing, batchSize, productTotalWeightGrams) {
                    // If explicit weight in grams is present, use it
                    if (typeof ing.Weight === 'number') return ing.Weight;
                    if (typeof ing['Weight (g)'] === 'number') return ing['Weight (g)'];
                    if (typeof ing['Weight(g)'] === 'number') return ing['Weight(g)'];
                    if (typeof ing['Grams'] === 'number') return ing['Grams'];
                    // If percent is present and product weight is known, calculate
                    let percent = undefined;
                    if (typeof ing['Ingredient Quantity(%)'] === 'number') percent = ing['Ingredient Quantity(%)'];
                    else if (typeof ing.Percent === 'number') percent = ing.Percent;
                    if (percent !== undefined && productTotalWeightGrams) {
                        return (percent / 100) * productTotalWeightGrams * batchSize*1.1;
                    }
                    // fallback
                    return undefined;
                }

                // Fetch ingredient names from Supabase synchronously (returns a Promise)
                // This function will be async, so the caller must await it
                // We'll use a cache to avoid duplicate lookups
                async function getIngredientNamesAndLocations(skuList) {
                    if (!skuList.length) return { nameMap: {}, locationMap: {} };
                    const { data: ingredients, error } = await supabase
                        .from('Ingredients')
                        .select('IngredientSKU,Name,Location')
                        .in('IngredientSKU', skuList);
                    if (error) {
                        console.error('Error fetching ingredient names/locations:', error);
                        return { nameMap: {}, locationMap: {} };
                    }
                    const nameMap = {};
                    const locationMap = {};
                    ingredients.forEach(row => {
                        nameMap[row.IngredientSKU] = row.Name;
                        locationMap[row.IngredientSKU] = row.Location || '';
                    });
                    return { nameMap, locationMap };
                }

            // Helper to format weight in lbs/oz/g
            function formatWeight(weightGrams) {
                if (typeof weightGrams !== 'number' || isNaN(weightGrams)) return '';
                const grams = weightGrams;
                const pounds = grams / 453.59237;
                const ounces = grams / 28.3495231;
                if (pounds >= 0.2) {
                    return pounds.toFixed(2) + ' lb';
                } else if (ounces >= 1) {
                    return ounces.toFixed(2) + ' oz';
                } else {
                    return grams.toFixed(1) + ' g';
                }
            }

                // The main rendering logic is now async
                return (async () => {
                    const skuList = Array.from(allSKUs);
                    const { nameMap: skuToName, locationMap: skuToLocation } = await getIngredientNamesAndLocations(skuList);
                    // Store globally for use in instructions rendering
                    window._skuToNameMap = skuToName;
                    const batchSize = getBatchSize();
                    // Get vessel from URL params
                    const params = new URLSearchParams(window.location.search);
                    const vessel = params.get('vessel') || '';
                    let html = `<div style="padding: 1.2rem; border: 1px solid #888; border-radius: 8px; margin: 1rem 0;">
                    <h2 style="margin: 0 0 0.5rem 0; font-size: 1.3rem; font-weight: 700; letter-spacing: 1px; text-align:center;">BATCH CARD</h2>
                    <div style="text-align:center; font-size:1.05rem; margin-bottom:0.5rem;">${data.Name || 'Product'}<br><span style='font-size:0.95em;'>SKU: ${sku || ''}</span><br><span style='font-size:0.95em;'><b>Batch Size:</b> ${batchSize}</span>${vessel ? `<br><span style='font-size:0.95em;'><b>Vessel:</b> ${vessel}</span>` : ''}</div>`;
                    const productTotalWeightGrams = getProductTotalWeightGrams();
                    phaseKeys.forEach(phaseKey => {
                        const phase = process[phaseKey];
                        html += `<div style='margin-top:1.2em;'><b>${phaseKey}</b></div>`;
                        html += `<div style='overflow-x:auto;'><table style='width:100%; border-collapse:collapse; margin-top:0.3em; font-size:1em;'>`;
                        html += `<colgroup>
                            <col style='width:28%;'>
                            <col style='width:15%;'>
                            <col style='width:10%;'>
                            <col style='width:17%;'>
                            <col style='width:15%;'>
                            <col style='width:15%;'>
                        </colgroup>`;
                        html += `<thead><tr>
                            <th style='padding:4px 8px; border:1px solid #b2d8a6; width:28%; min-width:100px;'>Ingredient</th>
                            <th style='padding:4px 8px; border:1px solid #b2d8a6; width:15%; min-width:80px;'>SKU</th>
                            <th style='padding:4px 8px; border:1px solid #b2d8a6; width:10%; min-width:50px;'>%</th>
                            <th style='padding:4px 8px; border:1px solid #b2d8a6; width:17%; min-width:90px;'>Weight</th>
                            <th style='padding:4px 8px; border:1px solid #b2d8a6; width:15%; min-width:80px;'>Location</th>
                            <th style='padding:4px 8px; border:1px solid #b2d8a6; width:15%; min-width:80px;'>Initials</th>
                        </tr></thead><tbody>`;
                        let ingredients = [];
                        const phaseNumMatch = phaseKey.match(/Phase (\d+)/);
                        if (phaseNumMatch) {
                            const phaseNum = phaseNumMatch[1];
                            const phaseIngredientsKey = `Phase ${phaseNum} Ingredients`;
                            if (Array.isArray(phase[phaseIngredientsKey])) {
                                ingredients = phase[phaseIngredientsKey];
                            }
                        }
                        if (ingredients.length === 0 && Array.isArray(phase['Ingredients'])) {
                            ingredients = phase['Ingredients'];
                        }
                        if (ingredients.length === 0) {
                            html += `<tr><td colspan='6' style='text-align:center; color:#888;'>No ingredients</td></tr>`;
                        } else {
                            ingredients.forEach(ing => {
                                const name = skuToName[ing.IngredientSKU] || '';
                                const location = skuToLocation[ing.IngredientSKU] || '';
                                let weightGrams = calculateIngredientWeight(ing, batchSize, productTotalWeightGrams);
                                html += `<tr>` +
                                    `<td style='padding:4px 8px; border:1px solid #b2d8a6; width:28%; min-width:100px;'>${name}</td>` +
                                    `<td style='padding:4px 8px; border:1px solid #b2d8a6; width:15%; min-width:80px;'>${ing.IngredientSKU || ing.sku || ''}</td>` +
                                    `<td style='padding:4px 8px; border:1px solid #b2d8a6; width:10%; min-width:50px;'>${ing['Ingredient Quantity(%)'] !== undefined ? ing['Ingredient Quantity(%)'] : (ing.Percent !== undefined ? ing.Percent : '')}</td>` +
                                    `<td style='padding:4px 8px; border:1px solid #b2d8a6; width:17%; min-width:90px;'>${weightGrams !== undefined ? formatWeight(weightGrams) : ''}</td>` +
                                    `<td style='padding:4px 8px; border:1px solid #b2d8a6; width:15%; min-width:80px;'>${location}</td>` +
                                    `<td style='padding:4px 8px; border:1px solid #b2d8a6; width:15%; min-width:80px;'><input type="text" style="width:90%;padding:4px 6px;border-radius:4px;border:1px solid #b2d8a6;" placeholder="Initials"></td>` +
                                `</tr>`;
                            });
                        }
                        html += `</tbody></table></div>`;
                    });
                    html += `</div>`;
                    return html;
                })();
            }




            // (Already rendered batch card table above)

            // Now append the instructions below the table
            if (['Makeup'].includes(data['Product Type'])) {
                showMakeupInstructions(data, true);
            } else if (['Emulsion', 'Specialized Emulsion','Cream','Skin Toner','Water Mixture'].includes(data['Product Type'])) {
                showEmulsionInstructions(data, true);
            } else if (['Soap Bar', 'Soap Cube', 'Soap Hotel', 'Shave Cube', 'Shave Bar', 'Shave Hotel'].includes(data['Product Type'])) {
                showSoapInstructions(data, true);
            } else if (['Deodorant', 'Balm 3'].includes(data['Product Type'])) {
                showDeodorantInstructions(data, true);
            } else if (['Shampoo Bar Machine','Shower Steamer'].includes(data['Product Type'])) {
                //TODO showPowderPressInstructions(data);
            } else if (['Mask', 'Powder', 'Scrub','Soak'].includes(data['Product Type'])) {
                //TODO showDryMixInstructions(data);
            }
            else {
                showGeneralInstructions(data, true);
            }
            
            // No localStorage usage for SKU anymore
        }

        function showMakeupInstructions(data) {

            
            const process = data.Process || {};
            const containerSKUs = data.ContainerSKUs || [];
            const pourTemp = data['Pour Temperature'] || data.PourTemperature || 'Unspecified';
            const pourConsistency = data['Pour Consistency'] || data.PourConsistency || 'Unspecified';
            const Aroma = data.Aroma || 'Unspecified';
            const phases = extractAllPhases(process);
            const makeupInstructions = `
                <div style="font-family: Arial, sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 20px;">
                    <h2>Makeup: Step-by-Step Manufacturing Process</h2>
                    
                    <h3>1. Preparation & Sanitization</h3>
                    <p>• Wear PPE (gloves, hairnet, lab coat, and face mask) to prevent contamination.</p>
                    
                    <h4>Equipment Needed:</h4>
                    <ul>
                        <li>Ingredient cups</li>
                        <li>Spatula</li>
                        <li>Immersion blender</li>
                        <li>Agitator</li>
                    </ul>
                    
                    <h4>✅ Clean & Sanitize Equipment:</h4>
                    <ul>
                        <li>Ensure all containers, utensils, and mixing vessels are cleaned and sanitized with alcohol or an approved cleaning solution.</li>
                        <li>Ensure there is no oil residue on any equipment, tools, or workspace.</li>
                        <li>Ensure the production area meets GMP requirements.</li>
                        <li>Ensure scale is working properly.</li>
                    </ul>
                    
                    <p><strong>Initials:</strong> <input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                    
                    <hr style="margin: 20px 0;">
                    
                    ${generatePhaseInstructions(phases)}
                    
                    <ol start="${phases.length + 1}">
                        <li>Set temperature on pot to <strong>${pourTemp}°C</strong>.</li>
                    </ol>
                    
                    <p><strong>Quality Initials:</strong> <input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                    
                    <hr style="margin: 20px 0;">
                    
                    <h3>Filling & Cooling Procedure:</h3>
                    
                    <h4>1. Pre-Fill Preparation</h4>
                    <ul>
                        <li>Verify that all containers, lids, and tools are sanitized and approved for use.</li>
                        <li>Lay out only the number of containers required for the batch.</li>
                        <li>Confirm container SKU <strong>${containerSKUs.join(', ') || 'Unspecified'}</strong><br>
                        <strong>Initials:</strong> <input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></li>
                    </ul>
                    
                    <h4>2. Fill Conditions</h4>
                    <ul>
                        <li>Confirm product temperature has reached <strong>${pourTemp}°C</strong>.</li>
                        <li>Carefully fill each container to target fill weight/volume.</li>
                        <li>Wipe container rims if necessary to prevent contamination before capping.</li>
                    </ul>
                    
                    <h4>3. Cooling Process</h4>
                    <ul>
                        <li>Allow filled containers to cool in a controlled area free of drafts, debris, and contamination risk for a minimum of 10 minutes or until fully set (maximum 30 minutes).</li>
                        <li>Do not disturb containers during this period to avoid texture disruption.</li>
                    </ul>
                    
                    <h4>4. In-Process Quality Control Checks</h4>
                    <p>Perform the following QC checks on at least 3 random units:</p>
                    <ul>
                        <li>Texture and consistency: <strong>${pourConsistency}</strong></li>
                        <li>Aroma: <strong>${Aroma}</strong></li>
                        <li>Visual inspection: Check for separation, graininess, air bubbles, or irregularities.</li>
                    </ul>
                    
                    <p>If deviations are observed, document immediately and notify supervisor before proceeding.</p>
                    
                    <p><strong>Quality Initials:</strong> <input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                    
                    <h4>5. Post-Fill Actions</h4>
                    <ul>
                        <li>Cap all containers securely using appropriate closures.</li>
                        <li>Inspect closures for proper application (tightness, alignment).</li>
                        <li>Shut down all filling equipment and clean per cleaning SOP.</li>
                        <li>Record number of containers filled.</li>
                    </ul>
                    
                    <p><strong>No. of Pieces Filled:</strong> <input type="text" style="width:120px;" placeholder="No. of Pieces Filled"></p>
                    <p><strong>Initials:</strong> <input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                    
                    <hr style="margin: 20px 0;">
                    
                    <h3>Packaging & Inventory Management</h3>
                    
                    <h4>1. Packaging</h4>
                    <ul>
                        <li>Confirm Container SKUs <strong>${containerSKUs.join(', ') || 'Unspecified'}</strong> <br>
                            <strong>Initials:</strong> <input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></li>
                        <li>Apply labels evenly and securely to containers.</li>
                        <li>Perform visual inspection to confirm legibility and placement.</li>
                        <li>Application method: <input type="text" style="width:180px;" placeholder="Application method"></li>
                    </ul>
                    
                    <h4>2. Inventory Management</h4>
                    <p>Move finished products into designated quarantine area for finished goods.</p>
                    <p><strong>Storage location:</strong> <input type="text" style="width:180px;" placeholder="Storage location"></p>
                    <p><strong>Initials:</strong> <input type="text" style="width:120px;" placeholder="Initials"></p>
                    <p><strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                </div>
            `;
            
            document.getElementById('productSteps').innerHTML += makeupInstructions;
            document.getElementById('instructions').classList.add('visible');
        }

        function showEmulsionInstructions(data) {
            const process = data.Process || {};
            const containerSKUs = data.ContainerSKUs || [];
            const pourTemp = data['Pour Temperature'] || data.PourTemperature || 'Unspecified';
            const pourConsistency = data['Pour Consistency'] || data.PourConsistency || 'Unspecified';
            const Aroma = data.Aroma || 'Unspecified';
            const phases = extractAllPhases(process);
            const emulsionInstructions = `
                <div style="font-family: Arial, sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 20px;">
                    <h2>Emulsion: Step-by-Step Manufacturing Process</h2>
                    
                    <h3>✅ Preparation & Sanitization</h3>
                    <p>• Wear PPE (gloves, hairnet, lab coat, and face mask) to prevent contamination.</p>
                    
                    <h4>Equipment Needed:</h4>
                    <ul>
                        <li>Ingredient cups</li>
                        <li>Spatula</li>
                        <li>Immersion blender or emulsifying kettle</li>
                        <li>Filling machine (manual/automatic)</li>
                    </ul>
                    
                    <h4>✅ Clean & Sanitize Equipment:</h4>
                    <ul>
                        <li>Ensure all containers, utensils, and mixing vessels are cleaned and sanitized with alcohol or an approved cleaning solution.</li>
                        <li>Ensure there is no oil residue on any equipment, tools, or workspace.</li>
                        <li>Ensure the production area meets GMP requirements.</li>
                        <li>Ensure scale is working properly.</li>
                    </ul>
                    
                    <p><strong>Initials:</strong> <input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                    
                    <hr style="margin: 20px 0;">
                    
                    ${generateEmulsionPhaseInstructions(phases, pourTemp)}
                    
                    <h3>Filling & Cooling Procedure:</h3>
                    
                    <h4>1. Pre-Fill Preparation</h4>
                    <ul>
                        <li>Verify that all containers, lids, and tools are sanitized and approved for use.</li>
                        <li>Lay out only the number of containers required for the batch.</li>
                        <li>Confirm container SKU <strong>${containerSKUs.join(', ') || 'Unspecified'}</strong><br>
                        <strong>Initials:</strong> <input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></li>
                    </ul>
                    
                    <h4>2. Fill Conditions</h4>
                    <ul>
                        <li>Confirm product temperature has reached <strong>${pourTemp}°C</strong>.</li>
                        <li>Carefully fill each container to target fill weight/volume.</li>
                        <li>Wipe container rims if necessary to prevent contamination before capping.</li>
                    </ul>
                    
                    <h4>3. Cooling Process</h4>
                    <ul>
                        <li>Allow filled containers to cool in a controlled area free of drafts, debris, and contamination risk for a minimum of 10 minutes or until fully set (maximum 30 minutes).</li>
                        <li>Do not disturb containers during this period to avoid texture disruption.</li>
                    </ul>
                    
                    <h4>4. In-Process Quality Control Checks</h4>
                    <p>Perform the following QC checks on at least 3 random units:</p>
                    <ul>
                        <li>Texture and consistency: <strong>${pourConsistency}</strong></li>
                        <li>Aroma: <strong>${Aroma}</strong></li>
                        <li>Visual inspection: Check for separation, graininess, air bubbles, or irregularities.</li>
                        <li>Microbial: <strong>[Pass/fail]</strong></li>
                    </ul>
                    
                    <p>If deviations are observed, document immediately and notify supervisor before proceeding.</p>
                    
                    <p><strong>Quality Initials:</strong> <input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                    
                    <h4>5. Post-Fill Actions</h4>
                    <ul>
                        <li>Cap all containers securely using appropriate closures.</li>
                        <li>Inspect closures for proper application (tightness, alignment).</li>
                        <li>Shut down all filling equipment and clean per cleaning SOP.</li>
                        <li>Record number of containers filled.</li>
                    </ul>
                    
                    <p><strong>No. of Pieces Filled:</strong> <input type="text" style="width:120px;" placeholder="No. of Pieces Filled"></p>
                    <p><strong>Initials:</strong> <input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                    
                    <hr style="margin: 20px 0;">
                    
                    <h3>Packaging & Inventory Management</h3>
                    
                    <h4>1. Packaging</h4>
                    <ul>
                        <li>Confirm Container SKUs <strong>${containerSKUs.join(', ') || 'Unspecified'}</strong><br>
                        <strong>Initials:</strong> <input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></li>
                        <li>Apply labels evenly and securely to containers.</li>
                        <li>Perform visual inspection to confirm legibility and placement.</li>
                        <li>Application method: <input type="text" style="width:120px;" placeholder="Application method"></li>
                    </ul>
                    
                    <h4>2. Inventory Management</h4>
                    <p>Move finished products into designated quarantine area for finished goods.</p>
                    <p><strong>Storage location:</strong> <input type="text" style="width:120px;" placeholder="Storage location"></p>
                    <p><strong>Initials:</strong> <input type="text" style="width:120px;" placeholder="Initials"></p>
                    <p><strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                </div>
            `;
            
            document.getElementById('productSteps').innerHTML += emulsionInstructions;
            document.getElementById('instructions').classList.add('visible');
        }

        function showSoapInstructions(data) {
            const process = data.Process || {};
            const containerSKUs = data.ContainerSKUs || [];
            const phases = extractAllPhases(process);
            const soapInstructions = `
                <div style="font-family: Arial, sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 20px;">
                    <h2>Soap: Step-by-Step Manufacturing Process</h2>
                    
                    <h3>✅ Preparation & Sanitization</h3>
                    <p>• Wear PPE (gloves, hairnet, lab coat, and face mask) to prevent contamination.</p>
                    
                    <h4>Equipment Needed:</h4>
                    <ul>
                        <li>Ingredient cups</li>
                        <li>Spatula</li>
                        <li>Immersion blender</li>
                    </ul>
                    
                    <h4>✅ Clean & Sanitize Equipment:</h4>
                    <ul>
                        <li>Ensure all containers, utensils, and mixing vessels are cleaned and sanitized with alcohol or an approved cleaning solution.</li>
                        <li>Ensure there is no oil residue on any equipment, tools, or workspace.</li>
                        <li>Ensure the production area meets GMP requirements.</li>
                        <li>Ensure scale is working properly.</li>
                    </ul>
                    
                    <h4>✅ Weigh all ingredients</h4>
                    <p>For each ingredient in the formula:</p>
                    <ul>
                        <li>Place the container on the scale and tare it to zero.</li>
                        <li>Slowly add the ingredient until the exact required amount is reached. (Aim for ±0.1% accuracy or tighter if required.)</li>
                        <li>Close the container and place the pre-printed label for that ingredient on it.</li>
                        <li>For critical or expensive ingredients, have a second person verify.</li>
                    </ul>
                    
                    <p><strong>Initials:</strong> <input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                    
                    <hr style="margin: 20px 0;">
                    
                    ${generateSoapPhaseInstructions(phases)}
                    
                    <hr style="margin: 20px 0;">
                    
                    <h3>Curing Process</h3>
                    
                    <h4>1. Initial Unmolding (12–72 hours post-pour)</h4>
                    <ul>
                        <li>Timing: Unmold when the soap is firm enough to release cleanly — usually within 1–3 days.</li>
                        <li>Caution: If the soap is still soft, wait an additional 24 hours.</li>
                        <li>Check: Surface should feel firm and not tacky.</li>
                    </ul>
                    
                    <h4>2. Cutting into Bars (Immediately after unmolding)</h4>
                    <ul>
                        <li>Use a wire soap cutter even sizing.</li>
                        <li>Handle with gloves to avoid fingerprints and contamination.</li>
                        <li>Label each batch tray with pre-printed labels</li>
                    </ul>
                    
                    <h4>3. Placement for Curing</h4>
                    <ul>
                        <li>Surface: Place bars on a breathable surface (e.g., uncoated shelving, baker's racks, or curing trays lined with parchment).</li>
                        <li>Spacing: Leave at least 0.5" (1.25 cm) between each bar for airflow.</li>
                        <li>Orientation: Rotate bars every few days to ensure even drying on all sides.</li>
                    </ul>
                    
                    <h4>5. Curing Duration</h4>
                    <ul>
                        <li>Minimum: 4 weeks (28 days)</li>
                        <li>Extended Cure (Optional): 6–8 weeks for high-olive or castile soaps</li>
                    </ul>
                    
                    <h4>6. Testing During Cure</h4>
                    <p>Perform the following checks:</p>
                    <ul>
                        <li>Weight Loss: Weigh sample bars weekly to track water loss.</li>
                        <li>pH Testing: Use pH strips or a diluted solution to confirm target pH is under ~10.</li>
                        <li>Hardness: Press gently to assess bar hardness over time.</li>
                        <li>Lather: Lather a small corner of a bar to test bubble quality and skin feel.</li>
                    </ul>
                    
                    <h4>7. End of Cure — Ready for Packaging</h4>
                    <p>Ensure bars are:</p>
                    <ul>
                        <li>Fully hardened</li>
                        <li>pH stable (ideal: 8.0–9.5)</li>
                        <li>Free from surface sweating or spots</li>
                        <li>Weigh and record final weight for labeling accuracy.</li>
                    </ul>
                    
                    <h4>8. Packaging Process</h4>
                    <ul>
                        <li>Confirm container SKU <strong>${containerSKUs.join(', ') || 'Unspecified'}</strong><br>
                        <strong>Initials:</strong> <input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></li>
                        <li>Inspect closures for proper application</li>
                        <li>Record number of bars packaged.</li>
                    </ul>
                    
                    <p><strong>No. of Pieces Filled:</strong> <input type="text" style="width:120px;" placeholder="No. of Pieces Filled"></p>
                    <p><strong>Initials:</strong> <input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>

                    <hr style="margin: 20px 0;">
                    
                    <h3>Labeling & Inventory Management</h3>
                    
                    <h4>1. Labeling</h4>
                    <ul>
                        <li>Confirm Container SKUs <strong>${containerSKUs.join(', ') || 'Unspecified'}</strong><br>
                        <strong>Initials:</strong> <input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></li>
                        <li>Apply labels evenly and securely to containers.</li>
                        <li>Perform visual inspection to confirm legibility and placement.</li>
                        <li>Application method: <input type="text" style="width:120px;" placeholder="Application method"></li>
                    </ul>
                    
                    <h4>2. Inventory Management</h4>
                    <p>Move finished products into designated quarantine area for finished goods.</p>
                    <p><strong>Storage location:</strong> <input type="text" style="width:120px;" placeholder="Storage location"></p>
                    <p><strong>Initials:</strong> <input type="text" style="width:120px;" placeholder="Initials"></p>
                    <p><strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                </div>
            `;
            
            document.getElementById('productSteps').innerHTML += soapInstructions;
            document.getElementById('instructions').classList.add('visible');
        }

        function showDeodorantInstructions(data) {

            
            const process = data.Process || {};
            const containerSKUs = data.ContainerSKUs || [];
            const pourTemp = data['Pour Temperature'] || data.PourTemperature || 'Unspecified';
            const pourConsistency = data['Pour Consistency'] || data.PourConsistency || 'Unspecified';
            const Aroma = data.Aroma || 'Unspecified';
            const phases = extractAllPhases(process);
            const deodorantInstructions = `
                <div style="font-family: Arial, sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 20px;">
                    <h2>Deodorant: Step-by-Step Manufacturing Process</h2>
                    
                    <h3>1. Preparation & Sanitization</h3>
                    <p>• Wear PPE (gloves, hairnet, lab coat, and face mask) to prevent contamination.</p>
                    
                    <h4>Equipment Needed:</h4>
                    <ul>
                        <li>Ingredient cups</li>
                        <li>Spatula</li>
                        <li>Immersion blender</li>
                        <li>Agitator</li>
                    </ul>
                    
                    <h4>✅ Clean & Sanitize Equipment:</h4>
                    <ul>
                        <li>Ensure all containers, utensils, and mixing vessels are cleaned and sanitized with alcohol or an approved cleaning solution.</li>
                        <li>Ensure there is no oil residue on any equipment, tools, or workspace.</li>
                        <li>Ensure the production area meets GMP requirements.</li>
                        <li>Ensure scale is working properly.</li>
                    </ul>
                    
                    <h4>✅ Weigh all ingredients</h4>
                    <p>For each ingredient in the formula:</p>
                    <ul>
                        <li>Place the container on the scale and tare it to zero.</li>
                        <li>Slowly add the ingredient until the exact required amount is reached. (Aim for ±0.1% accuracy or tighter if required.)</li>
                        <li>Close the container and place the pre-printed label for that ingredient on it.</li>
                        <li>For critical or expensive ingredients, have a second person verify.</li>
                    </ul>
                    
                    <p><strong>Initials:</strong> <input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                    
                    <hr style="margin: 20px 0;">
                    
                    ${generateDeodorantPhaseInstructions(phases)}
                    
                    <h3>7. Install agitator and prepare pot for filling.</h3>
                    <h3>8. Set temperature to <strong>${pourTemp}°C</strong>.</h3>
                    
                    <hr style="margin: 20px 0;">
                    
                    <h3>9. Filling Process</h3>
                    <ul>
                        <li>Ensure temperature has reached <strong>${pourTemp}°C</strong>.</li>
                        <li>Confirm container SKU <strong>${containerSKUs.join(', ') || 'Unspecified'}</strong><br> 
                        <strong>Initials:</strong> <input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></li>
                        <li>Dispense product directly into proper containers.</li>
                        <li>Place filled containers on a tray to cool.</li>
                    </ul>
                    
                    <p><strong>Initials:</strong> <input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                    
                    <hr style="margin: 20px 0;">
                    
                    <h3>10. Cooling Process</h3>
                    <p>Let products cool undisturbed, controlled environment for a minimum of 10 minutes or until fully solidified. Avoid contamination.</p>
                    
                    <hr style="margin: 20px 0;">
                    
                    <h3>11. In-Process Quality Control Checks</h3>
                    <p>Perform the following QC checks on at least 3 random units:</p>
                    <ul>
                        <li>Texture and consistency: <strong>${pourConsistency}</strong></li>
                        <li>Aroma: <strong>${Aroma}</strong></li>
                        <li>Visual inspection: Check for separation, graininess, air bubbles, or irregularities.</li>
                    </ul>
                    
                    <p>If deviations are observed, document immediately and notify supervisor before proceeding.</p>
                    
                    <p><strong>Quality Initials:</strong> <input type="text" style="width:120px;" placeholder="Quality Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                    
                    <hr style="margin: 20px 0;">
                    
                    <h3>12. Post-Fill Actions</h3>
                    <ul>
                        <li>Cap all containers securely using appropriate closures.</li>
                        <li>Inspect closures for proper application (tightness, alignment).</li>
                        <li>Shut down all filling equipment and clean per cleaning SOP.</li>
                        <li>Record number of containers filled.</li>
                    </ul>
                    
                    <p><strong>No. of Pieces Filled:</strong> <input type="text" style="width:120px;" placeholder="No. of Pieces Filled"></p>
                    <p><strong>Initials:</strong> <input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                    
                    <hr style="margin: 20px 0;">
                    
                    <h3>Labeling & Inventory Management</h3>
                    
                    <h4>1. Labeling</h4>
                    <ul>
                        <li>Confirm label SKU <strong>${containerSKUs.join(', ') || 'Unspecified'}</strong><br>
                        <strong>Initials:</strong> <input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></li>
                        <li>Apply labels evenly and securely to containers.</li>
                        <li>Perform visual inspection to confirm legibility and placement.</li>
                        <li>Application method: <input type="text" style="width:120px;" placeholder="Application method"></li>
                    </ul>
                    
                    <h4>2. Inventory Management</h4>
                    <p>Move finished products into designated quarantine area for finished goods.</p>
                    <p><strong>Storage location:</strong> <input type="text" style="width:120px;" placeholder="Storage location"></p>
                    <p><strong>Initials:</strong> <input type="text" style="width:120px;" placeholder="Initials"></p>
                    <p><strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                </div>
            `;
            
            document.getElementById('productSteps').innerHTML += deodorantInstructions;
            document.getElementById('instructions').classList.add('visible');
        }

        function extractAllPhases(process) {
            const phases = [];
            
            // Find all phase keys in the process object
            const phaseKeys = Object.keys(process).filter(key => key.startsWith('Phase '));
            
            // Sort phase keys numerically (Phase 1, Phase 2, etc.)
            phaseKeys.sort((a, b) => {
                const numA = parseInt(a.replace('Phase ', ''));
                const numB = parseInt(b.replace('Phase ', ''));
                return numA - numB;
            });
            
            // Extract info for each phase
            phaseKeys.forEach(phaseKey => {
                const phaseInfo = extractPhaseInfo(process, phaseKey);
                phaseInfo.name = phaseKey;
                phaseInfo.number = parseInt(phaseKey.replace('Phase ', ''));
                phases.push(phaseInfo);
            });
            
            return phases;
        }

        function generatePhaseInstructions(phases) {
            let instructions = '';
            let stepNumber = 1;
            
            phases.forEach((phase, index) => {
                instructions += `
                    <h3>${phase.name}:</h3>
                    <ol start="${stepNumber}">
                        <li>Set pot to <strong>${phase.temp}°C</strong>.</li>
                        <li>${index === 0 ? 'Add' : `${index === phases.length - 1 ? 'Once temperature has reached 65°C, add' : 'Add'}`} <strong>${phase.ingredients}</strong> to pot.<br>
                        ${index === 0 ? 'Stir occasionally with spatula to help melt quicker.' : 
                          index === phases.length - 1 ? 'Mix with immersion blender until smooth and homogenized.' : 
                          'Stir with spatula for 30 seconds to ensure uniform blending.'}</li>
                    </ol>
                    
                    <p><strong>Initials:</strong> <input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                    
                    <p><strong>Temperature:</strong> ${phase.temp}°C<br>
                    <strong>${phase.timeType} Time:</strong> ${phase.time} mins<br>
                    <strong>Consistency:</strong> ${phase.consistency}</p>
                    
                    <p><strong>Initials:</strong> <input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                    
                    <hr style="margin: 20px 0;">
                `;
                
                stepNumber += 2; // Each phase uses 2 steps
            });
            
            return instructions;
        }

        function extractPhaseInfo(process, phaseName) {
            const phaseData = process[phaseName] || {};
            const phaseInfo = {
                temp: '[Phase temp]',
                time: '[Phase time]',
                timeType: 'Mix', // Default to Mix
                consistency: '[Phase consistency]',
                ingredients: '[Phase ingredients]'
            };

            // Extract temperature - look for specific pattern
            const tempKey = Object.keys(phaseData).find(key => 
                key.includes('Temperature') || key.includes('Temperature(C)')
            );
            if (tempKey) {
                phaseInfo.temp = phaseData[tempKey] || 'Unspecified';
            }

            // Extract time and determine if it's Melt Time or Mix Time
            const meltTimeKey = Object.keys(phaseData).find(key => 
                key.includes('Melt Time') || key.includes('Melt Time(Hours)')
            );
            const mixTimeKey = Object.keys(phaseData).find(key => 
                key.includes('Mix Time') || key.includes('Mix Time(Hours)')
            );
            
            if (meltTimeKey) {
                phaseInfo.time = phaseData[meltTimeKey] || 'Unspecified';
                phaseInfo.timeType = 'Melt';
            } else if (mixTimeKey) {
                phaseInfo.time = phaseData[mixTimeKey] || 'Unspecified';
                phaseInfo.timeType = 'Mix';
            }
            
            // Convert hours to minutes for display (if it's a number)
            if (!isNaN(phaseInfo.time) && phaseInfo.time !== 'Unspecified') {
                phaseInfo.time = (parseFloat(phaseInfo.time) * 60).toString(); // Convert hours to minutes
            }

            // Extract consistency
            const consistencyKey = Object.keys(phaseData).find(key => key.includes('Consistency'));
            if (consistencyKey) {
                phaseInfo.consistency = phaseData[consistencyKey] || 'Unspecified';
            }

            // Extract ingredients (prefer Name fields, fallback to SKU or name, and use global skuToName map if available)
            const ingredientsKey = Object.keys(phaseData).find(key => key.includes('Ingredients'));
            if (ingredientsKey && Array.isArray(phaseData[ingredientsKey])) {
                // Try to use a global skuToName map if it exists (set by batch card table rendering)
                let skuToName = window._skuToNameMap || {};
                const ingredients = phaseData[ingredientsKey].map(ing => {
                    // Prefer explicit name fields
                    if (ing.Name) return ing.Name;
                    if (ing.name) return ing.name;
                    if (ing.IngredientName) return ing.IngredientName;
                    if (ing.ingredientName) return ing.ingredientName;
                    // If we have a SKU and a map, use the map
                    if (ing.IngredientSKU && skuToName[ing.IngredientSKU]) return skuToName[ing.IngredientSKU];
                    if (ing.SKU && skuToName[ing.SKU]) return skuToName[ing.SKU];
                    // Fallback to SKU
                    if (ing.IngredientSKU) return ing.IngredientSKU;
                    if (ing.SKU) return ing.SKU;
                    return 'Unspecified';
                }).join(', ');
                phaseInfo.ingredients = ingredients || 'Unspecified';
            }

            return phaseInfo;
        }

        function generateEmulsionPhaseInstructions(phases, pourTemp) {
            let instructions = '';
            let stepNumber = 1;
            
            // Generate instructions for all phases except the last one
            phases.slice(0, -1).forEach((phase, index) => {
                const phaseNum = index + 1;
                instructions += `
                    <h3>Phase ${phaseNum}:</h3>
                    <ol start="${stepNumber}">
                        <li>Set Phase ${phaseNum} pot to <strong>${phase.temp}°C</strong>.</li>
                        <li>Add <strong>${phase.ingredients}</strong> to Phase ${phaseNum} pot.<br>
                        ${phaseNum === 1 ? 'Mix continuously to help melt quicker.' : 'Mix continuously.'}</li>
                    </ol>
                    <p><strong>Initials:</strong><input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                    <p><strong>Temperature:</strong> ${phase.temp}°C<br>
                    <strong>${phase.timeType} Time:</strong> ${phase.time} mins<br>
                    <strong>Consistency:</strong> ${phase.consistency}</p>
                    <p><strong>Initials:</strong><input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                    <hr style="margin: 20px 0;">
                `;
                
                stepNumber += 2; // Each standard phase uses 2 steps
            });
            
            // Generate the final phase (combining phases and cooling)
            if (phases.length > 0) {
                const finalPhase = phases[phases.length - 1];
                const finalPhaseNum = phases.length;
                
                instructions += `
                    <h3>Phase ${finalPhaseNum}:</h3>
                    <ol start="${stepNumber}">
                        <li>Set temperature on ${phases.length > 1 ? `all previous phase pots` : 'Phase 1 pot'} to <strong>${finalPhase.temp}°C</strong>.</li>
                        <li>Once temperature is <strong>${finalPhase.temp}°C</strong>, ${phases.length > 1 ? `combine all previous phases together` : 'proceed with Phase 1'}.</li>
                        <li>Set temperature of pot to <strong>${pourTemp}°C</strong>.</li>
                        <li>Blend with immersion blender (or emulsifyer) for 5 minutes to ensure a homogenous mixture.</li>
                        <li>Start the cooling process - empty water jacket and refill with cold water from hose.</li>
                        <li>Repeat step ${stepNumber + 3}-${stepNumber + 4} until temperature has reached <strong>${pourTemp}°C</strong>.</li>
                    </ol>
                    
                    <p><strong>Initials:</strong><input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                    
                    <p><strong>${finalPhase.timeType} Time:</strong> ${finalPhase.time} mins<br>
                    <strong>Consistency:</strong> ${finalPhase.consistency}</p>
                    
                    <ol start="${stepNumber + 6}">
                        <li>Add <strong>${finalPhase.ingredients}</strong> to pot.<br>
                        Mix for 5 more minutes to ensure all ingredients are mixed in evenly.</li>
                    </ol>
                    <p><strong>Initials:</strong><input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                    <hr style="margin: 20px 0;">
                `;
            }
            
            return instructions;
        }

        function generateSoapPhaseInstructions(phases) {
            let instructions = '';
            let stepNumber = 1;
            
            phases.forEach((phase, index) => {
                const phaseNum = index + 1;
                instructions += `<h3>Phase ${phaseNum}:</h3>\n`;
                
                if (phaseNum === 1) {
                    // Phase 1 - melting base oils/fats
                    instructions += `<ol start="${stepNumber}">
                        <li>Set pot to <strong>${phase.temp}°C</strong>.</li>
                        <li>Add <strong>${phase.ingredients}</strong> to pot.<br>
                        Stir occasionally with spatula to help melt quicker.</li>
                    </ol>`;
                    stepNumber += 2;
                } else if (phaseNum === 2) {
                    // Phase 2 - typically lye solution (needs special safety instructions)
                    instructions += `<ol start="${stepNumber}">
                        <li>PPE Required: Gloves, respirator, safety glasses, lab coat. Add <strong>${phase.ingredients}</strong> to a bucket (water first) and mix vigorously for 30 seconds. Do not stand directly over the bucket while mixing or breathe the fumes coming off. The mixture will get very hot.</li>
                        <li>Allow mixture to cool for about an hour.</li>
                    </ol>`;
                    stepNumber += 2;
                } else if (phaseNum === phases.length - 1 && phases.length > 2) {
                    // Second to last phase - preparation before final combining
                    instructions += `<ol start="${stepNumber}">
                        <li>Add <strong>${phase.ingredients}</strong> to the bucket from Phase 2.<br>
                        Mix with immersion blender for 30 seconds to ensure uniform blending.</li>
                    </ol>`;
                    stepNumber += 1;
                } else if (phaseNum === phases.length && phases.length > 2) {
                    // Final phase - combining and trace formation
                    instructions += `
                    <p style="color: red; font-weight: bold; font-size: 1.1rem; background: #fff2f0; padding: 1rem; border: 2px solid #ff6b6b; border-radius: 8px; margin: 1rem 0;">
                        *****EVERYTHING FROM HERE ON IS TIME SENSITIVE - WORK QUICKLY! Have a supervisor close by if needed.*****
                    </p>
                    
                    <ol start="${stepNumber}">
                        <li>Ensure your mold is lined and ready for pouring.</li>
                        <li>Combine all of Phase 1 to the bucket.</li>
                        <li>Mix with immersion blender for 2 minutes or until a film starts to form on top.</li>
                        <li>Add <strong>${phase.ingredients}</strong> to bucket while still mixing.<br>
                        Mixture will start to get thicker.</li>
                        <li>Once mixture has reached medium trace, pour into lined mold.</li>
                    </ol>`;
                    stepNumber += 5;
                } else {
                    // Middle phases - general mixing
                    instructions += `<ol start="${stepNumber}">
                        <li>Add <strong>${phase.ingredients}</strong> to the mixture.<br>
                        Mix thoroughly to ensure uniform blending.</li>
                    </ol>`;
                    stepNumber += 1;
                }
                
                instructions += `
                    <p><strong>Initials:</strong><input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>

                    <p><strong>Temperature:</strong> ${phase.temp}°C<br>
                    <strong>${phase.timeType} Time:</strong> ${phase.time} mins<br>
                    <strong>Consistency:</strong> ${phase.consistency}</p>
                    
                    <p><strong>Initials:</strong><input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                    
                    <hr style="margin: 20px 0;">
                `;
            });
            
            return instructions;
        }

        // General manufacturing instructions for any other product type
        function showGeneralInstructions(data) {

            
            // Extract process data for dynamic values
            const process = data.Process || {};
            const containerSKUs = data.ContainerSKUs || [];
            
            // Extract pour temperature and consistency
            const pourTemp = data['Pour Temperature'] || data.PourTemperature || 'Unspecified';
            const pourConsistency = data['Pour Consistency'] || data.PourConsistency || 'Unspecified';
            const Aroma = data.Aroma || 'Unspecified';
            
            // Extract phase information dynamically
            const phases = extractAllPhases(process);
            
            const generalInstructions = `
                <div style="font-family: Arial, sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 20px;">
                    <h2>Main: Step-by-Step Manufacturing Process</h2>
                    
                    <h3>1. Preparation & Sanitization</h3>
                    <p>• Wear PPE (gloves, hairnet, lab coat, and face mask) to prevent contamination.</p>
                    
                    <h4>Equipment Needed:</h4>
                    <ul>
                        <li>Ingredient cups</li>
                        <li>Spatula</li>
                        <li>Agitator</li>
                    </ul>
                    
                    <h4>✅ Clean & Sanitize Equipment:</h4>
                    <ul>
                        <li>Ensure all containers, utensils, and mixing vessels are cleaned and sanitized with alcohol or an approved cleaning solution.</li>
                        <li>Ensure there is no oil residue on any equipment, tools, or workspace.</li>
                        <li>Ensure the production area meets GMP requirements.</li>
                        <li>Ensure scale is working properly.</li>
                    </ul>
                    
                    <h4>✅ Weigh all ingredients</h4>
                    <p>For each ingredient in the formula:</p>
                    <ul>
                        <li>Place the container on the scale and tare it to zero.</li>
                        <li>Slowly add the ingredient until the exact required amount is reached. (Aim for ±0.1% accuracy or tighter if required.)</li>
                        <li>Close the container and place the pre-printed label for that ingredient on it.</li>
                        <li>For critical or expensive ingredients, have a second person verify.</li>
                    </ul>
                    
                    <p><strong>Initials:</strong><input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                    
                    <p><strong>Install agitator.</strong></p>
                    
                    <hr style="margin: 20px 0;">
                    
                    ${generateGeneralPhaseInstructions(phases)}
                    
                    <h3>8. Set temperature to <strong>${pourTemp}°C</strong>.</h3>
                    
                    <hr style="margin: 20px 0;">
                    
                    <h3>9. Filling Process</h3>
                    <ul>
                        <li>Ensure temperature has reached <strong>${pourTemp}°C</strong>.</li>
                        <li>Confirm container SKU <strong>${containerSKUs.join(', ') || 'Unspecified'}</strong><br>
                        <strong>Initials:</strong><input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></li>
                        <li>Dispense product directly into proper containers.</li>
                        <li>Place filled containers on a tray to cool.</li>
                    </ul>
                    
                    <p><strong>Initials:</strong><input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                    
                    <hr style="margin: 20px 0;">
                    
                    <h3>10. Cooling Process</h3>
                    <p>Let products cool undisturbed, controlled environment for a minimum of 10 minutes or until fully solidified. Avoid contamination.</p>
                    
                    <hr style="margin: 20px 0;">
                    
                    <h3>11. In-Process Quality Control Checks</h3>
                    <p>Perform the following QC checks on at least 3 random units:</p>
                    <ul>
                        <li>Texture and consistency: <strong>${pourConsistency}</strong></li>
                        <li>Aroma: <strong>${Aroma}</strong></li>
                        <li>Visual inspection: Check for separation, graininess, air bubbles, or irregularities.</li>
                    </ul>
                    
                    <p>If deviations are observed, document immediately and notify supervisor before proceeding.</p>
                    
                    <p><strong>Quality Initials:</strong><input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                    
                    <hr style="margin: 20px 0;">
                    
                    <h3>12. Post-Fill Actions</h3>
                    <ul>
                        <li>Cap all containers securely using appropriate closures.</li>
                        <li>Inspect closures for proper application (tightness, alignment).</li>
                        <li>Shut down all filling equipment and clean per cleaning SOP.</li>
                        <li>Record number of containers filled.</li>
                    </ul>
                    
                    <p><strong>No. of Pieces Filled:</strong><input type="text" style="width:120px;" placeholder="No. of Pieces Filled"></p>
                    <p><strong>Initials:</strong><input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                    
                    <hr style="margin: 20px 0;">
                    
                    <h3>Labeling & Inventory Management</h3>
                    
                    <h4>1. Labeling</h4>
                    <ul>
                        <li>Confirm Container SKUs <strong>${containerSKUs.join(', ') || 'Unspecified'}</strong><br>
                        <strong>Initials:</strong><input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></li>
                        <li>Apply labels evenly and securely to containers.</li>
                        <li>Perform visual inspection to confirm legibility and placement.</li>
                        <li>Application method: <input type="text" style="width:300px;" placeholder="Application method"></li>
                    </ul>
                    
                    <h4>2. Inventory Management</h4>
                    <p>Move finished products into designated quarantine area for finished goods.</p>
                    <p><strong>Storage location:</strong> <input type="text" style="width:300px;" placeholder="Storage location"></p>
                    <p><strong>Initials:</strong><input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                </div>
            `;
            
            if (arguments[1]) {
                document.getElementById('productSteps').innerHTML += generalInstructions;
            } else {
                document.getElementById('productSteps').innerHTML = generalInstructions;
            }
            document.getElementById('instructions').classList.add('visible');
        }

        function generateGeneralPhaseInstructions(phases) {
            let instructions = '';
            
            phases.forEach((phase, index) => {
                const phaseNum = index + 1;
                instructions += `
                    <h3>Phase ${phaseNum}:</h3>
                    <ul>
                        <li>Set pot to <strong>${phase.temp}°C</strong>.</li>
                        <li>${phaseNum === 3 ? 'Once temperature reach 65°C or below, add' : 'Add'} <strong>${phase.ingredients}</strong> to pot.</li>
                        <li>${phaseNum === 1 ? 'Stir with agitator to help melt quicker.' : 
                             phaseNum === 3 ? 'Mix with agitator to ensure uniform consistency.' : 
                             'Stir with agitator ensure uniform blending.'}</li>
                    </ul>
                    
                    <p><strong>Initials:</strong><input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                    
                    <p><strong>Temperature:</strong> ${phase.temp}°C<br>
                    <strong>${phase.timeType} Time:</strong> ${phase.time} mins<br>
                    <strong>Consistency:</strong> ${phase.consistency}</p>
                    
                    <p><strong>Initials:</strong><input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                    
                    <hr style="margin: 20px 0;">
                `;
            });
            
            return instructions;
        }

        function generateDeodorantPhaseInstructions(phases) {
            let instructions = '';
            
            phases.forEach((phase, index) => {
                const phaseNum = index + 1;
                instructions += `
                    <h3>Phase ${phaseNum}:</h3>
                    <ul>
                        <li>Set pot to <strong>${phase.temp}°C</strong>.</li>
                        <li>${phaseNum === 3 ? 'Once temperature reach 65°C or below, add' : 'Add'} <strong>${phase.ingredients}</strong> to pot.</li>
                        <li>${phaseNum === 1 ? 'Stir occasionally with spatula to help melt quicker.' : 
                             phaseNum === 3 ? 'Mix with immersion blender for 2 minutes or until mixture reaches proper consistency.' : 
                             'Stir with spatula for 30 seconds to ensure uniform blending.'}</li>
                    </ul>
                    
                    <p><strong>Initials:</strong><input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                    
                    <p><strong>Temperature:</strong> ${phase.temp}°C<br>
                    <strong>${phase.timeType} Time:</strong> ${phase.time} mins<br>
                    <strong>Consistency:</strong> ${phase.consistency}</p>
                    
                    <p><strong>Initials:</strong><input type="text" style="width:120px;" placeholder="Initials"> &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date/Time:</strong> <input type="text" style="width:180px;" placeholder="Date/Time"></p>
                    
                    <hr style="margin: 20px 0;">
                `;
            });
            
            return instructions;
        }

        showInstructions();
        // Add Finish button after instructions
        function addFinishButton() {
            const instructionsDiv = document.getElementById('instructions');
            if (!instructionsDiv) return;
            // Only add once
            if (document.getElementById('finishInstructionsBtn')) return;
            const btn = document.createElement('button');
            btn.id = 'finishInstructionsBtn';
            btn.textContent = 'Finish & Save Instructions';
            btn.style = 'margin: 2rem auto; display: block; background: #4dba93; color: white; font-size: 1.2rem; padding: 1rem 2.5rem; border-radius: 8px; border: none; cursor: pointer; box-shadow: 0 4px 12px rgba(77,186,147,0.2);';
            btn.onclick = async function() {
                // Collect all input values
                const inputs = instructionsDiv.querySelectorAll('input');
                let filledInstructions = instructionsDiv.innerHTML;
                inputs.forEach(input => {
                    // Replace input with its value in the HTML
                    const value = input.value || '';
                    // Create a span to show the value for saving
                    const span = `<span style='background:#e9ecef;border-radius:4px;padding:2px 6px;'>${value}</span>`;
                    filledInstructions = filledInstructions.replace(input.outerHTML, span);
                });
                // Save to Supabase storage bucket
                const sku = getSku();
                const filename = `instructions_${sku}_${Date.now()}.html`;
                try {
                    const { data, error } = await supabase.storage
                        .from('manufacturinginstructions')
                        .upload(filename, new Blob([filledInstructions], { type: 'text/html' }), {
                            cacheControl: '3600',
                            upsert: true
                        });
                    if (error) {
                        alert('Failed to save instructions: ' + error.message);
                    } else {
                        alert('Instructions saved to Supabase!');
                    }
                } catch (err) {
                    alert('Error saving instructions: ' + err.message);
                }
            };
            instructionsDiv.appendChild(btn);
        }

        // Call after instructions are rendered
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(addFinishButton, 1200);
        });
    </script>
</body>
</html>