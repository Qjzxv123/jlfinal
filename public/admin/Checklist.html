<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Checklist</title>
  <link rel="stylesheet" href="https://unpkg.com/@coreui/icons/css/all.min.css">
  <link rel="stylesheet" href="/Assets/sidebar.css">
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #c1de9f 0%, #4dba93 100%);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      color: #333;
    }
    .main-content {
      margin: 2rem auto;
      max-width: 800px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 6px 32px rgba(0,0,0,0.12);
      padding: 2rem;
    }
    h1 {
      color: #2d3748;
      margin-bottom: 2rem;
    }
    .checklist-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 2rem;
    }
    .checklist-table th, .checklist-table td {
      border: 1px solid #e2e8f0;
      padding: 1rem;
      text-align: left;
      font-size: 1.05rem;
    }
    .checklist-table th {
      background: #f1f5f9;
      font-weight: 600;
      color: #374151;
    }
    .checklist-table td.status-complete { background: #d1fae5; color: #065f46; }
    .checklist-table td.status-incomplete { background: #fee2e2; color: #b91c1c; }
    .checklist-table td button {
      padding: 0.5rem 1rem;
      border-radius: 6px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      background: #4dba93;
      color: white;
      transition: background 0.2s;
    }
    .checklist-table td button:hover {
      background: #379c7a;
    }
    .add-task-form {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 2rem;
      align-items: flex-end;
    }
    .add-task-form label {
      font-weight: 600;
      margin-bottom: 0.2rem;
      display: block;
    }
    .add-task-form input, .add-task-form select {
      padding: 0.5rem 1rem;
      border-radius: 6px;
      border: 1px solid #cbd5e1;
      font-size: 1rem;
      background: #f8fafc;
      margin-bottom: 0.5rem;
    }
    .add-task-form button {
      background: #4dba93;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 0.7rem 1.5rem;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .add-task-form button:hover {
      background: #379c7a;
    }
    .status-complete { color: #27ae60; }
    .status-incomplete { color: #e74c3c; }
    .section-header {
      background: #f1f5f9;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .collapse-arrow {
      display: inline-block;
      transition: transform 0.2s;
      font-size: 1.2rem;
    }
    .section-title {
      font-weight: 600;
      color: #374151;
    }
    .table-container {
      margin-bottom: 2rem;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/Assets/CheckAccess.js"></script>
  <link rel="icon" type="image/x-icon" href="/Assets/favicon.ico">
</head>
  <body>
  <!-- Sidebar (injected by sidebar.js) -->
  <div id="sidebar"></div>
  <script src="/Assets/sidebar.js"></script>
  <div class="main-content" id="mainContent">
    <h1>Checklist</h1>
    <button id="openAddTaskModalBtn" style="background:#4dba93; color:white; border:none; border-radius:6px; padding:0.7rem 1.5rem; font-size:1.1rem; font-weight:600; cursor:pointer; margin-bottom:2rem;">Add Task</button>
    <div id="addTaskModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:2200; align-items:center; justify-content:center;">
      <div style="background:white; padding:2em 2em 1.5em 2em; border-radius:12px; min-width:320px; max-width:90vw; box-shadow:0 4px 24px rgba(0,0,0,0.18); position:relative;">
        <h3 style="margin-top:0;">Add New Task</h3>
        <form class="add-task-form" id="addTaskForm">
          <div>
            <label for="task">Task</label>
            <input type="text" id="task" required placeholder="Task description">
          </div>
          <div>
            <label for="priority">Priority</label>
            <select id="priority">
                <option value="Low">Low</option>
              <option value="Medium">Medium</option>
                <option value="High">High</option>
            </select>
          </div>
          <div>
            <label for="assignedTo">Assign To</label>
            <select id="assignedTo">
              <option value="">Select user...</option>
            </select>
          </div>
          <div>
            <label for="Deadline">Deadline (optional)</label>
            <input type="date" id="Deadline">
          </div>
          <div style="display:flex; gap:1em; justify-content:flex-end; margin-top:1em;">
            <button type="button" id="closeAddTaskModalBtn" style="background:#e2e8f0; color:#374151; border:none; border-radius:6px; padding:0.6em 1.2em; font-size:1em; cursor:pointer;">Cancel</button>
            <button type="submit" style="background:#4dba93; color:white; border:none; border-radius:6px; padding:0.7rem 1.5rem; font-size:1.1rem; font-weight:600; cursor:pointer;">Add Task</button>
          </div>
        </form>
      </div>
    </div>
    <div id="incompleteSection" style="margin-top:2rem;">
      <div class="section-header" id="header-incomplete">
        <span><span class="collapse-arrow">&#9654;</span><span class="section-title">Incomplete Tasks</span></span>
      </div>
      <div class="table-container" id="table-incomplete">
        <table class="checklist-table" id="incompleteTable">
          <thead>
            <tr>
              <th>Task</th>
              <th>Priority</th>
              <th>Assigned To</th>
              <th>Assigned By</th>
              <th>Deadline</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="incompleteTableBody">
            <!-- Incomplete tasks will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>
    <div id="awaitingConfirmationSection" style="margin-top:2rem;">
      <div class="section-header" id="header-awaitingConfirmation">
        <span><span class="collapse-arrow">&#9654;</span><span class="section-title">Awaiting Confirmation</span></span>
      </div>
      <div class="table-container" id="table-awaitingConfirmation">
        <table class="checklist-table" id="awaitingConfirmationTable">
          <thead>
            <tr>
              <th>Task</th>
              <th>Priority</th>
              <th>Assigned To</th>
              <th>Assigned By</th>
              <th>Deadline</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="awaitingConfirmationTableBody">
            <!-- Awaiting confirmation tasks will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <script>
// Use shared admin/employee check and inactivity timeout
    checkPermissions(['service_role','employee']);
    setup    
    async function fetchTasks() {
      const { data, error } = await supabase
        .from('Checklist')
        .select('*')
      if (error) {
        alert('Failed to fetch tasks: ' + error.message);
        return [];
      }
      return data || [];
    }

    async function addTask(task) {
      const { error } = await supabase
        .from('Checklist')
        .insert([task]);
      if (error) {
        alert('Failed to add task: ' + error.message);
        return false;
      }
      return true;
    }

    async function updateTaskStatus(id, status) {
      const { error } = await supabase
        .from('Checklist')
        .update({ Status: status })
        .eq('id', id);
      if (error) {
        alert('Failed to update task: ' + error.message);
      }
    }
    async function removeTask(id) {
      const { error } = await supabase
        .from('Checklist')
        .delete()
        .eq('id', id);
      if (error) {
        alert('Failed to remove task: ' + error.message);
      }
    }
    function renderIncompleteTasks(tasks) {
      const tbody = document.getElementById('incompleteTableBody');
      tbody.innerHTML = '';
      for (const task of tasks) {
        const tr = document.createElement('tr');
        const deadline = task.Deadline ? new Date(task.Deadline).toLocaleDateString() : '';
        tr.innerHTML = `
          <td>${task.Task || ''}</td>
          <td>${task.Priority || ''}</td>
          <td>${task.AssignedTo || ''}</td>
          <td>${task.AssignedBy || ''}</td>
          <td>${deadline}</td>
          <td><button class="mark-awaiting-btn" data-id="${task.id}" title="Mark Awaiting Confirmation" style="background:#4dba93;color:white;border:none;border-radius:6px;padding:0.5rem 1rem;font-size:1.2rem;cursor:pointer;"><span style="font-size:1.3em;">&#10003;</span></button></td>
        `;
        tbody.appendChild(tr);
      }
      // Add event listeners for Mark Awaiting Confirmation
      document.querySelectorAll('.mark-awaiting-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
          const id = this.getAttribute('data-id');
          await updateTaskStatus(id, 'Awaiting Confirmation');
          loadTasks();
        });
      });
    }
    function renderAwaitingConfirmationTasks(tasks) {
      const tbody = document.getElementById('awaitingConfirmationTableBody');
      tbody.innerHTML = '';
      for (const task of tasks) {
        const tr = document.createElement('tr');
        const deadline = task.Deadline ? new Date(task.Deadline).toLocaleDateString() : '';
        let actionCell = '';
        if (task.AssignedBy === CurrentUserDisplayName) {
          actionCell = `<button class="confirm-complete-btn" data-id="${task.id}">Confirm Complete</button>`;
        }
        tr.innerHTML = `
          <td>${task.Task || ''}</td>
          <td>${task.Priority || ''}</td>
          <td>${task.AssignedTo || ''}</td>
          <td>${task.AssignedBy || ''}</td>
          <td>${deadline}</td>
          <td>${actionCell}</td>
        `;
        tbody.appendChild(tr);
      }
      // Add event listeners for Confirm Complete
      document.querySelectorAll('.confirm-complete-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
          const id = this.getAttribute('data-id');
          // Remove task from table by deleting from database
          await removeTask(id);
          loadTasks();
        });
      });
    }
    async function loadTasks() {
      const tasks = await fetchTasks();
      // Only show tasks with status 'Incomplete' in Incomplete Table
      const incompleteTasks = tasks.filter(t => t.Status === 'Incomplete');
      renderIncompleteTasks(incompleteTasks);
      // Only show tasks with status 'Awaiting Confirmation' in Awaiting Confirmation Table
      const awaitingTasks = tasks.filter(t => t.Status === 'Awaiting Confirmation');
      renderAwaitingConfirmationTasks(awaitingTasks);
    }


    // Populate Assigned To select from Users table
    async function populateAssignedToSelect() {
      const { data, error } = await supabase
        .from('Users')
        .select('id, display_name, "Role"');
      const select = document.getElementById('assignedTo');
      if (!select) return;
      select.innerHTML = '<option value="">Select user...</option>';
      if (data) {
        data.forEach(user => {
          const label = user.display_name ? `${user.display_name} (${user.Role || ''})` : user.id;
          const option = document.createElement('option');
          option.value = JSON.stringify({id: user.id, display_name: user.display_name || '', Role: user.Role || ''});
          option.textContent = label;
          select.appendChild(option);
        });
      }
    }
    // Call on page load
    populateAssignedToSelect();

    document.getElementById('addTaskForm').onsubmit = async function(e) {
      e.preventDefault();
      let assignedObj = {};
      try {
        assignedObj = JSON.parse(document.getElementById('assignedTo').value);
      } catch (err) {
        assignedObj = {id: '', display_name: '', Role: ''};
      }
      const task = {
        Task: document.getElementById('task').value.trim(),
        Priority: document.getElementById('priority').value,
        AssignedTo: assignedObj.display_name,
        AssignedBy: CurrentUserDisplayName,
        UserID: [assignedObj.id, CurrentUserID],
        Deadline: document.getElementById('Deadline').value || null,
        Status: 'Incomplete',
      };
      if (!task.Task) {
        alert('Please enter a task description.');
        return;
      }
      const success = await addTask(task);
      if (success) {
        document.getElementById('addTaskForm').reset();
        loadTasks();
        // Close modal after adding task
        document.getElementById('addTaskModal').style.display = 'none';
      }
    };

    // Collapsible completed tasks
    const toggleCompletedBtn = document.getElementById('toggleCompletedBtn');
    const completedSection = document.getElementById('completedTasksSection');
    let completedVisible = false;
    if (toggleCompletedBtn && completedSection) {
      toggleCompletedBtn.addEventListener('click', function() {
        completedVisible = !completedVisible;
        completedSection.style.display = completedVisible ? '' : 'none';
        toggleCompletedBtn.textContent = completedVisible ? 'Hide Completed Tasks ▲' : 'Show Completed Tasks ▼';
      });
    }

    // Modal logic for Add Task
    const openAddTaskModalBtn = document.getElementById('openAddTaskModalBtn');
    const addTaskModal = document.getElementById('addTaskModal');
    const closeAddTaskModalBtn = document.getElementById('closeAddTaskModalBtn');

    openAddTaskModalBtn.onclick = function() {
      addTaskModal.style.display = 'flex';
    };
    closeAddTaskModalBtn.onclick = function() {
      addTaskModal.style.display = 'none';
    };
    addTaskModal.onclick = function(e) {
      if (e.target === addTaskModal) addTaskModal.style.display = 'none';
    };

    document.addEventListener('DOMContentLoaded', function() {
      // Collapsible Incomplete Table
      let incompleteCollapsed = false;
      const incompleteHeader = document.getElementById('header-incomplete');
      const incompleteTableContainer = document.getElementById('table-incomplete');
      const incompleteArrow = incompleteHeader ? incompleteHeader.querySelector('.collapse-arrow') : null;
      if (incompleteHeader && incompleteTableContainer && incompleteArrow) {
        incompleteHeader.addEventListener('click', function() {
          incompleteCollapsed = !incompleteCollapsed;
          if (incompleteCollapsed) {
            incompleteTableContainer.style.display = 'none';
            incompleteHeader.classList.add('collapsed');
            incompleteArrow.style.transform = 'rotate(-90deg)';
          } else {
            incompleteTableContainer.style.display = '';
            incompleteHeader.classList.remove('collapsed');
            incompleteArrow.style.transform = '';
          }
        });
        // Expanded by default
        incompleteTableContainer.style.display = '';
        incompleteHeader.classList.remove('collapsed');
        incompleteArrow.style.transform = '';
      }

      // Collapsible Awaiting Confirmation Table
      let awaitingCollapsed = false;
      const awaitingHeader = document.getElementById('header-awaitingConfirmation');
      const awaitingTableContainer = document.getElementById('table-awaitingConfirmation');
      const awaitingArrow = awaitingHeader ? awaitingHeader.querySelector('.collapse-arrow') : null;
      if (awaitingHeader && awaitingTableContainer && awaitingArrow) {
        awaitingHeader.addEventListener('click', function() {
          awaitingCollapsed = !awaitingCollapsed;
          if (awaitingCollapsed) {
            awaitingTableContainer.style.display = 'none';
            awaitingHeader.classList.add('collapsed');
            awaitingArrow.style.transform = 'rotate(-90deg)';
          } else {
            awaitingTableContainer.style.display = '';
            awaitingHeader.classList.remove('collapsed');
            awaitingArrow.style.transform = '';
          }
        });
        // Expanded by default
        awaitingTableContainer.style.display = '';
        awaitingHeader.classList.remove('collapsed');
        awaitingArrow.style.transform = '';
      }
    });

    // Initial load
    loadTasks();
  </script>
</body>
</html>