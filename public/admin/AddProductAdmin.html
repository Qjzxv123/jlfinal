<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add/Update Product</title>
  <link rel="stylesheet" href="https://unpkg.com/@coreui/icons/css/all.min.css">
  <link rel="stylesheet" href="/Assets/sidebar.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #c1de9f 0%, #4dba93 100%);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      color: #333;
    }
    .main-content {
      margin-left: 60px;
      transition: margin-left 0.3s ease;
      width: calc(100% - 60px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
    }
    .container {
      background: white;
      padding: 32px 28px;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.13);
      max-width: 800px;
      width: 100%;
      margin-top: 40px;
    }
    h2 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 18px;
    }
    form label {
      display: block;
      margin-top: 14px;
      font-weight: 600;
      color: #34495e;
    }
    form input, form select, form textarea {
      width: 100%;
      padding: 10px;
      margin-top: 4px;
      border: 1.5px solid #e1e5e9;
      border-radius: 7px;
      font-size: 1rem;
      margin-bottom: 8px;
      box-sizing: border-box;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      background-color: #fff;
    }
    form input:hover, form select:hover, form textarea:hover {
      outline: none;
      border-color: #4DBA93;
      box-shadow: 0 0 0 3px rgba(77, 186, 147, 0.1);
    }
    form select {
      cursor: pointer;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 8px center;
      background-repeat: no-repeat;
      background-size: 16px;
      padding-right: 40px;
    }
    form select:hover {
      border-color: #4DBA93;
    }
    form select option {
      padding: 8px 12px;
      background-color: #fff;
      color: #333;
    }
    form select option:hover {
      background-color: #f0f9ff;
    }
    form input[type="checkbox"] {
      width: auto;
      margin-right: 8px;
    }
    .btn {
      background: #4DBA93;
      color: white;
      border: none;
      padding: 12px 0;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: 600;
      width: 100%;
      margin-top: 18px;
      transition: background 0.2s;
    }
    .btn:hover {
      background: #379c7a;
    }
    .status {
      text-align: center;
      margin-top: 12px;
      font-weight: 600;
    }
    .status.success { color: #27ae60; }
    .status.error { color: #e74c3c; }
    /* Ingredient Dropdown Styles */
    .ingredient-dropdown-container {
      position: relative;
    }
    .ingredient-search {
      width: 100%;
      padding: 0.3rem 0.5rem;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .ingredient-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #cbd5e1;
      border-top: none;
      border-radius: 0 0 4px 4px;
      max-height: 150px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .ingredient-option {
      padding: 0.5rem;
      cursor: pointer;
      border-bottom: 1px solid #e5e7eb;
      font-size: 0.85rem;
    }
    .ingredient-option:hover {
      background: #f3f4f6;
    }
    .ingredient-option:last-child {
      border-bottom: none;
    }
    /* Product Dropdown Styles */
    .product-dropdown-container {
      position: relative;
    }
    .product-search {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 1rem;
      margin: 0;
    }
    .product-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #d1d5db;
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 9999;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .product-option {
      padding: 0.75rem;
      cursor: pointer;
      border-bottom: 1px solid #e5e7eb;
    }
    .product-option:hover {
      background: #f3f4f6;
    }
    .product-option:last-child {
      border-bottom: none;
    }
    .product-option .product-name {
      font-weight: 500;
      color: #1f2937;
    }
    .product-option .product-details {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <script src="/Assets/CheckAccess.js"></script>
  <link rel="icon" type="image/x-icon" href="/Assets/favicon.ico">
</head>
<body>
  <!-- Sidebar (injected by sidebar.js) -->
  <div id="sidebar"></div>
  <script src="/Assets/sidebar.js"></script>
  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <div class="container">
      <h2>Add/Update Product</h2>
      <div style="margin-bottom: 1rem; padding: 1rem; background: #f0f9ff; border-radius: 8px; border: 1px solid #bae6fd;">
        <label style="font-weight: 600; color: #1e40af; margin-bottom: 0.5rem; display: block;">Load from Existing Product:</label>
        <div id="loadFromProductDropdown"></div>
        <div style="font-size: 0.85rem; color: #6b7280; margin-top: 0.5rem;">This will populate all fields with data from an existing product for easy duplication or modification.</div>
      </div>
      <form id="productForm">
        <label>Product SKU*<input type="text" id="ProductSKU" required></label>
        <label>Name<input type="text" id="Name"></label>
        <label>Product Weight(oz)<input type="text" id="ProductSize" placeholder="e.g., 4, 8, 16, etc."></label>
        <label>Product Type
          <select id="ProductType">
            <option value="">Select Product Type</option>
            <option value="Balm 0.5">Balm 0.5</option>
            <option value="Deodorant">Deodorant</option>
            <option value="Serum">Serum</option>
            <option value="Oil">Oil</option>
            <option value="Balm 1.5">Balm 1.5</option>
            <option value="Rub">Rub</option>
            <option value="Mask">Mask</option>
            <option value="Powder">Powder</option>
            <option value="Scrub">Scrub</option>
            <option value="Soak">Soak</option>
            <option value="Conditioner">Conditioner</option>
            <option value="Soap Cube">Soap Cube</option>
            <option value="Soap Bar">Soap Bar</option>
            <option value="Soap Hotel">Soap Hotel</option>
            <option value="Shave Cube">Shave Cube</option>
            <option value="Shave Bar">Shave Bar</option>
            <option value="Shave Hotel">Shave Hotel</option>
            <option value="Shampoo Bar">Shampoo Bar</option>
            <option value="Balm 2.2">Balm 2.2</option>
            <option value="Butter">Butter</option>
            <option value="Infusion Oil">Infusion Oil</option>
            <option value="Cream">Cream</option>
            <option value="Skin Toner">Skin Toner</option>
            <option value="Water Mixture">Water Mixture</option>
            <option value="Shampoo bar machine">Shampoo bar machine</option>
            <option value="Conditioner molds">Conditioner molds</option>
            <option value="Conditioner Small">Conditioner Small</option>
            <option value="Balm">Balm</option>
            <option value="Infusion Oil + Seal">Infusion Oil + Seal</option>
            <option value="Premixed">Premixed</option>
            <option value="Oil with Machine">Oil with Machine</option>
            <option value="Oily Gel">Oily Gel</option>
            <option value="Oil with machine and box">Oil with machine and box</option>
            <option value="Shower Steamer">Shower Steamer</option>
            <option value="Candle">Candle</option>
            <option value="Emulsion">Emulsion</option>
            <option value="Balm with tube machine">Balm with tube machine</option>
            <option value="Balm 2oz+">Balm 2oz+</option>
            <option value="Serum Hotana">Serum Hotana</option>
            <option value="Hotana Unrefined Machine">Hotana Unrefined Machine</option>
            <option value="Specialized Emulsion">Specialized Emulsion</option>
            <option value="Makeup">Makeup</option>
          </select>
        </label>
        <label>Microbial Testing <input type="checkbox" id="MicrobialTesting"></label>
        <label>Container SKUs
          <div id="containerSKUsContainer" style="margin-top: 0.5rem;">
            <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
              <div id="containerDropdown" style="flex: 1;"></div>
              <button type="button" class="btn" style="background: #10b981; width: auto; padding: 0.5rem 1rem; margin: 0;" onclick="addSelectedContainer()">Add Container</button>
            </div>
            <div id="selectedContainers" style="margin-top: 0.5rem;"></div>
            <input type="hidden" id="ContainerSKUs" />
          </div>
        </label>
        <label>Amazon Packages
          <div id="amazonPackagesContainer" style="margin-top: 0.5rem;">
            <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
              <div id="amazonDropdown" style="flex: 1;"></div>
              <button type="button" class="btn" style="background: #f59e42; width: auto; padding: 0.5rem 1rem; margin: 0;" onclick="addSelectedAmazonPackage()">Add Amazon Package</button>
            </div>
            <div id="selectedAmazonPackages" style="margin-top: 0.5rem;"></div>
            <input type="hidden" id="AmazonPackages" />
          </div>
        </label>
        <label>Archived <input type="checkbox" id="Archived"></label>
        <label>Retailer<input type="text" id="Customer"></label>
        <label>Shelf Life (months)<input type="number" id="ShelfLife" min="0" step="any"></label>
        <label>Pack Size<input type="number" id="PackSize" min="0" step="1"></label>
        <label>Quantity<input type="number" id="Quantity" step="1"></label>
        <label>Quantity Per Bin<input type="number" id="QuantityPerBin" step="1" min="0" placeholder="e.g., 12"></label>
        <label>MSRP<input type="number" id="MSRP" min="0" step="any"></label>
        <label>Pour Temperature (°C)<input type="number" id="PourTemperature" min="0" step="any" placeholder="e.g., 45, 60, 80"></label>
        <label>Pour Consistency<input type="text" id="PourConsistency" placeholder="e.g., Thick, Thin, Viscous"></label>
        <label>Aroma<input type="text" id="Aroma" placeholder="e.g., Floral, Citrus, Earthy, Minty"></label>
    <label style="display:flex;align-items:center;gap:0.5em;margin-top:1em;">
      <input type="checkbox" id="useCustomInstructions" style="width:auto;"> Use Custom Manufacturing Instructions
    </label>
    <div id="manufacturingInstructionsContainer" style="display:none;">
      <label>Manufacturing Instructions
        <textarea id="ManufacturingInstructions" rows="6" style="width:100%;padding:10px;border-radius:8px;border:1.5px solid #e1e5e9;font-size:1rem;margin-top:4px;margin-bottom:8px;box-sizing:border-box;resize:vertical;" placeholder="Enter detailed manufacturing instructions here..."></textarea>
      </label>
    </div>
        <div style="margin-top:18px;">
          <label style="font-weight:600; color:#34495e;">Process Editor:</label>
          <div id="processTableEditor"></div>
          <button type="button" class="btn" style="background:#8b5cf6;margin-top:10px;" onclick="addPhaseRow()">Add Phase</button>
          <div style="font-size:0.9rem;color:#6b7280;margin-top:0.25rem;">Edit phases and ingredients below. All changes will be saved as process JSON.</div>
        </div>
        <button type="submit" class="btn">Add/Update Product</button>
      </form>
      <div class="status" id="statusMsg"></div>
    </div>
  </div>
  <script>
    // Use shared admin check and inactivity timeout
    checkPermissions(['service_role']);
    setupInactivityTimeout(10);

    const form = document.getElementById('productForm');
    const statusMsg = document.getElementById('statusMsg');

    let processTableData = [];
    let allIngredients = [];
    let allProducts = [];

    // Container management
    let selectedContainerSKUs = [];
    let selectedAmazonPackages = [];

    // Fetch all products for dropdown
    async function fetchAllProducts() {
      try {
        const { data: products, error } = await supabase
          .from('Products')
          .select('ProductSKU, Name, Retailer, "Product Type"')
          .order('ProductSKU');

        if (error) {
          console.error('Error fetching products:', error);
          return;
        }

        allProducts = products || [];
        console.log(`Loaded ${allProducts.length} products`);
        createProductDropdown();
      } catch (error) {
        console.error('Error fetching products:', error);
      }
    }

    // Create product dropdown with search functionality
    function createProductDropdown() {
      const container = document.getElementById('loadFromProductDropdown');
      if (!container) return;

      const dropdownHTML = `
        <div class="product-dropdown-container">
          <input type="text" class="product-search" placeholder="Type to search products..." />
          <div class="product-dropdown" style="display: none;"></div>
          <input type="hidden" class="selected-product-sku" value="" />
        </div>
      `;

      container.innerHTML = dropdownHTML;

      const searchInput = container.querySelector('.product-search');
      const dropdown = container.querySelector('.product-dropdown');
      const hiddenSKU = container.querySelector('.selected-product-sku');

      // Filter and display products based on search
      function updateDropdown(searchTerm = '') {
        const filtered = allProducts.filter(product => {
          const searchText = `${product.ProductSKU} ${product.Name || ''} ${product.Retailer || ''} ${product['Product Type'] || ''}`.toLowerCase();
          return searchText.includes(searchTerm.toLowerCase());
        });

        dropdown.innerHTML = '';
        
        filtered.slice(0, 20).forEach(product => {
          const option = document.createElement('div');
          option.className = 'product-option';
          option.innerHTML = `
            <div class="product-name">${product.ProductSKU} - ${product.Name || 'No Name'}</div>
            <div class="product-details">
              Retailer: ${product.Retailer || 'No Retailer'} | Type: ${product['Product Type'] || 'No Type'}
            </div>
          `;
          
          option.addEventListener('click', async () => {
            searchInput.value = `${product.ProductSKU} - ${product.Name || 'No Name'}`;
            hiddenSKU.value = product.ProductSKU;
            dropdown.style.display = 'none';
            
            // Automatically load the selected product
            await loadProductData(product.ProductSKU);
          });
          
          dropdown.appendChild(option);
        });

        if (filtered.length === 0) {
          dropdown.innerHTML = '<div class="product-option" style="color: #6b7280; font-style: italic;">No products found</div>';
        }
      }

      // Show dropdown when input is focused
      searchInput.addEventListener('focus', () => {
        updateDropdown(searchInput.value);
        dropdown.style.display = 'block';
      });

      // Update dropdown as user types
      searchInput.addEventListener('input', (e) => {
        updateDropdown(e.target.value);
        dropdown.style.display = 'block';
        hiddenSKU.value = ''; // Clear selection when typing
      });

      // Hide dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!container.contains(e.target)) {
          dropdown.style.display = 'none';
        }
      });
    }

    // Load product data by SKU
    async function loadProductData(sku) {
      if (!sku) return;

      try {
        statusMsg.textContent = 'Loading product data...';
        statusMsg.className = 'status';
        
        const { data: product, error } = await supabase
          .from('Products')
          .select('*')
          .eq('ProductSKU', sku)
          .single();

        if (error) {
          statusMsg.textContent = 'Product not found: ' + error.message;
          statusMsg.className = 'status error';
          return;
        }

        if (!product) {
          statusMsg.textContent = 'No product found with SKU: ' + sku;
          statusMsg.className = 'status error';
          return;
        }

        // Populate all form fields
        document.getElementById('ProductSKU').value = product.ProductSKU; 
        document.getElementById('Name').value = product.Name || '';
        document.getElementById('ProductSize').value = product['Product Weight(oz)'] || '';
        document.getElementById('ProductType').value = product['Product Type'] || '';
        document.getElementById('MicrobialTesting').checked = product['Microbial Testing'] || false;
        loadContainersFromString(product.ContainerSKUs);
        loadAmazonPackagesFromString(product.AmazonPackages);
        document.getElementById('Archived').checked = product.Archived || false;
        document.getElementById('Customer').value = product.Retailer || '';
        document.getElementById('ShelfLife').value = product.ShelfLife || '';
        document.getElementById('PackSize').value = product['Pack Size'] || '';
        document.getElementById('Quantity').value = product.Quantity || '';
        document.getElementById('MSRP').value = product.MSRP || '';
        document.getElementById('PourTemperature').value = product['Pour Temperature'] || '';
        document.getElementById('PourConsistency').value = product['Pour Consistency'] || '';
        document.getElementById('Aroma').value = product.Aroma || '';

        // Manufacturing Instructions logic
        const miCheckbox = document.getElementById('useCustomInstructions');
        const miContainer = document.getElementById('manufacturingInstructionsContainer');
        if (product.ManufacturingInstructions && String(product.ManufacturingInstructions).trim() !== "") {
          miCheckbox.checked = true;
          miContainer.style.display = '';
          document.getElementById('ManufacturingInstructions').value = product.ManufacturingInstructions;
        } else {
          miCheckbox.checked = false;
          miContainer.style.display = 'none';
          document.getElementById('ManufacturingInstructions').value = '';
        }

        // Load process data
        if (product.Process && typeof product.Process === 'object') {
          processTableData = [];
          
          Object.keys(product.Process)
            .filter(phaseName => phaseName.toLowerCase().includes('phase'))
            .forEach(phaseName => {
            const phaseData = product.Process[phaseName];
            const phase = {
              name: phaseName,
              temp: '',
              timeType: 'Mix',
              mixTime: '',
              consistency: '',
              ingredients: []
            };

            // Extract temperature
            const tempKey = Object.keys(phaseData).find(key => key.includes('Temperature'));
            if (tempKey) {
              phase.temp = phaseData[tempKey];
            }

            // Extract time and time type
            const timeKey = Object.keys(phaseData).find(key => key.includes('Time'));
            if (timeKey) {
              phase.mixTime = phaseData[timeKey];
              if (timeKey.includes('Melt')) {
                phase.timeType = 'Melt';
              } else if (timeKey.includes('Mix')) {
                phase.timeType = 'Mix';
              }
            }

            // Extract consistency
            const consistencyKey = Object.keys(phaseData).find(key => key.includes('Consistency'));
            if (consistencyKey) {
              phase.consistency = phaseData[consistencyKey];
            }

            // Extract ingredients
            const ingredientsKey = Object.keys(phaseData).find(key => key.includes('Ingredients'));
            if (ingredientsKey && Array.isArray(phaseData[ingredientsKey])) {
              phase.ingredients = phaseData[ingredientsKey].map(ing => {
                // Find ingredient name from SKU
                const ingredientData = allIngredients.find(ai => ai.IngredientSKU === ing.IngredientSKU);
                return {
                  name: ingredientData ? ingredientData.Name : ing.IngredientSKU,
                  sku: ing.IngredientSKU,
                  percent: ing['Ingredient Quantity(%)']
                };
              });
            }

            processTableData.push(phase);
          });

          renderProcessTableEditor();
        }

        statusMsg.textContent = 'Product data loaded successfully! You can now modify and save as a new product.';
        statusMsg.className = 'status success';

      } catch (error) {
        statusMsg.textContent = 'Error loading product: ' + error.message;
        statusMsg.className = 'status error';
      }
    }
    
    // Fetch all ingredients for dropdowns
    async function fetchAllIngredients() {
      try {
        const { data: ingredients, error } = await supabase
          .from('Ingredients')
          .select('IngredientSKU, Name, Supplier')
          .order('Name');

        if (error) {
          console.error('Error fetching ingredients:', error);
          allIngredients = [];
          return;
        }

        allIngredients = ingredients || [];
      } catch (error) {
        console.error('Error fetching ingredients:', error);
        allIngredients = [];
      }
    }
    
    // Fetch all ingredients that could be containers
    async function fetchContainerIngredients() {
      // Just return all ingredients since containers won't all have "container" in the name
      return allIngredients;
    }

    // Create ingredient dropdown with search functionality
    function createIngredientDropdown(containerId, currentName = '', currentSku = '') {
      const container = document.getElementById(containerId);
      if (!container) return null;

      const dropdownHTML = `
        <div class="ingredient-dropdown-container">
          <input type="text" class="ingredient-search" placeholder="Type to search ingredients..." value="${currentName}" />
          <div class="ingredient-dropdown" style="display: none;"></div>
          <input type="hidden" class="selected-sku" value="${currentSku}" />
        </div>
      `;

      container.innerHTML = dropdownHTML;

      const searchInput = container.querySelector('.ingredient-search');
      const dropdown = container.querySelector('.ingredient-dropdown');
      const hiddenSKU = container.querySelector('.selected-sku');

      // Filter and display ingredients based on search
      function updateDropdown(searchTerm = '') {
        const filtered = allIngredients.filter(ingredient => {
          const searchText = `${ingredient.Name} ${ingredient.Supplier || ''} ${ingredient.IngredientSKU}`.toLowerCase();
          return searchText.includes(searchTerm.toLowerCase());
        });

        dropdown.innerHTML = '';
        
        filtered.slice(0, 10).forEach(ingredient => {
          const option = document.createElement('div');
          option.className = 'ingredient-option';
          option.innerHTML = `
            <div style="font-weight: 500;">${ingredient.Name}</div>
            <div style="font-size: 0.8rem; color: #6b7280;">
              SKU: ${ingredient.IngredientSKU} | Supplier: ${ingredient.Supplier || 'No Supplier'}
            </div>
          `;
          
          option.addEventListener('click', () => {
            searchInput.value = ingredient.Name;
            hiddenSKU.value = ingredient.IngredientSKU;
            dropdown.style.display = 'none';
            
            // Update the ingredient data in processTableData
            const phaseIdx = parseInt(containerId.split('-')[2]);
            const ingIdx = parseInt(containerId.split('-')[3]);
            if (!isNaN(phaseIdx) && !isNaN(ingIdx)) {
              processTableData[phaseIdx].ingredients[ingIdx].name = ingredient.Name;
              processTableData[phaseIdx].ingredients[ingIdx].sku = ingredient.IngredientSKU;
            }
          });
          
          dropdown.appendChild(option);
        });

        if (filtered.length === 0) {
          dropdown.innerHTML = '<div class="ingredient-option" style="color: #6b7280; font-style: italic;">No ingredients found</div>';
        }
      }

      // Show dropdown when input is focused
      searchInput.addEventListener('focus', () => {
        updateDropdown(searchInput.value);
        dropdown.style.display = 'block';
      });

      // Update dropdown as user types
      searchInput.addEventListener('input', (e) => {
        updateDropdown(e.target.value);
        dropdown.style.display = 'block';
        hiddenSKU.value = ''; // Clear selection when typing
        
        // Update the ingredient name in processTableData
        const phaseIdx = parseInt(containerId.split('-')[2]);
        const ingIdx = parseInt(containerId.split('-')[3]);
        if (!isNaN(phaseIdx) && !isNaN(ingIdx)) {
          processTableData[phaseIdx].ingredients[ingIdx].name = e.target.value;
          processTableData[phaseIdx].ingredients[ingIdx].sku = '';
        }
      });

      // Hide dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!container.contains(e.target)) {
          dropdown.style.display = 'none';
        }
      });

      return {
        getSKU: () => hiddenSKU.value,
        getName: () => searchInput.value
      };
    }
    // Create container dropdown
    async function createContainerDropdown() {
      const containerIngredients = await fetchContainerIngredients();
      // Container SKUs dropdown
      const container = document.getElementById('containerDropdown');
      if (container) createGenericDropdown(container, selectedContainerSKUs, 'addSelectedContainer');
      // Amazon Packages dropdown
      const amazonContainer = document.getElementById('amazonDropdown');
      if (amazonContainer) createGenericDropdown(amazonContainer, selectedAmazonPackages, 'addSelectedAmazonPackage');
    }
    function createGenericDropdown(container, selectedList, addFnName) {
      const dropdownHTML = `
        <div class="ingredient-dropdown-container">
          <input type="text" class="ingredient-search" placeholder="Type to search containers..." />
          <div class="ingredient-dropdown" style="display: none;"></div>
          <input type="hidden" class="selected-sku" value="" />
        </div>
      `;
      container.innerHTML = dropdownHTML;
      const searchInput = container.querySelector('.ingredient-search');
      const dropdown = container.querySelector('.ingredient-dropdown');
      const hiddenSKU = container.querySelector('.selected-sku');
      function updateDropdown(searchTerm = '') {
        const filtered = allIngredients.filter(ingredient => {
          const searchText = `${ingredient.Name} ${ingredient.Supplier || ''} ${ingredient.IngredientSKU}`.toLowerCase();
          return searchText.includes(searchTerm.toLowerCase());
        });
        dropdown.innerHTML = '';
        filtered.slice(0, 10).forEach(ingredient => {
          const option = document.createElement('div');
          option.className = 'ingredient-option';
          option.innerHTML = `
            <div style="font-weight: 500;">${ingredient.Name}</div>
            <div style="font-size: 0.8rem; color: #6b7280;">
              SKU: ${ingredient.IngredientSKU} | Supplier: ${ingredient.Supplier || 'No Supplier'}
            </div>
          `;
          option.addEventListener('click', () => {
            searchInput.value = `${ingredient.Name} (${ingredient.IngredientSKU})`;
            hiddenSKU.value = ingredient.IngredientSKU;
            dropdown.style.display = 'none';
          });
          dropdown.appendChild(option);
        });
        if (filtered.length === 0) {
          dropdown.innerHTML = '<div class="ingredient-option" style="color: #6b7280; font-style: italic;">No containers found</div>';
        }
      }
      searchInput.addEventListener('focus', () => {
        updateDropdown(searchInput.value);
        dropdown.style.display = 'block';
      });
      searchInput.addEventListener('input', (e) => {
        updateDropdown(e.target.value);
        dropdown.style.display = 'block';
        hiddenSKU.value = '';
      });
      document.addEventListener('click', (e) => {
        if (!container.contains(e.target)) {
          dropdown.style.display = 'none';
        }
      });
      return {
        getSKU: () => hiddenSKU.value,
        getName: () => searchInput.value,
        clear: () => {
          searchInput.value = '';
          hiddenSKU.value = '';
        }
      };
    }

    // Add selected container to the list
    window.addSelectedContainer = function() {
      const containerDropdown = document.querySelector('#containerDropdown .selected-sku');
      const containerSearch = document.querySelector('#containerDropdown .ingredient-search');
      
      if (!containerDropdown || !containerSearch) return;

      const sku = containerDropdown.value;
      const name = containerSearch.value;

      if (!sku) {
        alert('Please select a container from the dropdown');
        return;
      }

      selectedContainerSKUs.push(sku);
      updateSelectedContainersDisplay();
      
      // Clear the dropdown
      containerSearch.value = '';
      containerDropdown.value = '';
      
      // Update hidden input
      document.getElementById('ContainerSKUs').value = selectedContainerSKUs.join(',');
    };

    // Add selected Amazon package to the list
    window.addSelectedAmazonPackage = function() {
      const amazonDropdown = document.querySelector('#amazonDropdown .selected-sku');
      const amazonSearch = document.querySelector('#amazonDropdown .ingredient-search');
      
      if (!amazonDropdown || !amazonSearch) return;

      const sku = amazonDropdown.value;
      const name = amazonSearch.value;

      if (!sku) {
        alert('Please select an Amazon package from the dropdown');
        return;
      }

      selectedAmazonPackages.push(sku);
      updateSelectedAmazonPackagesDisplay();
      
      // Clear the dropdown
      amazonSearch.value = '';
      amazonDropdown.value = '';
      
      // Update hidden input
      document.getElementById('AmazonPackages').value = selectedAmazonPackages.join(',');
    };

    // Update the display of selected containers
    function updateSelectedContainersDisplay() {
      const container = document.getElementById('selectedContainers');
      if (!container) return;

      if (selectedContainerSKUs.length === 0) {
        container.innerHTML = '<div style="color: #6b7280; font-style: italic; padding: 0.5rem;">No containers selected</div>';
        return;
      }

      const containersHTML = selectedContainerSKUs.map((sku, index) => {
        const ingredient = allIngredients.find(ing => ing.IngredientSKU === sku);
        const name = ingredient ? ingredient.Name : sku;
        
        return `
          <div style="display: flex; align-items: center; justify-content: space-between; background: #f3f4f6; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.25rem;">
            <span style="font-weight: 500;">${name} (${sku})</span>
            <button type="button" onclick="removeContainerAtIndex(${index})" style="background: #ef4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">Remove</button>
          </div>
        `;
      }).join('');

      container.innerHTML = containersHTML;
    }

    // Update the display of selected Amazon packages
    function updateSelectedAmazonPackagesDisplay() {
      const container = document.getElementById('selectedAmazonPackages');
      if (!container) return;

      if (selectedAmazonPackages.length === 0) {
        container.innerHTML = '<div style="color: #6b7280; font-style: italic; padding: 0.5rem;">No Amazon packages selected</div>';
        return;
      }

      const packagesHTML = selectedAmazonPackages.map((sku, index) => {
        const ingredient = allIngredients.find(ing => ing.IngredientSKU === sku);
        const name = ingredient ? ingredient.Name : sku;
        
        return `
          <div style="display: flex; align-items: center; justify-content: space-between; background: #f3f4f6; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.25rem;">
            <span style="font-weight: 500;">${name} (${sku})</span>
            <button type="button" onclick="removeAmazonPackageAtIndex(${index})" style="background: #ef4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">Remove</button>
          </div>
        `;
      }).join('');

      container.innerHTML = packagesHTML;
    }

    // Remove container from selected list by index
    window.removeContainerAtIndex = function(index) {
      selectedContainerSKUs.splice(index, 1);
      updateSelectedContainersDisplay();
      document.getElementById('ContainerSKUs').value = selectedContainerSKUs.join(',');
    };

    // Remove Amazon package from selected list by index
    window.removeAmazonPackageAtIndex = function(index) {
      selectedAmazonPackages.splice(index, 1);
      updateSelectedAmazonPackagesDisplay();
      document.getElementById('AmazonPackages').value = selectedAmazonPackages.join(',');
    };

    // Remove container from selected list (legacy function - removes first occurrence)
    window.removeContainer = function(sku) {
      const index = selectedContainerSKUs.indexOf(sku);
      if (index > -1) {
        selectedContainerSKUs.splice(index, 1);
        updateSelectedContainersDisplay();
        document.getElementById('ContainerSKUs').value = selectedContainerSKUs.join(',');
      }
    };

    // Remove Amazon package from selected list (legacy function - removes first occurrence)
    window.removeAmazonPackage = function(sku) {
      const index = selectedAmazonPackages.indexOf(sku);
      if (index > -1) {
        selectedAmazonPackages.splice(index, 1);
        updateSelectedAmazonPackagesDisplay();
        document.getElementById('AmazonPackages').value = selectedAmazonPackages.join(',');
      }
    };

    // Load containers from comma-separated string (for editing existing products)
    function loadContainersFromString(containerString) {
      if (!containerString) {
        selectedContainerSKUs = [];
      } else if (Array.isArray(containerString)) {
        selectedContainerSKUs = [...containerString];
      } else {
        selectedContainerSKUs = containerString.split(',').map(s => s.trim()).filter(s => s.length > 0);
      }
      updateSelectedContainersDisplay();
      document.getElementById('ContainerSKUs').value = selectedContainerSKUs.join(',');
    }

    // Load Amazon packages from comma-separated string (for editing existing products)
    function loadAmazonPackagesFromString(packageString) {
      if (!packageString) {
        selectedAmazonPackages = [];
      } else if (Array.isArray(packageString)) {
        selectedAmazonPackages = [...packageString];
      } else {
        selectedAmazonPackages = packageString.split(',').map(s => s.trim()).filter(s => s.length > 0);
      }
      updateSelectedAmazonPackagesDisplay();
      document.getElementById('AmazonPackages').value = selectedAmazonPackages.join(',');
    }

    function renderProcessTableEditor() {
      const container = document.getElementById('processTableEditor');
      if (!container) return;
      container.innerHTML = '';
      if (!processTableData.length) {
        container.innerHTML = '<div style="color:#888;">No phases. Click "Add Phase" to begin.</div>';
        return;
      }

      // Calculate total percent across all phases
      let totalPercent = 0;
      processTableData.forEach(phase => {
        if (Array.isArray(phase.ingredients)) {
          totalPercent += phase.ingredients.reduce((sum, ing) => {
            const val = parseFloat(ing.percent);
            return sum + (!isNaN(val) ? val : 0);
          }, 0);
        }
      });
      // Remove percent warning from inline display

      processTableData.forEach((phase, phaseIdx) => {
        const phaseDiv = document.createElement('div');
        phaseDiv.style = 'border:1px solid #cbd5e1; border-radius:8px; margin-bottom:1.5rem; background:#f8fafc; padding:1rem;';

        phaseDiv.innerHTML = `
          <div style=\"display:grid;grid-template-columns:1fr auto auto auto auto auto;gap:0.5rem;align-items:center;margin-bottom:1rem;\">
            <input type=\"text\" value=\"${phase.name}\" style=\"font-weight:600;font-size:1.1rem;padding:0.3rem 0.5rem;border-radius:4px;border:1px solid #cbd5e1;\" onchange=\"updatePhaseName(${phaseIdx}, this.value)\">
            <input type=\"number\" value=\"${phase.temp || ''}\" placeholder=\"Temp (°C)\" style=\"width:100px;padding:0.3rem 0.5rem;border-radius:4px;border:1px solid #cbd5e1;\" onchange=\"updatePhaseField(${phaseIdx},'temp',this.value)\">
            <select onchange=\"updatePhaseField(${phaseIdx},'timeType',this.value)\" style=\"padding:0.3rem 0.5rem;border-radius:4px;border:1px solid #cbd5e1;\">
              <option value=\"Melt\" ${phase.timeType==="Melt"?"selected":""}>Melt Time</option>
              <option value=\"Mix\" ${phase.timeType==="Mix"?"selected":""}>Mix Time</option>
            </select>
            <input type=\"text\" value=\"${phase.mixTime || ''}\" placeholder=\"Time (Minutes)\" style=\"width:110px;padding:0.3rem 0.5rem;border-radius:4px;border:1px solid #cbd5e1;\" onchange=\"updatePhaseField(${phaseIdx},'mixTime',this.value)\">
            <button type=\"button\" class=\"btn\" style=\"background:#f87171;padding:0.3rem 0.5rem;font-size:0.9rem;\" onclick=\"removePhaseRow(${phaseIdx})\">Remove Phase</button>
          </div>
          <div style=\"margin-bottom:1rem;\">
            <label style=\"display:block;font-weight:600;margin-bottom:0.25rem;\">Consistency:</label>
            <input type=\"text\" value=\"${phase.consistency || ''}\" placeholder=\"Enter consistency details...\" style=\"width:100%;padding:0.5rem;border-radius:4px;border:1px solid #cbd5e1;\" onchange=\"updatePhaseField(${phaseIdx},'consistency',this.value)\">
          </div>
          <table style=\"width:100%;margin-top:1rem;border-collapse:collapse;\">
            <thead>
              <tr style=\"background:#e2e8f0;\">
                <th style=\"padding:0.5rem;text-align:left;border:1px solid #cbd5e1;\">Ingredient Name</th>
                <th style=\"padding:0.5rem;text-align:left;border:1px solid #cbd5e1;width:100px;\">Percentage %</th>
                <th style=\"padding:0.5rem;text-align:left;border:1px solid #cbd5e1;width:100px;\">Actions</th>
              </tr>
            </thead>
            <tbody id=\"phase-ingredients-${phaseIdx}\"></tbody>
          </table>
          <button type=\"button\" class=\"btn\" style=\"background:#10b981;margin-top:0.5rem;\" onclick=\"addIngredientRow(${phaseIdx})\">Add Ingredient</button>
        `;
        container.appendChild(phaseDiv);

        // Render ingredient rows
        const tbody = phaseDiv.querySelector(`#phase-ingredients-${phaseIdx}`);
        phase.ingredients.forEach((ing, ingIdx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style=\"padding:0.5rem;border:1px solid #cbd5e1;position:relative;\">
              <div id=\"ingredient-dropdown-${phaseIdx}-${ingIdx}\"></div>
            </td>
            <td style=\"padding:0.5rem;border:1px solid #cbd5e1;\">
              <input type=\"number\" value=\"${ing.percent || ''}\" min=\"0\" step=\"0.01\" oninput=\"updateIngredientField(${phaseIdx},${ingIdx},'percent',this.value);\" style=\"width:100%;padding:0.3rem;border:1px solid #cbd5e1;border-radius:4px;\">
            </td>
            <td style=\"padding:0.5rem;border:1px solid #cbd5e1;\">
              <button type=\"button\" class=\"btn\" style=\"background:#f87171;padding:0.3rem 0.5rem;font-size:0.9rem;\" onclick=\"removeIngredientRow(${phaseIdx},${ingIdx})\">Remove</button>
            </td>
          `;
          tbody.appendChild(tr);
          // Create ingredient dropdown for this row
          setTimeout(() => {
            createIngredientDropdown(`ingredient-dropdown-${phaseIdx}-${ingIdx}`, ing.name || '', ing.sku || '');
          }, 0);
        });
      });
    }
    window.addPhaseRow = function() {
      processTableData.push({ name: `Phase ${processTableData.length+1}`, ingredients: [] });
      renderProcessTableEditor();
    };
    window.removePhaseRow = function(idx) {
      processTableData.splice(idx,1);
      renderProcessTableEditor();
    };
    window.addIngredientRow = function(phaseIdx) {
      processTableData[phaseIdx].ingredients.push({ name:'', sku:'', percent:'' });
      renderProcessTableEditor();
    };
    window.removeIngredientRow = function(phaseIdx, ingIdx) {
      processTableData[phaseIdx].ingredients.splice(ingIdx,1);
      renderProcessTableEditor();
    };
    window.updatePhaseName = function(idx, val) {
      processTableData[idx].name = val;
    };
    window.updatePhaseField = function(idx, field, val) {
      processTableData[idx][field] = val;
    };
    window.updateIngredientField = function(phaseIdx, ingIdx, field, val) {
      processTableData[phaseIdx].ingredients[ingIdx][field] = val;
    };
    function getProcessFromTableEditor() {
      const process = {};
      processTableData.forEach(phase => {
        process[phase.name] = {
          [`${phase.name} Temperature(C)`]: phase.temp || '',
          [`${phase.name} ${phase.timeType} Time(Minutes)`]: phase.mixTime || '',
          [`${phase.name} Consistency`]: phase.consistency || '',
          [`${phase.name} Ingredients`]: phase.ingredients.map(ing => ({
            'IngredientSKU': ing.sku,
            'Ingredient Quantity(%)': Number(ing.percent)
          }))
        };
      });
      if (Object.keys(process).length === 0) {
        return null;
      }
      return process;
    }
    
    // Initialize ingredients and render on load
    async function initializeApp() {
      await fetchAllIngredients();
      await fetchAllProducts();
      renderProcessTableEditor();
      await createContainerDropdown();
      updateSelectedContainersDisplay();
    }
    
    // Initialize the page
    window.addEventListener('DOMContentLoaded', async () => {
      await fetchAllIngredients();
      await fetchAllProducts();
      await createContainerDropdown();
      
      const urlParams = new URLSearchParams(window.location.search);
      const productSKU = urlParams.get('productSKU');
      
      if (productSKU) {
        // Set the dropdown value and load the product
        const container = document.getElementById('loadFromProductDropdown');
        const searchInput = container.querySelector('.product-search');
        const hiddenSKU = container.querySelector('.selected-product-sku');
        
        const product = allProducts.find(prod => prod.ProductSKU === productSKU);
        if (product) {
          searchInput.value = `${product.ProductSKU} - ${product.Name || 'No Name'}`;
          hiddenSKU.value = product.ProductSKU;
          await loadProductData(productSKU);
        }
      }
    });
    
    initializeApp();

    form.onsubmit = async function(e) {
      e.preventDefault();
      statusMsg.textContent = '';
      statusMsg.className = 'status';
      const useCustom = document.getElementById('useCustomInstructions').checked;
      const miValue = document.getElementById('ManufacturingInstructions').value.trim();
      const data = {
        ProductSKU: document.getElementById('ProductSKU').value.trim(),
        Archived: document.getElementById('Archived').checked,
        Name: document.getElementById('Name').value.trim(),
        'Product Weight(oz)': document.getElementById('ProductSize').value.trim() ? parseFloat(document.getElementById('ProductSize').value.trim()) : null,
        'Product Type': document.getElementById('ProductType').value.trim(),
        'Microbial Testing': document.getElementById('MicrobialTesting').checked,
        ContainerSKUs: selectedContainerSKUs.length > 0 ? selectedContainerSKUs : null,
        AmazonPackages: selectedAmazonPackages.length > 0 ? selectedAmazonPackages : null,
        Retailer: document.getElementById('Customer').value.trim(),
        ShelfLife: form.ShelfLife.value ? parseFloat(form.ShelfLife.value) : null,
        'Pack Size': form.PackSize.value ? parseInt(form.PackSize.value) : null,
        Quantity: form.Quantity.value ? parseInt(form.Quantity.value) : null,
        QuantityPerBin: form.QuantityPerBin.value ? parseInt(form.QuantityPerBin.value) : null,
        MSRP: form.MSRP.value ? parseFloat(form.MSRP.value) : null,
        'Pour Temperature': form.PourTemperature.value ? parseFloat(form.PourTemperature.value) : null,
        'Pour Consistency': document.getElementById('PourConsistency').value.trim(),
        Aroma: document.getElementById('Aroma').value.trim(),
        Process: getProcessFromTableEditor(),
        ManufacturingInstructions: useCustom && miValue !== '' ? miValue : null
      };
      Object.keys(data).forEach(k => { if (data[k] === '') data[k] = null; });

      // Calculate total percent across all phases
      let totalPercent = 0;
      processTableData.forEach(phase => {
        if (Array.isArray(phase.ingredients)) {
          totalPercent += phase.ingredients.reduce((sum, ing) => {
            const val = parseFloat(ing.percent);
            return sum + (!isNaN(val) ? val : 0);
          }, 0);
        }
      });

      if (Math.abs(totalPercent - 100) > 0.01 && totalPercent > 0) {
        showPercentModal(totalPercent, async function(confirmed) {
          if (!confirmed) {
            statusMsg.textContent = 'Save cancelled.';
            statusMsg.className = 'status error';
            return;
          }
          await saveProduct(data);
        });
      } else {
        await saveProduct(data);
      }
    };

    // Modal for percent warning
    function showPercentModal(totalPercent, callback) {
      let modal = document.getElementById('percentModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'percentModal';
        modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:99999;display:flex;align-items:center;justify-content:center;';
        modal.innerHTML = `
          <div style="background:white;padding:2rem 2.5rem;border-radius:12px;box-shadow:0 4px 24px rgba(0,0,0,0.18);max-width:400px;text-align:center;">
            <div style="font-size:1.15rem;color:#e74c3c;font-weight:600;margin-bottom:1em;">Warning: Total ingredient percentages across all phases add up to <span style='font-weight:bold;'>${totalPercent.toFixed(2)}%</span> (should be 100%)</div>
            <div style="margin-bottom:1.5em;color:#555;">Are you sure you want to continue saving?</div>
            <button id="percentModalContinue" style="background:#10b981;color:white;padding:0.6em 1.2em;border:none;border-radius:6px;font-size:1rem;margin-right:1em;cursor:pointer;">Continue</button>
            <button id="percentModalCancel" style="background:#f87171;color:white;padding:0.6em 1.2em;border:none;border-radius:6px;font-size:1rem;cursor:pointer;">Cancel</button>
          </div>
        `;
        document.body.appendChild(modal);
      } else {
        modal.style.display = 'flex';
        modal.querySelector('div').innerHTML = `
          <div style=\"font-size:1.15rem;color:#e74c3c;font-weight:600;margin-bottom:1em;\">Warning: Total ingredient percentages across all phases add up to <span style='font-weight:bold;'>${totalPercent.toFixed(2)}%</span> (should be 100%)</div>
          <div style=\"margin-bottom:1.5em;color:#555;\">Are you sure you want to continue saving?</div>
          <button id=\"percentModalContinue\" style=\"background:#10b981;color:white;padding:0.6em 1.2em;border:none;border-radius:6px;font-size:1rem;margin-right:1em;cursor:pointer;\">Continue</button>
          <button id=\"percentModalCancel\" style=\"background:#f87171;color:white;padding:0.6em 1.2em;border:none;border-radius:6px;font-size:1rem;cursor:pointer;\">Cancel</button>
        `;
      }
      // Button listeners
      modal.querySelector('#percentModalContinue').onclick = function() {
        modal.style.display = 'none';
        callback(true);
      };
      modal.querySelector('#percentModalCancel').onclick = function() {
        modal.style.display = 'none';
        callback(false);
      };
    }

    async function saveProduct(data) {
      // Use upsert to handle both insert and update based on ProductSKU
      const { error } = await supabase.from('Products').upsert([data], { onConflict: 'ProductSKU' });
      if (error) {
        statusMsg.textContent = 'Error: ' + error.message;
        statusMsg.className = 'status error';
      } else {
        statusMsg.textContent = 'Product saved successfully!'; // Updated message
        statusMsg.className = 'status success';
        form.reset();
        processTableData = [];
        selectedContainerSKUs = [];
        selectedAmazonPackages = [];
        renderProcessTableEditor();
        updateSelectedContainersDisplay();
        updateSelectedAmazonPackagesDisplay();
        // Hide MI textarea after save
        document.getElementById('manufacturingInstructionsContainer').style.display = 'none';
        document.getElementById('useCustomInstructions').checked = false;
      }
    }
    // Toggle Manufacturing Instructions textarea
    document.addEventListener('DOMContentLoaded', function() {
      const miCheckbox = document.getElementById('useCustomInstructions');
      const miContainer = document.getElementById('manufacturingInstructionsContainer');
      const miTextarea = document.getElementById('ManufacturingInstructions');
      const template = `Makeup: Step-by-Step Manufacturing Process\n\n1. Preparation & Sanitization\n\n- Wear PPE (gloves, hairnet, lab coat, and face mask) to prevent contamination.\n\nEquipment Needed:\n- Ingredient cups\n- Spatula\n- Immersion blender\n- Agitator\n\n✅ Clean & Sanitize Equipment:\n\n- Ensure all containers, utensils, and mixing vessels are cleaned and sanitized with alcohol or an approved cleaning solution.\n     - Ensure there is no oil residue on any equipment, tools, or workspace.\n- Ensure the production area meets GMP requirements.\n- Ensure scale is working properly.\n\n\nInitials: ____________      Date/Time: ________________________\n\n\nPhase 1:\n1. Set pot to [Phase 1 Temp]°C.\n2. Add [Phase 1 ingredients] to pot.\nStir occasionally with spatula to help melt quicker.\n\n\n\nInitials: ____________      Date/Time: ________________________\n\n\nTemperature: [Phase 1 temp]°C\nMelt Time: [Phase 1 melt time] mins\nConsistency: [Phase 1 consistency]\n\n\n\nInitials: ____________      Date/Time: ________________________\n\n\nPhase 2:\n3. Set temperature on pot to [Phase 2 temp]°C.\n4. Add [Phase 2 ingredients] to pot.\nStir with spatula for 30 seconds to ensure uniform blending.\n\n\nInitials: ____________      Date/Time: ________________________\n\n\nTemperature: [Phase 2 temp]°C\nMix Time: [Phase 2 time] mins\nConsistency: [Phase 2 consistency]\n\n\nInitials: ____________      Date/Time: ________________________\n\n\n\nPhase 3:\n5. Set temperature on pot to [Phase 3 temp]°C.\n6. Once temperature has reached 65°C, add [Phase 3 ingredients] to pot.\nMix with immersion blender until smooth and homogenized.\n\n\nInitials: ____________      Date/Time: ________________________\n\n\nTemperature: [Phase 3 temp]°C\nMix Time: [Phase 3 time] mins\nConsistency: [Phase 3 consistency]\n\n\n\nInitials: ____________      Date/Time: ________________________\n\n\n\n7. Set temperature on pot to [Pour temp]°C.\n\n\n\nQuality Initials: ____________      Date/Time: ________________________\n\n\n\nFilling & Cooling Procedure:\n\n1. Pre-Fill Preparation\n\n   - Verify that all containers, lids, and tools are sanitized and approved for use.\n   - Lay out only the number of containers required for the batch.\n   - Confirm container SKU [container SKU] Initials: ____________  Date/Time: ________________________\n\n\n2. Fill Conditions\n\n   - Confirm product temperature has reached [Pour temp]°C.\n   - Carefully fill each container to target fill weight/volume.\n   - Wipe container rims if necessary to prevent contamination before capping.\n\n\n3. Cooling Process\n\n   - Allow filled containers to cool in a controlled area free of drafts, debris, and contamination risk for a minimum of 10 minutes or until fully set (maximum 30 minutes).\n   - Do not disturb containers during this period to avoid texture disruption.\n\n\n4. In-Process Quality Control Checks\nPerform the following QC checks on at least 3 random units:\n\n   - Texture and consistency: [Product texture and consistency]\n   - Aroma: [Product aroma]\n   - Visual inspection: Check for separation, graininess, air bubbles, or irregularities.\n\nIf deviations are observed, document immediately and notify supervisor before proceeding.\n\nQuality Initials: ____________      Date/Time: ________________________\n\n\n5. Post-Fill Actions\n\n   - Cap all containers securely using appropriate closures.\n   - Inspect closures for proper application (tightness, alignment).\n   - Shut down all filling equipment and clean per cleaning SOP.\n   - Record number of containers filled.\n\nNo. of Pieces Filled: ____________________\n\nInitials: ____________  Date/Time: ________________________\n\n\nLabeling & Inventory Management\n1. Labeling\n\n   - Confirm label SKU [label sku] Initials: ____________  Date/Time: ________________________\n   - Apply labels evenly and securely to containers.\n   - Perform visual inspection to confirm legibility and placement.\n   - Application method: ________________________\n\n\n2. Inventory Management\nMove finished products into designated quarantine area for finished goods.\nStorage location: ________________ \nInitials: ____________\nDate/Time: ________________________`;
      miCheckbox.addEventListener('change', function() {
        if (miCheckbox.checked) {
          miContainer.style.display = '';
          if (!miTextarea.value.trim()) {
            miTextarea.value = template;
          }
        } else {
          miContainer.style.display = 'none';
          miTextarea.value = '';
        }
      });
    });
  </script>
</body>
</html>
