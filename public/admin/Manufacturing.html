
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Manufacturing Orders</title>
	<link rel="stylesheet" href="https://unpkg.com/@coreui/icons/css/all.min.css">
	<link rel="stylesheet" href="/Assets/sidebar.css">
	<style>
		.modal {
			display: none;
			position: fixed;
			z-index: 1000;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			overflow: auto;
			background-color: rgba(0,0,0,0.4);
		}
		.modal-content {
			background-color: #fff;
			margin: 10% auto;
			padding: 24px;
			border-radius: 12px;
			max-width: 400px;
			box-shadow: 0 4px 16px rgba(0,0,0,0.2);
			position: relative;
		}
		.close-modal {
			color: #aaa;
			position: absolute;
			top: 12px;
			right: 18px;
			font-size: 28px;
			font-weight: bold;
			cursor: pointer;
		}
		.close-modal:hover {
			color: #e74c3c;
		}
		.update-progress-btn {
			background: #4DBA93;
			color: white;
			border: none;
			border-radius: 8px;
			padding: 8px 16px;
			font-size: 1em;
			font-weight: 600;
			cursor: pointer;
			margin-top: 10px;
			margin-right: 8px;
			transition: background 0.3s;
		}
		.update-progress-btn:hover {
			background: #3a9b74;
		}
		.progress-select {
			padding: 6px 12px;
			border-radius: 6px;
			font-size: 1em;
			margin-right: 8px;
		}
		.warning-badge {
			position: absolute;
			bottom: 18px;
			left: 18px;
			background: #f7b731;
			color: #fff;
			border-radius: 16px;
			padding: 6px 16px;
			font-size: 1em;
			font-weight: 600;
			display: flex;
			align-items: center;
			gap: 8px;
			box-shadow: 0 2px 6px rgba(0,0,0,0.08);
			z-index: 4;
		}
		.delete-btn {
			position: absolute;
			bottom: 18px;
			right: 18px;
			background: none;
			border: none;
			cursor: pointer;
			color: #ba4d74;
			font-size: 1.5em;
			z-index: 3;
			transition: color 0.2s;
		}
		.delete-btn:hover {
			color: #e74c3c;
		}
		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: linear-gradient(135deg, #c1de9f 0%, #4dba93 100%);
			min-height: 100vh;
			color: #333;
			margin: 0;
			padding: 0;
			display: flex;
		}
		.main-content {
			margin-left: 60px;
			width: calc(100% - 60px);
			min-height: 100vh;
		}
		.container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 20px;
		}
		h1 {
			color: indigo;
			text-align: center;
			margin-bottom: 30px;
		}
		.order-card {
			background: white;
			border-radius: 12px;
			box-shadow: 0 4px 6px rgba(0,0,0,0.1);
			margin-bottom: 24px;
			padding: 24px;
			position: relative;
		}
		.progress-badge {
			position: absolute;
			top: 18px;
			right: 18px;
			padding: 6px 16px;
			border-radius: 16px;
			font-size: 1em;
			font-weight: 600;
			color: white;
			box-shadow: 0 2px 6px rgba(0,0,0,0.08);
			z-index: 2;
		}
		.badge-requested {
			background: #ba4d74;
		}
		.badge-scheduled {
			background: #f7b731;
		}
		.badge-completed {
			background: #4DBA93;
		}
		.badge-production {
			background: #4d6dba;
		}
		.selected {
			border: 2px solid #4DBA93;
			background-color: #f0f9f0;
		}
		.btn {
			background: #4DBA93;
			color: white;
			border: none;
			border-radius: 8px;
			padding: 12px 24px;
			font-size: 16px;
			font-weight: 600;
			cursor: pointer;
			transition: background 0.3s;
		}
		.btn:hover {
			background: #3a9b74;
		}
	</style>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
	<script src="/Assets/CheckAccess.js"></script>
	<link rel="icon" type="image/x-icon" href="/Assets/favicon.ico">
</head>
<body>
	<div id="sidebar"></div>
	<script src="/Assets/sidebar.js"></script>
	<div class="main-content">
		<div class="container">
			<h1>Manufacturing Orders</h1>
			<div style="margin-bottom:24px; text-align:center; display:flex; flex-wrap:wrap; justify-content:center; gap:16px;">
				<div>
					<label for="progressFilter" style="font-weight:600; color:#4DBA93; margin-right:8px;">Filter by Progress:</label>
					<select id="progressFilter" style="padding:8px 16px; border-radius:8px; font-size:1em;">
						<option value="">All</option>
						<option value="requested">Requested</option>
						<option value="scheduled">Scheduled</option>
						<option value="completed">Completed</option>
						<option value="production">In Production</option>
					</select>
				</div>
				<div>
					<input type="text" id="orderSearchBar" placeholder="Search orders..." style="padding:8px 16px; border-radius:8px; font-size:1em; min-width:220px; border:1px solid #4DBA93;" />
				</div>
			</div>
			<div id="manufacturingOrdersContainer">
				<p>Loading manufacturing orders...</p>
			</div>
		</div>
	</div>
	<script>
		checkPermissions(['service_role', 'employee']);
		setupInactivityTimeout(10);
		let orders = [];
	let currentProgressFilter = "";
	let currentSearchTerm = "";
	async function loadManufacturingOrders(progressFilter = "", searchTerm = "") {
			const container = document.getElementById('manufacturingOrdersContainer');
			container.innerHTML = '<p>Loading manufacturing orders...</p>';
			try {
				const { data: ordersRaw, error } = await supabase
					.from('ManufacturingTasks')
					.select('*')
					.order('OrderNumber', { ascending: false });
				if (error) throw error;
				if (!ordersRaw || ordersRaw.length === 0) {
					container.innerHTML = '<p>No manufacturing orders found.</p>';
					return;
				}
				orders = ordersRaw;
				let filteredOrders = orders;
				if (progressFilter) {
					filteredOrders = filteredOrders.filter(order => {
						let progress = (order.Progress || '').toLowerCase();
						if (progressFilter === 'production') {
							return progress !== 'requested' && progress !== 'scheduled' && progress !== 'completed';
						}
						return progress === progressFilter;
					});
				}
				if (searchTerm && searchTerm.trim() !== "") {
					const term = searchTerm.trim().toLowerCase();
					filteredOrders = filteredOrders.filter(order => {
						return (
							(order.Customer && order.Customer.toLowerCase().includes(term)) ||
							(order.ProductSKU && order.ProductSKU.toLowerCase().includes(term)) ||
							(order.OrderNumber && String(order.OrderNumber).includes(term))
						);
					});
				}
				let cardsHtml = '';
				// Helper: fetch product info for all unique SKUs
				const productSKUs = Array.from(new Set(filteredOrders.map(o => o.ProductSKU).filter(Boolean)));
				let productsMap = {};
				if (productSKUs.length > 0) {
					const { data: productsData, error: prodError } = await supabase
						.from('Products')
						.select('ProductSKU, ManufacturingSteps')
						.in('ProductSKU', productSKUs);
					if (!prodError && productsData) {
						productsData.forEach(prod => {
							productsMap[prod.ProductSKU] = prod;
						});
					}
				}

				// Gather all needed ingredient SKUs for all orders
				let allIngredientSKUs = new Set();
				filteredOrders.forEach(order => {
					let product = productsMap[order.ProductSKU];
					if (product && product.ManufacturingSteps) {
						let steps = [];
						if (Array.isArray(product.ManufacturingSteps)) {
							steps = product.ManufacturingSteps;
						} else if (product.ManufacturingSteps.Steps && Array.isArray(product.ManufacturingSteps.Steps)) {
							steps = product.ManufacturingSteps.Steps;
						}
						// Defensive: flatten steps if prototype chain is weird
						if (steps && typeof steps.length === 'number' && steps.length > 0) {
							for (let i = 0; i < steps.length; i++) {
								const step = steps[i];
								let stepIngredients = step.StepIngredients || step["Step Ingredients"];
								if (step && stepIngredients && Array.isArray(stepIngredients)) {
									stepIngredients.forEach(ing => {
										if (ing.IngredientSKU) allIngredientSKUs.add(ing.IngredientSKU);
									});
								}
							}
						}
					}
				});

				// Fetch ingredient quantities
				let ingredientsMap = {};
				let ingredientFetchEmpty = false;
				if (allIngredientSKUs.size > 0) {
					const { data: ingredientsData, error: ingError } = await supabase
						.from('Ingredients')
						.select('IngredientSKU, "Quantity(Lbs/Units)"')
						.in('IngredientSKU', Array.from(allIngredientSKUs));
					if (!ingError && ingredientsData) {
						if (ingredientsData.length === 0) ingredientFetchEmpty = true;
						ingredientsData.forEach(ing => {
							ingredientsMap[ing.IngredientSKU] = ing["Quantity(Lbs/Units)"] || 0;
						});
					}
				}

				filteredOrders.forEach((order, idx) => {
					let progressRaw = order.Progress || '';
					let progress = progressRaw.toLowerCase();
					let badgeClass = '';
					if (progress === 'requested') {
						badgeClass = 'badge-requested';
					} else if (progress === 'scheduled') {
						badgeClass = 'badge-scheduled';
					} else if (progress === 'completed') {
						badgeClass = 'badge-completed';
					} else {
						badgeClass = 'badge-production';
					}
					let deadlineHtml = order.Deadline ? `<div style=\"margin-bottom:10px;\"><strong>Deadline:</strong> ${order.Deadline}</div>` : '';
					let completionHtml = order.CompletionDate ? `<div style=\"margin-bottom:10px;\"><strong>Completion Date:</strong> ${order.CompletionDate}</div>` : '';

					// --- Warning badge logic ---
					let showWarning = false;
					let warningText = '';
					   let showIngredientWarning = false;
					   let ingredientWarningText = '';
					let product = productsMap[order.ProductSKU];
					if (!product || !product.ManufacturingSteps || (Array.isArray(product.ManufacturingSteps) ? product.ManufacturingSteps.length === 0 : Object.keys(product.ManufacturingSteps).length === 0)) {
						showWarning = true;
						warningText = 'No manufacturing steps';
					} else if (ingredientFetchEmpty && allIngredientSKUs.size > 0) {
						showWarning = true;
						warningText = 'Invalid ingredient(s)';
					} else {
						try {
							let steps = Array.isArray(product.ManufacturingSteps) ? product.ManufacturingSteps : product.ManufacturingSteps.Steps;
							if (!steps || steps.length === 0) {
								showWarning = true;
								warningText = 'No manufacturing steps';
							}
							   // --- Insufficient ingredient badge logic ---
							   let insufficientIngredients = [];
							   let ProductWeightOz = order.ProductWeightOz || product.ProductWeightOz || 0;
							   let QuantityBeingMade = order.Quantity || 1;
							   if (steps && steps.length > 0) {
								   for (let i = 0; i < steps.length; i++) {
									   const step = steps[i];
									   let stepIngredients = step.StepIngredients || step["Step Ingredients"];
									   if (stepIngredients && Array.isArray(stepIngredients)) {
										   for (let j = 0; j < stepIngredients.length; j++) {
											   const ing = stepIngredients[j];
											   const dbQty = ingredientsMap[ing.IngredientSKU] || 0;
											   if (ing.ingredientUnits !== undefined) {
												   if (dbQty < ing.ingredientUnits) {
													   insufficientIngredients.push(ing.IngredientSKU);
												   }
											   }
											   if (ing.ingredientPercent !== undefined && ProductWeightOz > 0) {
												   let neededLbs = ((ing.ingredientPercent / 100) * ProductWeightOz * QuantityBeingMade * 1.1) / 453.6;
												   if (dbQty < neededLbs) {
													   insufficientIngredients.push(ing.IngredientSKU);
												   }
											   }
										   }
									   }
								   }
							   }
							   if (insufficientIngredients.length > 0) {
								   showIngredientWarning = true;
								   ingredientWarningText = `Insufficient ingredients: ${insufficientIngredients.join(", ")}`;
							   }
						} catch (e) {
							showWarning = true;
							warningText = 'Step check error';
						}
					}

					// Get step titles for this product
					let stepTitles = [];
					if (product && product.ManufacturingSteps) {
						let steps = Array.isArray(product.ManufacturingSteps)
							? product.ManufacturingSteps
							: (product.ManufacturingSteps.Steps && Array.isArray(product.ManufacturingSteps.Steps)
								? product.ManufacturingSteps.Steps
								: []);
						if (steps && steps.length > 0) {
							stepTitles = steps.map(s => s["Step Title"] || s.StepTitle).filter(Boolean);
						}
					}
					let progressOptions = [
						{ value: "requested", label: "Requested" },
						{ value: "scheduled", label: "Scheduled" },
						{ value: "completed", label: "Completed" },
						...stepTitles.map(t => ({ value: t, label: t }))
					];
					cardsHtml += `<div class=\"order-card\" id=\"order-card-${idx}\">
						<span class=\"progress-badge ${badgeClass}\">${progressRaw}</span>
						<div style=\"display:flex;align-items:center;gap:10px;\">
							<h2 style=\"margin-top:0; color:#4DBA93; font-size:1.3rem; margin-bottom:0;\">Order #${order.OrderNumber}</h2>
							${showWarning ? `<span class=\"warning-badge\" style=\"position:static;\"><i class=\"cil-warning\"></i> ${warningText}</span>` : ''}
							   ${showIngredientWarning ? `<span class=\"warning-badge\" style=\"position:static;background:#e74c3c;\"><i class=\"cil-warning\"></i> ${ingredientWarningText}</span>` : ''}
						</div>
						<div style=\"margin-bottom:10px;\"><strong>Customer:</strong> ${order.Customer || ''} &nbsp; <strong>SKU:</strong> ${order.ProductSKU || ''} &nbsp; <strong>Qty:</strong> ${order.Quantity || ''}</div>
						<div style=\"margin-bottom:10px;\"><strong>Planned Manufacture Date:</strong> ${order.PlannedManufactureDate || ''}</div>
						${deadlineHtml}
						${completionHtml}
						<button class=\"update-progress-btn\" onclick=\"openProgressModal(${order.OrderNumber}, '${progressRaw.replace(/'/g, "&#39;")}', ${JSON.stringify(progressOptions).replace(/"/g, '&quot;')})\">Update Progress</button>
						<button class=\"delete-btn\" title=\"Delete Order\" onclick=\"deleteOrder(${order.OrderNumber})\"><i class=\"cil-trash\"></i></button>
						<a href=\"Instructions.html?ordernumber=${order.OrderNumber}\" class=\"update-progress-btn\" style=\"height:40px;width:40px;display:inline-flex;align-items:center;justify-content:center;padding:0;text-decoration:none;\"><i class=\"cil-list-numbered\" style=\"font-size:1.7em;\"></i></a>
					   // Declare these once per order
					   let insufficientIngredients = [];
					   let ProductWeightOz = order.ProductWeightOz || (productsMap[order.ProductSKU] && productsMap[order.ProductSKU].ProductWeightOz) || 0;
					   let QuantityBeingMade = order.Quantity || 1;
					</div>`;
		// Modal HTML
		if (!document.getElementById('progressModal')) {
			const modalDiv = document.createElement('div');
			modalDiv.id = 'progressModal';
			modalDiv.className = 'modal';
			modalDiv.innerHTML = `
				<div class="modal-content">
					<span class="close-modal" id="closeProgressModal">&times;</span>
					<h2>Update Progress</h2>
					<div style="margin-bottom:16px;">
						<label for="modalProgressSelect" style="font-weight:600;">Select new progress:</label><br>
						<select id="modalProgressSelect" class="progress-select" style="width:100%;margin-top:8px;">
							<option value="requested">Requested</option>
							<option value="scheduled">Scheduled</option>
					<div id="plannedDateContainer" style="display:none;margin-top:12px;">
						<label for="plannedManufactureDate" style="font-weight:600;">Planned Manufacture Date:</label><br>
						<input type="date" id="plannedManufactureDate" style="width:100%;margin-top:8px;" />
					</div>
					</div>
					<button id="modalUpdateBtn" class="update-progress-btn" style="width:100%;">Update</button>
				</div>
			`;
			document.body.appendChild(modalDiv);
		}

		let modalOrderNumber = null;
		window.openProgressModal = function(orderNumber, currentProgress, options) {
			modalOrderNumber = orderNumber;
			const modal = document.getElementById('progressModal');
			const select = document.getElementById('modalProgressSelect');
			// Clear and repopulate options
			select.innerHTML = '';
			let opts = Array.isArray(options) ? options : [];
			opts.forEach(opt => {
				let o = document.createElement('option');
				o.value = opt.value;
				o.textContent = opt.label;
				select.appendChild(o);
			});
			// Show/hide date input based on initial value
			const plannedDateContainer = document.getElementById('plannedDateContainer');
			if (select.value === 'scheduled') {
				plannedDateContainer.style.display = 'block';
			} else {
				plannedDateContainer.style.display = 'none';
			}
			select.onchange = function() {
				if (select.value === 'scheduled') {
					plannedDateContainer.style.display = 'block';
				} else {
					plannedDateContainer.style.display = 'none';
				}
			};
			select.value = currentProgress.toLowerCase();
			modal.style.display = 'block';
		};
		document.getElementById('closeProgressModal').onclick = function() {
			document.getElementById('progressModal').style.display = 'none';
		};
		window.onclick = function(event) {
			const modal = document.getElementById('progressModal');
			if (event.target === modal) {
				modal.style.display = 'none';
			}
		};
		document.getElementById('modalUpdateBtn').onclick = async function() {
			const select = document.getElementById('modalProgressSelect');
			if (!select || !modalOrderNumber) return;
			const newProgress = select.value;
			let updateObj = { Progress: newProgress };
			if (newProgress === 'scheduled') {
				const plannedDateInput = document.getElementById('plannedManufactureDate');
				if (!plannedDateInput.value) {
					alert('Please enter a Planned Manufacture Date.');
					plannedDateInput.focus();
					return;
				}
				updateObj.PlannedManufactureDate = plannedDateInput.value;
			}
			const { error } = await supabase
				.from('ManufacturingTasks')
				.update(updateObj)
				.eq('OrderNumber', modalOrderNumber);
			if (error) {
				alert('Error updating progress: ' + error.message);
			} else {
				document.getElementById('progressModal').style.display = 'none';
				loadManufacturingOrders(currentProgressFilter, currentSearchTerm);
			}
		};
		async function updateOrderProgress(orderNumber) {
			const select = document.getElementById(`progress-select-${orderNumber}`);
			if (!select) return;
			const newProgress = select.value;
			const { error } = await supabase
				.from('ManufacturingTasks')
				.update({ Progress: newProgress })
				.eq('OrderNumber', orderNumber);
			if (error) {
				alert('Error updating progress: ' + error.message);
			} else {
				loadManufacturingOrders(currentProgressFilter, currentSearchTerm);
			}
		}
				});
				container.innerHTML = cardsHtml;
			} catch (err) {
				container.innerHTML = `<p style="color:red;">Error loading manufacturing orders: ${err.message}</p>`;
			}
		}
		document.getElementById('progressFilter').addEventListener('change', function() {
			currentProgressFilter = this.value;
			loadManufacturingOrders(currentProgressFilter, currentSearchTerm);
		});

		document.getElementById('orderSearchBar').addEventListener('input', function() {
			currentSearchTerm = this.value;
			loadManufacturingOrders(currentProgressFilter, currentSearchTerm);
		});

		async function deleteOrder(orderNumber) {
			if (!confirm('Are you sure you want to delete this order?')) return;
			const { error } = await supabase
				.from('ManufacturingTasks')
				.delete()
				.eq('OrderNumber', orderNumber);
			if (error) {
				alert('Error deleting order: ' + error.message);
			} else {
				loadManufacturingOrders(currentProgressFilter, currentSearchTerm);
			}
		}

		loadManufacturingOrders();
	</script>
</body>
</html>
