<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Manufacturing Orders</title>
	<link rel="stylesheet" href="https://unpkg.com/@coreui/icons/css/all.min.css">
	<link rel="stylesheet" href="/Assets/sidebar.css">
	<style>
		.modal {
			display: none;
			position: fixed;
			z-index: 1000;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			overflow: auto;
			background-color: rgba(0,0,0,0.4);
		}
		.modal-content {
			background-color: #fff;
			margin: 10% auto;
			padding: 24px;
			border-radius: 12px;
			max-width: 400px;
			box-shadow: 0 4px 16px rgba(0,0,0,0.2);
			position: relative;
		}
		.close-modal {
			color: #aaa;
			position: absolute;
			top: 12px;
			right: 18px;
			font-size: 28px;
			font-weight: bold;
			cursor: pointer;
		}
		.close-modal:hover {
			color: #e74c3c;
		}
		.update-progress-btn {
			background: #4DBA93;
			color: white;
			border: none;
			border-radius: 8px;
			padding: 8px 16px;
			font-size: 1em;
			font-weight: 600;
			cursor: pointer;
			margin-top: 10px;
			margin-right: 8px;
			transition: background 0.3s;
		}
		.update-progress-btn:hover {
			background: #3a9b74;
		}
		.progress-select {
			padding: 6px 12px;
			border-radius: 6px;
			font-size: 1em;
			margin-right: 8px;
		}
		.warning-badge {
			position: absolute;
			bottom: 18px;
			left: 18px;
			background: #f7b731;
			color: #fff;
			border-radius: 16px;
			padding: 6px 16px;
			font-size: 1em;
			font-weight: 600;
			display: flex;
			align-items: center;
			gap: 8px;
			box-shadow: 0 2px 6px rgba(0,0,0,0.08);
			z-index: 4;
		}
		.delete-btn {
			position: absolute;
			bottom: 18px;
			right: 18px;
			background: none;
			border: none;
			cursor: pointer;
			color: #ba4d74;
			font-size: 1.5em;
			z-index: 3;
			transition: color 0.2s;
		}
		.delete-btn:hover {
			color: #e74c3c;
		}
		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: linear-gradient(135deg, #c1de9f 0%, #4dba93 100%);
			min-height: 100vh;
			color: #333;
			margin: 0;
			padding: 0;
			display: flex;
		}
		.main-content {
			margin-left: 60px;
			width: calc(100% - 60px);
			min-height: 100vh;
		}
		.container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 20px;
		}
		h1 {
			color: indigo;
			text-align: center;
			margin-bottom: 30px;
		}
		.order-card {
			background: white;
			border-radius: 12px;
			box-shadow: 0 4px 6px rgba(0,0,0,0.1);
			margin-bottom: 24px;
			padding: 24px;
			position: relative;
		}
		.progress-badge {
			position: absolute;
			top: 18px;
			right: 18px;
			padding: 6px 16px;
			border-radius: 16px;
			font-size: 1em;
			font-weight: 600;
			color: white;
			box-shadow: 0 2px 6px rgba(0,0,0,0.08);
			z-index: 2;
		}
		.badge-requested {
			background: #ba4d74;
		}
		.badge-scheduled {
			background: #f7b731;
		}
		.badge-completed {
			background: #4DBA93;
		}
		.badge-production {
			background: #4d6dba;
		}
		.selected {
			border: 2px solid #4DBA93;
			background-color: #f0f9f0;
		}
		.btn {
			background: #4DBA93;
			color: white;
			border: none;
			border-radius: 8px;
			padding: 12px 24px;
			font-size: 16px;
			font-weight: 600;
			cursor: pointer;
			transition: background 0.3s;
		}
		.btn:hover {
			background: #3a9b74;
		}
		.product-search-input {
			width: 100%;
			margin-bottom: 4px;
			padding: 12px 16px;
			border: 2px solid #e1e5e9;
			border-radius: 8px;
			font-size: 1em;
			transition: border-color 0.3s, box-shadow 0.3s;
			box-sizing: border-box;
		}
		.product-search-input:focus {
			outline: none;
			border-color: #4DBA93;
			box-shadow: 0 0 0 3px rgba(77, 186, 147, 0.1);
		}
		.form-input {
			width: 100%;
			margin-bottom: 12px;
			padding: 12px 16px;
			border: 2px solid #e1e5e9;
			border-radius: 8px;
			font-size: 1em;
			transition: border-color 0.3s, box-shadow 0.3s;
			box-sizing: border-box;
			background-color: #fff;
		}
		.form-input:focus {
			outline: none;
			border-color: #4DBA93;
			box-shadow: 0 0 0 3px rgba(77, 186, 147, 0.1);
		}
		.form-select {
			width: 100%;
			margin-bottom: 12px;
			padding: 12px 16px;
			border: 2px solid #e1e5e9;
			border-radius: 8px;
			font-size: 1em;
			transition: border-color 0.3s, box-shadow 0.3s;
			box-sizing: border-box;
			background-color: #fff;
			cursor: pointer;
		}
		.form-select:focus {
			outline: none;
			border-color: #4DBA93;
			box-shadow: 0 0 0 3px rgba(77, 186, 147, 0.1);
		}
		.form-label {
			font-weight: 600;
			color: #333;
			margin-bottom: 6px;
			display: block;
			font-size: 0.95em;
		}
		.product-suggestions {
			display: none;
			position: absolute;
			top: 100%;
			left: 0;
			right: 0;
			max-height: 200px;
			overflow-y: auto;
			border: 2px solid #4DBA93;
			border-top: none;
			border-radius: 0 0 8px 8px;
			background: #fff;
			box-shadow: 0 4px 12px rgba(0,0,0,0.1);
			z-index: 1000;
			animation: slideDown 0.2s ease-out;
		}
		@keyframes slideDown {
			from {
				opacity: 0;
				transform: translateY(-5px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}
		.suggestion-item {
			padding: 12px 16px;
			cursor: pointer;
			border-bottom: 1px solid #f0f0f0;
			transition: background-color 0.2s;
			font-size: 0.95em;
		}
		.suggestion-item:last-child {
			border-bottom: none;
		}
		.suggestion-item:hover {
			background-color: #f0f9f0;
		}
		.suggestion-item strong {
			color: #4DBA93;
			font-weight: 600;
		}
		.suggestion-item .product-name {
			color: #666;
			font-size: 0.9em;
			margin-top: 2px;
		}
	</style>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
	<script src="/Assets/CheckAccess.js"></script>
	<link rel="icon" type="image/x-icon" href="/Assets/favicon.ico">
</head>
<body>
	<div id="sidebar"></div>
	<script src="/Assets/sidebar.js"></script>
	<div class="main-content">
		<div class="container">
			<div style="margin-bottom:24px; text-align:center;">
				<h1 style="text-align:center;">Manufacturing Orders</h1>
			</div>
			<div style="margin-bottom:24px; text-align:center; display:flex; flex-wrap:wrap; justify-content:center; gap:16px; align-items:center;">
				<button id="createOrderBtn" class="btn" style="padding:10px 24px;font-size:1em;">+ Create New Order</button>
				<div>
					<label for="progressFilter" style="font-weight:600; color:#4DBA93; margin-right:8px;">Filter by Progress:</label>
					<select id="progressFilter" style="padding:8px 16px; border-radius:8px; font-size:1em;">
						<option value="">All</option>
						<option value="requested">Requested</option>
						<option value="scheduled">Scheduled</option>
						<option value="completed">Completed</option>
						<option value="production">In Production</option>
					</select>
				</div>
				<div>
					<input type="text" id="orderSearchBar" placeholder="Search orders..." style="padding:8px 16px; border-radius:8px; font-size:1em; min-width:220px; border:1px solid #4DBA93;" />
				</div>
			</div>
			<div id="manufacturingOrdersContainer">
				<p>Loading manufacturing orders...</p>
			</div>
			<!-- Create Order Modal -->
			<div id="createOrderModal" class="modal">
				<div class="modal-content" style="max-width:500px;">
					<span class="close-modal" id="closeCreateOrderModal">&times;</span>
					<h2>Create New Manufacturing Order</h2>
					<form id="createOrderForm">
						<label for="newOrderProductSKU" class="form-label">Product SKU:</label>
						<div style="position:relative;">
							<input type="text" id="newOrderProductSKU" class="product-search-input" placeholder="Search for product SKU or name..." required />
							<div id="productSuggestions" class="product-suggestions"></div>
						</div>
						<label for="newOrderCustomer" class="form-label">Customer:</label>
						<select id="newOrderCustomer" class="form-select" required>
							<option value="">Select a customer...</option>
						</select>
						<label for="newOrderQuantity" class="form-label">Quantity:</label>
						<input type="number" id="newOrderQuantity" class="form-input" min="1" placeholder="Enter quantity..." required />
						<!-- Progress field removed, always set to 'requested' -->
						<label for="newOrderDeadline" class="form-label">Deadline (optional):</label>
						<input type="date" id="newOrderDeadline" class="form-input" style="margin-bottom:18px;" />
						<button type="submit" class="btn" style="width:100%;">Create Order</button>
					</form>
					<div id="createOrderStatus" style="margin-top:10px;text-align:center;font-weight:600;"></div>
				</div>
			</div>
		</div>
	</div>
	<script>
// DRY: Shared function to parse steps and calculate ingredient usage
function getIngredientUsage(product, order) {
	let steps = [];
	if (Array.isArray(product.ManufacturingSteps)) {
		steps = product.ManufacturingSteps;
	} else if (product.ManufacturingSteps && Array.isArray(product.ManufacturingSteps.Steps)) {
		steps = product.ManufacturingSteps.Steps;
	}
	let QuantityBeingMade = order.Quantity || 1;
	let usage = {};
	for (let i = 0; i < steps.length; i++) {
		const step = steps[i];
		let stepIngredients = Array.isArray(step["Step Ingredients"]) ? step["Step Ingredients"] : [];
		for (let j = 0; j < stepIngredients.length; j++) {
			const ing = stepIngredients[j];
			if (ing.IngredientSKU && ing.IngredientQuantity !== undefined) {
				let neededQty = ing.IngredientQuantity * QuantityBeingMade;
				if (!usage[ing.IngredientSKU]) usage[ing.IngredientSKU] = 0;
				usage[ing.IngredientSKU] += neededQty;
			}
		}
	}
	return usage;
}
		// Modal logic for creating new order
		document.addEventListener('DOMContentLoaded', function() {
			const createOrderBtn = document.getElementById('createOrderBtn');
			const createOrderModal = document.getElementById('createOrderModal');
			const closeCreateOrderModal = document.getElementById('closeCreateOrderModal');
			const createOrderForm = document.getElementById('createOrderForm');
			const createOrderStatus = document.getElementById('createOrderStatus');
			const productInput = document.getElementById('newOrderProductSKU');
			const productSuggestions = document.getElementById('productSuggestions');
			const customerSelect = document.getElementById('newOrderCustomer');
			
			let allProducts = [];
			let selectedProductSKU = null;
			
			// Load all products for search
			async function loadAllProducts() {
				const { data: products, error } = await supabase.from('Products').select('ProductSKU, Name');
				if (error || !products) {
					console.error('Error loading products:', error);
					return;
				}
				allProducts = products;
			}
			
			// Filter and display product suggestions
			function showProductSuggestions(searchTerm) {
				if (!searchTerm || searchTerm.length < 1) {
					productSuggestions.style.display = 'none';
					return;
				}
				
				const filtered = allProducts.filter(prod => 
					prod.ProductSKU.toLowerCase().includes(searchTerm.toLowerCase()) ||
					(prod.Name && prod.Name.toLowerCase().includes(searchTerm.toLowerCase()))
				);
				
				if (filtered.length === 0) {
					productSuggestions.innerHTML = '<div class="suggestion-item" style="color:#999;cursor:default;"><em>No products found</em></div>';
					productSuggestions.style.display = 'block';
					return;
				}
				
				let html = '';
				filtered.slice(0, 10).forEach(prod => { // Limit to 10 suggestions
					html += `<div class="suggestion-item" 
						onclick="selectProduct('${prod.ProductSKU}', '${(prod.Name || '').replace(/'/g, "&#39;")}')"
					>
						<strong>${prod.ProductSKU}</strong>
						${prod.Name ? `<div class="product-name">${prod.Name}</div>` : ''}
					</div>`;
				});
				
				productSuggestions.innerHTML = html;
				productSuggestions.style.display = 'block';
			}
			
			// Handle product selection
			window.selectProduct = function(sku, name) {
				selectedProductSKU = sku;
				productInput.value = sku + (name ? ` - ${name}` : '');
				productSuggestions.style.display = 'none';
			};
			
			// Add input event listener for search
			productInput.addEventListener('input', function() {
				selectedProductSKU = null; // Reset selection when typing
				showProductSuggestions(this.value);
			});
			
			// Hide suggestions when clicking outside
			document.addEventListener('click', function(e) {
				if (!productInput.contains(e.target) && !productSuggestions.contains(e.target)) {
					productSuggestions.style.display = 'none';
				}
			});
			
			// Populate ProductSKU dropdown - now loads all products for search
			async function populateProductDropdown() {
				await loadAllProducts();
			}
			// Populate Customer dropdown
			async function populateCustomerDropdown() {
				customerSelect.innerHTML = '<option value="">Loading...</option>';
				const { data: users, error } = await supabase.from('Users').select('id, display_name, email').in('Role', ['client', 'service_role']);
				if (error || !users) {
					customerSelect.innerHTML = '<option value="">Error loading users</option>';
					return;
				}
				customerSelect.innerHTML = '';
				users.forEach(user => {
					const opt = document.createElement('option');
					opt.value = user.display_name;
					opt.textContent = user.display_name ? `${user.display_name} (${user.email})` : user.email;
					customerSelect.appendChild(opt);
				});
			}
			createOrderBtn.onclick = async function() {
				createOrderStatus.textContent = '';
				selectedProductSKU = null;
				productInput.value = '';
				productSuggestions.style.display = 'none';
				await populateProductDropdown();
				await populateCustomerDropdown();
				createOrderModal.style.display = 'block';
			};
			closeCreateOrderModal.onclick = function() {
				createOrderModal.style.display = 'none';
			};
			window.onclick = function(event) {
				if (event.target === createOrderModal) {
					createOrderModal.style.display = 'none';
				}
			};
			createOrderForm.onsubmit = async function(e) {
				e.preventDefault();
				const ProductSKU = selectedProductSKU || productInput.value.split(' - ')[0]; // Use selected SKU or extract from input
				const Customer = customerSelect.value;
				const Quantity = parseInt(document.getElementById('newOrderQuantity').value);
				const Progress = 'requested';
				const Deadline = document.getElementById('newOrderDeadline').value;
				if (!ProductSKU || !Customer || !Quantity || !Progress) {
					createOrderStatus.textContent = 'Please fill all required fields.';
					createOrderStatus.style.color = '#e74c3c';
					return;
				}
				// Validate that the product SKU exists
				const productExists = allProducts.some(prod => prod.ProductSKU === ProductSKU);
				if (!productExists) {
					createOrderStatus.textContent = 'Please select a valid product SKU from the suggestions.';
					createOrderStatus.style.color = '#e74c3c';
					return;
				}
				createOrderStatus.textContent = 'Creating order...';
				createOrderStatus.style.color = '#333';
				try {
					const { error } = await supabase.from('ManufacturingTasks').insert([
						{
							ProductSKU,
							Customer,
							Quantity,
							Progress,
							Deadline: Deadline || null
						}
					]);
					if (error) throw error;
					createOrderStatus.textContent = 'Order created successfully!';
					createOrderStatus.style.color = '#27ae60';
					setTimeout(() => {
						createOrderModal.style.display = 'none';
						loadManufacturingOrders(currentProgressFilter, currentSearchTerm);
					}, 1200);
				} catch (err) {
					createOrderStatus.textContent = 'Error creating order: ' + err.message;
					createOrderStatus.style.color = '#e74c3c';
				}
			};
		});
		checkPermissions(['service_role', 'employee']);
		setup
		let orders = [];
	let currentProgressFilter = "";
	let currentSearchTerm = "";
	async function loadManufacturingOrders(progressFilter = "", searchTerm = "") {
			const container = document.getElementById('manufacturingOrdersContainer');
			container.innerHTML = '<p>Loading manufacturing orders...</p>';
			try {
				const { data: ordersRaw, error } = await supabase
					.from('ManufacturingTasks')
					.select('*')
					.order('OrderNumber', { ascending: false });
				if (error) throw error;
				if (!ordersRaw || ordersRaw.length === 0) {
					container.innerHTML = '<p>No manufacturing orders found.</p>';
					return;
				}
				orders = ordersRaw;
				let filteredOrders = orders;
				if (progressFilter) {
					filteredOrders = filteredOrders.filter(order => {
						let progress = (order.Progress || '').toLowerCase();
						if (progressFilter === 'production') {
							return progress !== 'requested' && progress !== 'scheduled' && progress !== 'completed';
						}
						if (progressFilter === 'completed') {
							return progress === 'completed';
						}
						return progress === progressFilter;
					});
				} else {
					// Default: omit completed orders
					filteredOrders = filteredOrders.filter(order => (order.Progress || '').toLowerCase() !== 'completed');
				}
				if (searchTerm && searchTerm.trim() !== "") {
					const term = searchTerm.trim().toLowerCase();
					filteredOrders = filteredOrders.filter(order => {
						return (
							(order.Customer && order.Customer.toLowerCase().includes(term)) ||
							(order.ProductSKU && order.ProductSKU.toLowerCase().includes(term)) ||
							(order.OrderNumber && String(order.OrderNumber).includes(term))
						);
					});
				}
				let cardsHtml = '';
				// Helper: fetch product info for all unique SKUs
				const productSKUs = Array.from(new Set(filteredOrders.map(o => o.ProductSKU).filter(Boolean)));
				let productsMap = {};
				if (productSKUs.length > 0) {
					const { data: productsData, error: prodError } = await supabase
						.from('Products')
						.select('ProductSKU, ManufacturingSteps, "Product Weight(oz)"')
						.in('ProductSKU', productSKUs);
					if (!prodError && productsData) {
						productsData.forEach(prod => {
							productsMap[prod.ProductSKU] = prod;
						});
					}
				}

				// Gather all needed ingredient SKUs for all orders
				let allIngredientSKUs = new Set();
				filteredOrders.forEach(order => {
					let product = productsMap[order.ProductSKU];
					if (product && product.ManufacturingSteps) {
						let steps = [];
						if (Array.isArray(product.ManufacturingSteps)) {
							steps = product.ManufacturingSteps;
						} else if (product.ManufacturingSteps.Steps && Array.isArray(product.ManufacturingSteps.Steps)) {
							steps = product.ManufacturingSteps.Steps;
						}
						// Defensive: flatten steps if prototype chain is weird
						if (steps && typeof steps.length === 'number' && steps.length > 0) {
							for (let i = 0; i < steps.length; i++) {
								const step = steps[i];
								let stepIngredients = step.StepIngredients || step["Step Ingredients"];
								if (step && stepIngredients && Array.isArray(stepIngredients)) {
									stepIngredients.forEach(ing => {
										if (ing.IngredientSKU) allIngredientSKUs.add(ing.IngredientSKU);
									});
								}
							}
						}
					}
				});

				// Fetch ingredient quantities
				let ingredientsMap = {};
				let ingredientFetchEmpty = false;
				if (allIngredientSKUs.size > 0) {
					const { data: ingredientsData, error: ingError } = await supabase
						.from('Ingredients')
						.select('IngredientSKU, "Quantity(Lbs/Units)"')
						.in('IngredientSKU', Array.from(allIngredientSKUs));
					if (!ingError && ingredientsData) {
						if (ingredientsData.length === 0) ingredientFetchEmpty = true;
						ingredientsData.forEach(ing => {
							ingredientsMap[ing.IngredientSKU] = ing["Quantity(Lbs/Units)"] || 0;
						});
					}
				}

				filteredOrders.forEach((order, idx) => {
					let progressRaw = order.Progress || '';
					let progress = progressRaw.toLowerCase();
					let badgeClass = '';
					if (progress === 'requested') {
						badgeClass = 'badge-requested';
					} else if (progress === 'scheduled') {
						badgeClass = 'badge-scheduled';
					} else if (progress === 'completed') {
						badgeClass = 'badge-completed';
					} else {
						badgeClass = 'badge-production';
					}
					let deadlineHtml = order.Deadline ? `<div style=\"margin-bottom:10px;\"><strong>Deadline:</strong> ${order.Deadline}</div>` : '';
					let completionHtml = order.CompletionDate ? `<div style=\"margin-bottom:10px;\"><strong>Completion Date:</strong> ${order.CompletionDate}</div>` : '';

					// --- DRY ingredient sufficiency logic ---
										let showWarning = false;
										let warningText = '';
										let showIngredientWarning = false;
										let ingredientWarningText = '';
										let product = productsMap[order.ProductSKU];
										// DRY: Use shared function for ingredient check
										   function getInsufficientIngredients(product, order, ingredientsMap) {
											   if (!product || !product.ManufacturingSteps) {
												   return { error: 'No manufacturing steps', insufficient: [] };
											   }
											   try {
												   let usage = getIngredientUsage(product, order);
												   let insufficientIngredients = [];
												   for (let sku in usage) {
													   const dbQty = ingredientsMap[sku] || 0;
													   if (dbQty < usage[sku]) {
														   insufficientIngredients.push(sku);
													   }
												   }
												   return { error: null, insufficient: insufficientIngredients };
											   } catch (e) {
												   return { error: 'Step check error', insufficient: [] };
											   }
										   }
										const checkResult = getInsufficientIngredients(product, order, ingredientsMap);
										if (checkResult.error) {
											showWarning = true;
											warningText = checkResult.error;
										} else if (checkResult.insufficient.length > 0) {
											showIngredientWarning = true;
											ingredientWarningText = checkResult.insufficient;
										}

					// Get step titles for this product
					let stepTitles = [];
					if (product && product.ManufacturingSteps) {
						let steps = Array.isArray(product.ManufacturingSteps)
							? product.ManufacturingSteps
							: (product.ManufacturingSteps.Steps && Array.isArray(product.ManufacturingSteps.Steps)
								? product.ManufacturingSteps.Steps
								: []);
						if (steps && steps.length > 0) {
							stepTitles = steps.map(s => s["Step Title"] || s.StepTitle).filter(Boolean);
						}
					}
					let progressOptions = [
						{ value: "requested", label: "Requested" },
						{ value: "scheduled", label: "Scheduled" },
						{ value: "completed", label: "Completed" },
						...stepTitles.map(t => ({ value: t, label: t }))
					];
					cardsHtml += `<div class=\"order-card\" id=\"order-card-${idx}\">
						<span class=\"progress-badge ${badgeClass}\">${progressRaw}</span>
						<div style=\"display:flex;align-items:center;gap:14px;\">
							<h2 style=\"margin-top:0; color:#4DBA93; font-size:1.3rem; margin-bottom:0;display:flex;align-items:center;gap:10px;\">
								<span>Order #${order.OrderNumber}</span>
								<span style=\"background:#f7f7fa;border-radius:8px;padding:4px 14px;font-size:1.08rem;color:#4d6dba;font-weight:600;box-shadow:0 1px 4px rgba(77,109,186,0.07);border:1px solid #e1e5e9;\">
									${order.ProductSKU || ''} <span style=\"color:#888;\">×</span> ${order.Quantity || ''}
								</span>
							</h2>
							${showWarning ? `<span class=\"warning-badge\" style=\"position:static;\"><i class=\"cil-warning\"></i> ${warningText}</span>` : ''}
							${showIngredientWarning ? `<button onclick="showInsufficientIngredientsModal(${JSON.stringify(ingredientWarningText).replace(/"/g, '&quot;')})" class="warning-badge" style="position:static;background:#e74c3c;"><i class="cil-warning"></i>Insufficient Ingredients</button>` : ''}
							${order.IngredientsRemoved ? `<button id=\"restore\" onclick="restoreIngredients(${order.OrderNumber})" style=\"background:#4DBA93;color:#fff;border-radius:8px;padding:4px 10px;font-size:0.98em;margin-left:10px;display:inline-block;vertical-align:middle;\"><i class="cil-history"></i> Add Back Ingredients</button>` : ''}
									</h2>
						</div>
						<div style=\"margin-bottom:10px;\"><strong>Customer:</strong> ${order.Customer || ''}</div>
						${order.PlannedManufactureDate ? `<div style=\"margin-bottom:10px;\"><strong>Planned Manufacture Date:</strong> ${order.PlannedManufactureDate}</div>` : ''}
						${deadlineHtml}
						${completionHtml}
						<button class=\"update-progress-btn\" onclick=\"openProgressModal(${order.OrderNumber}, '${progressRaw.replace(/'/g, "&#39;")}', ${JSON.stringify(progressOptions).replace(/"/g, '&quot;')})\">Update Progress</button>
						<button class=\"delete-btn\" title=\"Delete Order\" onclick=\"deleteOrder(${order.OrderNumber})\"><i class=\"cil-trash\"></i></button>
						<a href=\"Instructions.html?ordernumber=${order.OrderNumber}\" class=\"update-progress-btn\" style=\"height:40px;width:40px;display:inline-flex;align-items:center;justify-content:center;padding:0;text-decoration:none;\"><i class=\"cil-list-numbered\" style=\"font-size:1.7em;\"></i></a>
					</div>`;
		// Modal HTML
		if (!document.getElementById('progressModal')) {
			const modalDiv = document.createElement('div');
			modalDiv.id = 'progressModal';
			modalDiv.className = 'modal';
			modalDiv.innerHTML = `
				<div class="modal-content">
					<span class="close-modal" id="closeProgressModal">&times;</span>
					<h2>Update Progress</h2>
					<div style="margin-bottom:16px;">
						<label for="modalProgressSelect" style="font-weight:600;">Select new progress:</label><br>
						<select id="modalProgressSelect" class="progress-select" style="width:100%;margin-top:8px;">
							<option value="requested">Requested</option>
							<option value="scheduled">Scheduled</option>
              <option value="in production">In Production</option>
							<option value="completed">Completed</option>
						</select>
					<div id="plannedDateContainer" style="display:none;margin-top:12px;">
						<label for="plannedManufactureDate" style="font-weight:600;">Planned Manufacture Date:</label><br>
						<input type="date" id="plannedManufactureDate" style="width:100%;margin-top:8px;" />
					</div>
					</div>
					<button id="modalUpdateBtn" class="update-progress-btn" style="width:100%;">Update</button>
				</div>
			`;
			document.body.appendChild(modalDiv);
		}

		let modalOrderNumber = null;
		window.openProgressModal = function(orderNumber, currentProgress, options) {
			modalOrderNumber = orderNumber;
			const modal = document.getElementById('progressModal');
			const select = document.getElementById('modalProgressSelect');
			// Clear and repopulate options
			select.innerHTML = '';
			let opts = Array.isArray(options) ? options : [];
			opts.forEach(opt => {
				let o = document.createElement('option');
				o.value = opt.value;
				o.textContent = opt.label;
				select.appendChild(o);
			});
			// Show/hide date input based on initial value
			const plannedDateContainer = document.getElementById('plannedDateContainer');
			if (select.value === 'scheduled') {
				plannedDateContainer.style.display = 'block';
			} else {
				plannedDateContainer.style.display = 'none';
			}
			select.onchange = function() {
				if (select.value === 'scheduled') {
					plannedDateContainer.style.display = 'block';
				} else {
					plannedDateContainer.style.display = 'none';
				}
			};
			select.value = currentProgress.toLowerCase();
			modal.style.display = 'block';
		};
		document.getElementById('closeProgressModal').onclick = function() {
			document.getElementById('progressModal').style.display = 'none';
		};
		window.onclick = function(event) {
			const modal = document.getElementById('progressModal');
			if (event.target === modal) {
				modal.style.display = 'none';
			}
		};
		document.getElementById('modalUpdateBtn').onclick = async function() {
			const select = document.getElementById('modalProgressSelect');
			if (!select || !modalOrderNumber) return;
			const newProgress = select.value;
			let updateObj = { Progress: newProgress };
			if (newProgress === 'scheduled') {
				// DRY: Use shared function for ingredient warning
				let order = orders.find(o => o.OrderNumber === modalOrderNumber);
				let product = order && order.ProductSKU && productsMap[order.ProductSKU] ? productsMap[order.ProductSKU] : null;
				const checkResult = getInsufficientIngredients(product, order, ingredientsMap);
				let confirmed = true;
				if (checkResult.insufficient && checkResult.insufficient.length > 0) {
					confirmed = confirm('Warning: There are insufficient ingredients for this order. Are you sure you want to schedule it?');
					if (!confirmed) return;
				}
				const plannedDateInput = document.getElementById('plannedManufactureDate');
				if (!plannedDateInput.value) {
					alert('Please enter a Planned Manufacture Date.');
					plannedDateInput.focus();
					return;
				}
				updateObj.PlannedManufactureDate = plannedDateInput.value;
				// Do not subtract ingredients if IngredientsRemoved is already true
				if (!order.IngredientsRemoved && confirmed && product && product.ManufacturingSteps) {
					let ingredientUsage = getIngredientUsage(product, order);
					// Fetch current quantities for all used ingredients
					const usedSKUs = Object.keys(ingredientUsage);
					if (usedSKUs.length > 0) {
						const { data: currentIngredients, error: fetchError } = await supabase
							.from('Ingredients')
							.select('IngredientSKU, "Quantity(Lbs/Units)"')
							.in('IngredientSKU', usedSKUs);
						if (!fetchError && currentIngredients) {
							// Prepare updates
							let updates = [];
							currentIngredients.forEach(ing => {
								let newQty = (ing["Quantity(Lbs/Units)"] || 0) - (ingredientUsage[ing.IngredientSKU] || 0);
								if (newQty < 0) newQty = 0;
								updates.push({ IngredientSKU: ing.IngredientSKU, "Quantity(Lbs/Units)": newQty });
							});
							// Update all in parallel
							for (let upd of updates) {
								// Update ingredient quantity
								await supabase
									.from('Ingredients')
									.update({ "Quantity(Lbs/Units)": upd["Quantity(Lbs/Units)"] })
									.eq('IngredientSKU', upd.IngredientSKU);
								// Log the removal
								await supabase
									.from('IngredientLog')
									.insert([
										{
											ChangeTime: new Date().toISOString(),
											IngredientSKU: upd.IngredientSKU,
											QuantityChanged: -ingredientUsage[upd.IngredientSKU],
											Updated_By: window.CurrentUserDisplayName,
											Log: `Scheduled order #${order.OrderNumber} for product ${order.ProductSKU}`
										}
									]);
							}
						}
					}
					// Set IngredientsRemoved if ingredients were subtracted
					updateObj.IngredientsRemoved = true;
				}
			}
			const { error } = await supabase
				.from('ManufacturingTasks')
				.update(updateObj)
				.eq('OrderNumber', modalOrderNumber);
			if (error) {
				alert('Error updating progress: ' + error.message);
			} else {
				document.getElementById('progressModal').style.display = 'none';
				loadManufacturingOrders(currentProgressFilter, currentSearchTerm);
			}
		};
				});
				container.innerHTML = cardsHtml;
			} catch (err) {
				container.innerHTML = `<p style="color:red;">Error loading manufacturing orders: ${err.message}</p>`;
			}
		}
		document.getElementById('progressFilter').addEventListener('change', function() {
			currentProgressFilter = this.value;
			loadManufacturingOrders(currentProgressFilter, currentSearchTerm);
		});

		document.getElementById('orderSearchBar').addEventListener('input', function() {
			currentSearchTerm = this.value;
			loadManufacturingOrders(currentProgressFilter, currentSearchTerm);
		});

		async function deleteOrder(orderNumber) {
			if (!confirm('Are you sure you want to delete this order?')) return;
			const { error } = await supabase
				.from('ManufacturingTasks')
				.delete()
				.eq('OrderNumber', orderNumber);
			if (error) {
				alert('Error deleting order: ' + error.message);
			} else {
				loadManufacturingOrders(currentProgressFilter, currentSearchTerm);
			}
		}
		async function restoreIngredients(orderNumber){
			document.getElementById('restore').disabled = true;
					// Fetch order info (ProductSKU, Quantity)
					const { data: order, error: orderError } = await supabase
						.from('ManufacturingTasks')
						.select('ProductSKU, Quantity')
						.eq('OrderNumber', orderNumber)
						.single();
					if (!order || orderError) {
						alert('Could not find order.');
						return;
					}
					// Fetch product steps
					const { data: product, error: prodError } = await supabase
						.from('Products')
						.select('ManufacturingSteps')
						.eq('ProductSKU', order.ProductSKU)
						.single();
					if (!product || prodError || !product.ManufacturingSteps) {
						alert('Could not find product steps.');
						return;
					}
					let ingredientUsage = getIngredientUsage(product, order);
					// Fetch current ingredient quantities
					const usedSKUs = Object.keys(ingredientUsage);
					if (usedSKUs.length === 0) {
						alert('No ingredients to restore.');
						return;
					}
					const { data: currentIngredients, error: fetchError } = await supabase
						.from('Ingredients')
						.select('IngredientSKU, "Quantity(Lbs/Units)"')
						.in('IngredientSKU', usedSKUs);
					if (fetchError || !currentIngredients) {
						alert('Could not fetch ingredient data.');
						return;
					}
					// Prepare updates
					let updates = [];
					currentIngredients.forEach(ing => {
						let newQty = (ing["Quantity(Lbs/Units)"] || 0) + (ingredientUsage[ing.IngredientSKU] || 0);
						updates.push({ IngredientSKU: ing.IngredientSKU, "Quantity(Lbs/Units)": newQty });
					});
					// Update all in parallel
					for (let upd of updates) {
						await supabase
							.from('Ingredients')
							.update({ "Quantity(Lbs/Units)": upd["Quantity(Lbs/Units)"] })
							.eq('IngredientSKU', upd.IngredientSKU);
						// Log the restoration
						await supabase
							.from('IngredientLog')
							.insert([
								{
									ChangeTime: new Date().toISOString(),
									IngredientSKU: upd.IngredientSKU,
									QuantityChanged: ingredientUsage[upd.IngredientSKU],
									Updated_By: window.CurrentUserDisplayName,
									Log: `Restored for order #${orderNumber} (undo removal)`
								}
							]);
					}
					// Set IngredientsRemoved to false
					await supabase
						.from('ManufacturingTasks')
						.update({ IngredientsRemoved: false })
						.eq('OrderNumber', orderNumber);
					alert('Ingredients restored.');
					loadManufacturingOrders(currentProgressFilter, currentSearchTerm);
				}
		loadManufacturingOrders();
	</script>
	<!-- Add modal for insufficient ingredients -->
	<div id="ingredientModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:9999;align-items:center;justify-content:center;">
		<div style="background:#fff;padding:32px 24px;border-radius:12px;max-width:480px;width:90vw;box-shadow:0 4px 24px rgba(0,0,0,0.18);position:relative;">
			<h2 style="margin-top:0;color:#e74c3c;text-align:center;font-size:1.3em;">Insufficient Ingredients</h2>
			<div id="ingredientModalContent" style="margin-top:18px;"></div>
			<button id="closeIngredientModal" style="margin-top:24px;width:100%;background:#4DBA93;color:#fff;border:none;padding:10px 0;border-radius:8px;font-size:1em;cursor:pointer;">Close</button>
		</div>
	</div>
	<script>
		document.getElementById('closeIngredientModal').onclick = function() {
  document.getElementById('ingredientModal').style.display = 'none';
};

// Function to show modal with ingredient info
async function showInsufficientIngredientsModal(insufficientSKUs) {
  if (!Array.isArray(insufficientSKUs) || insufficientSKUs.length === 0) return;
  const { data: ingredients, error } = await supabase
    .from('Ingredients')
    .select('IngredientSKU, Name, Link')
    .in('IngredientSKU', insufficientSKUs);
  let html = '<table style="width:100%;border-collapse:collapse;">';
  html += '<thead><tr><th>Name</th><th>SKU</th><th>Link</th></tr></thead><tbody>';
  (ingredients || []).forEach(ing => {
    html += `<tr>
      <td style="padding:6px 8px;border-bottom:1px solid #eee;">${ing.Name || ''}</td>
      <td style="padding:6px 8px;border-bottom:1px solid #eee;">${ing.IngredientSKU}</td>
      <td style="padding:6px 8px;border-bottom:1px solid #eee;">${ing.Link ? `<a href="${ing.Link}" target="_blank">Link</a>` : ''}</td>
    </tr>`;
  });
  html += '</tbody></table>';
  document.getElementById('ingredientModalContent').innerHTML = html;
  document.getElementById('ingredientModal').style.display = 'flex';
}
	</script>
</body>
</html>
