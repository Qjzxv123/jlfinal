<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - J&L Naturals</title>
  <link rel="stylesheet" href="https://unpkg.com/@coreui/icons/css/all.min.css">
  <link rel="stylesheet" href="/Assets/sidebar.css">
  <style>
    /* Notification banners */
    #banner-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }
    .alert-banner {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid #f1e4b8;
      background: #fffbef;
      color: #5c4b19;
      box-shadow: 0 6px 18px rgba(0,0,0,0.05);
      font-weight: 600;
    }
    .alert-banner.info {
      border-color: #cce4ff;
      background: #f5f9ff;
      color: #1f4473;
    }
    .alert-banner.success {
      border-color: #b8e4c6;
      background: #f3fff7;
      color: #1f6b3a;
    }
    .alert-banner .icon {
      font-size: 1.2em;
      line-height: 1;
      margin-top: 2px;
    }
    .alert-banner .text {
      flex: 1;
      font-size: 0.98em;
      line-height: 1.4;
    }
    .alert-banner .close-btn {
      background: none;
      border: none;
      color: inherit;
      font-size: 1.2em;
      cursor: pointer;
      padding: 0 4px;
      line-height: 1;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #c1de9f 0%, #4dba93 100%);
      min-height: 100vh;
      color: #333;
      margin: 0;
      padding: 0;
      display: flex;
    }
    .main-content {
      margin-left: 60px;
      width: calc(100% - 60px);
      min-height: 100vh;
      padding: 20px;
    }
    .dashboard-container {
      max-width: 1500px;
      margin: 0 auto;
    }
    .dashboard-header {
      background: white;
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    h1 {
      color: #2d3748;
      font-size: 2.2rem;
      margin-bottom: 10px;
    }
    .section-card {
      background: white;
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
    }
    /* KPI cards */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 14px;
      margin-bottom: 20px;
      max-width: 720px;
      margin-left: auto;
      margin-right: auto;
    }
    .kpi-card {
      background: white;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
      border: 1px solid #eef2f7;
      text-align: center;
    }
    .kpi-label { color: #718096; font-weight: 600; font-size: 0.9rem; }
    .kpi-value { color: #2d3748; font-size: 1.8rem; font-weight: 800; margin-top: 6px; }
    .kpi-sub { color: #4dba93; font-size: 0.85rem; font-weight: 600; margin-top: 4px; }

    /* Quick actions */
    .quick-actions { display: grid; grid-template-columns: repeat(6, minmax(140px, 1fr)); gap: 12px; }
    .qa-card { background:white; border:1px solid #eef2f7; border-radius:12px; padding:14px; text-align:center; cursor:pointer; transition: transform .12s ease, box-shadow .12s ease; }
    .qa-card:hover { transform: translateY(-2px); box-shadow: 0 6px 14px rgba(0,0,0,0.08); }
    .qa-card .qa-title { margin-top:8px; font-weight:700; color:#2d3748; font-size:0.95rem; }

    /* Chart container */
    .chart-wrap { position: relative; height: 260px; }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f7fafc;
      cursor: pointer;
    }
    .section-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #2d3748;
    }
    .row-count {
      font-size: 1rem;
      color: #4dba93;
      font-weight: 600;
      margin-left: 10px;
    }
    .table-list {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .table-list th, .table-list td {
      border: 1px solid #e2e8f0;
      padding: 8px 12px;
      text-align: left;
    }
    .table-list th {
      background: #f7fafc;
      font-weight: 700;
    }
    .loading-state, .empty-state {
      text-align: center;
      padding: 30px 10px;
      color: #718096;
    }
    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 4px solid #e2e8f0;
      border-top-color: #4dba93;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .collapsed-table {
      display: none;
    }
    .collapse-arrow {
      margin-right: 8px;
      transition: transform 0.2s;
    }
    .collapsed .collapse-arrow {
      transform: rotate(-90deg);
    }
    @media (max-width: 900px) {
      .main-content { margin-left: 0; width: 100%; padding: 10px; }
      .dashboard-header { padding: 18px; }
      .section-card { padding: 14px; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/Assets/CheckAccess.js"></script>
  <link rel="icon" type="image/x-icon" href="/Assets/favicon.ico">
</head>
<body>
  <div id="sidebar"></div>
  <script src="/Assets/sidebar.js"></script>
  <div class="main-content">
    <div class="dashboard-container">
      <div class="dashboard-header">
        <h1>Admin Dashboard</h1>
      </div>
      <!-- KPI Cards -->
      <div class="kpi-grid" id="kpiGrid">
        <div class="kpi-card"><div class="kpi-label">Active Orders</div><div class="kpi-value" id="kpi-active-orders">—</div><div class="kpi-sub" id="kpi-active-sub">Loading…</div></div>
        <div class="kpi-card"><div class="kpi-label">Inventory Removed</div><div class="kpi-value" id="kpi-inv-removed">—</div><div class="kpi-sub">Ready to ship</div></div>
        <div class="kpi-card"><div class="kpi-label">Low Products</div><div class="kpi-value" id="kpi-low-products">—</div><div class="kpi-sub">Qty &lt; 20</div></div>
      </div>
      <!-- Quick actions -->
      <div class="section-card">
        <div class="section-header" style="cursor:default;">
          <span><span class="section-title">Quick Actions</span></span>
        </div>
        <div class="quick-actions">
          <div class="qa-card" onclick="location.href='/admin/Orders.html'"><i class="cil-truck" style="font-size:20px;color:#4dba93;"></i><div class="qa-title">Orders</div></div>
          <div class="qa-card" onclick="location.href='/admin/Manufacturing.html'"><i class="cil-factory" style="font-size:20px;color:#4d6dba;"></i><div class="qa-title">Manufacturing</div></div>
          <div class="qa-card" onclick="location.href='/admin/UserManagement.html'"><i class="cil-user" style="font-size:20px;color:#ba4d74;"></i><div class="qa-title">Users</div></div>
          <div class="qa-card" onclick="location.href='/admin/DatabaseViewer.html'"><i class="cil-storage" style="font-size:20px;color:#8a5cf6;"></i><div class="qa-title">Inventory</div></div>
          <div class="qa-card" onclick="location.href='/admin/AmazonShipments.html'"><i class="cil-send" style="font-size:20px;color:#f5a623;"></i><div class="qa-title">Amazon Shipments</div></div>
          <div class="qa-card" onclick="location.href='/admin/Calendar.html'"><i class="cil-calendar" style="font-size:20px;color:#228B22;"></i><div class="qa-title">Calendar</div></div>
        </div>
      </div>

      <div id="ordersCount" style="font-size:1.2rem;font-weight:600;margin-top:10px;"></div>
      <div id="adminSections"></div>
    </div>
  </div>
  <script>
    checkPermissions(['service_role']);
    
    const sections = [
  { key: 'AmazonShipments', label: 'Amazon Shipments', columns: ['Items','Notes','display_name'], filter: row => row.Status !=="Completed" },
  { key: 'IngredientOrders', label: 'Ingredient Orders', columns: ['ExpectedBy','IngredientSKU','Quantity','Unit'] },
  { key: 'ReceivingLog', label: 'Receiving Log', columns: ['TrackingLink','Retailer','RecievedAt','Status'] },
  { key: 'Checklist', label: 'Checklist', columns: ['Priority','Task','Status','AssignedTo','AssignedBy','Deadline'], filter: row => row.Status !== 'completed' },
  { key: 'ManufacturingTasks', label: 'Manufacturing Tasks', columns: ['OrderNumber','ProductSKU','Quantity','PlannedManufactureDate','Progress'], filter: row => row.Progress !== 'completed' }
    ];
    document.addEventListener('DOMContentLoaded', async function() {
      await Promise.all([
        loadOrdersCount(),
        loadKpis()
      ]);
      for (const section of sections) {
        await renderCollapsableTable(section);
      }
      await renderLowInventorySection();
      warnIfTasksToReview();
      Alerts();
    });
    async function loadOrdersCount() {
      let banner = document.getElementById('ordersCountBanner');
      if (!banner) {
        banner = createBanner('');
        banner.id = 'ordersCountBanner';
      }
      banner.innerHTML = '<span class="loading-spinner"></span> Loading order count...';
      try {
        const { count, error } = await supabase
          .from('Orders')
          .select('OrderID', { count: 'exact', head: true });
        if (error) throw error;
        banner.textContent = `Active Ecommerce Orders: ${count ?? 0}`;
      } catch (e) {
        banner.textContent = 'Unable to load order count';
      }
    }
    async function renderCollapsableTable(section) {
      const container = document.getElementById('adminSections');
      const card = document.createElement('div');
      card.className = 'section-card';
      card.innerHTML = `
        <div class="section-header" id="header-${section.key}">
          <span><span class="collapse-arrow">&#9654;</span><span class="section-title">${section.label}</span><span class="row-count" id="count-${section.key}"></span></span>
        </div>
        <div class="table-container" id="table-${section.key}">
          <div class="loading-state"><div class="loading-spinner"></div>Loading...</div>
        </div>
      `;
      container.appendChild(card);
      let collapsed = true;
      const header = card.querySelector('.section-header');
      const tableContainer = card.querySelector('.table-container');
      const arrow = card.querySelector('.collapse-arrow');
      header.addEventListener('click', () => {
        collapsed = !collapsed;
        if (collapsed) {
          tableContainer.classList.add('collapsed-table');
          card.classList.add('collapsed');
        } else {
          tableContainer.classList.remove('collapsed-table');
          card.classList.remove('collapsed');
        }
      });
      // Start collapsed, show only row count
      tableContainer.classList.add('collapsed-table');
      card.classList.add('collapsed');
      // Load data
      try {
        const { data, error, count } = await supabase
          .from(section.key)
          .select('*', { count: 'exact' });
        if (error) throw error;
        let filteredData = data;
        if (section.filter) {
          filteredData = (data || []).filter(section.filter);
        }
        document.getElementById(`count-${section.key}`).textContent = `(${filteredData.length})`;
        if (!filteredData.length) {
          tableContainer.innerHTML = `<div class="empty-state">No ${section.label} data</div>`;
          return;
        }
        // Render table
        let table = `<table class="table-list"><thead><tr>`;
        for (const col of section.columns) {
          table += `<th>${col}</th>`;
        }
        table += `</tr></thead><tbody>`;
        for (const row of filteredData) {
          table += '<tr>';
          for (const col of section.columns) {
            let val = row[col];
            if (typeof val === 'object' && val !== null) val = JSON.stringify(val);
            table += `<td>${val ?? ''}</td>`;
          }
          table += '</tr>';
        }
        table += '</tbody></table>';
        tableContainer.innerHTML = table;
      } catch (e) {
        tableContainer.innerHTML = '<div class="empty-state">Unable to load data</div>';
      }
    }
    // KPIs
    async function loadKpis() {
      try {
        const [activeOrders, invRemoved, lowProducts] = await Promise.all([
          supabase.from('Orders').select('OrderID', { count: 'exact', head: true }),
          supabase.from('Orders').select('OrderID', { count: 'exact', head: true }).eq('InventoryRemoved', true),
          supabase.from('Products').select('ProductSKU', { count: 'exact', head: true }).lt('Quantity', 20),
        ]);
        document.getElementById('kpi-active-orders').textContent = activeOrders.count ?? 0;
        document.getElementById('kpi-inv-removed').textContent = invRemoved.count ?? 0;
        document.getElementById('kpi-low-products').textContent = lowProducts.count ?? 0;
        document.getElementById('kpi-active-sub').textContent = 'Across all platforms';
      } catch (e) {
        // Best-effort: leave defaults
      }
    }

    // Chart removed: orders trend now linked to Analytics page
    async function renderLowInventorySection() {
      const container = document.getElementById('adminSections');
      // Products low inventory
      const prodCard = document.createElement('div');
      prodCard.className = 'section-card';
      prodCard.innerHTML = `
        <div class="section-header" id="header-ProductsLow">
          <span><span class="collapse-arrow">&#9654;</span><span class="section-title">Products Low Inventory</span><span class="row-count" id="count-ProductsLow"></span></span>
        </div>
        <div class="table-container" id="table-ProductsLow">
          <div class="loading-state"><div class="loading-spinner"></div>Loading...</div>
        </div>
      `;
      container.appendChild(prodCard);
      let collapsed = true;
      const header = prodCard.querySelector('.section-header');
      const tableContainer = prodCard.querySelector('.table-container');
      header.addEventListener('click', () => {
        collapsed = !collapsed;
        if (collapsed) {
          tableContainer.classList.add('collapsed-table');
          prodCard.classList.add('collapsed');
        } else {
          tableContainer.classList.remove('collapsed-table');
          prodCard.classList.remove('collapsed');
        }
      });
      tableContainer.classList.add('collapsed-table');
      prodCard.classList.add('collapsed');
      try {
        const { data, error } = await supabase
          .from('Products')
          .select('*')
          .lt('Quantity', 20);
        if (error) throw error;
        document.getElementById('count-ProductsLow').textContent = `(${data.length})`;
        if (!data.length) {
          tableContainer.innerHTML = '<div class="empty-state">No low inventory products</div>';
          return;
        }
        let table = `<table class="table-list"><thead><tr><th>ProductSKU</th><th>Name</th><th>Quantity</th></tr></thead><tbody>`;
        for (const row of data) {
          table += `<tr><td>${row.ProductSKU}</td><td>${row.Name}</td><td>${row.Quantity}</td></tr>`;
        }
        table += '</tbody></table>';
        tableContainer.innerHTML = table;
      } catch (e) {
        tableContainer.innerHTML = '<div class="empty-state">Unable to load data</div>';
      }
      // Ingredients low inventory
      const ingCard = document.createElement('div');
      ingCard.className = 'section-card';
      ingCard.innerHTML = `
        <div class="section-header" id="header-IngredientsLow">
          <span><span class="collapse-arrow">&#9654;</span><span class="section-title">Ingredients Low Inventory</span><span class="row-count" id="count-IngredientsLow"></span></span>
        </div>
        <div class="table-container" id="table-IngredientsLow">
          <div class="loading-state"><div class="loading-spinner"></div>Loading...</div>
        </div>
      `;
      container.appendChild(ingCard);
      let ingCollapsed = true;
      const ingHeader = ingCard.querySelector('.section-header');
      const ingTableContainer = ingCard.querySelector('.table-container');
      ingHeader.addEventListener('click', () => {
        ingCollapsed = !ingCollapsed;
        if (ingCollapsed) {
          ingTableContainer.classList.add('collapsed-table');
          ingCard.classList.add('collapsed');
        } else {
          ingTableContainer.classList.remove('collapsed-table');
          ingCard.classList.remove('collapsed');
        }
      });
      ingTableContainer.classList.add('collapsed-table');
      ingCard.classList.add('collapsed');
      try {
        const { data, error } = await supabase
          .from('Ingredients')
          .select('*');
        if (error) throw error;
        // Filter for Quantity < LowInvThreshold
        const lowInv = (data || []).filter(row => row.Quantity < row.LowInvThreshold);
        document.getElementById('count-IngredientsLow').textContent = `(${lowInv.length})`;
        if (!lowInv.length) {
          ingTableContainer.innerHTML = '<div class="empty-state">No low inventory ingredients</div>';
          return;
        }
        let table = `<table class="table-list"><thead><tr><th>IngredientSKU</th><th>Name</th><th>Quantity</th><th>Unit</th><th>Threshold</th></tr></thead><tbody>`;
        for (const row of lowInv) {
          table += `<tr><td>${row.IngredientSKU}</td><td>${row.Name}</td><td>${row.Quantity}</td><td>${row.Unit || 'lb'}</td><td>${row.LowInvThreshold}</td></tr>`;
        }
        table += '</tbody></table>';
        ingTableContainer.innerHTML = table;
      } catch (e) {
        ingTableContainer.innerHTML = '<div class="empty-state">Unable to load data</div>';
      }
    }
    // Notification banners
    function ensureBannerContainer() {
      let bannerContainer = document.getElementById('banner-container');
      if (!bannerContainer) {
        bannerContainer = document.createElement('div');
        bannerContainer.id = 'banner-container';
        const dash = document.querySelector('.dashboard-container');
        if (dash) {
          dash.prepend(bannerContainer);
        } else {
          document.body.prepend(bannerContainer);
        }
      }
      return bannerContainer;
    }

    function createBanner(text, tone = 'warning', id = '') {
      const bannerContainer = ensureBannerContainer();
      let banner = id ? document.getElementById(id) : null;
      if (!banner) {
        banner = document.createElement('div');
        if (id) banner.id = id;
        banner.className = `alert-banner ${tone}`;
        const iconSpan = document.createElement('span');
        iconSpan.className = 'icon';
        iconSpan.innerHTML = tone === 'info' ? '&#9432;' : tone === 'success' ? '&#10003;' : '&#9888;';
        const textSpan = document.createElement('span');
        textSpan.className = 'text';
        const closeBtn = document.createElement('button');
        closeBtn.className = 'close-btn';
        closeBtn.type = 'button';
        closeBtn.innerHTML = '&times;';
        closeBtn.onclick = () => banner.remove();
        banner.appendChild(iconSpan);
        banner.appendChild(textSpan);
        banner.appendChild(closeBtn);
        bannerContainer.appendChild(banner);
      }
      const textSpan = banner.querySelector('.text');
      if (textSpan) textSpan.textContent = text;
      return banner;
    }

    function showTasksToReviewBanner(count) {
      createBanner(`You have ${count} task(s) awaiting your confirmation in the checklist.`, 'warning', 'tasksToReviewBanner');
    }
    async function warnIfTasksToReview() {
      const currentUserDisplayName = window.CurrentUserDisplayName || '';
      const { data, error } = await supabase
        .from('Checklist')
        .select('*')
        .eq('AssignedBy', currentUserDisplayName)
        .eq('Status', 'Awaiting Confirmation');
      if (error) return;
      if ((data || []).length > 0) {
        showTasksToReviewBanner(data.length);
      }
    }
    async function Alerts() {
      const currentUserDisplayName = window.CurrentUserDisplayName || '';
      const { data, error } = await supabase
        .from('Users')
        .select('Alerts')
        .eq('display_name', currentUserDisplayName);
      if (error) return;
      for (const i of data) {
        if (i.Alerts) {
          let alertsArr = Array.isArray(i.Alerts) ? i.Alerts : [i.Alerts];
          for (let idx = 0; idx < alertsArr.length; idx++) {
            const alertText = alertsArr[idx];
            if (alertText && typeof alertText === 'string') {
              const alertBanner = createBanner(alertText, 'info');
              // Override close handler to persist dismissal
              const closeBtn = alertBanner.querySelector('.close-btn');
              if (closeBtn) {
                closeBtn.onclick = async function() {
                  alertBanner.remove();
                  alertsArr.splice(idx, 1);
                  await supabase
                    .from('Users')
                    .update({ Alerts: alertsArr })
                    .eq('display_name', currentUserDisplayName);
                };
              }
            }
          }
        }
      }
    }
  </script>
</body>
</html>