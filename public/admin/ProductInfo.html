<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Info</title>
  <link rel="icon" type="image/x-icon" href="/Assets/favicon.ico">
  <link rel="stylesheet" href="https://unpkg.com/@coreui/icons/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #c1de9f 0%, #4dba93 100%);
      min-height: 100vh;
      color: #333;
      margin: 0;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .product-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
      padding: 32px 24px;
      max-width: 80%;
      width: 100%;
      text-align: center;
    }
    .product-title {
      font-size: 2rem;
      font-weight: 700;
      color: #4DBA93;
      margin-bottom: 12px;
    }
    .product-sku {
      font-size: 1.1rem;
      color: #888;
      margin-bottom: 18px;
    }
    .product-details {
      font-size: 1rem;
      color: #333;
      margin-bottom: 10px;
    }
    .error {
      color: #e74c3c;
      font-weight: 600;
      margin-top: 20px;
    }
    .collapsible-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-top: 2em;
      margin-bottom: 0.5em;
      font-weight: 600;
      color: #4DBA93;
      transition: background 0.2s;
    }
    .collapsible-header:hover {
      background: #e9ecef;
    }
    .collapsible-icon {
      transition: transform 0.3s;
      font-size: 1.2rem;
    }
    .collapsible-icon.open {
      transform: rotate(180deg);
    }
    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    .collapsible-content.open {
      max-height: 2000px;
      transition: max-height 0.5s ease-in;
    }
    .file-upload-section {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 16px;
      margin-top: 10px;
    }
    .file-input-wrapper {
      margin-bottom: 12px;
    }
    .file-input {
      display: block;
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.95rem;
    }
    .upload-btn {
      background: #4DBA93;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      transition: background 0.2s;
    }
    .upload-btn:hover {
      background: #3da87f;
    }
    .upload-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .file-list {
      margin-top: 16px;
    }
    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: white;
      border-radius: 4px;
      margin-bottom: 8px;
      border: 1px solid #e2e8f0;
      gap: 12px;
    }
    .file-preview {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid #e2e8f0;
    }
    .file-info {
      flex: 1;
      text-align: left;
      min-width: 0;
    }
    .file-name {
      color: #333;
      font-size: 0.95rem;
      word-break: break-word;
    }
    .file-actions {
      display: flex;
      gap: 8px;
    }
    .download-btn, .delete-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: opacity 0.2s;
    }
    .download-btn {
      background: #4DBA93;
      color: white;
    }
    .download-btn:hover {
      opacity: 0.8;
    }
    .delete-btn {
      background: #e74c3c;
      color: white;
    }
    .delete-btn:hover {
      opacity: 0.8;
    }
    .upload-status {
      margin-top: 8px;
      font-size: 0.9rem;
      color: #4DBA93;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <script src="/Assets/CheckAccess.js"></script>
</head>
<body>
  <div class="product-container" id="productContainer">
    <div class="product-title">Product Info</div>
    <div class="product-sku" id="skuDisplay"></div>
    <div class="product-details" id="productDetails">Loading...</div>
  </div>
  <script>
    // Access control and inactivity timeout
    checkPermissions(['service_role', 'employee']);
    
    // Get SKU from URL
    function getSKUFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get('sku');
    }

    async function loadProductInfo(sku) {
      document.getElementById('skuDisplay').textContent = `SKU: ${sku}`;
      const detailsDiv = document.getElementById('productDetails');
      detailsDiv.textContent = 'Loading...';
      try {
        // Query Supabase for product info by SKU
        const { data, error } = await supabase
          .from('Products')
          .select('*')
          .eq('ProductSKU', sku)
          .single();
        if (error || !data) {
          detailsDiv.innerHTML = `<span class='error'>Product not found for SKU: ${sku}</span>`;
          return;
        }
        // Display all product info fields
        let html = '';
        html += '<table style="width:100%;margin:auto;text-align:left;font-size:1rem;">';
        const hiddenFields = [
          'UserID', 'Process'
        ];
        for (const key in data) {
          if (hiddenFields.includes(key)) continue;
          let value = data[key];
          if (Array.isArray(value)) {
            value = value.length ? value.map(v => `<span style='background:#f8f9fa;border-radius:4px;padding:2px 6px;margin:2px;'>${v}</span>`).join(' ') : '[]';
          } else if (typeof value === 'object' && value !== null) {
            value = `<pre style='background:#f8f9fa;border-radius:4px;padding:6px;'>${JSON.stringify(value, null, 2)}</pre>`;
          } else if (value === null || value === undefined || value === '') {
            value = '<span style="color:#888;">N/A</span>';
          }
          html += `<tr><td style='font-weight:600;padding:6px 10px;'>${key}</td><td style='padding:6px 10px;'>${value}</td></tr>`;
        }
        // Add Faire Inventory row (async fetch)
        html += `<tr><td style='font-weight:600;padding:6px 10px;'>Faire Inventory</td><td style='padding:6px 10px;' id='faire-inv-cell'>Loading...</td></tr>`;
        html += '</table>';

        // Add Manufacturing Steps section if it exists
        if (data.Process) {
          html += `<div style='margin-top:2em;'>`;
          html += `<div class='collapsible-header' onclick='toggleCollapsible(this)'>`;
          html += `<span style='font-weight:600;color:#4DBA93;'>Manufacturing Steps</span>`;
          html += `<span class='collapsible-icon'>▼</span>`;
          html += `</div>`;
          html += `<div class='collapsible-content'>`;
          
          let steps = null;
          try {
            steps = typeof data.Process === 'string' ? JSON.parse(data.Process) : data.Process;
          } catch (e) {
            html += `<div style='color:#e74c3c;padding:10px;'>Error parsing manufacturing steps</div>`;
          }
          
          if (steps && steps.Steps && Array.isArray(steps.Steps)) {
            html += `<div style='background:#f8f9fa;border-radius:8px;padding:16px;'>`;
            steps.Steps.forEach((step, index) => {
              html += `<div style='margin-bottom:16px;${index > 0 ? 'border-top:1px solid #e2e8f0;padding-top:16px;' : ''}'>`;
              html += `<h4 style='margin:0 0 8px 0;color:#4DBA93;'>${step['Step Title'] || `Step ${index + 1}`}</h4>`;
              
              if (step['Step Instructions']) {
                html += `<p style='margin:0 0 8px 0;color:#666;'><strong>Instructions:</strong> ${step['Step Instructions']}</p>`;
              }
              
              if (step['Step Duration (Minutes)'] !== undefined && step['Step Duration (Minutes)'] !== null) {
                html += `<p style='margin:0 0 8px 0;color:#666;'><strong>Duration:</strong> ${step['Step Duration (Minutes)']} minutes</p>`;
              }
              
              if (step['Step Ingredients'] && Array.isArray(step['Step Ingredients']) && step['Step Ingredients'].length > 0) {
                html += `<div style='margin-top:8px;'><strong>Ingredients:</strong></div>`;
                html += `<ul style='margin:4px 0 0 20px;'>`;
                step['Step Ingredients'].forEach(ing => {
                  const unitStr = ing.Unit ? ` ${ing.Unit}` : '';
                  const scopeStr = ing.Scope ? ` (${ing.Scope})` : '';
                  html += `<li style='margin:2px 0;'>${ing.SKU}: ${ing.Quantity}${unitStr}${scopeStr}</li>`;
                });
                html += `</ul>`;
              }
              
              html += `</div>`;
            });
            html += `</div>`;
          } else {
            html += `<div style='color:#888;padding:10px;'>No manufacturing steps defined</div>`;
          }
          
          html += `</div>`; // close collapsible-content
          html += `</div>`; // close container
        }

        // Add File Management section
        html += `<div style='margin-top:2em;'>`;
        html += `<div class='collapsible-header' onclick='toggleCollapsible(this)'>`;
        html += `<span style='font-weight:600;color:#4DBA93;'>Product Files</span>`;
        html += `<span class='collapsible-icon'>▼</span>`;
        html += `</div>`;
        html += `<div class='collapsible-content'>`;
        html += `<div class='file-upload-section'>`;
        html += `<div class='file-input-wrapper'>`;
        html += `<input type='file' id='fileInput' class='file-input' multiple>`;
        html += `</div>`;
        html += `<button onclick='uploadFiles()' class='upload-btn' id='uploadBtn'>Upload Files</button>`;
        html += `<div id='uploadStatus' class='upload-status'></div>`;
        html += `<div class='file-list' id='fileList'>Loading files...</div>`;
        html += `</div>`;
        html += `</div>`; // close collapsible-content
        html += `</div>`; // close container

        // Render table immediately so user sees loading state
        detailsDiv.innerHTML = html;

        // Fetch Faire inventory for this SKU
        (async () => {
          try {
            const faireRes = await fetch('/.netlify/functions/faire-get-inventory', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ skus: [sku] })
            });
            let faireInv = '';
            if (faireRes.ok) {
              const faireData = await faireRes.json();
              faireInv = faireData && typeof faireData[sku] !== 'undefined' ? faireData[sku] : '';
            } else {
              faireInv = '—';
            }
            document.getElementById('faire-inv-cell').textContent = (faireInv !== '' && faireInv !== undefined) ? faireInv : '—';
          } catch (e) {
            document.getElementById('faire-inv-cell').textContent = '—';
          }
        })();

        // Fetch inventory update logs for this SKU
        (async () => {
          let logsHtml = '';
          try {
            const { data: logs, error: logsError } = await supabase
              .from('inventoryupdatelogs')
              .select('created_at,log,updated_by')
              .eq('SKU', sku)
              .order('created_at', { ascending: false })
            if (logs && logs.length) {
              logsHtml += `<div style='margin-top:2em;'>`;
              logsHtml += `<div class='collapsible-header' onclick='toggleCollapsible(this)'>`;
              logsHtml += `<span style='font-weight:600;color:#4DBA93;'>Recent Inventory Updates</span>`;
              logsHtml += `<span class='collapsible-icon'>▼</span>`;
              logsHtml += `</div>`;
              logsHtml += `<div class='collapsible-content'>`;
              logsHtml += `<table style='width:100%;font-size:0.97em;background:#f8f9fa;border-radius:8px;'><thead><tr><th style='padding:6px 10px;text-align:left;'>Time</th><th style='padding:6px 10px;text-align:left;'>User</th><th style='padding:6px 10px;text-align:left;'>Message</th></tr></thead><tbody>`;
              for (const log of logs) {
                logsHtml += `<tr><td style='padding:6px 10px;'>${new Date(log.created_at).toLocaleString()}</td><td style='padding:6px 10px;'>${log.updated_by || ''}</td><td style='padding:6px 10px;'>${log.log}</td></tr>`;
              }
              logsHtml += '</tbody></table>';
              logsHtml += `</div>`; // close collapsible-content
              logsHtml += `</div>`; // close container
            } else {
              logsHtml += `<div style='margin-top:2em;color:#888;'>No inventory update logs found for this SKU.</div>`;
            }
          } catch (logErr) {
            logsHtml += `<div class='error'>Error loading inventory update logs.</div>`;
          }
          detailsDiv.insertAdjacentHTML('beforeend', logsHtml);
        })();

        // Load files for this SKU
        loadFiles(sku);

        // Fetch order history for this SKU using new schema
        (async () => {
          let ordersHtml = '';
          try {
            // Query the new table and filter for this SKU in Items JSONB
            const { data: orders, error: ordersError } = await supabase
              .from('Order History')
              .select('OrderID,ShippedAt,Items,Customer,Platform,Retailer,Link,ShippingCost,Notes')
              .order('ShippedAt', { ascending: false });
            let filteredOrders = [];
            if (orders && Array.isArray(orders)) {
              filteredOrders = orders.filter(order => {
                if (!order.Items) return false;
                let itemsArr = [];
                if (typeof order.Items === 'string') {
                  try { itemsArr = JSON.parse(order.Items); } catch { return false; }
                } else if (Array.isArray(order.Items)) {
                  itemsArr = order.Items;
                }
                return itemsArr.some(item => item.sku === sku);
              });
            }
            if (filteredOrders.length) {
              ordersHtml += `<div style='margin-top:2em;margin-bottom:0.5em;font-weight:600;color:#4DBA93;'>Order History</div>`;
              ordersHtml += `<table style='width:100%;font-size:0.97em;background:#f8f9fa;border-radius:8px;'><thead><tr><th style='padding:6px 10px;text-align:left;'>Shipped</th><th style='padding:6px 10px;text-align:left;'>Order ID</th><th style='padding:6px 10px;text-align:left;'>Platform</th><th style='padding:6px 10px;text-align:left;'>Qty</th><th style='padding:6px 10px;text-align:left;'>Link</th></tr></thead><tbody>`;
              for (const order of filteredOrders) {
                // Find quantity for this SKU in Items
                let qty = '';
                let itemsArr = [];
                if (typeof order.Items === 'string') {
                  try { itemsArr = JSON.parse(order.Items); } catch { itemsArr = []; }
                } else if (Array.isArray(order.Items)) {
                  itemsArr = order.Items;
                }
                const found = itemsArr.find(item => item.sku === sku);
                qty = found ? (found.quantity || '') : '';
                ordersHtml += `<tr><td style='padding:6px 10px;'>${order.ShippedAt ? new Date(order.ShippedAt).toLocaleString() : ''}</td><td style='padding:6px 10px;'>${order.OrderID || ''}</td><td style='padding:6px 10px;'>${order.Platform || ''}</td><td style='padding:6px 10px;'>${qty}</td><td style='padding:6px 10px;'>${order.Link ? `<a href='${order.Link}' target='_blank'>View</a>` : ''}</td></tr>`;
              }
              ordersHtml += '</tbody></table>';
            } else {
              ordersHtml += `<div style='margin-top:2em;color:#888;'>No order history found for this SKU.</div>`;
            }
          } catch (ordersErr) {
            ordersHtml += `<div class='error'>Error loading order history.</div>`;
          }
          detailsDiv.insertAdjacentHTML('beforeend', ordersHtml);
        })();
      } catch (err) {
        detailsDiv.innerHTML = `<span class='error'>Error loading product info: ${err.message}</span>`;
      }
    }

    const sku = getSKUFromURL();
    if (sku) {
      loadProductInfo(sku);
    } else {
      document.getElementById('skuDisplay').textContent = '';
      document.getElementById('productDetails').innerHTML = `<span class='error'>No SKU provided in URL.</span>`;
    }

    // Toggle collapsible sections
    function toggleCollapsible(headerElement) {
      const icon = headerElement.querySelector('.collapsible-icon');
      const content = headerElement.nextElementSibling;
      
      if (content && content.classList.contains('collapsible-content')) {
        icon.classList.toggle('open');
        content.classList.toggle('open');
      }
    }

    // File management functions
    let currentSKU = null;

    async function loadFiles(sku) {
      currentSKU = sku;
      const fileListDiv = document.getElementById('fileList');
      fileListDiv.innerHTML = 'Loading files...';
      
      try {
        // List files in the SKU folder
        const { data: files, error } = await supabase.storage
          .from('productimages')
          .list(sku);
        
        if (error && error.message.includes('not found')) {
          // Folder doesn't exist yet
          fileListDiv.innerHTML = '<div style="color:#888;text-align:left;">No files uploaded yet</div>';
          return;
        }
        
        if (error) {
          fileListDiv.innerHTML = `<div class='error'>Error loading files: ${error.message}</div>`;
          return;
        }
        
        if (!files || files.length === 0) {
          fileListDiv.innerHTML = '<div style="color:#888;text-align:left;">No files uploaded yet</div>';
          return;
        }
        
        // Display files
        let filesHtml = '';
        for (const file of files) {
          if (file.name === '.emptyFolderPlaceholder') continue; // Skip placeholder
          
          // Get public URL for image preview
          const { data: urlData } = await supabase.storage
            .from('productimages')
            .getPublicUrl(`${sku}/${file.name}`);
          
          filesHtml += `<div class='file-item'>`;
          if (urlData && urlData.publicUrl) {
            filesHtml += `<img src='${urlData.publicUrl}' class='file-preview' alt='${file.name}' onerror="this.style.display='none'">`;
          }
          filesHtml += `<div class='file-info'>`;
          filesHtml += `<div class='file-name'>${file.name}</div>`;
          filesHtml += `</div>`;
          filesHtml += `<div class='file-actions'>`;
          filesHtml += `<button class='download-btn' onclick='downloadFile("${file.name}")'>Download</button>`;
          filesHtml += `<button class='delete-btn' onclick='deleteFile("${file.name}")'>Delete</button>`;
          filesHtml += `</div>`;
          filesHtml += `</div>`;
        }
        fileListDiv.innerHTML = filesHtml || '<div style="color:#888;text-align:left;">No files uploaded yet</div>';
      } catch (err) {
        fileListDiv.innerHTML = `<div class='error'>Error: ${err.message}</div>`;
      }
    }

    async function uploadFiles() {
      const fileInput = document.getElementById('fileInput');
      const uploadBtn = document.getElementById('uploadBtn');
      const statusDiv = document.getElementById('uploadStatus');
      
      if (!fileInput.files || fileInput.files.length === 0) {
        statusDiv.textContent = 'Please select files to upload';
        statusDiv.style.color = '#e74c3c';
        return;
      }
      
      uploadBtn.disabled = true;
      statusDiv.textContent = 'Uploading...';
      statusDiv.style.color = '#4DBA93';
      
      try {
        // Upload each file to the SKU folder
        for (const file of fileInput.files) {
          const filePath = `${currentSKU}/${file.name}`;
          const { error } = await supabase.storage
            .from('productimages')
            .upload(filePath, file, {
              upsert: true // Overwrite if exists
            });
          
          if (error) {
            throw error;
          }
        }
        
        statusDiv.textContent = `Successfully uploaded ${fileInput.files.length} file(s)`;
        fileInput.value = ''; // Clear input
        
        // Reload file list
        await loadFiles(currentSKU);
        
        setTimeout(() => {
          statusDiv.textContent = '';
        }, 3000);
      } catch (err) {
        statusDiv.textContent = `Upload failed: ${err.message}`;
        statusDiv.style.color = '#e74c3c';
      } finally {
        uploadBtn.disabled = false;
      }
    }

    async function downloadFile(fileName) {
      try {
        const filePath = `${currentSKU}/${fileName}`;
        const { data, error } = await supabase.storage
          .from('productimages')
          .download(filePath);
        
        if (error) throw error;
        
        // Create download link
        const url = URL.createObjectURL(data);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (err) {
        alert(`Download failed: ${err.message}`);
      }
    }

    async function deleteFile(fileName) {
      if (!confirm(`Are you sure you want to delete ${fileName}?`)) {
        return;
      }
      
      try {
        const filePath = `${currentSKU}/${fileName}`;
        const { error } = await supabase.storage
          .from('productimages')
          .remove([filePath]);
        
        if (error) throw error;
        
        // Reload file list
        await loadFiles(currentSKU);
      } catch (err) {
        alert(`Delete failed: ${err.message}`);
      }
    }
  </script>
</body>
</html>