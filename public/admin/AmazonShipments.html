<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amazon Shipments Viewer</title>
  <link rel="stylesheet" href="https://unpkg.com/@coreui/icons/css/all.min.css">
  <link rel="stylesheet" href="/Assets/sidebar.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #c1de9f 0%, #4dba93 100%);
      min-height: 100vh;
      color: #333;
      margin: 0;
      padding: 0;
      display: flex;
    }
    
    .main-content {
      margin-left: 60px;
      transition: margin-left 0.3s ease;
      width: calc(100% - 60px);
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      color: indigo;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }
    
    .controls {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn {
      background: #4DBA93;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .search-box {
      flex: 1;
      min-width: 300px;
    }

    .search-box input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }

    .search-box input:focus {
      outline: none;
      border-color: #4DBA93;
    }

    .filter-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .filter-controls select {
      padding: 8px 12px;
      border: 2px solid #e1e5e9;
      border-radius: 6px;
      font-size: 14px;
    }

    .status {
      margin: 20px 0;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
    }

    .loading {
      color: #4DBA93;
      font-weight: 600;
    }

    .error {
      color: #e74c3c;
      font-weight: 600;
    }

    .success {
      color: #27ae60;
      font-weight: 600;
    }

    .shipments-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .shipments-summary {
      padding: 15px 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #e1e5e9;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .summary-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .shipments-table {
      width: 100%;
      border-collapse: collapse;
    }

    .shipments-table th,
    .shipments-table td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #e1e5e9;
    }

    .shipments-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #2c3e50;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .shipments-table tr:hover {
      background: #f8f9fa;
    }

    .sku-link {
      color: #4DBA93;
      text-decoration: none;
      font-weight: 500;
      font-family: 'Courier New', monospace;
    }

    .sku-link:hover {
      text-decoration: underline;
    }

    .quantity-badge {
      background: #c1de9f;
      color: #2c3e50;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.9rem;
      font-weight: 600;
      min-width: 40px;
      text-align: center;
    }

    .notes-cell {
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .notes-cell:hover {
      white-space: normal;
      word-wrap: break-word;
    }

    .user-name {
      font-weight: 500;
      color: #2c3e50;
    }

    .no-shipments {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .no-shipments h3 {
      margin-bottom: 10px;
      color: #2c3e50;
    }

    .action-buttons {
      background: white;
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: center;
    }

    .action-btn {
      background: #BA4D74;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .action-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }

    .action-btn.danger {
      background: #e74c3c;
    }

    .action-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .checkbox-cell {
      width: 40px;
      text-align: center;
    }

    .shipment-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .selected-row {
      background: #e8f5e8 !important;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 20px;
      border-radius: 12px;
      width: 80%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 2px solid #e1e5e9;
      padding-bottom: 15px;
    }

    .modal-header h2 {
      color: #2c3e50;
      margin: 0;
    }

    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
    }

    .close:hover {
      color: #000;
    }

    .box-selection {
      margin-bottom: 20px;
    }

    .box-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      margin-bottom: 10px;
      background: #f8f9fa;
    }

    .box-item.selected {
      border-color: #4DBA93;
      background: #e8f5e8;
    }

    .box-info {
      flex: 1;
    }

    .box-sku {
      font-weight: 600;
      color: #2c3e50;
      font-family: 'Courier New', monospace;
    }

    .box-dimensions {
      color: #666;
      font-size: 0.9rem;
    }

    .box-quantity {
      color: #4DBA93;
      font-weight: 600;
    }

    .quantity-input {
      width: 80px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      text-align: center;
    }

    .process-summary {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <script src="/Assets/CheckAccess.js"></script>
  <link rel="icon" type="image/x-icon" href="/Assets/favicon.ico">
</head>
<body>
  <!-- Sidebar -->
  <div id="sidebar"></div>
  <script src="/Assets/sidebar.js"></script>
  
  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <div class="container">
      <div class="header">
        <h1>Amazon Shipments Viewer</h1>
        <p>View and manage Amazon shipment orders</p>
      </div>
      <div id="removalLogs" style="display:none;margin-bottom:20px;padding:16px;background:#f8f9fa;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.07);color:#2c3e50;font-size:1.08em;"></div>

      <div class="controls">
        <button class="btn" onclick="loadShipments()" id="refreshBtn">
          üîÑ Refresh Shipments
        </button>
        
        <button class="btn" onclick="processAmazonShipments()" id="processBtn" style="background: #BA4D74;">
          üì¶ Process Shipments
        </button>
        
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Search by SKU, user name, or notes..." 
                 oninput="filterShipments()">
        </div>
        
        <div class="filter-controls">
          <select id="userFilter" onchange="filterShipments()">
            <option value="">All Users</option>
          </select>
        </div>
      </div>

      <div class="status" id="statusDiv" style="display: none;"></div>

      <div class="action-buttons" id="actionButtons" style="display: none;">
        <span style="font-weight: 600; color: #2c3e50;">Selected Shipments:</span>
        <span id="selectedCount" style="font-weight: 600; color: #4DBA93;">0</span>
        <button title="Print Picklist for Selected Shipments" class="action-btn" onclick="printPicklist()" id="picklistBtn" style="background: #7c3aed;">
          <i class="cil-print"></i> Print Picklist
        </button>
        <button title="Delete Selected Shipments" class="action-btn danger" onclick="deleteSelectedShipments()" id="deleteBtn">
          <i class="cil-trash"></i>
        </button>
      </div>

      <div class="shipments-container">
        <div class="shipments-summary" id="shipmentsSummary" style="display: none;">
          <div class="summary-item">
            <span>Total Shipments: <strong id="totalShipments">0</strong></span>
          </div>
          <div class="summary-item">
            <span>Total Quantity: <strong id="totalQuantity">0</strong></span>
          </div>
          <div class="summary-item">
            <span>Unique SKUs: <strong id="uniqueSKUs">0</strong></span>
          </div>
        </div>

        <div id="shipmentsTableContainer">
          <div class="no-shipments">
            <h3>Ready to load shipments</h3>
            <p>Click "Refresh Shipments" to load Amazon shipment orders</p>
          </div>
        </div>
        <!-- Collapsible Completed Shipments Table (moved below main table) -->
        <div id="completedShipmentsSection" style="margin-top:32px;">
          <div style="display:flex;align-items:center;cursor:pointer;gap:10px;background:#f8f9fa;padding:12px 18px;border-radius:8px 8px 0 0;user-select:none;" onclick="toggleCompletedShipments()">
            <span id="completedCollapseArrow" style="font-size:1.3em;font-weight:bold;">&#9654;</span>
            <span style="font-size:1.1em;font-weight:600;color:#2c3e50;">Completed Shipments</span>
            <span id="completedCount" style="margin-left:8px;color:#4DBA93;font-weight:600;"></span>
          </div>
          <div id="completedShipmentsTableContainer" style="display:none;border:1px solid #e1e5e9;border-top:none;border-radius:0 0 8px 8px;overflow-x:auto;background:white;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Box Selection Modal -->
  <div id="boxModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Select Boxes for Amazon Shipments</h2>
        <span class="close" onclick="closeBoxModal()">&times;</span>
      </div>
      
      <div class="process-summary" id="processSummary">
        <!-- Summary will be populated by JavaScript -->
      </div>
      
      <div class="box-selection" id="boxSelection">
        <!-- Box options will be populated by JavaScript -->
      </div>
      
      <div style="text-align: center; margin-top: 20px;">
        <button class="btn" onclick="submitProcessing()" id="submitProcessBtn">
          üìã Send to Inventory Updater(This will remove Products from Inventory)
        </button>
        <button class="btn" onclick="closeBoxModal()" style="background: #666; margin-left: 10px;">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <script>
    // Collapsible Completed Shipments Table logic
    function renderCompletedShipmentsTable() {
      const completedShipments = allShipments.filter(s => s.Status === 'Completed');
      const completedCount = completedShipments.length;
      document.getElementById('completedCount').textContent = completedCount > 0 ? `(${completedCount})` : '';
      const container = document.getElementById('completedShipmentsTableContainer');
      if (completedCount === 0) {
        container.innerHTML = `<div class=\"no-shipments\"><h3>No completed shipments</h3></div>`;
        return;
      }
      container.innerHTML = `
        <table class=\"shipments-table\">
          <thead>
            <tr>
              <th>ID</th>
              <th>Request Date</th>
              <th>Items</th>
              <th>User</th>
              <th>Notes</th>
              <th>Boxes</th>
            </tr>
          </thead>
          <tbody>
            ${completedShipments.map(shipment => {
              // Format Items column for completed shipments
              let itemsHtml = '';
              if (shipment.Items && Array.isArray(shipment.Items)) {
                itemsHtml = shipment.Items.map(item => `${item.sku} √ó ${item.quantity}`).join(', ');
              } else {
                itemsHtml = 'No items';
              }
              
              return `
              <tr>
                <td><strong>#${shipment.id}</strong></td>
                <td>${formatRequestDate(shipment.RequestDate)}</td>
                <td>${itemsHtml}</td>
                <td>${shipment.display_name || 'Unknown User'}</td>
                <td class=\"notes-cell\" title=\"${shipment.Notes || ''}\">${shipment.Notes || '<em style=\"color: #999;\">No notes</em>'}</td>
                <td>
                  ${Array.isArray(shipment.Boxes) && shipment.Boxes.length > 0 ?
                    shipment.Boxes.map(boxObj => {
                      if (boxObj && typeof boxObj === 'object' && boxObj.sku) {
                        return `${boxObj.sku} (${boxObj.quantity || 1})`;
                      }
                      return '';
                    }).filter(Boolean).join(', ')
                    : '<em style="color: #999;">None</em>'}
                </td>
              </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
    }

    // Toggle completed shipments section
    window.toggleCompletedShipments = function() {
      const container = document.getElementById('completedShipmentsTableContainer');
      const arrow = document.getElementById('completedCollapseArrow');
      const isOpen = container.style.display === '';
      container.style.display = isOpen ? 'none' : '';
      arrow.innerHTML = isOpen ? '&#9654;' : '&#9660;';
    }
    // Access control and inactivity timeout
    checkPermissions(['service_role','employee']);
    

    let allShipments = [];
    let filteredShipments = [];
    let selectedShipments = new Set();
    let availableBoxes = [];
    let selectedBoxes = {};

    function showStatus(message, type = 'loading') {
      const statusDiv = document.getElementById('statusDiv');
      statusDiv.style.display = 'block';
      statusDiv.className = `status ${type}`;
      statusDiv.textContent = message;
    }

    function hideStatus() {
      document.getElementById('statusDiv').style.display = 'none';
    }

    async function processAmazonShipments() {
      if (selectedShipments.size === 0) {
        alert('Please select at least one shipment to process.');
        return;
      }

      showStatus('Loading available boxes...', 'loading');
      
      try {
        // Load available boxes from Boxes table
        const { data: boxes, error } = await supabase
          .from('Boxes')
          .select('*')
          .order('SKU');

        if (error) {
          throw error;
        }

        availableBoxes = boxes || [];
        hideStatus();
        showBoxSelectionModal();

      } catch (error) {
        console.error('Error loading boxes:', error);
        showStatus(`Error loading boxes: ${error.message}`, 'error');
      }
    }

    function showBoxSelectionModal() {
      const modal = document.getElementById('boxModal');
      const summaryDiv = document.getElementById('processSummary');
      const boxSelectionDiv = document.getElementById('boxSelection');

      // Get selected shipments data
      const selectedShipmentsData = getSelectedShipmentsData();

      // Create summary
      const totalShipments = selectedShipmentsData.length;
      let totalQuantity = 0;
      const uniqueSKUs = new Set();
      
      selectedShipmentsData.forEach(shipment => {
        if (shipment.Items && Array.isArray(shipment.Items)) {
          shipment.Items.forEach(item => {
            totalQuantity += item.quantity || 0;
            if (item.sku) uniqueSKUs.add(item.sku);
          });
        }
      });

      summaryDiv.innerHTML = `
        <h3>Processing Summary</h3>
        <div class="summary-row">
          <span>Total Shipments:</span>
          <strong>${totalShipments}</strong>
        </div>
        <div class="summary-row">
          <span>Total Quantity:</span>
          <strong>${totalQuantity}</strong>
        </div>
        <div class="summary-row">
          <span>Unique SKUs:</span>
          <strong>${uniqueSKUs.size}</strong>
        </div>
      `;

      // Create box selection
      boxSelectionDiv.innerHTML = `
        <h3>Select Boxes and Quantities</h3>
        <p style="margin-bottom: 15px; color: #666;">Choose which boxes to include and specify quantities for each:</p>
        ${availableBoxes.map(box => `
          <div class="box-item" id="box-${box.SKU}" onclick="toggleBoxSelection('${box.SKU}')">
            <div class="box-info">
              <div class="box-sku">${box.SKU}</div>
              <div class="box-dimensions">${box.Dimensions || 'No dimensions'}</div>
              <div class="box-quantity">Available: ${box.Quantity || 0}</div>
            </div>
            <div>
              <input type="number" 
                     class="quantity-input" 
                     id="qty-${box.SKU}" 
                     placeholder="Qty"
                     onclick="event.stopPropagation()"
                     onchange="updateBoxQuantity('${box.SKU}', this.value)">
            </div>
          </div>
        `).join('')}
      `;

      modal.style.display = 'block';
      selectedBoxes = {};
    }

    function toggleBoxSelection(boxSKU) {
      const boxElement = document.getElementById(`box-${boxSKU}`);
      const qtyInput = document.getElementById(`qty-${boxSKU}`);
      
      if (selectedBoxes[boxSKU]) {
        delete selectedBoxes[boxSKU];
        boxElement.classList.remove('selected');
        qtyInput.value = '';
      } else {
        selectedBoxes[boxSKU] = 1;
        boxElement.classList.add('selected');
        qtyInput.value = '1';
      }
    }

    function updateBoxQuantity(boxSKU, quantity) {
      const qty = parseInt(quantity);
      if (qty > 0) {
        selectedBoxes[boxSKU] = qty;
        document.getElementById(`box-${boxSKU}`).classList.add('selected');
      } else {
        delete selectedBoxes[boxSKU];
        document.getElementById(`box-${boxSKU}`).classList.remove('selected');
      }
    }

    function closeBoxModal() {
      document.getElementById('boxModal').style.display = 'none';
      selectedBoxes = {};
    }

    async function submitProcessing() {
      if (Object.keys(selectedBoxes).length === 0) {
        alert('Please select at least one box with a quantity.');
        return;
      }

      const submitBtn = document.getElementById('submitProcessBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = '‚è≥ Processing...';

      try {
        // Capture box removals before closing modal and resetting selectedBoxes
        const boxRemovals = Object.entries(selectedBoxes).map(([boxSKU, quantityUsed]) => ({ boxSKU, quantityUsed }));

        // Update box quantities directly in the database
        await updateBoxQuantities();

        // Update product quantities and log changes
        const selectedShipmentsData = getSelectedShipmentsData();
        let displayName = null;
        if (window.user && window.user.user_metadata && window.user.user_metadata.display_name) {
          displayName = window.user.user_metadata.display_name;
        }
        // Prepare array of box objects for jsonb[] column
        const selectedBoxObjects = Object.entries(selectedBoxes).map(([sku, quantity]) => ({ sku, quantity }));
        
        for (const shipment of selectedShipmentsData) {
          // Get items from shipment
          let items = [];
          if (shipment.Items && Array.isArray(shipment.Items)) {
            items = shipment.Items;
          }
          
          // Process each item in the shipment
          for (const item of items) {
            if (!item.sku || !item.quantity || item.quantity <= 0) continue;
            
            // Update existing product quantity only
            const { data: prod, error: prodErr } = await supabase
              .from('Products')
              .select('Quantity')
              .eq('ProductSKU', item.sku)
              .maybeSingle();
            if (prodErr) throw prodErr;
            if (prod) {
              const newQty = (prod.Quantity || 0) - item.quantity;
              const { error: upErr } = await supabase
                .from('Products')
                .update({ Quantity: newQty })
                .eq('ProductSKU', item.sku);
              if (upErr) throw upErr;
              // Log the inventory update
              const logMsg = `Amazon shipment removed ${item.quantity} SKU ${item.sku}`;
              await supabase
                .from('inventoryupdatelogs')
                .insert({
                  log: logMsg,
                  updated_by: displayName || null,
                  SKU: item.sku,
                  QuantityChanged: -item.quantity
                });
            } else {
              throw new Error(`Product with SKU ${item.sku} does not exist in Products table.`);
            }
          }
          
          // Update the Boxes column for this shipment with array of objects
          await supabase
            .from('AmazonShipments')
            .update({ Boxes: selectedBoxObjects })
            .eq('id', shipment.id);
        }

        // Show removal logs to user
        let logsHtml = '<strong>Removal Logs:</strong><ul style="margin-top:8px;">';
        for (const shipment of selectedShipmentsData) {
          // Get items from shipment
          if (shipment.Items && Array.isArray(shipment.Items)) {
            for (const item of shipment.Items) {
              if (item.sku && item.quantity && item.quantity > 0) {
                logsHtml += `<li>Product: Removed ${item.quantity} from SKU <b>${item.sku}</b></li>`;
              }
            }
          }
        }
        for (const { boxSKU, quantityUsed } of boxRemovals) {
          logsHtml += `<li>Box: Removed ${quantityUsed} from SKU <b>${boxSKU}</b></li>`;
        }
        logsHtml += '</ul>';
        const logsDiv = document.getElementById('removalLogs');
        logsDiv.innerHTML = logsHtml;
        logsDiv.style.display = 'block';
        // Scroll to logs for visibility
        setTimeout(() => {
          logsDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);

        // Close modal
        closeBoxModal();

        // Update status of processed shipments to 'Completed'
        const processedShipmentIds = Array.from(selectedShipments);
        if (processedShipmentIds.length > 0) {
          const { error: statusErr } = await supabase
            .from('AmazonShipments')
            .update({ Status: 'Completed' },{CompletionDate: Date.now()})
            .in('id', processedShipmentIds);
          if (statusErr) {
            console.error('Error updating status:', statusErr);
          }
        }
        allShipments = allShipments.filter(shipment => !processedShipmentIds.includes(shipment.id));
        filteredShipments = filteredShipments.filter(shipment => !processedShipmentIds.includes(shipment.id));
        selectedShipments.clear();

        // Update display
        displayShipments();
        updateSummary();
        populateUserFilter();

        showStatus('Shipments processed, inventory and boxes updated!', 'success');
        setTimeout(hideStatus, 3000);

      } catch (error) {
        console.error('Error processing shipments:', error);
        showStatus(`Error processing shipments: ${error.message}`, 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'üìã Send to Inventory Updater';
      }
    }

    function generateShipmentCSV() {
      // Generate CSV content for selected shipments only
      const selectedShipmentsData = getSelectedShipmentsData();
      const skuMap = new Map();
      
      // Aggregate quantities by SKU for selected shipments
      selectedShipmentsData.forEach(shipment => {
        if (shipment.Items && Array.isArray(shipment.Items)) {
          shipment.Items.forEach(item => {
            if (item.sku) {
              const currentQty = skuMap.get(item.sku) || 0;
              skuMap.set(item.sku, currentQty + (item.quantity || 0));
            }
          });
        }
      });
      
      // Create CSV lines
      const csvLines = ['SKU,Product Name,Quantity'];
      skuMap.forEach((quantity, sku) => {
        // For Amazon shipments, we might not have product names, so use SKU as name
        const productName = sku; // You could enhance this by looking up product names from a Products table
        const escapedName = productName.includes(',') || productName.includes('"') 
          ? `"${productName.replace(/"/g, '""')}"` 
          : productName;
        csvLines.push(`${sku},${escapedName},${quantity}`);
      });
      
      return csvLines.join('\n');
    }

    async function updateBoxQuantities() {
      // Update box quantities directly in the Boxes table
      for (const [boxSKU, quantityUsed] of Object.entries(selectedBoxes)) {
        const box = availableBoxes.find(b => b.SKU === boxSKU);
        if (box) {
          const newQuantity = (box.Quantity || 0) - quantityUsed;
          
          const { error } = await supabase
            .from('Boxes')
            .update({ Quantity: newQuantity }) // Allow negative quantities
            .eq('SKU', boxSKU);
            
          if (error) {
            throw new Error(`Failed to update box ${boxSKU}: ${error.message}`);
          }
        }
      }
    }

    function hideStatus() {
      document.getElementById('statusDiv').style.display = 'none';
    }

    async function loadShipments() {
      const refreshBtn = document.getElementById('refreshBtn');
      refreshBtn.disabled = true;
      refreshBtn.textContent = '‚è≥ Loading...';

      showStatus('Loading Amazon shipments...', 'loading');
      
      try {
        const { data: shipments, error } = await supabase
          .from('AmazonShipments')
          .select('*')
          .order('id', { ascending: false });

        if (error) {
          throw error;
        }

        allShipments = shipments || [];
        showStatus(`Successfully loaded ${allShipments.length} shipments`, 'success');
        setTimeout(hideStatus, 3000);

      } catch (error) {
        console.error('Error loading shipments:', error);
        showStatus(`Error loading shipments: ${error.message}`, 'error');
      }

      refreshBtn.disabled = false;
      refreshBtn.textContent = 'üîÑ Refresh Shipments';

      filteredShipments = [...allShipments];
      displayShipments();
      updateSummary();
      populateUserFilter();
    }

    function populateUserFilter() {
      const userSelect = document.getElementById('userFilter');
      const currentValue = userSelect.value;
      
      // Get unique users from allShipments
      const users = Array.from(new Set(allShipments.map(shipment => shipment.display_name).filter(Boolean)));
      users.sort((a, b) => a.localeCompare(b));
      
      // Save the first option (All Users)
      const firstOption = document.createElement('option');
      firstOption.value = '';
      firstOption.textContent = 'All Users';
      
      userSelect.innerHTML = '';
      userSelect.appendChild(firstOption);
      
      users.forEach(user => {
        const opt = document.createElement('option');
        opt.value = user;
        opt.textContent = user;
        userSelect.appendChild(opt);
      });
      
      // Restore previous selection if possible
      userSelect.value = currentValue;
    }

    function filterShipments() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const userFilter = document.getElementById('userFilter').value;

      filteredShipments = allShipments.filter(shipment => {
        // User filter
        if (userFilter && shipment.display_name !== userFilter) {
          return false;
        }

        // Search filter
        if (searchTerm) {
          const searchFields = [
            shipment.SKU,
            shipment.display_name,
            shipment.Notes
          ].join(' ').toLowerCase();

          if (!searchFields.includes(searchTerm)) {
            return false;
          }
        }

        return true;
      });

      displayShipments();
      updateSummary();
    }

    function displayShipments() {
      const container = document.getElementById('shipmentsTableContainer');
      const summaryDiv = document.getElementById('shipmentsSummary');
      const actionButtons = document.getElementById('actionButtons');
      
      if (filteredShipments.length === 0) {
        summaryDiv.style.display = 'none';
        actionButtons.style.display = 'none';
        container.innerHTML = `
          <div class="no-shipments">
            <h3>${allShipments.length === 0 ? 'No shipments found' : 'No shipments match your filters'}</h3>
            <p>${allShipments.length === 0 ? 'No Amazon shipments have been created yet. Use the Amazon Shipments form to create shipments.' : 'Try adjusting your search or filter criteria'}</p>
          </div>
        `;
        return;
      }

      summaryDiv.style.display = 'flex';
      actionButtons.style.display = 'flex';

      // Only show non-completed shipments in the main table
      const nonCompletedShipments = filteredShipments.filter(s => s.Status !== 'Completed');
      const tableHTML = `
        <table class="shipments-table">
          <thead>
            <tr>
              <th class="checkbox-cell">
                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
              </th>
              <th>ID</th>
              <th>Request Date</th>
              <th>Items</th>
              <th>User</th>
              <th>Notes</th>
              <th>Boxes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${nonCompletedShipments.map(shipment => {
              const isSelected = selectedShipments.has(shipment.id);
              const boxesHtml = Array.isArray(shipment.Boxes) && shipment.Boxes.length > 0
                ? shipment.Boxes.map(boxObj => {
                    if (boxObj && typeof boxObj === 'object' && boxObj.sku) {
                      return `${boxObj.sku} (${boxObj.quantity || 1})`;
                    }
                    return '';
                  }).filter(Boolean).join(', ')
                : '<em style="color:#999;">None</em>';
              
              // Format Items column
              let itemsHtml = '';
              if (shipment.Items && Array.isArray(shipment.Items)) {
                itemsHtml = shipment.Items.map(item => {
                  return `<div style="margin-bottom: 4px;"><span class="sku-link">${item.sku}</span> √ó <span class="quantity-badge">${item.quantity}</span></div>`;
                }).join('');
              } else {
                itemsHtml = '<em style="color: #999;">No items</em>';
              }
              
              return `
                <tr class="${isSelected ? 'selected-row' : ''}" id="shipment-${shipment.id}">
                  <td class="checkbox-cell">
                    <input type="checkbox" class="shipment-checkbox" 
                           ${isSelected ? 'checked' : ''} 
                           onchange="toggleShipmentSelection(${shipment.id})">
                  </td>
                  <td><strong>#${shipment.id}</strong></td>
                  <td>${formatRequestDate(shipment.RequestDate)}</td>
                  <td class="items-cell" data-field="Items">
                    ${itemsHtml}
                  </td>
                  <td>
                    <span class="user-name">${shipment.display_name || 'Unknown User'}</span>
                  </td>
                  <td class="notes-cell" data-field="Notes" title="${shipment.Notes || ''}">
                    ${shipment.Notes || '<em style="color: #999;">No notes</em>'}
                  </td>
                  <td class="boxes-cell">${boxesHtml}</td>
                  <td class="actions-cell">
                    <button class="action-btn" style="background:#4DBA93;padding:6px 10px;font-size:12px;" onclick="enterEditMode(${shipment.id})">‚úèÔ∏è Edit</button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;

      container.innerHTML = tableHTML;
      updateSelectedCount();
      updateSelectAllCheckbox();
    renderCompletedShipmentsTable();
    }

    function updateSummary() {
      const summaryDiv = document.getElementById('shipmentsSummary');
      
      if (filteredShipments.length === 0) {
        summaryDiv.style.display = 'none';
        return;
      }
      
      // Exclude Completed shipments from summary metrics
      const activeShipments = filteredShipments.filter(s => s.Status !== 'Completed');
      
      // Calculate total quantity and unique SKUs
      let totalQuantity = 0;
      const uniqueSKUs = new Set();
      
      activeShipments.forEach(shipment => {
        if (shipment.Items && Array.isArray(shipment.Items)) {
          shipment.Items.forEach(item => {
            totalQuantity += item.quantity || 0;
            if (item.sku) uniqueSKUs.add(item.sku);
          });
        }
      });

      document.getElementById('totalShipments').textContent = activeShipments.length;
      document.getElementById('totalQuantity').textContent = totalQuantity;
      document.getElementById('uniqueSKUs').textContent = uniqueSKUs.size;
    }

    function formatRequestDate(val) {
      if (!val) return '<em style="color:#999;">N/A</em>';
      try {
        const d = new Date(val);
        if (isNaN(d.getTime())) return '<em style="color:#999;">N/A</em>';
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        const yyyy = d.getFullYear();
        return `${mm}/${dd}/${yyyy}`;
      } catch(e) {
        return '<em style="color:#999;">N/A</em>';
      }
    }

    // Inline Editing Logic
    const editingShipments = {}; // id -> original data

    window.enterEditMode = function(id) {
      if (editingShipments[id]) return; // already editing
      const row = document.getElementById(`shipment-${id}`);
      if (!row) return;
      const shipment = allShipments.find(s => s.id === id);
      if (!shipment) return;
      editingShipments[id] = { ...shipment }; // shallow copy original

      // Replace Items cell with user-friendly item editor
      const itemsCell = row.querySelector('.items-cell');
      let itemsHtml = '';
      
      if (shipment.Items && Array.isArray(shipment.Items)) {
        // Create editable rows for each item
        itemsHtml = shipment.Items.map((item, index) => `
          <div class="item-edit-row" style="display: flex; gap: 8px; margin-bottom: 4px; align-items: center;">
            <input type="text" value="${item.sku}" placeholder="SKU" class="item-sku-input" data-index="${index}" style="flex: 1; padding: 4px; border: 1px solid #ccc; border-radius: 4px;">
            <input type="number" value="${item.quantity}" min="1" placeholder="Qty" class="item-qty-input" data-index="${index}" style="width: 60px; padding: 4px; border: 1px solid #ccc; border-radius: 4px;">
            <button type="button" onclick="removeItemRow(this)" style="background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">√ó</button>
          </div>
        `).join('');
      }
      
      // Add button to add new items
      itemsHtml += `
        <div class="add-item-section" style="margin-top: 8px;">
          <button type="button" onclick="addItemRow(${id})" style="background: #4DBA93; color: white; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-size: 12px;">+ Add Item</button>
        </div>
      `;
      
      itemsCell.innerHTML = `<div class="items-editor">${itemsHtml}</div>`;

      // Replace Notes cell with input (single line to keep row height reasonable)
      const notesCell = row.querySelector('[data-field="Notes"]');
      const safeNotes = (shipment.Notes || '').replace(/"/g,'&quot;');
      notesCell.innerHTML = `<input type="text" value="${safeNotes}" class="edit-input" style="width:100%;padding:4px 6px;">`;
      notesCell.title = shipment.Notes || '';

      // Actions cell -> Save / Cancel
      const actionsCell = row.querySelector('.actions-cell');
      actionsCell.innerHTML = `
        <button class="action-btn" style="background:#27ae60;padding:6px 10px;font-size:12px;margin-right:4px;" onclick="saveShipment(${id})">üíæ Save</button>
        <button class="action-btn danger" style="padding:6px 10px;font-size:12px;" onclick="cancelEdit(${id})">‚úñ Cancel</button>
      `;
    }

    // Helper function to add new item row
    window.addItemRow = function(shipmentId) {
      const itemsEditor = document.querySelector(`#shipment-${shipmentId} .items-editor`);
      const addSection = itemsEditor.querySelector('.add-item-section');
      const currentItems = itemsEditor.querySelectorAll('.item-edit-row');
      const newIndex = currentItems.length;
      
      const newItemHtml = `
        <div class="item-edit-row" style="display: flex; gap: 8px; margin-bottom: 4px; align-items: center;">
          <input type="text" value="" placeholder="SKU" class="item-sku-input" data-index="${newIndex}" style="flex: 1; padding: 4px; border: 1px solid #ccc; border-radius: 4px;">
          <input type="number" value="1" min="1" placeholder="Qty" class="item-qty-input" data-index="${newIndex}" style="width: 60px; padding: 4px; border: 1px solid #ccc; border-radius: 4px;">
          <button type="button" onclick="removeItemRow(this)" style="background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">√ó</button>
        </div>
      `;
      
      addSection.insertAdjacentHTML('beforebegin', newItemHtml);
    }

    // Helper function to remove item row
    window.removeItemRow = function(button) {
      button.closest('.item-edit-row').remove();
    }

    window.cancelEdit = function(id) {
      const original = editingShipments[id];
      if (!original) return;
      delete editingShipments[id];
      // Re-render just this row using current displayShipments approach (simpler: rebuild table)
      displayShipments();
    }

    window.saveShipment = async function(id) {
      const row = document.getElementById(`shipment-${id}`);
      if (!row) return;
      
      // Get notes input
      const notesInput = row.querySelector('[data-field="Notes"] .edit-input');
      const newNotes = (notesInput.value || '').trim();

      // Collect items from the user-friendly interface
      const itemRows = row.querySelectorAll('.item-edit-row');
      const newItems = [];
      
      for (const itemRow of itemRows) {
        const skuInput = itemRow.querySelector('.item-sku-input');
        const qtyInput = itemRow.querySelector('.item-qty-input');
        
        const sku = (skuInput.value || '').trim();
        const quantity = parseInt(qtyInput.value, 10);
        
        if (!sku) {
          alert('All items must have a SKU. Please fill in all SKU fields or remove empty items.');
          return;
        }
        if (isNaN(quantity) || quantity <= 0) {
          alert('All items must have a quantity greater than 0.');
          return;
        }
        
        newItems.push({ sku, quantity });
      }

      if (newItems.length === 0) {
        alert('Shipment must have at least one item.');
        return;
      }

      try {
        showStatus('Saving shipment update...', 'loading');
        const { error } = await supabase
          .from('AmazonShipments')
          .update({ Items: newItems, Notes: newNotes || null })
          .eq('id', id);
        if (error) throw error;
        
        // Update local cache
        const idx = allShipments.findIndex(s => s.id === id);
        if (idx !== -1) {
          allShipments[idx].Items = newItems;
          allShipments[idx].Notes = newNotes || null;
        }
        delete editingShipments[id];
        displayShipments();
        updateSummary();
        showStatus('Shipment updated successfully', 'success');
        setTimeout(hideStatus, 2500);
      } catch (err) {
        console.error('Error updating shipment:', err);
        showStatus('Failed to update shipment: ' + err.message, 'error');
      }
    }

    function toggleShipmentSelection(shipmentId) {
      const shipmentRow = document.getElementById(`shipment-${shipmentId}`);
      const checkbox = shipmentRow.querySelector('.shipment-checkbox');
      
      if (selectedShipments.has(shipmentId)) {
        selectedShipments.delete(shipmentId);
        shipmentRow.classList.remove('selected-row');
      } else {
        selectedShipments.add(shipmentId);
        shipmentRow.classList.add('selected-row');
      }
      
      updateSelectedCount();
      updateSelectAllCheckbox();
    }

    function toggleSelectAll() {
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      
      if (selectAllCheckbox.checked) {
        filteredShipments.forEach(shipment => {
          selectedShipments.add(shipment.id);
        });
      } else {
        selectedShipments.clear();
      }
      
      displayShipments();
    }

    function updateSelectedCount() {
      const selectedCountSpan = document.getElementById('selectedCount');
      selectedCountSpan.textContent = selectedShipments.size;
    }

    function updateSelectAllCheckbox() {
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      const filteredShipmentIds = filteredShipments.map(shipment => shipment.id);
      const selectedFilteredShipments = filteredShipmentIds.filter(id => selectedShipments.has(id));
      
      if (selectedFilteredShipments.length === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      } else if (selectedFilteredShipments.length === filteredShipmentIds.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
      } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
      }
    }

    function getSelectedShipmentsData() {
      return allShipments.filter(shipment => selectedShipments.has(shipment.id));
    }

    async function deleteSelectedShipments() {
      if (selectedShipments.size === 0) {
        alert('Please select at least one shipment to delete.');
        return;
      }
      
      if (!confirm(`Are you sure you want to delete ${selectedShipments.size} selected shipment(s)? This action cannot be undone.`)) {
        return;
      }

      showStatus('Deleting selected shipments...', 'loading');
      
      let deletedCount = 0;
      let errorCount = 0;

      for (const shipmentId of selectedShipments) {
        try {
          const { error } = await supabase
            .from('AmazonShipments')
            .delete()
            .eq('id', shipmentId);

          if (!error) {
            deletedCount++;
            // Remove from local arrays
            allShipments = allShipments.filter(s => s.id !== shipmentId);
            filteredShipments = filteredShipments.filter(s => s.id !== shipmentId);
          } else {
            console.error('Error deleting shipment', shipmentId, error);
            errorCount++;
          }
        } catch (err) {
          console.error('Error deleting shipment', shipmentId, err);
          errorCount++;
        }
      }

      selectedShipments.clear();
      displayShipments();
      updateSummary();
      
      showStatus(`${deletedCount} shipment(s) deleted${errorCount > 0 ? `, ${errorCount} errors` : ''}`, errorCount === 0 ? 'success' : 'error');
      setTimeout(hideStatus, 3000);
    }

    function printPicklist() {
      if (selectedShipments.size === 0) {
        alert('Please select at least one shipment to print a picklist.');
        return;
      }

      const selectedShipmentsData = getSelectedShipmentsData();
      
      // Group items by SKU and sum quantities
      const skuMap = new Map();
      let totalShipments = selectedShipmentsData.length;
      
      selectedShipmentsData.forEach(shipment => {
        if (shipment.Items && Array.isArray(shipment.Items)) {
          shipment.Items.forEach(item => {
            if (item.sku) {
              const currentQty = skuMap.get(item.sku) || 0;
              skuMap.set(item.sku, currentQty + (item.quantity || 0));
            }
          });
        }
      });

      // Generate HTML for the picklist
      const printDate = new Date().toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      let picklistHTML = `
        <html>
          <head>
            <title>Amazon Shipments Picklist</title>
            <style>
              body {
                font-family: Arial, sans-serif;
                margin: 20px;
                line-height: 1.4;
              }
              .header {
                text-align: center;
                margin-bottom: 30px;
                border-bottom: 2px solid #333;
                padding-bottom: 15px;
              }
              .header h1 {
                margin: 0;
                color: #333;
                font-size: 24px;
              }
              .header p {
                margin: 5px 0;
                color: #666;
                font-size: 14px;
              }
              .summary {
                background: #f5f5f5;
                padding: 15px;
                border-radius: 5px;
                margin-bottom: 20px;
              }
              .summary h3 {
                margin-top: 0;
                color: #333;
              }
              table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 20px;
              }
              th, td {
                border: 1px solid #ddd;
                padding: 10px;
                text-align: left;
              }
              th {
                background-color: #f9f9f9;
                font-weight: bold;
                color: #333;
              }
              .sku-column {
                font-family: 'Courier New', monospace;
                font-weight: bold;
                width: 30%;
              }
              .quantity-column {
                text-align: center;
                width: 15%;
                font-weight: bold;
              }
              .checkbox-column {
                text-align: center;
                width: 10%;
              }
              .notes-column {
                width: 45%;
              }
              .total-row {
                background-color: #e8f5e8;
                font-weight: bold;
              }
              .checkbox {
                width: 20px;
                height: 20px;
              }
              @media print {
                body {
                  margin: 10px;
                }
                .no-print {
                  display: none;
                }
              }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>Amazon Shipments Picklist</h1>
              <p>Generated on: ${printDate}</p>
              <p>Total Shipments: ${totalShipments} | Unique SKUs: ${skuMap.size}</p>
            </div>

            <table>
              <thead>
                <tr>
                  <th class="checkbox-column">‚úì</th>
                  <th class="sku-column">SKU</th>
                  <th class="quantity-column">Quantity to Pick</th>
                  <th class="notes-column">Notes</th>
                </tr>
              </thead>
              <tbody>`;

      // Sort SKUs alphabetically for easier picking
      const sortedSKUs = Array.from(skuMap.entries()).sort((a, b) => a[0].localeCompare(b[0]));
      const totalQuantity = sortedSKUs.reduce((sum, [sku, qty]) => sum + qty, 0);

      sortedSKUs.forEach(([sku, quantity]) => {
        // Find any notes from the shipments for this SKU
        const shipmentNotes = [];
        selectedShipmentsData.forEach(shipment => {
          if (shipment.Items && Array.isArray(shipment.Items)) {
            const hasThisSku = shipment.Items.some(item => item.sku === sku);
            if (hasThisSku && shipment.Notes) {
              shipmentNotes.push(shipment.Notes);
            }
          }
        });

        picklistHTML += `
          <tr>
            <td class="checkbox-column">
              <input type="checkbox" class="checkbox">
            </td>
            <td class="sku-column">${sku}</td>
            <td class="quantity-column">${quantity}</td>
            <td class="notes-column">${shipmentNotes.join('; ') || ''}</td>
          </tr>`;
      });

      picklistHTML += `
                <tr class="total-row">
                  <td class="checkbox-column">‚Äî</td>
                  <td class="sku-column">TOTAL</td>
                  <td class="quantity-column">${totalQuantity}</td>
                  <td class="notes-column">${skuMap.size} unique SKUs</td>
                </tr>
              </tbody>
            </table>

            <div class="summary" style="margin-top: 30px;">
              <h3>Shipment Details</h3>
              <table style="margin: 0;">
                <thead>
                  <tr>
                    <th style="width: 15%;">Shipment ID</th>
                    <th style="width: 35%;">Items</th>
                    <th style="width: 20%;">Requested By</th>
                    <th style="width: 30%;">Notes</th>
                  </tr>
                </thead>
                <tbody>`;

      selectedShipmentsData.forEach(shipment => {
        // Format items for this shipment
        let itemsText = '';
        if (shipment.Items && Array.isArray(shipment.Items)) {
          itemsText = shipment.Items.map(item => `${item.sku} √ó ${item.quantity}`).join(', ');
        } else {
          itemsText = 'No items';
        }
        
        picklistHTML += `
          <tr>
            <td>#${shipment.id}</td>
            <td style="font-family: 'Courier New', monospace;">${itemsText}</td>
            <td>${shipment.display_name || 'Unknown'}</td>
            <td>${shipment.Notes || ''}</td>
          </tr>`;
      });

      picklistHTML += `
                </tbody>
              </table>
            </div>

            <div class="no-print" style="text-align: center; margin-top: 30px;">
              <button onclick="window.print()" style="background: #4DBA93; color: white; border: none; padding: 12px 24px; border-radius: 5px; font-size: 16px; cursor: pointer;">
                üñ®Ô∏è Print This Picklist
              </button>
              <button onclick="window.close()" style="background: #666; color: white; border: none; padding: 12px 24px; border-radius: 5px; font-size: 16px; cursor: pointer; margin-left: 10px;">
                Close
              </button>
            </div>
          </body>
        </html>`;

      // Open the picklist in a new window and trigger print
      const printWindow = window.open('', '_blank', 'width=800,height=600');
      printWindow.document.write(picklistHTML);
      printWindow.document.close();
      
      // Auto-print after a short delay to allow content to load
      setTimeout(() => {
        printWindow.focus();
        printWindow.print();
      }, 500);
    }

    // Make functions globally available
    window.loadShipments = loadShipments;
    window.filterShipments = filterShipments;
    window.toggleShipmentSelection = toggleShipmentSelection;
    window.toggleSelectAll = toggleSelectAll;
    window.deleteSelectedShipments = deleteSelectedShipments;
    window.printPicklist = printPicklist;
    window.processAmazonShipments = processAmazonShipments;
    window.closeBoxModal = closeBoxModal;
    window.toggleBoxSelection = toggleBoxSelection;
    window.updateBoxQuantity = updateBoxQuantity;
    window.submitProcessing = submitProcessing;

    // Initialize the page
    window.addEventListener('DOMContentLoaded', () => {
      loadShipments();
    });

    // Close modal when clicking outside of it
    window.addEventListener('click', (event) => {
      const modal = document.getElementById('boxModal');
      if (event.target === modal) {
        closeBoxModal();
      }
    });
  </script>
</body>
</html>